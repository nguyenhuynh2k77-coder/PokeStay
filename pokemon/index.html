<!DOCTYPE html>
<html lang="vi">
<head>
ย ย <head>
ย ย <meta charset="UTF-8">
ย ย <meta name="viewport" content="width=device-width, initial-scale=1.0">
ย ยย
ย ย <title>PokeStay - Game Pokemon Online | Sฤn Bแบฏt, ฤแบฅu Boss & Leo Thรกp</title>

ย ย <meta name="description" content="Chฦกi ngay PokeStay v2.4.2 - Game nhแบญp vai Pokemon trรชn trรฌnh duyแปt miแปn phรญ. Tรญnh nฤng: Sฤn Shiny, Chแปฃ ฤen, Leo Thรกp Vรด Tแบญn, World Boss. Khรดng cแบงn cรi ฤแบทt!">

ย ย <meta name="keywords" content="pokestay, game pokemon, webgame pokemon, pokemon online, game rpg, game html5, game pokemon hay">

ย ย <meta property="og:title" content="PokeStay - Game Pokemon Online">
ย ย <meta property="og:description" content="Vรo chฦกi ngay! Sฤn Pokemon 7 mรu, Leo thรกp vรด tแบญn, ฤแบฅu trรนm thแบฟ giแปi.">
ย ย <meta property="og:image" content="https://nguyenhuynh2k77-coder.github.io/PokeStay/pokemon/thumbnail.jpg">
ย ย <meta property="og:url" content="https://nguyenhuynh2k77-coder.github.io/PokeStay/pokemon/index.html">
ย ย <meta property="og:type" content="website">
ย ย <link rel="canonical" href="https://nguyenhuynh2k77-coder.github.io/PokeStay/pokemon/" />

ย ย </head>
ย ย <title>PokeStay v2.5.0: REAWAKENED POWER</title>
ย ย <link rel="icon" type="image/png" href="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png">
ย ยย
ย ย <style>
ย ย ย ยย
ย ย ย ย /* Style cho cรกc thแบป ฤแป hiแบฟm */
.rarity-tag {
ย ย padding: 2px 6px;
ย ย border-radius: 4px;
ย ย font-size: 0.7em;
ย ย font-weight: bold;
ย ย color: white;
ย ย text-transform: uppercase;
ย ย display: inline-block;
}
.rarity-common { background: #7f8c8d; }
.rarity-uncommon { background: #27ae60; }
.rarity-rare { background: #2980b9; }
.rarity-epic { background: #8e44ad; }
.rarity-legendary { background: #f39c12; box-shadow: 0 0 5px gold; }
ย ย ย ย /* --- ADMIN PANEL STYLES --- */
#admin-panel {
ย ย display: none; /* Mแบทc ฤแปnh แบฉn */
ย ย position: fixed;
ย ย top: 50px; left: 50px;
ย ย width: 320px;
ย ย background: rgba(0, 0, 0, 0.9);
ย ย border: 2px solid #ff0000;
ย ย box-shadow: 0 0 15px #ff0000;
ย ย z-index: 10000;
ย ย color: #fff;
ย ย font-family: monospace;
ย ย border-radius: 8px;
ย ย overflow: hidden;
}

#admin-header {
ย ย background: #a00000;
ย ย padding: 10px;
ย ย cursor: move; /* Con trแป di chuyแปn */
ย ย font-weight: bold;
ย ย display: flex;
ย ย justify-content: space-between;
ย ย align-items: center;
}

.admin-body {
ย ย padding: 10px;
ย ย max-height: 400px;
ย ย overflow-y: auto;
}

.admin-group {
ย ย margin-bottom: 15px;
ย ย border-bottom: 1px solid #444;
ย ย padding-bottom: 10px;
}

.admin-label { color: #ff6b6b; font-size: 0.8em; margin-bottom: 5px; display:block; }
.admin-input { width: 100%; background: #222; border: 1px solid #555; color: white; padding: 5px; margin-bottom: 5px; }
.admin-btn {ย
ย ย width: 100%; background: #444; color: white; border: 1px solid #fff;ย
ย ย padding: 5px; cursor: pointer; margin-top: 5px; font-weight:bold;
}
.admin-btn:hover { background: #ff0000; color: black; }

/* Nรบt mแป Admin nhแป xรญu แป gรณc */
#admin-toggle-btn {
ย ย position: fixed; bottom: 10px; right: 10px;
ย ย width: 40px; height: 40px; background: red;
ย ย border-radius: 50%; border: 2px solid white;
ย ย cursor: pointer; z-index: 9999;
ย ย display: flex; align-items: center; justify-content: center;
ย ย font-size: 20px; box-shadow: 0 0 10px red;
}
ย ย ย ย /* --- SแปฌA GIAO DIแปN MENU (TแบO KHแปI Rร RรNG) --- */

/* 1. Lรm nแปi bแบญt thanh Tab แป dฦฐแปi */
.menu-tabs {
ย ย background-color: #18191c !important; /* Mรu ฤen ฤแบญm hฦกn nแปn app */
ย ย border-top: 2px solid #444;ย ย ย ย ย ย/* Kแบป vแบกch ngฤn cรกch vแปi nแปi dung trรชn */
ย ย border-bottom: 1px solid #000;ย ย ย ย /* Kแบป vแบกch ngฤn cรกch vแปi footer dฦฐแปi */
ย ย box-shadow: 0 -4px 10px rgba(0,0,0,0.3); /* ฤแป bรณng ngฦฐแปฃc lรชn trรชn cho ฤแบนp */
ย ย margin-top: 5px;ย ย ย ย ย ย ย ย ย ย ย /* Tแบกo khoแบฃng cรกch nhแป */
ย ย padding: 5px 0;ย ย ย ย ย ย ย ย ย ย ย ย/* Thรชm ฤแปm trรชn dฦฐแปi */
}

/* 2. Lรm nรบt bแบฅm nแปi lรชn khแปi nแปn */
.menu-btn {
ย ย background: #36393f !important;ย ย ย ย/* Sรกng hฦกn nแปn app mแปt chรบt */
ย ย box-shadow: 0 2px 4px rgba(0,0,0,0.4); /* ฤแป bรณng nรบt */
ย ย border: 1px solid #202225 !important; /* Viแปn tแปi mรu */
}
.menu-btn:hover {
ย ย background: #40444b !important;ย ย ย ย/* Sรกng hฦกn nแปฏa khi di chuแปt vรo */
ย ย transform: translateY(-2px);
}

/* 3. Chแปnh lแบกi Footer cho tรกch biแปt hแบณn */
.footer {
ย ย background: #111 !important;ย ย ย ย ย /* ฤen gแบงn nhฦฐ tuyแปt ฤแปi */
ย ย border-top: 1px solid #333;ย ย ย ย ย ย/* Viแปn mแป */
ย ย font-size: 0.75em !important;ย ย ย ย ย/* Chแปฏ nhแป lแบกi xรญu cho gแปn */
ย ย padding: 8px 10px !important;
}
ย ย ย ย /* GIแปฎ NGUYรN CSS Cลจ */
ย ย ย ย * { box-sizing: border-box; }
ย ย ย ย body { background: url('wp2595124.jpg') no-repeat center center fixed; background-size: cover; color: #dcddde; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; justify-content: center; height: 100vh; margin: 0; overflow: hidden; }
ย ย ย ย /* --- SแปฌA LแปI GIAO DIแปN Bแป DแปN --- */

/* 1. Khung tแปng: Xแบฟp dแปc tแปซ trรชn xuแปng dฦฐแปi */
/* --- SแปฌA LแปI FOOTER & Bแป CแปคC --- */

/* 1. Cแบฅu hรฌnh lแบกi khung chรญnh #app */
#app {
ย ย display: flex !important;
ย ย flex-direction: column !important;
ย ย height: 100vh !important;ย ย ย ย/* Chiแปu cao 100% mรn hรฌnh */
ย ย height: 100dvh !important;ย ย ย /* Chiแปu cao ฤแปng (Fix lแปi trรฌnh duyแปt mobile che footer) */
ย ย width: 100% !important;
ย ย max-width: 500px !important;ย ย /* Giแปi hแบกn chiแปu rแปng trรชn PC */
ย ย margin: 0 auto !important;
ย ย overflow: hidden !important;ย ย /* Cแบฏt bแป mแปi thแปฉ thแปซa ra ngoรi */
ย ย position: relative !important;
ย ย background-color: #2f3136 !important;
}

/* 2. Khung Chat: Phแบฃi co giรฃn ฤแป nhฦฐแปng chแป cho Footer */
#chat-area {
ย ย flex: 1 1 auto !important;ย ย ย /* Tแปฑ ฤแปng chiแบฟm khoแบฃng trแปng cรฒn lแบกi */
ย ย min-height: 0 !important;ย ย ย ย/* BแบฎT BUแปC: ฤแป cho phรฉp co lแบกi khi mรn hรฌnh bรฉ */
ย ย overflow-y: auto !important;ย ย /* Chแป cuแปn nแปi dung chat, khรดng cuแปn cแบฃ trang */
ย ย width: 100%;
}
/* 3. Controls (Nรบt bแบฅm): Khรดng ฤฦฐแปฃc co giรฃn */
#controls {
ย ย flex: 0 0 auto !important;ย ย ย /* Giแปฏ nguyรชn kรญch thฦฐแปc nแปi dung */
ย ย width: 100%;
ย ย z-index: 10;
}
/* 4. Footer (Thoรกt/Donate): Luรดn nแบฑm ฤรกy, khรดng bแป chแบกy */
.footer {
ย ย flex: 0 0 auto !important;ย ย ย /* Khรดng co giรฃn */
ย ย width: 100% !important;
ย ย background: #111 !important;ย ย /* Mรu nแปn ฤen tรกch biแปt */
ย ย border-top: 1px solid #333;
ย ย padding: 8px 10px !important;
ย ยย
ย ย /* Cฤn chแปnh nแปi dung */
ย ย display: flex !important;
ย ย justify-content: space-between !important;
ย ย align-items: center !important;
ย ยย
ย ย /* Fix lแปi bแป che trรชn iPhone ฤแปi mแปi (Tai thแป) */
ย ย padding-bottom: env(safe-area-inset-bottom, 10px) !important;
}
/* 2. Header: Cแป ฤแปnh chiแปu cao แป trรชn cรนng */
header {
ย ย flex: 0 0 auto !important; /* Khรดng ฤฦฐแปฃc co giรฃn */
ย ย width: 100%;
ย ย z-index: 10;
}

/* 3. Khung Chat/Game: Tแปฑ ฤแปng giรฃn ra ฤแป ฤแบฉy Controls xuแปng ฤรกy */
#chat-area {
ย ย flex: 1 1 auto !important; /* Quan trแปng: Chiแบฟm hแบฟt khoแบฃng trแปng thแปซa */
ย ย overflow-y: auto !important; /* Cho phรฉp cuแปn */
ย ย width: 100%;
ย ย position: relative;
}

/* 4. Controls (Nรบt bแบฅm): Cแป ฤแปnh แป ฤรกy */
#controls {
ย ย flex: 0 0 auto !important; /* Khรดng ฤฦฐแปฃc co giรฃn */
ย ย width: 100%;
ย ย z-index: 10;
}

/* 5. Footer: Nแบฑm dฦฐแปi cรนng */
.footer {
ย ย flex: 0 0 auto !important;
ย ย width: 100%;
}
ย ย ย ย .btn { padding: 10px 0; border: none; border-radius: 3px; font-weight: bold; cursor: pointer; color: white; width: calc(33.33% - 4px); font-size: 0.85em; transition: 0.2s; display: flex; align-items: center; justify-content: center; gap: 5px; }
ย ย ย ย .btn:hover { transform: translateY(-2px); filter: brightness(1.1); }
ย ย ย ย .btn-hunt { width: 32% !important; background: url('image_1.png') no-repeat center center; background-size: cover; text-shadow: 0 0 3px black, 0 0 3px black; border: 2px solid #2ecc71; }
ย ย ย ย .btn-shop { background: #faa61a; color: #202225; } .btn-bag { background: #5865f2; }
ย ย ย ย .btn-job { background: #7289da; } .btn-achieve { background: #f1c40f; color:#202225; } .btn-daycare { background: #e91e63; }
ย ย ย ย .btn-daily { background: #eb459e; } .btn-dex { background: #3498db; } .btn-center { background: #ff7675; color: white; }
ย ย ย ย @media (max-width: 768px) {
ย ย ย ย ย ย body { background: #202225; }
ย ย ย ย ย ย #app { max-width: 100%; border: none; box-shadow: none; height: 100dvh; position: fixed; top: 0; left: 0; }
ย ย ย ย ย ย #controls { padding-bottom: 20px; gap: 5px; }
ย ย ย ย ย ยย
ย ย ย ย ย ย /* Chแปnh lแบกi kรญch thฦฐแปc nรบt trรชn ฤiแปn thoแบกi */
ย ย ย ย ย ย .btn { padding: 12px 0; font-size: 0.9em; width: 48%; }
ย ย ย ย ย ยย
ย ย ย ย ย ย /* Nรบt Sฤn to nhแบฅt */
ย ย ย ย ย ย .btn-hunt { width: 100% !important; margin-bottom: 5px; font-size: 1.2em; }
ย ย ย ย ย ยย
ย ย ย ย ย ย /* Hรng 2 nรบt (Shop, Bag, Daily, Center) */
ย ย ย ย ย ย .btn-shop, .btn-bag, .btn-daily, .btn-center { width: 49% !important; }

ย ย ย ย ย ย /* Hรng 3 nรบt (Job, Achieve, Care, Dex, Log) - CHแปNH SแปฌA แป ฤรY */
ย ย ย ย ย ย .btn-job, .btn-achieve, .btn-daycare, .btn-dex, .btn-log {ย
ย ย ย ย ย ย ย ย width: 32% !important; /* Chia 3 cแปt ฤแปu nhau */
ย ย ย ย ย ย ย ย font-size: 0.8em;ย
ย ย ย ย ย ย ย ย padding: 10px 0;ย
ย ย ย ย ย ย ย ย display: flex !important; /* Bแบฏt buแปc hiแปn */
ย ย ย ย ย ย }
ย ย ย ย }
ย ย ย ย /* --- CSS HรNH NแปN Mแป CHO ฤIแปN THOแบI --- */
@media (max-width: 768px) {
ย ย #app {
ย ย ย ย /* Mรu nแปn ฤen xรกm nhฦฐng cรณ ฤแป trong suแปt (0.85) ฤแป lแป แบฃnh bรชn dฦฐแปi */
ย ย ย ย background-color: rgba(32, 34, 37, 0.85) !important;ย
ย ย ย ย position: relative; /* ฤแป canh chแปnh lแปp แบฃnh mแป */
ย ย ย ย overflow: hidden;ย ย/* Cแบฏt bแป phแบงn แบฃnh bแป nhรฒe ra ngoรi khung */
ย ย ย ย z-index: 1;ย ย ย ย ย/* ฤแบฃm bแบฃo nแปi dung nแปi lรชn trรชn */
ย ย }

ย ย /* Tแบกo lแปp แบฃnh nแปn giแบฃ lแบญp */
ย ย #app::before {
ย ย ย ย content: "";
ย ย ย ย position: absolute;
ย ย ย ย top: 0;ย
ย ย ย ย left: 0;ย
ย ย ย ย width: 100%;ย
ย ย ย ย height: 100%;
ย ย ย ยย
ย ย ย ย /* ฤแปi tรชn แบฃnh 'wp2595124.jpg' thรnh แบฃnh bแบกn muแปn nแบฟu cแบงn */
ย ย ย ย background: url('wp2595124.jpg') no-repeat center center;
ย ย ย ย background-size: cover;
ย ย ย ยย
ย ย ย ย /* --- CHแปNH ฤแป Mแป TแบI ฤรY --- */
ย ย ย ย opacity: 0.3;ย ย ย ย/* ฤแป trong suแปt: 0.1 (rแบฅt mแป) -> 0.5 (rรต hฦกn) */
ย ย ย ย filter: blur(3px);ย ย/* ฤแป nhรฒe: sแป cรng to cรng nhรฒe */
ย ย ย ยย
ย ย ย ย z-index: -1;ย ย ย ย ย/* Bแบฏt buแปc: ฤแบฉy แบฃnh ra sau lฦฐng chแปฏ viแบฟt */
ย ย ย ย pointer-events: none; /* Khรดng cho phรฉp bแบฅm vรo แบฃnh nแปn */
ย ย }
}
ย ย ย ย #login-screen, #donate-modal, #update-modal, #shop-modal, #buy-modal, #battle-modal, #job-modal, #achieve-modal, #daycare-modal, #repair-modal, #dex-modal, #daily-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 999; display: flex; flex-direction: column; justify-content: center; align-items: center; }
ย ย ย ย #donate-modal, #update-modal, #shop-modal, #buy-modal, #battle-modal, #job-modal, #achieve-modal, #daycare-modal, #repair-modal, #dex-modal, #daily-modal { display: none; z-index: 1000; }
ย ย ย ย .box-style { background: #2f3136; padding: 20px; border-radius: 10px; border: 2px solid #faa61a; text-align: center; width: 90%; max-width: 350px; box-shadow: 0 0 20px rgba(0,0,0,0.5); max-height: 80vh; display: flex; flex-direction: column; overflow-y: auto;}
ย ย ย ย #buy-modal .box-style { background: url('image_3.png') no-repeat center center; background-size: cover; }
ย ย ย ย #dex-modal .box-style { background: url('image_4.png') no-repeat center center; background-size: cover; color: #eee; }
ย ย ย ย #achieve-modal .box-style { background: url('image_5.png') no-repeat center center; background-size: cover; }
ย ย ย ย #battle-modal .box-style { width: 100%; max-width: 450px; height: 100%; max-height: 100%; border:none; background: linear-gradient(to bottom, #2c3e50, #000); justify-content: flex-start; padding: 10px; }
ย ย ย ย .inner-box { background: rgba(0, 0, 0, 0.7); padding: 15px; border-radius: 8px; height: 100%; display: flex; flex-direction: column; width:100%; }
ย ย ย ย .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; width: 100%; }
ย ย ย ย .shop-card { background: rgba(64, 68, 75, 0.6); padding: 10px; border-radius: 5px; border: 1px solid #202225; cursor: pointer; display:flex; flex-direction:column; align-items:center; transition: 0.2s; }
ย ย ย ย .shop-card:hover { background: rgba(64, 68, 75, 0.9); border-color: #faa61a; }
ย ย ย ย .embed { background-color: rgba(41, 43, 47, 0.8); border-left: 4px solid #00b0f4; padding: 10px; border-radius: 4px; position: relative; margin-bottom: 5px; }
ย ย ย ย .embed-header { display: flex; justify-content: space-between; align-items: flex-start; }
ย ย ย ย .poke-sprite { width: 110px; height: 110px; image-rendering: pixelated; margin-left: 5px; filter: drop-shadow(0 0 5px rgba(255,255,255,0.2)); }
ย ย ย ย .rarity-tag { font-size: 0.6em; padding: 2px 4px; border-radius: 3px; font-weight: bold; margin-right: 5px; display: inline-block; text-transform: uppercase; letter-spacing: 0.5px; }
ย ย ย ย .r-common { background: #95a5a6; color: #fff; } .r-uncommon { background: #2ecc71; color: #000; } .r-rare { background: #3498db; color: #fff; } .r-superrare { background: #9b59b6; color: #fff; } .r-legendary { background: linear-gradient(45deg, #f1c40f, #e67e22); color: #000; } .r-shiny { background: #e74c3c; color: white; }
ย ย ย ย .hp-wrapper { display: flex; align-items: center; gap: 5px; margin-top: 3px; }
ย ย ย ย .hp-container { flex: 1; height: 8px; background: #202225; border-radius: 4px; overflow: hidden; border: 1px solid #444; }
ย ย ย ย .hp-fill { height: 100%; width: 0%; transition: width 0.3s, background-color 0.3s; }
ย ย ย ย .ball-btn { background: #2f3136; border: 1px solid #202225; padding: 5px; border-radius: 5px; cursor: pointer; display: flex; flex-direction: column; align-items: center; min-width: 60px; position: relative; width: 23%; margin-bottom:5px;}
ย ย ย ย .ball-btn img { width: 28px; }
ย ย ย ย .rate-badge { position: absolute; top: -5px; right: -5px; background: #3ba55c; color: white; font-size: 0.7em; padding: 1px 3px; border-radius: 3px; }
ย ย ย ย .ball-btn.disabled { opacity: 0.4; pointer-events: none; filter: grayscale(1); }
ย ย ย ย .login-input { width: 100%; padding: 12px; margin: 10px 0; border-radius: 5px; border: 1px solid #202225; background: #40444b; color: white; text-align: center; font-weight: bold; font-size: 16px; }
ย ย ย ย .btn-auth { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; color:white; }
ย ย ย ย .btn-login { background: #3ba55c; } .btn-register { background: #e91e63; }
ย ย ย ย .btn-close { background: #ed4245; color: white; padding: 8px 20px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; font-weight:bold;}
ย ย ย ย .bag-row { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(32, 34, 37, 0.5); margin-bottom: 5px; border-radius: 3px; border: 1px solid #2f3136; }
ย ย ย ย .bag-actions { display: flex; gap: 3px; flex-wrap: wrap; justify-content: flex-end; width: 120px;}
ย ย ย ย .btn-small { padding: 3px 6px; font-size: 0.7em; border: none; border-radius: 3px; color: white; cursor: pointer; margin-bottom: 2px;}
ย ย ย ย .btn-battle { background: #e74c3c; width:100% } .btn-heal { background: #2ecc71; color:black} .btn-evo { background: #9b59b6; } .btn-sell { background: #ed4245; }
ย ย ย ย .battle-scene { width: 100%; height: 280px; position: relative; background: rgba(0,0,0,0.3); border-radius: 10px; margin-bottom: 10px; overflow: hidden; }
ย ย ย ย .battle-platform { position: absolute; bottom: 30px; width: 120px; height: 40px; background: rgba(255,255,255,0.1); border-radius: 50%; transform: scaleY(0.4); border: 2px solid rgba(255,255,255,0.2); }
ย ย ย ย .p-enemy { position: absolute; top: 20px; right: 20px; text-align: center; }
ย ย ย ย .p-player { position: absolute; bottom: 20px; left: 20px; text-align: center; }
ย ย ย ย .battle-sprite { width: 96px; height: 96px; image-rendering: pixelated; transition: transform 0.2s; }
ย ย ย ย .shake { animation: shake 0.5s; }
ย ย ย ย /* 2. Hiแปu แปฉng lแบฏc chuแบฉn (Xoay nghiรชng chแปฉ khรดng kรฉo dรฃn) */
@keyframes shake {
ย ย 0%, 100% {ย
ย ย ย ย transform: rotate(0deg) translateX(0);ย
ย ย }
ย ย 20% {ย
ย ย ย ย transform: rotate(-12deg) translateX(-2px); /* Nghiรชng trรกi */
ย ย }
ย ย 40% {ย
ย ย ย ย transform: rotate(12deg) translateX(2px);ย /* Nghiรชng phแบฃi */
ย ย }
ย ย 60% {ย
ย ย ย ย transform: rotate(-6deg) translateX(-1px); /* Nghiรชng trรกi nhแบน */
ย ย }
ย ย 80% {ย
ย ย ย ย transform: rotate(6deg) translateX(1px);ย ย/* Nghiรชng phแบฃi nhแบน */
ย ย }
}

/* Class รกp dแปฅng hiแปu แปฉng (ฤแบฃm bแบฃo class nรy ฤang ฤฦฐแปฃc JS sแปญ dแปฅng) */
.shake {
ย ย /* Thแปi gian lแบฏc vร sแป lแบงn lแบฏc */
ย ย animation: shake 0.6s cubic-bezier(.36,.07,.19,.97) 3;ย
ย ย /* cubic-bezier giรบp chuyแปn ฤแปng giแบญt cแปฅc giแปng game thแบญt hฦกn */
}
ย ย ย ย .battle-log-box { height: 80px; overflow-y: auto; background: rgba(0,0,0,0.5); border: 1px solid #555; padding: 5px; font-size: 0.8em; margin-bottom: 10px; text-align: left; color: #ddd; border-radius: 5px; }
ย ย ย ย .action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; }
ย ย ย ย .action-btn { padding: 12px; border: none; border-radius: 5px; font-weight: bold; cursor: pointer; color: white; font-size: 0.9em; position:relative; overflow:hidden;}
ย ย ย ย .move-btn { border: 2px solid transparent; background: rgba(0,0,0,0.6); display:flex; flex-direction:column; align-items:center; justify-content:center; transition:0.2s; }
ย ย ย ย .move-btn:hover { filter:brightness(1.2); transform: translateY(-1px); }
ย ย ย ย .daycare-row { background: rgba(0,0,0,0.2); border: 1px dashed #7289da; border-radius: 5px; padding: 10px; margin-bottom: 10px; display:flex; justify-content:space-between; align-items:center; }
ย ย ย ย .donate-btn-text { color: #eb459e; font-weight: bold; animation: pulse 2s infinite; cursor: pointer;}
ย ย ย ย @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
ย ย ย ย .quest-item { margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; text-align: left;}
ย ย ย ย .quest-progress-bar { width: 100%; height: 6px; background: #202225; border-radius: 3px; overflow: hidden; margin-top:3px; }
ย ย ย ย .quest-progress-fill { height: 100%; background: #3ba55c; width: 0%; transition: width 0.3s; }
ย ย ย ย .difficulty-tag { padding: 1px 4px; border-radius: 3px; font-size: 0.7em; font-weight: bold; color:black;}
ย ย ย ย .diff-0 { background: #2ecc71; } .diff-1 { background: #f1c40f; } .diff-2 { background: #ed4245; color:white;}
ย ย ย ย .quiz-img { width: 100px; height: 100px; margin: 10px auto; filter: brightness(0); transition: filter 0.5s; image-rendering: pixelated;}
ย ย ย ย .quiz-img.revealed { filter: brightness(1); }
ย ย ย ย .quiz-opt { padding: 10px; background: #2f3136; border: 1px solid #444; color: white; cursor: pointer; border-radius: 4px; transition: 0.2s; font-size: 0.9em; }
ย ย ย ย /* --- CSS CHO BแบขNG XแบพP HแบNG --- */
ย ย ย ย .rank-row {
ย ย ย ย ย ย display: flex;
ย ย ย ย ย ย justify-content: space-between;
ย ย ย ย ย ย align-items: center;
ย ย ย ย ย ย background: rgba(0,0,0,0.3);
ย ย ย ย ย ย padding: 10px;
ย ย ย ย ย ย border-radius: 5px;
ย ย ย ย ย ย border: 1px solid #444;
ย ย ย ย }
ย ย ย ย .rank-num { font-weight: bold; width: 30px; text-align: center; font-size: 1.2em; }
ย ย ย ย .rank-name { flex: 1; text-align: left; padding-left: 10px; font-weight: bold; }
ย ย ย ย .rank-coin { color: #f1c40f; font-weight: bold; }

ย ย ย ย /* Mรu sแบฏc riรชng cho Top 3 */
ย ย ย ย .top-1 { border: 2px solid #f1c40f; background: rgba(241, 196, 15, 0.2); } /* Vรng */
ย ย ย ย .top-1 .rank-num { color: #f1c40f; text-shadow: 0 0 5px #f1c40f; }

ย ย ย ย .top-2 { border: 2px solid #bdc3c7; background: rgba(189, 195, 199, 0.2); } /* Bแบกc */
ย ย ย ย .top-2 .rank-num { color: #bdc3c7; }

ย ย ย ย .top-3 { border: 2px solid #d35400; background: rgba(211, 84, 0, 0.2); } /* ฤแปng */
ย ย ย ย .top-3 .rank-num { color: #d35400; }
ย ย ย ย /* --- SแปฌA LแปI GIAO DIแปN MODAL BXH (QUAN TRแปNG) --- */
#leaderboard-modal {
ย ย position: fixed;ย ย ย ย/* Ghim chแบทt vรo mรn hรฌnh, khรดng trรดi */
ย ย top: 0;
ย ย left: 0;
ย ย width: 100%;
ย ย height: 100%;
ย ย background: rgba(0, 0, 0, 0.85); /* Lรm tแปi mรn hรฌnh game ฤแบฑng sau */
ย ย backdrop-filter: blur(5px);ย ย ย /* Lรm mแป nแปn cho ฤแบนp */
ย ย z-index: 9999;ย ย ย ย ย ย ย ย ย ย/* ฤแบฃm bแบฃo nรณ ฤรจ lรชn trรชn tแบฅt cแบฃ mแปi thแปฉ */
ย ย display: none;ย ย ย ย ย ย ย ย ย ย/* Mแบทc ฤแปnh แบฉn */
ย ย justify-content: center;ย ย ย ย ย/* Cฤn giแปฏa chiแปu ngang */
ย ย align-items: center;ย ย ย ย ย ย ย/* Cฤn giแปฏa chiแปu dแปc */
ย ย flex-direction: column;
}

/* Chแปnh lแบกi cรกi hแปp nแปi dung cho gแปn gรng trรชn mobile */
#leaderboard-modal .box-style {
ย ย background: #2f3136;ย ย ย ย ย ย ย/* Mรu nแปn xรกm ฤแบญm cho hแปp */
ย ย width: 90%;ย ย ย ย ย ย ย ย ย ย ย /* Trรชn mobile chแป chiแบฟm 90% chiแปu rแปng */
ย ย max-width: 400px;ย ย ย ย ย ย ย ย /* Khรดng to quรก khแป trรชn PC */
ย ย max-height: 80vh;ย ย ย ย ย ย ย ย /* Chiแปu cao tแปi ฤa 80% mรn hรฌnh */
ย ย border: 2px solid #f1c40f;ย ย ย ย/* Viแปn vรng sang trแปng */
ย ย box-shadow: 0 0 20px rgba(0,0,0,0.8);
ย ย padding: 15px;
ย ย border-radius: 10px;
ย ย display: flex;
ย ย flex-direction: column;
ย ย position: relative;ย ย ย ย ย ย ย /* ฤแป ฤแบฃm bแบฃo nรบt ฤรณng nแบฑm ฤรบng chแป */
}

/* ฤแบฃm bแบฃo danh sรกch cuแปn ฤฦฐแปฃc nแบฟu quรก dรi */
#leaderboard-list {
ย ย overflow-y: auto;ย ย ย ย /* Cho phรฉp cuแปn dแปc */
ย ย flex: 1;ย ย ย ย ย ย ย ย ย/* Tแปฑ chiแบฟm khoแบฃng trแปng cรฒn lแบกi */
ย ย margin: 10px 0;
ย ย border: 1px solid #444;
ย ย border-radius: 5px;
ย ย padding: 5px;
ย ย background: rgba(0,0,0,0.2);
ย ย min-height: 150px;ย ย ย ย/* Chiแปu cao tแปi thiแปu */
}
ย ย ย ย #feedback-modal {
ย ย position: fixed;
ย ย top: 0; left: 0; width: 100%; height: 100%;
ย ย background: rgba(0, 0, 0, 0.85);
ย ย backdrop-filter: blur(5px);
ย ย z-index: 9999;
ย ย display: none;
ย ย justify-content: center;
ย ย align-items: center;
ย ย flex-direction: column;
}
ย ย ย ย @keyframes fadeIn {
ย ย from { opacity: 0; transform: translateY(-10px); }
ย ย to { opacity: 1; transform: translateY(0); }
}
ย ย ย ย /* --- CSS CHO VISUAL POKEDEX --- */
.dex-grid {
ย ย display: grid;
ย ย grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
ย ย gap: 10px;
ย ย width: 100%;
ย ย padding: 10px;
ย ย overflow-y: auto;
ย ย max-height: 60vh;
}

.dex-card {
ย ย background: rgba(0, 0, 0, 0.3);
ย ย border: 1px solid #444;
ย ย border-radius: 5px;
ย ย padding: 5px;
ย ย display: flex;
ย ย flex-direction: column;
ย ย align-items: center;
ย ย position: relative;
ย ย cursor: pointer;
ย ย transition: 0.2s;
}

.dex-card:hover {
ย ย background: rgba(255, 255, 255, 0.1);
ย ย border-color: #3498db;
}

.dex-card.owned {
ย ย border-color: #f1c40f; /* Viแปn vรng cho con ฤรฃ bแบฏt */
ย ย background: rgba(241, 196, 15, 0.1);
}

.dex-img {
ย ย width: 60px;
ย ย height: 60px;
ย ย image-rendering: pixelated;
ย ย filter: brightness(0); /* Mแบทc ฤแปnh ฤen thui (chฦฐa bแบฏt) */
ย ย opacity: 0.5;
ย ย transition: 0.3s;
}

.dex-card.owned .dex-img {
ย ย filter: brightness(1); /* Sรกng lรชn nแบฟu ฤรฃ bแบฏt */
ย ย opacity: 1;
}

.dex-id {
ย ย font-size: 0.7em;
ย ย color: #777;
ย ย position: absolute;
ย ย top: 2px;
ย ย left: 4px;
}
ย ย ย ย /* --- CSS SแปฌA LแปI MENU VรNG (REGION BAR) --- */
.region-bar {
ย ย display: flex;ย
ย ย gap: 8px;ย
ย ย overflow-x: auto;ย
ย ย width: 100%;ย
ย ย padding: 10px 5px;ย
ย ย margin-bottom: 10px;
ย ย background: rgba(0,0,0,0.2); /* Nแปn tแปi nhแบน ฤแป phรขn biแปt */
ย ย border-radius: 5px;
ย ย border-bottom: 1px solid #444;
ย ย flex-shrink: 0; /* KHรNG ฤฦฏแปขC CO LแบI */
ย ย min-height: 50px; /* ฤแบฃm bแบฃo chiแปu cao tแปi thiแปu */
ย ย align-items: center;
}

/* Kiแปu dรกng cho nรบt bแบฅm vรนng */
.btn-region {
ย ย flex: 0 0 auto; /* Quan trแปng: Giแปฏ nguyรชn kรญch thฦฐแปc, khรดng bแป bรณp mรฉo */
ย ย padding: 6px 12px;
ย ย border: 1px solid #555;
ย ย border-radius: 4px;
ย ย background: #2f3136;
ย ย color: #bbb;
ย ย font-size: 0.8em;
ย ย cursor: pointer;
ย ย transition: 0.2s;
ย ย white-space: nowrap; /* Khรดng xuแปng dรฒng chแปฏ */
}

.btn-region.active {
ย ย background: #f1c40f;
ย ย color: black;
ย ย border-color: #f1c40f;
ย ย font-weight: bold;
ย ย box-shadow: 0 0 5px rgba(241, 196, 15, 0.5);
}

/* Tรนy chแปnh thanh cuแปn cho ฤแบนp */
.region-bar::-webkit-scrollbar {
ย ย height: 4px;
}
.region-bar::-webkit-scrollbar-thumb {
ย ย background: #555;
ย ย border-radius: 2px;
}
ย ย ย ย /* --- CSS CHO QUIZ COMBO --- */
.combo-text {
ย ย font-size: 1.2em;
ย ย font-weight: bold;
ย ย color: #f1c40f;
ย ย animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
ย ย margin-bottom: 5px;
ย ย text-shadow: 0 0 5px rgba(0,0,0,0.5);
}

@keyframes popIn {
ย ย 0% { transform: scale(0); opacity: 0; }
ย ย 80% { transform: scale(1.2); opacity: 1; }
ย ย 100% { transform: scale(1); opacity: 1; }
}

.quiz-reward-item {
ย ย background: rgba(46, 204, 113, 0.2);
ย ย border: 1px solid #2ecc71;
ย ย color: #2ecc71;
ย ย padding: 5px;
ย ย border-radius: 5px;
ย ย margin-top: 5px;
ย ย font-size: 0.9em;
}
ย ย ย ย /* --- CSS CHO SHOP TABS --- */
.shop-tabs {
ย ย display: flex;
ย ย width: 100%;
ย ย margin-bottom: 10px;
ย ย border-bottom: 1px solid #444;
}
.shop-tab-btn {
ย ย flex: 1;
ย ย padding: 10px;
ย ย background: #2f3136;
ย ย color: #bbb;
ย ย border: none;
ย ย cursor: pointer;
ย ย font-weight: bold;
ย ย transition: 0.2s;
}
.shop-tab-btn.active {
ย ย background: #faa61a; /* Mรu cam cแปงa Shop */
ย ย color: black;
ย ย box-shadow: 0 0 10px rgba(250, 166, 26, 0.4);
}
ย ย ย ย /* --- HIแปU แปจNG LแบฎC BรNG CHUYรN NGHIแปP --- */
@keyframes shake-ball {
ย ย 0% { transform: translate(0, 0) rotate(0); }
ย ย 20% { transform: translate(-10px, 0) rotate(-20deg); }
ย ย 30% { transform: translate(-10px, 0) rotate(-20deg); } /* Khแปฑng lแบกi 1 nhแปp */
ย ย 50% { transform: translate(0, 0) rotate(0); }
ย ย 70% { transform: translate(10px, 0) rotate(20deg); }
ย ย 80% { transform: translate(10px, 0) rotate(20deg); } /* Khแปฑng lแบกi 1 nhแปp */
ย ย 100% { transform: translate(0, 0) rotate(0); }
}

/* Class nรy sแบฝ ฤฦฐแปฃc JS gรกn vรo quแบฃ bรณng khi lแบฏc */
.shaking {
ย ย animation: shake-ball 0.5s ease-in-out;
}

/* Hiแปu แปฉng khi bแบฏt trรบng (Sรกng lรชn) */
@keyframes catch-success {
ย ย 0% { filter: brightness(1); transform: scale(1); }
ย ย 50% { filter: brightness(2) drop-shadow(0 0 10px gold); transform: scale(1.2); }
ย ย 100% { filter: brightness(1); transform: scale(1); }
}

.caught-anim {
ย ย animation: catch-success 0.5s ease-out;
}
ย ย ย ย /* --- CSS CHO CHแบพ ฤแป CHแปN NHIแปU (BULK SELECT) --- */
.bag-row.selected {
ย ย border: 2px solid #f1c40f;
ย ย background: rgba(241, 196, 15, 0.1);
}

.select-checkbox {
ย ย width: 20px;ย
ย ย height: 20px;ย
ย ย cursor: pointer;
ย ย accent-color: #f1c40f; /* Mรu checkbox vรng */
}

/* Thanh hรnh ฤแปng dรญnh แป dฦฐแปi khi chแปn nhiแปu */
.bulk-action-bar {
ย ย display: flex;
ย ย justify-content: space-between;
ย ย align-items: center;
ย ย background: #202225;
ย ย padding: 10px;
ย ย border-top: 1px solid #444;
ย ย margin-top: 10px;
ย ย border-radius: 0 0 5px 5px;
}
ย ย ย ย /* --- WORLD BOSS CSS --- */
.boss-container {
ย ย text-align: center;
ย ย background: radial-gradient(circle, #4a1414 0%, #000 100%); /* Nแปn ฤแป ฤen nguy hiแปm */
ย ย padding: 20px;
ย ย border-radius: 10px;
ย ย border: 2px solid #ed4245;
ย ย margin-bottom: 10px;
ย ย position: relative;
ย ยย
}

.boss-sprite {
ย ย width: 150px;
ย ย height: 150px;
ย ย filter: drop-shadow(0 0 10px red);
ย ย animation: boss-float 3s ease-in-out infinite;
}

@keyframes boss-float {
ย ย 0%, 100% { transform: translateY(0) scale(1); }
ย ย 50% { transform: translateY(-10px) scale(1.05); }
}

.boss-hp-bar {
ย ย width: 100%;
ย ย height: 20px;
ย ย background: #333;
ย ย border: 2px solid #fff;
ย ย border-radius: 10px;
ย ย margin-top: 10px;
ย ย position: relative;
ย ย overflow: hidden;
}

.boss-hp-fill {
ย ย height: 100%;
ย ย background: linear-gradient(90deg, #e74c3c, #c0392b);
ย ย width: 100%;
ย ย transition: width 0.5s;
}

.dps-rank-row {
ย ย display: flex;
ย ย justify-content: space-between;
ย ย padding: 5px 10px;
ย ย background: rgba(255,255,255,0.05);
ย ย margin-bottom: 2px;
ย ย font-size: 0.9em;
}
ย ย ย ย /* --- BOSS TEAM & STAMINA --- */
.stamina-bar-container {
ย ย width: 100%;
ย ย background: #333;
ย ย height: 12px;
ย ย border-radius: 6px;
ย ย border: 1px solid #555;
ย ย position: relative;
ย ย margin: 5px 0 15px 0;
}
.stamina-fill {
ย ย height: 100%;
ย ย background: #3498db; /* Mรu xanh nฤng lฦฐแปฃng */
ย ย width: 100%;
ย ย border-radius: 5px;
ย ย transition: width 0.5s;
}
.stamina-text {
ย ย position: absolute;
ย ย top: -2px;
ย ย left: 0;
ย ย width: 100%;
ย ย text-align: center;
ย ย font-size: 0.7em;
ย ย font-weight: bold;
ย ย color: white;
ย ย text-shadow: 0 0 3px black;
}

/* Lฦฐแปi chแปn team */
.team-grid {
ย ย display: grid;
ย ย grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
ย ย gap: 8px;
ย ย max-height: 300px;
ย ย overflow-y: auto;
}
.team-card {
ย ย background: #2f3136;
ย ย border: 2px solid #444;
ย ย border-radius: 5px;
ย ย padding: 5px;
ย ย text-align: center;
ย ย cursor: pointer;
ย ย position: relative;
}
.team-card.selected {
ย ย border-color: #f1c40f;
ย ย background: rgba(241, 196, 15, 0.2);
}
.team-card img {
ย ย width: 50px;
ย ย height: 50px;
}
.team-slot-indicator {
ย ย position: absolute;
ย ย top: 2px;
ย ย right: 2px;
ย ย background: #f1c40f;
ย ย color: black;
ย ย font-size: 0.7em;
ย ย width: 16px;
ย ย height: 16px;
ย ย border-radius: 50%;
ย ย font-weight: bold;
ย ย display: none; /* แบจn mแบทc ฤแปnh */
}
.team-card.selected .team-slot-indicator {
ย ย display: block; /* Hiแปn khi chแปn */
}
ย ย ย ย /* --- HIแปU แปจNG SรT THฦฏฦNG (DAMAGE POPUP) --- */
@keyframes floatUp {
ย ย 0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
ย ย 20% { transform: translate(-50%, -100%) scale(1.2); opacity: 1; }
ย ย 100% { transform: translate(-50%, -250%) scale(1); opacity: 0; }
}

.damage-popup {
ย ย position: absolute;
ย ย left: 50%;
ย ย top: 40%; /* Xuแบฅt hiแปn tแปซ giแปฏa Boss */
ย ย color: white;
ย ย font-weight: 900;
ย ย font-size: 24px;
ย ย text-shadow: 2px 2px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000;
ย ย pointer-events: none; /* ฤแป chuแปt click xuyรชn qua ฤฦฐแปฃc */
ย ย animation: floatUp 1s ease-out forwards;
ย ย z-index: 9999;
ย ย font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.damage-popup.crit {
ย ย color: #f1c40f; /* Mรu vรng */
ย ย font-size: 36px; /* To hฦกn */
ย ย text-shadow: 0 0 10px red; /* Viแปn phรกt sรกng ฤแป */
}
ย ย ย ย /* --- CHAT CSS --- */
.chat-msg {
ย ย padding: 3px 5px;
ย ย margin-bottom: 3px;
ย ย border-radius: 4px;
ย ย background: rgba(0,0,0,0.3);
ย ย word-wrap: break-word;
}
.chat-name { font-weight: bold; margin-right: 5px; cursor:pointer; }
.role-admin { color: #e74c3c; }
.role-vip { color: #f1c40f; }
.role-user { color: #3ba55c; }

/* --- MARKET CSS --- */
.market-item {
ย ย background: #2f3136;
ย ย border: 1px solid #444;
ย ย border-radius: 5px;
ย ย padding: 10px;
ย ย display: flex;
ย ย flex-direction: column;
ย ย align-items: center;
ย ย position: relative;
}
.market-price {
ย ย background: rgba(0,0,0,0.5);
ย ย padding: 2px 5px;
ย ย border-radius: 3px;
ย ย color: #f1c40f;
ย ย font-weight: bold;
ย ย margin-top: 5px;
ย ย font-size: 0.9em;
}
.seller-name {
ย ย position: absolute;
ย ย top: 5px;
ย ย left: 5px;
ย ย font-size: 0.6em;
ย ย color: #bbb;
ย ย background: rgba(0,0,0,0.5);
ย ย padding: 1px 3px;
ย ย border-radius: 3px;
}
ย ย ย ย /* --- GIAO DIแปN MENU TAB MแปI --- */
#menu-container {
ย ย display: flex;
ย ย flex-direction: column;
ย ย height: 100%;
ย ย gap: 5px;
}

/* Lฦฐแปi chแปฉa cรกc nรบt chแปฉc nฤng */
#menu-grid {
ย ย display: grid;
ย ย grid-template-columns: repeat(3, 1fr); /* 3 cแปt */
ย ย gap: 8px;
ย ย padding: 5px;
ย ย overflow-y: auto;
ย ย max-height: 200px; /* Giแปi hแบกn chiแปu cao */
}

/* Thanh Tab chuyแปn ฤแปi nhรณm */
.menu-tabs {
ย ย display: flex;
ย ย background: #202225;
ย ย border-radius: 5px;
ย ย overflow: hidden;
ย ย margin-top: auto; /* ฤแบฉy xuแปng ฤรกy */
}

.menu-tab-btn {
ย ย flex: 1;
ย ย padding: 10px 5px;
ย ย background: transparent;
ย ย border: none;
ย ย color: #72767d;
ย ย cursor: pointer;
ย ย font-weight: bold;
ย ย font-size: 0.9em;
ย ย border-top: 2px solid transparent;
ย ย transition: 0.2s;
ย ย display: flex;
ย ย flex-direction: column;
ย ย align-items: center;
ย ย gap: 3px;
}

.menu-tab-btn:hover { background: rgba(255,255,255,0.05); }

/* Mรu sแบฏc cho tแปซng Tab khi Active */
.menu-tab-btn.active.tab-battle { border-color: #ed4245; color: #ed4245; background: rgba(237, 66, 69, 0.1); }
.menu-tab-btn.active.tab-city { border-color: #3498db; color: #3498db; background: rgba(52, 152, 219, 0.1); }
.menu-tab-btn.active.tab-user { border-color: #f1c40f; color: #f1c40f; background: rgba(241, 196, 15, 0.1); }
.menu-tab-btn.active.tab-social { border-color: #9b59b6; color: #9b59b6; background: rgba(155, 89, 182, 0.1); }

/* Style lแบกi nรบt bแบฅm cho gแปn */
.menu-btn {
ย ย background: #2f3136;
ย ย color: white;
ย ย border: 1px solid #444;
ย ย border-radius: 5px;
ย ย padding: 12px 5px;
ย ย font-size: 0.85em;
ย ย cursor: pointer;
ย ย display: flex;
ย ย flex-direction: column;
ย ย align-items: center;
ย ย justify-content: center;
ย ย gap: 5px;
ย ย transition: transform 0.1s;
}
.menu-btn:active { transform: scale(0.95); }
.menu-btn i { font-size: 1.2em; margin-bottom: 2px; } /* Icon */
ย ย ย ย /* --- CSS CHO NรT BแบฎT POKEMON NแบฐM NGANG --- */
.hunt-controls-bar {
ย ย display: flex;
ย ย flex-direction: row; /* Xแบฟp ngang */
ย ย justify-content: center;
ย ย align-items: stretch;
ย ย gap: 5px;
ย ย width: 100%;
ย ย padding: 5px 0;
ย ย overflow-x: auto; /* Cho phรฉp trฦฐแปฃt ngang nแบฟu mรn hรฌnh quรก bรฉ */
}

/* Chแปnh lแบกi nรบt ball cho gแปn */
.ball-btn-horizontal {
ย ย flex: 1; /* Chia ฤแปu chiแปu rแปng */
ย ย min-width: 50px; /* Chiแปu rแปng tแปi thiแปu */
ย ย background: #2f3136;
ย ย border: 1px solid #444;
ย ย border-radius: 5px;
ย ย padding: 5px 2px;
ย ย cursor: pointer;
ย ย display: flex;
ย ย flex-direction: column;
ย ย align-items: center;
ย ย justify-content: center;
ย ย transition: 0.1s;
}

.ball-btn-horizontal:active { transform: scale(0.95); }
.ball-btn-horizontal.disabled { opacity: 0.4; pointer-events: none; filter: grayscale(1); }
.ball-btn-horizontal img { width: 28px; height: 28px; object-fit: contain; margin-bottom: 2px; }
.ball-btn-horizontal span { font-size: 0.75em; font-weight: bold; color: white; }
ย ย ย ย /* --- SแปฌA LแปI BรNG Bแป MรO --- */

/* 1. ฤแปnh dแบกng lแบกi hรฌnh แบฃnh quแบฃ bรณng */
#battle-middle-area img[src*="ball"] {
ย ย /* รp buแปc hรฌnh vuรดng */
ย ย width: 80px !important;ย /* Bแบกn cรณ thแป chแปnh sแป nรy to nhแป tรนy รฝ */
ย ย height: 80px !important; /* BแบฎT BUแปC PHแบขI BแบฐNG width */
ย ยย
ย ย /* Quan trแปng: Giแปฏ nguyรชn tแปท lแป แบฃnh gแปc, khรดng cho phรฉp bแป kรฉo dรฃn */
ย ย object-fit: contain;ย
ย ยย
ย ย /* Cฤn giแปฏa */
ย ย display: block;
ย ย margin: 10px auto;
ย ยย
ย ย /* ฤแบทt ฤiแปm neo xoay xuแปng ฤรกy quแบฃ bรณng ฤแป lแบฏc thแบญt hฦกn */
ย ย transform-origin: bottom center;
}
ย ย ย ย /* --- BIแบพN THแป ฤแบถC BIแปT (VISUAL VARIANTS) --- */

/* 1. Shadow: ฤen trแบฏng + Hรo quang tรญm + Tฦฐฦกng phแบฃn cao */
.variant-shadow {
ย ย filter: grayscale(1) contrast(1.3) drop-shadow(0 0 6px #9b59b6) !important;
}

/* 2. Rainbow: ฤแปi mรu liรชn tแปฅc + Phรกt sรกng vรng */
@keyframes rainbow-shift {
ย ย 0% { filter: hue-rotate(0deg) drop-shadow(0 0 3px gold); }
ย ย 50% { filter: hue-rotate(180deg) drop-shadow(0 0 8px cyan); }
ย ย 100% { filter: hue-rotate(360deg) drop-shadow(0 0 3px gold); }
}

.variant-rainbow {
ย ย animation: rainbow-shift 2s linear infinite !important;
}

/* Thรชm tag hiแปn thแป tรชn cho ngแบงu */
.tag-shadow { background: #2c3e50; color: #a29bfe; border: 1px solid #9b59b6; }
.tag-rainbow { background: linear-gradient(90deg, red, orange, yellow, green, blue, indigo, violet); color: black; font-weight:bold; animation: pulse 1s infinite; }
ย ย ย ย /* CSS CHO MAP CARD */
.map-card {
ย ย background: #2f3136;
ย ย border: 1px solid #444;
ย ย border-radius: 5px;
ย ย padding: 10px;
ย ย cursor: pointer;
ย ย position: relative;
ย ย overflow: hidden;
ย ย transition: 0.2s;
ย ย text-align: center;
}
.map-card:hover { transform: translateY(-2px); border-color: #0984e3; }
.map-card.active { border: 2px solid #2ecc71; background: rgba(46, 204, 113, 0.1); }
.map-card.locked { opacity: 0.6; cursor: not-allowed; filter: grayscale(1); }
.map-icon { font-size: 2em; margin-bottom: 5px; display: block; }
.map-req { font-size: 0.7em; color: #ed4245; font-weight: bold; }
ย ย ย ย /* --- SแปฌA LแปI KHOแบขNG CรCH MENU & FOOTER TRรN ฤIแปN THOแบI --- */

/* 1. Xรณa khoแบฃng ฤแปm thแปซa แป dฦฐแปi nรบt ฤiแปu khiแปn */
#controls {
ย ย padding-bottom: 0 !important; /* Code cลฉ lร 20px -> Xรณa vแป 0 */
}

/* 2. Lรm gแปn thanh Footer lแบกi */
.footer {
ย ย padding: 5px 10px !important; /* Thu nhแป ฤแปm trรชn dฦฐแปi */
ย ย font-size: 0.7em !important;ย /* Chแปฏ nhแป lแบกi xรญu cho tinh tแบฟ */
ย ย background: #111 !important;ย /* ฤแบฃm bแบฃo nแปn ฤen ฤแปng bแป */
ย ย border-top: 1px solid #333;ย ย/* Kแบป vแบกch mแป ngฤn cรกch */
}

/* 3. Dรญnh chแบทt thanh Tab vรo Footer */
.menu-tabs {
ย ย margin-bottom: 0 !important; /* Khรดng cho ฤแบฉy xuแปng */
ย ย border-bottom: none !important; /* Xรณa viแปn dฦฐแปi nแบฟu cรณ */
ย ย background: #18191c !important;
}
ย ย ย ย /* Style cho nรบt chแปn quรชn chiรชu */
.move-select-btn {
ย ย display: flex;ย
ย ย justify-content: space-between;ย
ย ย align-items: center;
ย ย background: #2f3136;ย
ย ย border: 1px solid #555;ย
ย ย padding: 10px;ย
ย ย border-radius: 5px;ย
ย ย color: white;ย
ย ย cursor: pointer;
ย ย transition: 0.2s;
ย ย text-align: left;
}
.move-select-btn:hover {
ย ย background: #40444b;
ย ย border-color: #f1c40f;
}
.move-select-btn .m-name { font-weight: bold; }
.move-select-btn .m-info { font-size: 0.8em; color: #aaa; }
ย ย ย ย /* Style cho Item chiรชu thแปฉc */
.move-item {
ย ย background: #2f3136;
ย ย border: 1px solid #444;
ย ย padding: 8px;
ย ย border-radius: 4px;
ย ย cursor: pointer;
ย ย transition: 0.2s;
ย ย display: flex;
ย ย justify-content: space-between;
ย ย align-items: center;
}
.move-item:hover {
ย ย background: #40444b;
ย ย border-color: white;
}
/* Hiแปu แปฉng khi ฤang chแปn chiรชu ฤแป hแปc */
.move-item.selected-learn {
ย ย border-color: #2ecc71;
ย ย background: rgba(46, 204, 113, 0.2);
ย ย animation: pulse 1s infinite;
}
/* Tag hiแปn thแป hแป */
.type-tag {
ย ย font-size: 0.7em;
ย ย padding: 2px 5px;
ย ย border-radius: 3px;
ย ย font-weight: bold;
ย ย color: black;
ย ย text-transform: uppercase;
}
ย ย </style>
</head>
<body>
ย ย <div id="move-manager-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:9999; justify-content:center; align-items:center;">
ย ย <div class="box-style" style="width:95%; max-width:700px; height:80vh; border-color:#9b59b6; display:flex; flex-direction:column;">
ย ย ย ยย
ย ย ย ย <div style="display:flex; align-items:center; gap:10px; border-bottom:1px solid #555; padding-bottom:10px; margin-bottom:10px">
ย ย ย ย ย ย <img id="mm-poke-img" src="" width="60">
ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย <h3 id="mm-poke-name" style="margin:0; color:#f1c40f">POKEMON</h3>
ย ย ย ย ย ย ย ย <div style="font-size:0.8em; color:#bbb">Quแบฃn Lรฝ & Hแปi Tฦฐแปng Chiรชu Thแปฉc</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <button class="btn-close" style="margin-left:auto; width:auto" onclick="closeMoveManager()">ฤรณng</button>
ย ย ย ย </div>

ย ย ย ย <div style="display:flex; flex:1; gap:10px; overflow:hidden;">
ย ย ย ย ย ยย
ย ย ย ย ย ย <div style="width:40%; background:rgba(0,0,0,0.3); border:1px solid #3498db; border-radius:5px; padding:5px; display:flex; flex-direction:column;">
ย ย ย ย ย ย ย ย <div style="text-align:center; color:#3498db; font-weight:bold; margin-bottom:5px">ฤANG Sแปฌ DแปคNG (4/4)</div>
ย ย ย ย ย ย ย ย <div id="mm-current-list" style="flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:5px;">
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div style="width:60%; background:rgba(0,0,0,0.3); border:1px solid #9b59b6; border-radius:5px; padding:5px; display:flex; flex-direction:column;">
ย ย ย ย ย ย ย ย <div style="text-align:center; color:#9b59b6; font-weight:bold; margin-bottom:5px">KHO TรNG Kร แปจC (Cรณ thแป hแปc)</div>
ย ย ย ย ย ย ย ย <div id="mm-pool-list" style="flex:1; overflow-y:auto; display:flex; flex-direction:column; gap:5px;">
ย ย ย ย ย ย ย ย ย ย <div style="text-align:center; color:yellow; margin-top:20px">โณ ฤang tแบฃi dแปฏ liแปu Move Pool...</div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>

ย ย ย ย </div>
ย ย ย ยย
ย ย ย ย <div style="margin-top:10px; font-size:0.9em; color:#bbb; text-align:center">
ย ย ย ย ย ย <i>*Bแบฅm vรo chiรชu bรชn phแบฃi ฤแป hแปc, sau ฤรณ chแปn chiรชu bรชn trรกi ฤแป quรชn.*</i>
ย ย ย ย </div>
ย ย </div>
</div>
ย ย <div id="learn-move-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:9999; justify-content:center; align-items:center; flex-direction:column;">
ย ยย
ย ย <div style="color:white; margin-bottom:10px; font-size:1.2em; text-align:center">
ย ย ย ย <b id="learner-name" style="color:#f1c40f">POKEMON</b> muแปn hแปc chiรชu mแปi!<br>
ย ย ย ย Nhฦฐng giแปi hแบกn lร 4 chiรชu.
ย ย </div>

ย ย <div style="display:flex; gap:10px; width:100%; max-width:600px; justify-content:center; align-items:stretch;">
ย ย ย ยย
ย ย ย ย <div style="width:40%; background:#2c3e50; border:2px solid #3498db; border-radius:10px; padding:15px; display:flex; flex-direction:column; justify-content:center; align-items:center;">
ย ย ย ย ย ย <div style="color:#bbb; font-size:0.8em; margin-bottom:5px">CHIรU MแปI</div>
ย ย ย ย ย ย <div id="new-move-name" style="font-size:1.3em; font-weight:bold; color:#3498db; margin-bottom:10px">TACKLE</div>
ย ย ย ย ย ยย
ย ย ย ย ย ย <div style="width:100%; text-align:left; font-size:0.9em; color:#ddd; border-top:1px solid #555; padding-top:10px;">
ย ย ย ย ย ย ย ย <div>Hแป: <span id="new-move-type" style="font-weight:bold">NORMAL</span></div>
ย ย ย ย ย ย ย ย <div>Sแปฉc mแบกnh: <span id="new-move-pwr" style="color:#e74c3c">40</span></div>
ย ย ย ย ย ย ย ย <div>Chรญnh xรกc: <span id="new-move-acc">100</span>%</div>
ย ย ย ย ย ย ย ย <div style="margin-top:5px; font-style:italic; font-size:0.8em; color:#aaa" id="new-move-desc">
ย ย ย ย ย ย ย ย ย ย Gรขy sรกt thฦฐฦกng thฦฐแปng.
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <button class="btn-auth" style="background:#ed4245; margin-top:20px;" onclick="giveUpMove()">
ย ย ย ย ย ย ย ย โ Bแป QUA
ย ย ย ย ย ย </button>
ย ย ย ย </div>

ย ย ย ย <div style="width:60%; background:#222; border:2px solid #555; border-radius:10px; padding:10px;">
ย ย ย ย ย ย <div style="color:#bbb; font-size:0.8em; margin-bottom:5px; text-align:center">CHแปN CHIรU ฤแป QUรN:</div>
ย ย ย ย ย ย <div id="old-moves-list" style="display:flex; flex-direction:column; gap:5px;">
ย ย ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย </div>
</div>
ย ย </div>
ย ย <div id="login-screen">
ย ย ย ย <div class="box-style">
ย ย ย ย ย ย <img src="https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/master-ball.png" width="80" style="margin:0 auto">
ย ย ย ย ย ย <h2 style="color: white; margin: 10px 0;">POKESTAY v2.5.0</h2>
ย ย ย ย ย ย <div style="color: #b9bbbe; font-size: 0.9em; margin-bottom: 15px;"> REAWAKENED POWER</div>
ย ย ย ย ย ย <div style="width:100%">
ย ย ย ย ย ย ย ย <input type="text" id="username-input" class="login-input" placeholder="Tรชn ฤฤng nhแบญp..." onkeypress="handleEnter(event)">
ย ย ย ย ย ย ย ย <input type="password" id="password-input" class="login-input" placeholder="Mแบญt khแบฉu..." onkeypress="handleEnter(event)">
ย ย ย ย ย ย ย ย <button class="btn-auth btn-login" onclick="login()">ฤฤNG NHแบฌP</button>
ย ย ย ย ย ย ย ย <button class="btn-auth btn-register" onclick="register()">ฤฤNG Kร</button>
ย ย ย ย ย ย ย ย <div style="font-size:0.8em; color:#777; margin-top:20px; max-width:600px">
ย ย ย ย ย ย ย ย ย ย Chรo mแปซng ฤแบฟn vแปi <b>PokeStay</b> - Webgame Pokemon nhแบญp vai trแปฑc tuyแบฟn.ย
ย ย ย ย ย ย ย ย ย ย Trแบฃi nghiแปm phiรชn bแบฃn mแปi nhแบฅt <b>v2.4.2 Shadow & Light</b> vแปi tรญnh nฤng Chแปฃ ฤen vร Thรกp Vรด Tแบญn.
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย </div>
ย ยย
ย ย <div id="app">
ย ย ย ย <header>
ย ย <div style="display:flex; flex-direction:column; width:100%; padding-bottom:5px">
ย ย ย ยย
ย ย ย ย <div style="display:flex; justify-content:space-between; align-items:center">
ย ย ย ย ย ยย
ย ย ย ย ย ย <div style="display:flex; align-items:center; gap:5px">
ย ย ย ย ย ย ย ย <div style="display:flex; align-items:center; background:rgba(0,0,0,0.3); padding:2px 8px; border-radius:15px; border:1px solid #444; margin-right:5px; cursor:pointer" onclick="openMap()">
ย ย ย ย ย ย ย ย ย ย <span style="font-size:1.4em; margin-right:5px">๐บ๏ธ</span>
ย ย ย ย ย ย ย ย ย ย <div style="display:flex; flex-direction:column; line-height:1">
ย ย ย ย ย ย ย ย ย ย ย ย <span style="font-size:0.6em; color:#bbb; text-transform:uppercase">LOCATION</span>
ย ย ย ย ย ย ย ย ย ย ย ย <span id="zone-display-name" style="font-size:0.8em; font-weight:bold; color:#0984e3">Vรนng ฤแบฅt</span>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <div style="font-weight:bold; font-size:0.9em" id="display-username">TRAINER</div>
ย ย ย ย ย ย ย ย ย ย <div style="font-size:0.7em; color:#f1c40f" id="rank-title">Tแบญp sแปฑ</div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ยย
ย ย ย ย ย ย <div style="text-align:right">
ย ย ย ย ย ย ย ย <div style="font-weight:bold; color:#f1c40f"><span id="coin-display">0</span> ๐ฐ</div>
ย ย ย ย ย ย ย ย <div style="font-size:0.8em; color:#3ba55c">Lv.<span id="trainer-level">1</span></div>
ย ย ย ย ย ย ย ย <div id="online-box" style="font-size:0.7em; color:#00b0f4; margin-top:2px; font-weight:bold">
ย ย ย ย ย ย ย ย ย ย ๐ข Online: <span id="online-count">1</span>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>

ย ย ย ย <div style="width:100%; height:4px; background:#444; margin-top:5px; border-radius:2px; position:relative">
ย ย ย ย ย ย <div id="trainer-xp-bar" style="width:0%; height:100%; background:#0984e3; transition:width 0.5s"></div>
ย ย ย ย </div>
ย ย </div>
</header>
ย ย ย ย <div id="badge-bar" style="display:none; gap:5px; justify-content:center; background:rgba(0,0,0,0.2); padding:5px;"></div>
ย ย ย ย <div id="buff-bar" style="padding: 5px 15px; font-size: 0.75em; display: flex; gap: 10px; background: rgba(0,0,0,0.3); min-height: 20px;"></div>
ย ย ย ยย
ย ย ย ย <div id="chat-area"></div>
ย ย ย ยย
ย ย ย ย <div id="controls"></div>
ย ย ย ยย
ย ย ย ย <div class="footer">
ย ย <div style="display:flex; gap:10px">
ย ย ย ย <span class="footer-link" onclick="logout()" style="cursor:pointer; color:#ed4245">[Thoรกt]</span>ย
ย ย ย ย <span class="footer-link" onclick="resetGame()" style="cursor:pointer; color:#777">[Xรณa]</span>
ย ย </div>

ย ย <div style="display:flex; gap:15px">
ย ย ย ย <span class="footer-link" onclick="openFeedback()" style="cursor:pointer; color:#3498db; font-weight:bold">๐ฉ Gรณp รฝ</span>
ย ย ย ย <span class="footer-link donate-btn-text" onclick="showDonate()">๐ แปฆng hแป</span>
ย ย </div>
</div>
ย ย </div>

ย ย <div id="shop-modal"><div class="box-style" style="width:95%; max-width:500px"><h2 style="color: #faa61a; margin: 0 0 10px 0;">๐ Poke Mart</h2><div style="text-align:right; width:100%; margin-bottom:5px">Sแป dฦฐ: <span id="shop-coin-display" style="color:#f1c40f; font-weight:bold">0</span>๐ฐ</div><div id="shop-list" class="shop-grid" style="overflow-y:auto; max-height:60vh"></div><button class="btn-close" onclick="closeShop()">ฤรณng</button></div></div>
ย ยย
ย ย <div id="buy-modal"><div class="box-style"><div class="inner-box"><h3 style="color: #faa61a; margin: 5px 0;" id="buy-name">Item</h3><img id="buy-img" src="" width="60" style="margin: 10px auto; display:block"><div style="margin-bottom: 10px; color:#bbb">Giรก: <span id="buy-price" style="color:white; font-weight:bold">0</span>๐ฐ</div><div style="display:flex; justify-content:center; align-items:center; gap:10px; margin: 10px 0;"><input type="number" id="buy-qty" class="login-input" style="width:60px; margin:0" value="1" min="1" oninput="calcTotal()"></div><div style="font-size: 1.1em; margin-bottom: 15px;">Tแปng: <span id="buy-total" style="color:#3ba55c; font-weight:bold">0</span>๐ฐ</div><div style="display:flex; gap:10px; width:100%"><button class="btn-auth" style="background:#7f8c8d; margin:0" onclick="closeBuy()">HแปฆY</button><button class="btn-auth btn-login" style="margin:0" onclick="submitBuy()">MUA</button></div></div></div></div>
ย ยย
ย ย <div id="job-modal">
ย ย <div class="box-style">
ย ย ย ย <h2 style="color: #7289da; margin: 0 0 15px 0;">๐ผ Job Center</h2>
ย ย ย ยย
ย ย ย ย <div id="job-menu" style="width:100%">
ย ย ย ย ย ยย
ย ย ย ย ย ย <button id="btn-mining" class="btn-auth" style="background:#40444b; text-align:left; display:flex; align-items:center; gap:10px; margin-bottom:8px" onclick="startMining()">
ย ย ย ย ย ย ย ย <span style="font-size:1.5em">โ๏ธ</span>ย
ย ย ย ย ย ย ย ย <div style="flex:1">
ย ย ย ย ย ย ย ย ย ย <div style="display:flex; justify-content:space-between">
ย ย ย ย ย ย ย ย ย ย ย ย <span>ฤรo Mแป (Mining)</span>
ย ย ย ย ย ย ย ย ย ย ย ย <span id="durability-text" style="font-size:0.8em; color:#bbb">30/30</span>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div style="width:100%;height:6px;background:#202225;border-radius:3px;overflow:hidden;margin-top:5px">
ย ย ย ย ย ย ย ย ย ย ย ย <div id="durability-bar-fill" style="height:100%;background:#3ba55c;width:100%;transition:width 0.2s"></div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </button>

ย ย ย ย ย ย <button id="btn-repair" class="btn-auth" style="background:#e74c3c; display:none; animation:pulse 1s infinite; margin-bottom:8px" onclick="openRepairModal()">
ย ย ย ย ย ย ย ย ๐ง CรP GรY! Sแปญa ngay (500๐ฐ)
ย ย ย ย ย ย </button>

ย ย ย ย ย ย <button class="btn-auth" style="background:#40444b; display:flex; align-items:center; gap:10px" onclick="startQuiz()">
ย ย ย ย ย ย ย ย <span style="font-size:1.5em">๐</span>
ย ย ย ย ย ย ย ย <div style="text-align:left; flex:1">
ย ย ย ย ย ย ย ย ย ย <div>Giรกo Sฦฐ Oak's Quiz</div>
ย ย ย ย ย ย ย ย ย ย <div style="font-size:0.75em; color:#bbb">Trแบฃ lแปi ฤรบng liรชn tiแบฟp nhแบญn quร!</div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </button>

ย ย ย ย ย ย <div id="emergency-aid" style="margin-top:15px; border-top:1px solid #555; padding-top:10px; display:none;">
ย ย ย ย ย ย ย ย <button class="btn-auth" style="background:#ed4245" onclick="claimEmergency()">๐ Trแปฃ cแบฅp khแบฉn cแบฅp</button>
ย ย ย ย ย ย ย ย <div style="font-size:0.7em; color:#bbb; margin-top:2px; text-align:center">(Dรnh cho ngฦฐแปi chฦกi < 200 coins)</div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>

ย ย ย ย <div id="quiz-ui" style="display:none; width:100%; text-align:center">
ย ย ย ย ย ย <div id="quiz-combo-display" class="combo-text" style="display:none">๐ฅ Streak: 0</div>
ย ย ย ย ย ยย
ย ย ย ย ย ย <div style="color:#bbb; font-size:0.9em; margin-bottom:5px">Who's that Pokemon?</div>
ย ย ย ย ย ยย
ย ย ย ย ย ย <img id="quiz-image" class="quiz-img" src="" style="width:120px; height:120px; margin:0 auto; display:block">
ย ย ย ย ย ยย
ย ย ย ย ย ย <div id="quiz-options" style="display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-top:15px; width:100%">
ย ย ย ย ย ย ย ย </div>
ย ย ย ย </div>

ย ย ย ย <button class="btn-close" style="margin-top:15px" onclick="closeJobs()">ฤรณng</button>
ย ย </div>
</div>
ย ยย
ย ย <div id="daily-modal"><div class="box-style"><h2 style="color: #eb459e; margin: 0 0 10px 0;">๐ Daily Zone</h2><div class="daily-section" style="background:rgba(0,0,0,0.2);padding:10px;border-radius:5px;border:1px solid #444;text-align:left"><div style="font-weight:bold; color:#f1c40f">๐ ฤiแปm danh</div><div style="font-size:0.8em; color:#bbb; margin-bottom:5px">Nhแบญn 5,000 Coins</div><button id="btn-claim-daily" class="btn-small" style="background:#3ba55c; width:100%; padding:8px" onclick="claimDailyReward()">Nhแบญn</button></div><div class="daily-section" style="margin-top:10px;background:rgba(0,0,0,0.2);padding:10px;border-radius:5px;border:1px solid #444;text-align:left"><div style="font-weight:bold; color:#3498db; margin-bottom:5px">๐ Nhiแปm vแปฅ ngรy</div><div id="daily-quests-container"></div></div><button class="btn-close" style="margin-top:15px" onclick="closeDaily()">ฤรณng</button></div></div>
ย ยย
ย ย <div id="daycare-modal"><div class="box-style" style="width:95%; max-width:400px"><h2 style="color: #e91e63;">๐ก Daycare</h2><div style="font-size:0.8em; color:#bbb; margin-bottom:10px">Nhแบญn 50 XP/phรบt cho mแปi Pokemon.</div><div id="daycare-list" style="width:100%"></div><button id="btn-buy-slot" class="btn-auth" style="background:#f1c40f; color:black; display:none" onclick="buyDaycareSlot()">Mแป rแปng Slot</button><button class="btn-close" onclick="closeDaycare()">ฤรณng</button></div></div>
ย ยย
ย ย <div id="repair-modal"><div class="box-style"><h2 style="color: #e67e22;">๐ง Sแปญa Cรบp</h2><div style="margin-bottom:15px; color:#bbb">Trแบฃ lแปi cรขu hแปi:</div><div id="repair-question" style="font-size: 2em; font-weight:bold; color:white; margin-bottom:15px"></div><div id="repair-options" style="display:grid; grid-template-columns:1fr 1fr; gap:10px; width:100%"></div><div id="repair-limit-text" style="color:#ed4245; font-size:0.8em; margin-top:10px"></div></div></div>
ย ยย
ย ย <div id="achieve-modal"><div class="box-style"><div class="inner-box"><h2 style="color: #f1c40f;">๐ Thรnh Tแปฑu</h2><div style="font-size:0.7em; color:#aaa; margin-bottom:10px">Bแบฅm vรo ฤแป xem phแบงn thฦฐแปng</div><div id="achieve-list" style="overflow-y:auto; flex:1; width:100%; max-height:60vh"></div><button class="btn-close" onclick="closeAchieve()">ฤรณng</button></div></div></div>
ย ยย
ย ย <div id="dex-modal"><div class="box-style"><div class="inner-box"><h2 style="color: #3498db;">๐ Pokedex</h2><div style="font-size: 1.2em; margin-bottom: 20px;">ฤรฃ bแบฏt: <span style="color: #f1c40f; font-weight: bold;" id="dex-count">0</span> / 649</div><button class="btn-close" onclick="closePokedex()">ฤรณng</button></div></div></div>
ย ยย
ย ย <div id="donate-modal"><div class="box-style" style="background:white; color:black"><h3 style="color: #6c38c6; margin:0 0 10px 0">แปฆng Hแป Dev</h3><img src="38b84fc99acb15954cda.jpg" class="donate-qr" style="width:100%; border-radius:5px; border:1px solid #ddd"><div style="font-size:0.9em; margin-top:10px; font-weight:bold">TPBank QR</div><button class="btn-close" onclick="closeDonate()">ฤรณng</button></div></div>
<div id="chat-modal" style="display:none; position:fixed; bottom:80px; right:10px; width:300px; height:400px; z-index:3500; flex-direction:column; align-items:end;">
ย ย <div class="box-style" style="width:100%; height:100%; padding:10px; display:flex; flex-direction:column; background:rgba(32, 34, 37, 0.95); border:1px solid #7289da">
ย ย ย ย <div style="display:flex; justify-content:space-between; width:100%; border-bottom:1px solid #444; padding-bottom:5px; margin-bottom:5px">
ย ย ย ย ย ย <span style="color:#7289da; font-weight:bold">๐ฌ Kรชnh Thแบฟ Giแปi</span>
ย ย ย ย ย ย <span style="cursor:pointer; color:#ed4245" onclick="toggleChat()">[Thu nhแป]</span>
ย ย ย ย </div>
ย ย ย ย <div id="global-chat-content" style="flex:1; overflow-y:auto; text-align:left; font-size:0.85em; margin-bottom:5px; display:flex; flex-direction:column; gap:5px">
ย ย ย ย ย ย <div style="color:#777; font-style:italic">ฤang kแบฟt nแปi kรชnh chat...</div>
ย ย ย ย </div>
ย ย ย ย <div style="display:flex; gap:5px; width:100%">
ย ย ย ย ย ย <input type="text" id="chat-input" class="login-input" placeholder="Nรณi gรฌ ฤรณ..." style="margin:0; padding:5px; font-size:0.9em; text-align:left" onkeypress="handleChatEnter(event)">
ย ย ย ย ย ย <button class="btn-small" style="background:#7289da; width:auto" onclick="sendChat()">Gแปญi</button>
ย ย ย ย </div>
ย ย </div>
</div>

<button id="btn-chat-float" style="position:fixed; bottom:80px; right:20px; width:50px; height:50px; border-radius:50%; background:#7289da; border:2px solid white; z-index:3400; font-size:24px; cursor:move; box-shadow:0 0 10px rgba(0,0,0,0.5); touch-action: none;">๐ฌ</button>

<div id="market-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:3000; justify-content:center; align-items:center;">
ย ย <div class="box-style" style="width:95%; max-width:600px; border-color:#9b59b6">
ย ย ย ย <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
ย ย ย ย ย ย <h2 style="color: #9b59b6; margin:0">โ๏ธ CHแปข ฤEN</h2>
ย ย ย ย ย ย <div style="font-size:0.9em">Vรญ: <span style="color:#f1c40f" id="market-coin">0</span>๐ฐ</div>
ย ย ย ย </div>

ย ย ย ย <div class="shop-tabs">
ย ย ย ย ย ย <button class="shop-tab-btn active" onclick="switchMarketTab('buy')">MUA POKEMON</button>
ย ย ย ย ย ย <button class="shop-tab-btn" onclick="switchMarketTab('sell')">TREO BรN</button>
ย ย ย ย ย ย <button class="shop-tab-btn" onclick="switchMarketTab('inbox')">HรM THฦฏ (<span id="inbox-count" style="color:#ed4245">0</span>)</button>
ย ย ย ย </div>

ย ย ย ย <div id="market-buy-tab" style="display:block; height:300px; overflow-y:auto; margin-top:10px" class="shop-grid">
ย ย ย ย ย ย <div style="color:#bbb; padding:20px">ฤang tแบฃi dแปฏ liแปu chแปฃ...</div>
ย ย ย ย </div>

ย ย ย ย <div id="market-sell-tab" style="display:none; height:300px; overflow-y:auto; margin-top:10px">
ย ย ย ย ย ย <div style="color:#bbb; margin-bottom:10px">Chแปn Pokemon trong tรบi ฤแป bรกn:</div>
ย ย ย ย ย ย <div id="market-sell-list" class="shop-grid"></div>
ย ย ย ย </div>

ย ย ย ย <div id="market-inbox-tab" style="display:none; height:300px; overflow-y:auto; margin-top:10px">
ย ย ย ย ย ย <div style="text-align:center; padding:20px">
ย ย ย ย ย ย ย ย <div style="margin-bottom:10px">Tiแปn bรกn ฤฦฐแปฃc sแบฝ gแปญi vแป ฤรขy.</div>
ย ย ย ย ย ย ย ย <button id="btn-claim-money" class="btn-auth" style="background:#2ecc71; display:none" onclick="claimMarketMoney()">๐ฐ RรT TIแปN: 0</button>
ย ย ย ย ย ย ย ย <div id="inbox-logs" style="margin-top:15px; text-align:left; font-size:0.8em; color:#bbb"></div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>

ย ย ย ย <button class="btn-close" style="margin-top:10px" onclick="closeMarket()">ฤรณng</button>
ย ย </div>
</div>
ย ย <div id="boss-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:3000; justify-content:center; align-items:center;">
ย ย <div class="box-style" style="width:95%; max-width:500px; border-color:#ed4245">
ย ย ย ย <h2 style="color: #ed4245; margin: 0 0 5px 0;">โ๏ธ WORLD BOSS</h2>
ย ย ย ยย
ย ย ย ย <div class="stamina-bar-container">
ย ย ย ย ย ย <div id="stamina-bar-fill" class="stamina-fill"></div>
ย ย ย ย ย ย <div id="stamina-text" class="stamina-text">100/100</div>
ย ย ย ย </div>

ย ย ย ย <div id="boss-display-area">
ย ย ย ย ย ย <div style="color:yellow">ฤang tแบฃi dแปฏ liแปu Boss...</div>
ย ย ย ย </div>

ย ย ย ย <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center">
ย ย ย ย ย ย <h4 style="color:#f1c40f; margin:0">๐ Top Sรกt Thฦฐฦกng</h4>
ย ย ย ย ย ย <button class="btn-small" style="background:#7289da; width:auto; padding:5px 10px" onclick="openBossTeamSelect()">
ย ย ย ย ย ย ย ย ๐ฅ Chแปnh Team (<span id="team-count-display">0</span>/6)
ย ย ย ย ย ย </button>
ย ย ย ย </div>

ย ย ย ย <div id="boss-dps-list" style="height:120px; overflow-y:auto; background:rgba(0,0,0,0.5); padding:5px; border-radius:5px; margin-top:5px"></div>

ย ย ย ย <div style="margin-top:15px; display:flex; gap:10px; justify-content:center">
ย ย ย ย ย ย <button id="btn-attack-boss" class="btn-auth" style="background:#ed4245" onclick="attackWorldBoss()">โ๏ธ TแบคN CรNG (10 Energy)</button>
ย ย ย ย ย ย <button class="btn-auth" style="background:#7f8c8d; width:auto" onclick="closeWorldBoss()">ฤรณng</button>
ย ย ย ย </div>
ย ย ย ย <div id="boss-regen-timer" style="font-size:0.8em; color:#bbb; margin-top:5px">Hแปi 1 nฤng lฦฐแปฃng mแปi phรบt</div>
ย ย </div>
ย ย </div>

<div id="boss-team-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:3500; justify-content:center; align-items:center;">
ย ย <div class="box-style" style="border-color:#7289da">
ย ย ย ย <h3 style="color:#7289da">Chแปn ฤแปi Hรฌnh (Tแปi ฤa 6)</h3>
ย ย ย ย <div style="font-size:0.8em; color:#bbb; margin-bottom:10px">Chแปn Pokemon mแบกnh nhแบฅt ฤแป tแปi ฦฐu sรกt thฦฐฦกng!</div>
ย ย ย ยย
ย ย ย ย <div id="boss-team-grid" class="team-grid"></div>
ย ย ย ยย
ย ย ย ย <div style="margin-top:15px; display:flex; justify-content:center; gap:10px">
ย ย ย ย ย ย <button class="btn-auth" style="background:#3ba55c" onclick="saveBossTeam()">LฦฏU ฤแปI HรNH</button>
ย ย ย ย </div>
ย ย </div>
</div>
ย ยย
ย ย <div id="update-modal">
ย ย ย ย <div class="box-style">
ย ย ย ย ย ย <h2 style="color: #faa61a;">๐ Nhแบญt Kรฝ Cแบญp Nhแบญt</h2>
ย ย ย ย ย ย <div class="update-list" style="text-align:left; width:100%; overflow-y:auto; max-height:60vh">
ย ย ย ย ย ย ย ย <div style="margin-bottom:10px; border-bottom:1px solid #444; padding-bottom:5px">
ย ย ย ย ย ย ย ย ย ย <span style="background:#8e44ad; color:white; padding:2px 5px; border-radius:3px">v2.4</span> <b>Online & Hardcore</b>
ย ย ย ย ย ย ย ย ย ย <ul style="padding-left:20px; font-size:0.9em; color:#ddd">
ย ย ย ย ย ย ย ย ย ย ย ย <li>Lฦฐu trแปฏ Cloud Firebase.</li>
ย ย ย ย ย ย ย ย ย ย ย ย <li>Cรขn bแบฑng kinh tแบฟ & Tแป lแป Shiny chuแบฉn.</li>
ย ย ย ย ย ย ย ย ย ย ย ย <li>Giao diแปn Menu mแปi.</li>
ย ย ย ย ย ย ย ย ย ย </ul>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <button class="btn-close" onclick="closeUpdates()">ฤรณng</button>
ย ย ย ย </div>
ย ย </div>

ย ย <div id="battle-modal">
ย ย ย ย <div class="box-style">
ย ย ย ย ย ย <div id="battle-select-screen" style="width:100%; text-align:center">
ย ย ย ย ย ย ย ย <h2 style="color: #e74c3c; margin-bottom: 15px;">๐ฅ ฤแบคU TRฦฏแปNG</h2>
ย ย ย ย ย ย ย ย <div class="battle-card" style="width:100%; margin-bottom:10px; padding:10px; background:rgba(0,0,0,0.5); border-radius:5px">
ย ย ย ย ย ย ย ย ย ย <span id="battle-my-poke" style="color:#3ba55c; font-weight:bold">My Pokemon</span>
ย ย ย ย ย ย ย ย ย ย <div style="font-size:0.8em; color:#bbb">Ready for battle!</div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <button class="difficulty-btn diff-easy btn-auth" style="background:#2ecc71" onclick="startBattle('easy')"><span>EASY (300 Xu)</span></button>
ย ย ย ย ย ย ย ย <button class="difficulty-btn diff-med btn-auth" style="background:#f1c40f; color:black" onclick="startBattle('medium')"><span>MEDIUM (1000 Xu)</span></button>
ย ย ย ย ย ย ย ย <button id="gym-btn" class="difficulty-btn gym-btn btn-auth" style="background:#ed4245" onclick="startBattle('hard')"><span>HARD: GYM (5000 Xu)</span></button>
ย ย ย ย ย ย ย ย <button class="btn-close" onclick="closeBattle()">Thoรกt</button>
ย ย ย ย ย ย </div>
ย ยย
ย ย ย ย ย ย <div id="battle-combat-screen" style="display:none; width:100%; flex-direction:column; height:100%">
ย ย ย ย ย ย ย ย <div class="battle-scene">
ย ย ย ย ย ย ย ย ย ย <div class="p-enemy">
ย ย ย ย ย ย ย ย ย ย ย ย <div class="hp-box">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div style="display:flex;justify-content:space-between;font-size:0.8em;font-weight:bold"><span id="enemy-name">Enemy</span> <span id="enemy-lv">Lv.5</span></div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="hp-container" style="height:6px; margin-top:2px"><div id="enemy-hp-bar" class="hp-fill" style="width:100%;background:#2ecc71"></div></div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <img id="enemy-sprite" class="battle-sprite" src="">
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย <div class="p-player">
ย ย ย ย ย ย ย ย ย ย ย ย <img id="player-sprite" class="battle-sprite" src="">
ย ย ย ย ย ย ย ย ย ย ย ย ย<div class="hp-box" style="margin-top:5px">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div style="display:flex;justify-content:space-between;font-size:0.8em;font-weight:bold"><span id="player-name">Player</span> <span id="player-hp-text">20/20</span></div>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <div class="hp-container" style="height:6px; margin-top:2px"><div id="player-hp-bar" class="hp-fill" style="width:100%;background:#2ecc71"></div></div>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ยย
ย ย ย ย ย ย ย ย <div id="battle-log" class="battle-log-box">Trแบญn ฤแบฅu bแบฏt ฤแบงu!</div>
ย ยย
ย ย ย ย ย ย ย ย <div id="battle-main-menu" class="action-grid">
ย ย ย ย ย ย ย ย ย ย <button class="action-btn main-menu-btn" style="background:#e74c3c" onclick="showMoveMenu()">โ๏ธ CHIแบพN ฤแบคU</button>
ย ย ย ย ย ย ย ย ย ย <button class="action-btn main-menu-btn" style="background:#2ecc71; color:black" onclick="playerHeal()">๐ Potion (<span id="potion-count">0</span>)</button>
ย ย ย ย ย ย ย ย ย ย <button class="action-btn main-menu-btn" style="background:#f1c40f; color:black" onclick="playerSkip()">๐ค Nghแป</button>
ย ย ย ย ย ย ย ย ย ย <button class="action-btn main-menu-btn" style="background:#95a5a6" onclick="playerRun()">๐ Bแป chแบกy</button>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <div id="battle-move-menu" class="action-grid" style="display:none">
ย ย ย ย ย ย ย ย ย ย <button id="move-btn-0" class="action-btn move-btn" onclick="useMove(0)"></button>
ย ย ย ย ย ย ย ย ย ย <button id="move-btn-1" class="action-btn move-btn" onclick="useMove(1)"></button>
ย ย ย ย ย ย ย ย ย ย <button id="move-btn-2" class="action-btn move-btn" onclick="useMove(2)"></button>
ย ย ย ย ย ย ย ย ย ย <button id="move-btn-3" class="action-btn move-btn" onclick="useMove(3)"></button>
ย ย ย ย ย ย ย ย ย ย <button class="action-btn" style="grid-column: span 2; background:#7f8c8d; padding:5px" onclick="hideMoveMenu()">โฌ๏ธ Quay lแบกi</button>
ย ย ย ย ย ย ย ย </div>
ย ยย
ย ย ย ย ย ย ย ย <button id="battle-end-btn" class="btn-auth" style="display:none; background:#3ba55c" onclick="endBattle()">Hoรn Tแบฅt</button>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย </div>

ย ย <div id="learn-move-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:2000; justify-content:center; align-items:center;">
ย ย <div class="box-style" style="border-color:#3498db; max-width:400px;">
ย ย ย ย <h3 style="color:#f1c40f; margin-bottom:10px;">๐ก Hแปc Chiรชu Mแปi!</h3>
ย ย ย ย <div id="learn-move-msg" style="margin-bottom:15px;">
ย ย ย ย ย ย Bulbasaur muแปn hแปc <b style="color:#3498db">Vine Whip</b>.<br>
ย ย ย ย ย ย Nhฦฐng Bulbasaur ฤรฃ biแบฟt 4 chiรชu!
ย ย ย ย </div>
ย ย ย ยย
ย ย ย ย <div style="display:grid; grid-template-columns:1fr; gap:5px; width:100%; margin-bottom:10px;">
ย ย ย ย ย ย <div id="move-forget-list"></div>
ย ย ย ย </div>

ย ย ย ย <div style="border-top:1px solid #555; padding-top:10px; margin-top:5px;">
ย ย ย ย ย ย <button class="btn-auth" style="background:#ed4245" onclick="cancelLearnMove()">Bแป qua chiรชu mแปi</button>
ย ย ย ย </div>
ย ย </div>
</div>
ย ยย
ย ย <div id="leaderboard-modal">
ย ย ย ย <div class="box-style">
ย ย ย ย ย ย <h2 style="color: #f1c40f; margin: 0 0 10px 0;">๐ Bแบฃng Phong Thแบงn</h2>
ย ย ย ย ย ย <div style="font-size:0.8em; color:#bbb; margin-bottom:15px">Top 10 ฤแบกi Gia Server</div>
ย ย ย ย ย ย <div id="leaderboard-list">
ย ย ย ย ย ย ย ย ย<div style="color:yellow; padding:20px">ฤang tแบฃi...</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <button class="btn-close" onclick="closeLeaderboard()">ฤรณng</button>
ย ย ย ย </div>
ย ย </div>
ย ยย
ย ย <div id="feedback-modal">
ย ย ย ย <div class="box-style">
ย ย ย ย ย ย <h2 style="color: #3498db; margin: 0 0 10px 0;">๐ฉ Hรฒm Thฦฐ Gรณp ร</h2>
ย ย ย ย ย ย <div style="font-size:0.9em; color:#bbb; margin-bottom:10px">ร tฦฐแปng cแปงa bแบกn sแบฝ ฤฦฐแปฃc gแปญi trแปฑc tiแบฟp ฤแบฟn Dev!</div>
ย ย ย ย ย ย <textarea id="feedback-text" style="width:100%; height:120px; background:#40444b; color:white; border:1px solid #202225; border-radius:5px; padding:10px; resize:none; font-family:inherit" placeholder="Vรญ dแปฅ: Cแบงn thรชm Pokemon huyแปn thoแบกi, giแบฃm giรก Shop..."></textarea>
ย ย ย ย ย ย <div style="display:flex; justify-content:flex-end; gap:10px; margin-top:10px; width:100%">
ย ย ย ย ย ย ย ย <button class="btn-auth" style="background:#7f8c8d; width:auto" onclick="closeFeedback()">Hแปงy</button>
ย ย ย ย ย ย ย ย <button class="btn-auth" style="background:#3498db; width:auto" onclick="submitFeedback()">GแปฌI NGAY</button>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย </div>
ย ย <div id="gift-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:4000; justify-content:center; align-items:center;">
ย ย <div class="box-style" style="border-color:#e91e63; width:300px">
ย ย ย ย <h3 style="color:#e91e63">๐ NHแบฌP GIFTCODE</h3>
ย ย ย ย <input type="text" id="input-giftcode" placeholder="Nhแบญp mรฃ tแบกi ฤรขy..." style="width:100%; padding:10px; margin:10px 0; background:#222; color:white; border:1px solid #555; text-align:center; text-transform:uppercase">
ย ย ย ยย
ย ย ย ย <div style="display:flex; gap:10px; justify-content:center">
ย ย ย ย ย ย <button class="btn-auth" onclick="submitGiftCodeUI()">XรC NHแบฌN</button>
ย ย ย ย ย ย <button class="btn-auth" style="background:#555" onclick="document.getElementById('gift-modal').style.display='none'">ฤรNG</button>
ย ย ย ย </div>
ย ย </div>
ย ย </div>
ย ย <div id="shop-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:5000; justify-content:center; align-items:center;">
ย ย <div class="box-style" style="border-color:#f1c40f; width:300px; text-align:center; background:#222">
ย ย ย ย <h3 id="shop-buy-title" style="color:#f1c40f; margin:0 0 10px 0">Xรกc nhแบญn mua</h3>
ย ย ย ยย
ย ย ย ย <div style="margin-bottom:15px; color: white">
ย ย ย ย ย ย Sแป lฦฐแปฃng:ย
ย ย ย ย ย ย <input type="number" id="shop-buy-qty" value="1" min="1" style="width:60px; padding:5px; text-align:center; font-weight:bold; border-radius:5px; border:1px solid #555">
ย ย ย ย </div>

ย ย ย ย <div style="display:flex; justify-content:center; gap:10px">
ย ย ย ย ย ย <button class="btn-auth" style="background:#2ecc71" onclick="submitBuy()">โ MUA NGAY</button>
ย ย ย ย ย ย <button class="btn-auth" style="background:#e74c3c" onclick="closeShopModal()">โ HแปฆY</button>
ย ย ย ย </div>
ย ย </div>
</div>
ย ย <div id="tower-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:3200; justify-content:center; align-items:center;">
ย ย <div class="box-style" style="border-color:#a29bfe; width:95%; max-width:500px; background:linear-gradient(135deg, #2d3436, #000)">
ย ย ย ย <h2 style="color:#a29bfe; margin:0">๐ผ THรP Vร TแบฌN</h2>
ย ย ย ย <div style="color:#bbb; font-size:0.8em; margin-bottom:10px">Leo thรกp - Sแปng sรณt - Nhแบญn quร ฤแปc quyแปn</div>

ย ย ย ย <div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:10px; margin-bottom:15px">
ย ย ย ย ย ย <div style="font-size:2em; font-weight:bold; color:white">TแบฆNG <span id="tower-floor-display" style="color:#f1c40f">1</span></div>
ย ย ย ย ย ย <div style="font-size:0.9em">ฤแปch: <span id="tower-enemy-preview" style="color:#e74c3c">Lv.10</span></div>
ย ย ย ย ย ย <div style="margin-top:5px; font-size:0.8em; color:#aaa">Luแบญt: Hแปi 20% HP sau mแปi trแบญn. Thua = Reset.</div>
ย ย ย ย </div>

ย ย ย ย <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
ย ย ย ย ย ย <button class="btn-small" style="background:#6c5ce7" onclick="openTowerTeamSelect()">๐ฅ Chแปn Team (6)</button>
ย ย ย ย ย ย <div style="font-weight:bold; color:#f1c40f">๐ Token: <span id="tower-token-display">0</span></div>
ย ย ย ย </div>

ย ย ย ย <div style="display:flex; gap:10px; justify-content:center; margin-top:10px">
ย ย ย ย ย ย <button class="btn-auth" style="background:#e74c3c; width:60%" onclick="startTowerBattle()">โ๏ธ KHIรU CHIแบพN</button>
ย ย ย ย ย ย <button class="btn-auth" style="background:#0984e3; width:35%" onclick="openTowerShop()">๐ Shop</button>
ย ย ย ย </div>

ย ย ย ย <button class="btn-close" style="margin-top:15px" onclick="closeTower()">Thoรกt</button>
ย ย </div>
</div>

<div id="tower-shop-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:3300; justify-content:center; align-items:center;">
ย ย <div class="box-style" style="border-color:#f1c40f">
ย ย ย ย <h3 style="color:#f1c40f">๐ฐ TOWER SHOP</h3>
ย ย ย ย <div style="margin-bottom:10px">Dรนng <b style="color:#f1c40f">Tower Token ๐</b> ฤแป ฤแปi vแบญt phแบฉm hiแบฟm.</div>
ย ย ย ย <div id="tower-shop-list" class="shop-grid">
ย ย ย ย ย ย </div>
ย ย ย ย <button class="btn-close" onclick="document.getElementById('tower-shop-modal').style.display='none'">ฤรณng Shop</button>
ย ย </div>
</div>
ย ย <div id="switch-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.95); z-index:3500; justify-content:center; align-items:center;">
ย ย <div class="box-style" style="border-color:#e74c3c; width:90%; max-width:400px">
ย ย ย ย <h3 style="color:#e74c3c">โ๏ธ POKEMON ฤร GแปคC NGร!</h3>
ย ย ย ย <div style="margin-bottom:15px; color:#bbb">Hรฃy chแปn Pokemon khรกc ฤแป tiแบฟp tแปฅc chiแบฟn ฤแบฅu:</div>
ย ย ย ยย
ย ย ย ย <div id="switch-list" class="shop-grid" style="max-height:300px; overflow-y:auto">
ย ย ย ย ย ย </div>
ย ย ย ยย
ย ย ย ย <button class="btn-auth" style="background:#333; margin-top:10px" onclick="surrenderTower()">๐ณ๏ธ ฤแบฆU HรNG (Reset)</button>
ย ย </div>
</div>
ย ย <div id="map-modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.9); z-index:3100; justify-content:center; align-items:center;">
ย ย <div class="box-style" style="width:95%; max-width:500px; border-color:#0984e3; background:#222">
ย ย ย ย <h2 style="color:#0984e3; margin:0 0 10px 0">๐บ๏ธ BแบขN ฤแป THแบพ GIแปI</h2>
ย ย ย ย <div style="color:#bbb; font-size:0.8em; margin-bottom:15px">Chแปn khu vแปฑc ฤแป sฤn bแบฏt Pokemon ฤแบทc thรน.</div>
ย ย ย ยย
ย ย ย ย <div id="map-list" class="shop-grid" style="max-height:400px; overflow-y:auto">
ย ย ย ย ย ย </div>

ย ย ย ย <button class="btn-close" style="margin-top:15px" onclick="document.getElementById('map-modal').style.display='none'">ฤรณng</button>
ย ย </div>
</div>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script>
ย ย // --- FIREBASE CONFIG & INIT (DรN VรO ฤรY) ---
ย ย const firebaseConfig = {
ย ย ย apiKey: "AIzaSyBfS5Mtj27J9CLd92m4m3X5rBwQOpv52v8",
ย ย ย authDomain: "pokestay-online.firebaseapp.com",
ย ย ย databaseURL: "https://pokestay-online-default-rtdb.asia-southeast1.firebasedatabase.app",
ย ย ย projectId: "pokestay-online",
ย ย ย storageBucket: "pokestay-online.firebasestorage.app",
ย ย ย messagingSenderId: "848625481232",
ย ย ย appId: "1:848625481232:web:60c88cdcbef8ae2f347c95"
ย ย };
ย ยย
ย ย // Khแปi tแบกo Firebase
ย ย firebase.initializeApp(firebaseConfig);
ย ย const db = firebase.database(); // Biแบฟn nรy dรนng ฤแป gแปi Database sau nรy
ย ย // ----------------------------------------------
ย ย let currentUser = "";
ย ยย
ย ย // --- AUDIO SYSTEM (FINAL FIXED) ---
ย ย let isMuted = false;
ย ย const AUDIO_SRC = {
ย ย ย ย // Nhแบกc Battle: Pokemon Red/Blue - Wild Battle (MP3)
ย ย ย ย bgm_battle: "https://ia800605.us.archive.org/32/items/PokemonGBS/107-battle%20%28vs%20wild%20pokemon%29.mp3",ย
ย ย ย ยย
ย ย ย ย // Nhแบกc Map: Pokemon Red/Blue - Pallet Town (MP3)
ย ย ย ย bgm_map: "nhac_nen.mp3",ย
ย ย ย ยย
ย ย ย ย sfx_level: "https://upload.wikimedia.org/wikipedia/commons/1/13/7550_-_sfx_level_up_2.wav",
ย ย ย ย sfx_catch: "https://upload.wikimedia.org/wikipedia/commons/3/3a/Cat_meow.ogg"ย
ย ย };
ย ยย
ย ย // Khai bรกo biแบฟn Audio 1 lแบงn duy nhแบฅt
ย ย let currentBGM = new Audio();
ย ย currentBGM.loop = true;
ย ย currentBGM.volume = 0.5;

ย ย function toggleMute() {
ย ย ย ย isMuted = !isMuted;
ย ย ย ย document.getElementById('btn-mute').innerText = isMuted ? "๐" : "๐";
ย ย ย ย if(isMuted) {ย
ย ย ย ย ย ย currentBGM.pause();ย
ย ย ย ย } else {
ย ย ย ย ย ย // Nแบฟu ฤang trong trแบญn thรฌ bแบญt nhแบกc battle, khรดng thรฌ nhแบกc map
ย ย ย ย ย ย if(battleState.active) playBGM('battle');
ย ย ย ย ย ย else playBGM('map');
ย ย ย ย }
ย ย }

ย ย function playCry(id) {
ย ย ย ย if(isMuted) return;
ย ย ย ย let audio = new Audio(`https://raw.githubusercontent.com/PokeAPI/cries/main/cries/pokemon/latest/${id}.ogg`);
ย ย ย ย audio.volume = 0.15;
ย ย ย ย audio.play().catch(e => console.log("Audio play error:", e));
ย ย }

ย ย function playBGM(type) {
ย ย ย ย if(isMuted) return;
ย ย ย ยย
ย ย ย ย let newSrc = "";
ย ย ย ย // Chแปn link nhแบกc
ย ย ย ย if(type === 'battle') newSrc = AUDIO_SRC.bgm_battle;
ย ย ย ย else if (type === 'map') newSrc = AUDIO_SRC.bgm_map;
ย ย ย ยย
ย ย ย ย // Nแบฟu link mแปi khรกc link ฤang hรกt, hoแบทc nhแบกc ฤang bแป tแบฏt
ย ย ย ย if(currentBGM.src !== newSrc || currentBGM.paused) {
ย ย ย ย ย ย currentBGM.src = newSrc;
ย ย ย ย ย ยย
ย ย ย ย ย ย // Chแปnh รขm lฦฐแปฃng tรนy bรi
ย ย ย ย ย ย if(type === 'battle') currentBGM.volume = 0.3;
ย ย ย ย ย ย else currentBGM.volume = 0.4;
ย ย ย ย ย ยย
ย ย ย ย ย ย // Lแปnh phรกt nhแบกc
ย ย ย ย ย ย let playPromise = currentBGM.play();

ย ย ย ย ย ย if (playPromise !== undefined) {
ย ย ย ย ย ย ย ย playPromise.then(_ => {
ย ย ย ย ย ย ย ย ย ย console.log("ฤang phรกt nhแบกc: " + type);
ย ย ย ย ย ย ย ย })
ย ย ย ย ย ย ย ย .catch(error => {
ย ย ย ย ย ย ย ย ย ย console.warn("Chฦฐa thแป phรกt nhแบกc tแปฑ ฤแปng. Hรฃy click vรo mรn hรฌnh.");
ย ย ย ย ย ย ย ย });
ย ย ย ย ย ย }
ย ย ย ย }
ย ย }

ย ย function stopBGM() {
ย ย ย ย currentBGM.pause();
ย ย ย ย currentBGM.currentTime = 0;
ย ย }

ย ย function playSFX(type) {
ย ย ย ย if(isMuted) return;
ย ย ย ย let src = "";
ย ย ย ย if(type === 'levelup') src = AUDIO_SRC.sfx_level;
ย ย ย ย if(type === 'catch') src = AUDIO_SRC.sfx_catch;
ย ย ย ยย
ย ย ย ย if(src) {
ย ย ย ย ย ย let a = new Audio(src);
ย ย ย ย ย ย a.volume = 0.3;
ย ย ย ย ย ย a.play();
ย ย ย ย }
ย ย }
ย ยย
ย ย // Tแปฑ ฤแปng kรญch hoแบกt nhแบกc khi ngฦฐแปi dรนng bแบฅm chuแปt lแบงn ฤแบงu tiรชn
ย ย document.body.addEventListener('click', function() {
ย ย ย ย if (currentBGM.paused && !isMuted && currentUser) {
ย ย ย ย ย ย let type = battleState.active ? 'battle' : 'map';
ย ย ย ย ย ย playBGM(type);
ย ย ย ย }
ย ย }, { once: true });

ย ย // --- KแบพT THรC AUDIO ---
ย ย const BASE_SAVE_KEY = 'poke_save_';
ย ย const AUTH_KEY = 'poke_auth_';ย
ย ย const MAX_ID = 649;
ย ย const URL_ITEMS = "https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/";
ย ย const LEGENDARY_IDS = [144,145,146,150,151,243,244,245,249,250,251,377,378,379,380,381,382,383,384,385,386,480,481,482,483,484,485,486,487,488,489,490,491,492,493,494,638,639,640,641,642,643,644,645,646];
ย ยย
ย ย const TYPE_ADVANTAGE = {ย
ย ย ย ย 'normal': [],
ย ย ย ย 'fire': ['grass', 'ice', 'bug', 'steel'],ย
ย ย ย ย 'water': ['fire', 'ground', 'rock'],ย
ย ย ย ย 'grass': ['water', 'ground', 'rock'],ย
ย ย ย ย 'electric': ['water', 'flying'],ย
ย ย ย ย 'ice': ['grass', 'ground', 'flying', 'dragon'],ย
ย ย ย ย 'fighting': ['normal', 'ice', 'rock', 'dark', 'steel'],ย
ย ย ย ย 'poison': ['grass', 'fairy'],ย
ย ย ย ย 'ground': ['fire', 'electric', 'poison', 'rock', 'steel'],ย
ย ย ย ย 'flying': ['grass', 'fighting', 'bug'],ย
ย ย ย ย 'psychic': ['fighting', 'poison'],ย
ย ย ย ย 'bug': ['grass', 'psychic', 'dark'],ย
ย ย ย ย 'rock': ['fire', 'ice', 'flying', 'bug'],ย
ย ย ย ย 'ghost': ['psychic', 'ghost'],ย
ย ย ย ย 'dragon': ['dragon'],ย
ย ย ย ย 'steel': ['ice', 'rock', 'fairy'],ย
ย ย ย ย 'fairy': ['fighting', 'dragon', 'dark']ย
ย ย };
ย ย const SPECIAL_TYPES = ['fire', 'water', 'grass', 'electric', 'psychic', 'ice', 'dragon', 'fairy'];
ย ยย
ย ย const TYPE_COLORS = {
ย ย ย ย 'normal': '#A8A77A', 'fire': '#EE8130', 'water': '#6390F0', 'electric': '#F7D02C',
ย ย ย ย 'grass': '#7AC74C', 'ice': '#96D9D6', 'fighting': '#C22E28', 'poison': '#A33EA1',
ย ย ย ย 'ground': '#E2BF65', 'flying': '#A98FF3', 'psychic': '#F95587', 'bug': '#A6B91A',
ย ย ย ย 'rock': '#B6A136', 'ghost': '#735797', 'dragon': '#6F35FC', 'steel': '#B7B7CE',
ย ย ย ย 'fairy': '#D685AD'
ย ย };

ย ย // MOVES_DB V2.3: Added 'cat' (phy/spe) for Physical/Special split
ย ย // --- DATABASE MแปI: Skill, Status, Priority ---
ย ย // --- Dแปฎ LIแปU CHIรU THแปจC Mแป RแปNG (GEN 5 STYLE) ---
const ALL_MOVES = [
ย ย // NORMAL
ย ย {name: 'Tackle', type: 'normal', pwr: 40, cat: 'phy', acc: 100},
ย ย {name: 'Quick Attack', type: 'normal', pwr: 40, cat: 'phy', acc: 100, priority: 1},
ย ย {name: 'Slash', type: 'normal', pwr: 70, cat: 'phy', acc: 100, crit: true}, // High crit
ย ย {name: 'Hyper Beam', type: 'normal', pwr: 150, cat: 'spe', acc: 90},
ย ย {name: 'Growl', type: 'normal', pwr: 0, cat: 'stat', stat: 'atk', stage: -1, target: 'enemy'},
ย ย {name: 'Swords Dance', type: 'normal', pwr: 0, cat: 'stat', stat: 'atk', stage: 2, target: 'self'},
ย ยย
ย ย // FIRE
ย ย {name: 'Ember', type: 'fire', pwr: 40, cat: 'spe', acc: 100, effect: 'brn', chance: 0.1},
ย ย {name: 'Flame Wheel', type: 'fire', pwr: 60, cat: 'phy', acc: 100, effect: 'brn', chance: 0.1},
ย ย {name: 'Flamethrower', type: 'fire', pwr: 90, cat: 'spe', acc: 100, effect: 'brn', chance: 0.1},
ย ย {name: 'Fire Blast', type: 'fire', pwr: 110, cat: 'spe', acc: 85, effect: 'brn', chance: 0.1},
ย ย {name: 'Will-O-Wisp', type: 'fire', pwr: 0, cat: 'status', status: 'brn', acc: 85},

ย ย // WATER
ย ย {name: 'Water Gun', type: 'water', pwr: 40, cat: 'spe', acc: 100},
ย ย {name: 'Bubble Beam', type: 'water', pwr: 65, cat: 'spe', acc: 100, effect: 'spd', chance: 0.1},
ย ย {name: 'Surf', type: 'water', pwr: 90, cat: 'spe', acc: 100},
ย ย {name: 'Hydro Pump', type: 'water', pwr: 110, cat: 'spe', acc: 80},
ย ย {name: 'Aqua Jet', type: 'water', pwr: 40, cat: 'phy', acc: 100, priority: 1},

ย ย // GRASS
ย ย {name: 'Vine Whip', type: 'grass', pwr: 45, cat: 'phy', acc: 100},
ย ย {name: 'Razor Leaf', type: 'grass', pwr: 55, cat: 'phy', acc: 95, crit: true},
ย ย {name: 'Energy Ball', type: 'grass', pwr: 90, cat: 'spe', acc: 100},
ย ย {name: 'Solar Beam', type: 'grass', pwr: 120, cat: 'spe', acc: 100},
ย ย {name: 'Sleep Powder', type: 'grass', pwr: 0, cat: 'status', status: 'slp', acc: 75},

ย ย // ELECTRIC
ย ย {name: 'Thunder Shock', type: 'electric', pwr: 40, cat: 'spe', acc: 100, effect: 'par', chance: 0.1},
ย ย {name: 'Spark', type: 'electric', pwr: 65, cat: 'phy', acc: 100, effect: 'par', chance: 0.3},
ย ย {name: 'Thunderbolt', type: 'electric', pwr: 90, cat: 'spe', acc: 100, effect: 'par', chance: 0.1},
ย ย {name: 'Thunder', type: 'electric', pwr: 110, cat: 'spe', acc: 70, effect: 'par', chance: 0.3},
ย ย {name: 'Thunder Wave', type: 'electric', pwr: 0, cat: 'status', status: 'par', acc: 90},
ย ยย
ย ย // FIGHTING (Thรชm 1 รญt hแป khรกc ฤแป vรญ dแปฅ)
ย ย {name: 'Karate Chop', type: 'fighting', pwr: 50, cat: 'phy', acc: 100, crit: true},
ย ย {name: 'Close Combat', type: 'fighting', pwr: 120, cat: 'phy', acc: 100}, // Thฦฐแปng giแบฃm def nhฦฐng game nรy tแบกm bแป qua
];

// Hรm lแบฅy chiรชu theo tรชn
function getMoveData(name) {
ย ย return ALL_MOVES.find(m => m.name === name) || ALL_MOVES[0];
}

// --- Hแป THแปNG MOVE POOL THEO LEVEL (PROCEDURAL) ---
// Thay vรฌ viแบฟt database cho 649 con, ta tแบกo quy tแบฏc:
// Level 1-10: Chiรชu yแบฟu (40 pwr)
// Level 11-25: Chiรชu trung bรฌnh (60 pwr)
// Level 26-45: Chiรชu mแบกnh (90 pwr)
// Level 46+: Chiรชu cuแปi (110+ pwr)
function getLearnsetForType(type) {
ย ย // Lแปc ra cรกc chiรชu cแปงa hแป ฤรณ
ย ย let moves = ALL_MOVES.filter(m => m.type === type);
ย ย if(moves.length === 0) moves = ALL_MOVES.filter(m => m.type === 'normal'); // Fallback

ย ย // Sแบฏp xแบฟp sฦก bแป theo sแปฉc mแบกnh
ย ย moves.sort((a,b) => (a.pwr || 0) - (b.pwr || 0));

ย ย // Tแบกo bแบฃng Learnset แบฃo
ย ย let learnset = {};
ย ยย
ย ย // Gรกn chiรชu Status vรo Lv 8 hoแบทc 12
ย ย let statusMove = moves.find(m => m.cat === 'status' || m.cat === 'stat');
ย ย if(statusMove) learnset[12] = statusMove.name;

ย ย // Gรกn chiรชu Tแบฅn cรดng theo sแปฉc mแบกnh tฤng dแบงn
ย ย let attackMoves = moves.filter(m => m.pwr > 0);
ย ย if(attackMoves.length > 0) learnset[1] = attackMoves[0].name; // Chiรชu khแปi ฤแบงu
ย ย if(attackMoves.length > 1) learnset[15] = attackMoves[1].name;
ย ย if(attackMoves.length > 2) learnset[30] = attackMoves[2].name;
ย ย if(attackMoves.length > 3) learnset[45] = attackMoves[3].name;
ย ย if(attackMoves.length > 4) learnset[60] = attackMoves[4].name;

ย ย return learnset;
}
ย ย const GYM_DB = [
ย ย ย ย { name: "Brock", type: "rock", badge: "Boulder Badge", icon: "๐ชจ", buff: "Def +10%", id: 1 },
ย ย ย ย { name: "Misty", type: "water", badge: "Cascade Badge", icon: "๐ง", buff: "Coin +10%", id: 2 },
ย ย ย ย { name: "Lt. Surge", type: "electric", badge: "Thunder Badge", icon: "โก", buff: "Crit +5%", id: 3 },
ย ย ย ย { name: "Erika", type: "grass", badge: "Rainbow Badge", icon: "๐ฟ", buff: "Catch +5%", id: 4 },
ย ย ย ย { name: "Koga", type: "poison", badge: "Soul Badge", icon: "โ๏ธ", buff: "Def +15%", id: 5 },
ย ย ย ย { name: "Sabrina", type: "psychic", badge: "Marsh Badge", icon: "๐ฎ", buff: "XP +10%", id: 6 },
ย ย ย ย { name: "Blaine", type: "fire", badge: "Volcano Badge", icon: "๐ฅ", buff: "Dmg +10%", id: 7 },
ย ย ย ย { name: "Giovanni", type: "ground", badge: "Earth Badge", icon: "๐", buff: "All +10%", id: 8 }
ย ย ];

ย ย const ACHIEVEMENT_DB = [
ย ย // --- Cลจ ---
ย ย { id: 'novice', name: 'Tแบญp sแปฑ', desc: 'Bแบฏt 10 Pokemon', req: (s)=>s.catches>=10, reward: {type:'item', id:'poke-ball', qty:5} },
ย ย { id: 'collector', name: 'Sฦฐu tแบงm', desc: 'Bแบฏt 50 Pokemon', req: (s)=>s.catches>=50, reward: {type:'item', id:'great-ball', qty:10} },
ย ย { id: 'master', name: 'Bแบญc Thแบงy', desc: 'Bแบฏt 100 Pokemon', req: (s)=>s.catches>=100, reward: {type:'item', id:'ultra-ball', qty:5} },
ย ย { id: 'lucky', name: 'May mแบฏn', desc: 'Bแบฏt 1 Shiny', req: (s)=>s.shinies>=1, reward: {type:'item', id:'lucky-egg', qty:2} },
ย ย { id: 'miner', name: 'Thแปฃ mแป', desc: 'ฤรo 100 lแบงn', req: (s)=>s.mining>=100, reward: {type:'item', id:'stardust', qty:5} },
ย ย { id: 'spender', name: 'Dรขn chฦกi', desc: 'Tiรชu 5000 Coins', req: (s)=>s.spent>=5000, reward: {type:'item', id:'amulet-coin', qty:1} },
ย ย { id: 'rich', name: 'Nhร Giรu', desc: 'Cรณ 20,000 Coins', req: (s)=>coins>=20000, reward: {type:'item', id:'nugget', qty:1} },
ย ย { id: 'breaker', name: 'Kแบป Phรก Gym', desc: 'Thแบฏng Gym 5 lแบงn', req: (s)=>s.hardWins>=5, reward: {type:'item', id:'rare-candy', qty:1} },
ย ย { id: 'champion', name: 'Vรด ฤแปch', desc: 'Thแบฏng Gym 20 lแบงn', req: (s)=>s.hardWins>=20, reward: {type:'item', id:'master-ball', qty:1} },
ย ย { id: 'hoarder', name: 'Tรบi Ba Gang', desc: 'Tรบi chแปฉa 50 Pokemon', req: (s)=>myBag.length>=50, reward: {type:'item', id:'great-ball', qty:10} },

ย ย // --- MแปI THรM VรO (NEW) ---
ย ย { id: 'tycoon', name: 'Tแปท Phรบ', desc: 'Sแป hแปฏu 100,000 Coins', req: (s)=>coins>=100000, reward: {type:'item', id:'master-ball', qty:2} },
ย ยย
ย ย { id: 'expert_miner', name: 'Trรนm ฤรo Mแป', desc: 'ฤรo 500 lแบงn', req: (s)=>s.mining>=500, reward: {type:'item', id:'nugget', qty:5} },
ย ยย
ย ย { id: 'shiny_king', name: 'Vua Shiny', desc: 'Bแบฏt ฤฦฐแปฃc 5 Pokemon Shiny', req: (s)=>s.shinies>=5, reward: {type:'item', id:'mystery-egg', qty:1} },
ย ยย
ย ย { id: 'powerhouse', name: 'Sแปฉc Mแบกnh', desc: 'Cรณ 1 Pokemon ฤแบกt Level 50', req: (s)=>myBag.some(p => p.level >= 50), reward: {type:'item', id:'rare-candy', qty:5} },
ย ยย
ย ย { id: 'legend', name: 'Huyแปn Thoแบกi', desc: 'Sแป hแปฏu 1 Pokemon Huyแปn Thoแบกi', req: (s)=>myBag.some(p => LEGENDARY_IDS.includes(p.id)), reward: {type:'item', id:'master-ball', qty:1} }
];
ย ย const SHOP_DB = [
ย ย ย ย { id: 'poke-ball', name: 'Pokรฉ Ball', price: 200, type: 'ball', rate: 0.30, img: 'poke-ball.png' },
ย ย ย ย { id: 'great-ball', name: 'Great Ball', price: 600, type: 'ball', rate: 0.50, img: 'great-ball.png' },
ย ย ย ย { id: 'ultra-ball', name: 'Ultra Ball', price: 1500, type: 'ball', rate: 0.75, img: 'ultra-ball.png' },
ย ย ย ย { id: 'master-ball', name: 'Master Ball', price: 100000, type: 'ball', rate: 1.0, img: 'master-ball.png' },
ย ย ย ย { id: 'potion', name: 'Potion', price: 300, type: 'item', desc: 'Hแปi 50 HP (Chแป dรนng trong Battle)', img: 'potion.png' },
ย ย ย ย { id: 'super-potion', name: 'Super Potion', price: 500, type: 'item', desc: 'Hแปi Full HP (Chแป dรนng trong Battle)', img: 'super-potion.png' },
ย ย ย ย { id: 'rare-candy', name: 'Rare Candy', price: 3000, type: 'item', desc: '+1 Level', img: 'rare-candy.png' },ย
ย ย ย ย { id: 'mystery-egg', name: 'Mystery Egg', price: 1000, type: 'item', desc: 'แบคp nแป thรบ hiแบฟm', img: 'lucky-egg.png' },ย
ย ย ย ย { id: 'razz-berry', name: 'Razz Berry', price: 150, type: 'item', desc: '+15% Rate', img: 'razz-berry.png' },
ย ย ย ย { id: 'lucky-egg', name: 'Lucky Egg', price: 300, type: 'item', desc: 'x2 Coins', img: 'lucky-egg.png' },
ย ย ย ย { id: 'incense', name: 'Incense', price: 200, type: 'item', desc: 'Reroll', img: 'super-repel.png' },
ย ย ย ย { id: 'evo-stone', name: 'Evo Stone', price: 1000, type: 'item', desc: 'Tiแบฟn hรณa', img: 'fire-stone.png' },
ย ย ย ย { id: 'amulet-coin', name: 'Amulet Coin', price: 5000, type: 'item', desc: '+5% Coin/Catch (Max 10)', img: 'amulet-coin.png' },
ย ย ย ย { id: 'nugget', name: 'Nugget', price: 5000, type: 'sell', desc: 'Bรกn lแบฅy tiแปn', img: 'nugget.png' },
ย ย ย ย { id: 'shiny-charm', name: 'Shiny Charm', price: 1000000, type: 'item', desc: 'Tฤng 3x tแป lแป gแบทp Shiny (Vฤฉnh viแปn)', img: 'shiny-charm.png' },
ย ย ย ย { id: 'stardust', name: 'Stardust', price: 1000, type: 'sell', desc: 'Bรกn lแบฅy tiแปn', img: 'stardust.png' }
ย ย ย ยย
ย ย ];
ย ย // --- Dแปฎ LIแปU CรU HแปI SแปฌA CรP ---
const REPAIR_QUESTIONS = [
ย ย { q: "1 + 1 = ?", a: ["2", "3", "11", "0"], correct: 0 },
ย ย { q: "2 x 3 = ?", a: ["5", "6", "9", "12"], correct: 1 },
ย ย { q: "Pokemon nรo mรu vรng?", a: ["Bulbasaur", "Charmander", "Pikachu", "Squirtle"], correct: 2 },
ย ย { q: "Mแบทt trแปi mแปc hฦฐแปng nรo?", a: ["Tรขy", "Bแบฏc", "Nam", "ฤรดng"], correct: 3 },
ย ย { q: "10 - 5 = ?", a: ["2", "5", "10", "15"], correct: 1 },
ย ย { q: "Cรก sแปng แป ฤรขu?", a: ["Trรชn cรขy", "Dฦฐแปi ฤแบฅt", "Dฦฐแปi nฦฐแปc", "Trong lแปญa"], correct: 2 },
ย ย { q: "5 x 5 = ?", a: ["10", "20", "25", "55"], correct: 2 },
ย ย { q: "Nฦฐแปc sรดi แป bao nhiรชu ฤแป?", a: ["50ยฐC", "90ยฐC", "100ยฐC", "1000ยฐC"], correct: 2 },
ย ย { q: "Con gรฌ gรกy รฒ รณ o?", a: ["Chรณ", "Mรจo", "Gร trแปng", "Vแปt"], correct: 2 },
ย ย { q: "Pokemon hแป Lแปญa sแปฃ hแป gรฌ?", a: ["Cแป", "Nฦฐแปc", "Bฤng", "Tiรชn"], correct: 1 }
];
ย ย // --- BIแบพN TRแบNG THรI CHแปN NHIแปU ---
ย ย let stamina = 100;
ย ย let usedCodes = [];
ย ย let towerData = {
ย ย floor: 1,ย ย ย ย ย ย// Tแบงng hiแปn tแบกi
ย ย tokens: 0,ย ย ย ย ย // Tiแปn thรกp
ย ย teamIndices: [],ย ย // Index cแปงa 6 con Pokemon leo thรกp
ย ย bestRecord: 0ย ย ย ย// Kแปท lแปฅc cao nhแบฅt
ย ย };
ย ย let lastStaminaTime = Date.now();
ย ย const MAX_STAMINA = 100;
ย ย let bossTeamIndices = [];
ย ย let limitedShopHistory = {};
ย ย let isSelectMode = false;
ย ย let selectedIndices = new Set(); // Dรนng Set ฤแป lฦฐu index khรดng bแป trรนng
ย ย let quizStreak = 0;
ย ย let dailyQuizStatus = { date: "", milestones: [] };
ย ย let coins = 5000; let myBag = []; let pokedex = new Set(); let inventory = { 'poke-ball': 20, 'potion': 5, 'bag-upgrade': 0 }; let lastDailyDate = "";
ย ย let userStats = { catches: 0, spent: 0, hardWins: 0, mining: 0, shinies: 0 };
ย ย let completedAchievements = []; let gymProgress = 0; let maxBagSize = 200; let pickaxe = { durability: 30, max: 30 }; let dailyRepairs = { date: "", count: 0 };
ย ย let dailyQuests = [];
ย ย let daycare = { unlocked: 1, slots: [{pokemon: null, depositTime: 0}] };
ย ย const DAYCARE_PRICES = [0, 5000, 15000, 50000, 100000];

ย ย let currentWild = null; let streakBonus = 0; let activeBuffs = { berry: false, egg: false }; let selectedItemId = null; let selectedBattleIdx = null;

ย ย let battleState = { active: false, player: null, enemy: null, turn: 0, difficulty: 'easy', rewards: {xp:0, coin:0}, finished: false };

ย ย function getRarity(p) {ย
ย ย ย ย if(p.isEgg) return {label:'EGG',class:'r-common',val:0};ย
ย ย ย ย if(p.isShiny) return {label:'SHINY',class:'r-shiny',val:5};ย
ย ย ย ย if(LEGENDARY_IDS.includes(p.id)) return {label:'LEGENDARY',class:'r-legendary',val:4};ย
ย ย ย ย if(p.baseXp>=200) return {label:'SUPER RARE',class:'r-superrare',val:3};ย
ย ย ย ย if(p.baseXp>=140) return {label:'RARE',class:'r-rare',val:2};ย
ย ย ย ย if(p.baseXp>=60) return {label:'UNCOMMON',class:'r-uncommon',val:1};ย
ย ย ย ย return {label:'COMMON',class:'r-common',val:0};ย
ย ย }

ย ย function calculateMaxHp(base, iv, level) {ย
ย ย ย ย if(isNaN(base) || isNaN(iv) || isNaN(level)) return 100;
ย ย ย ย return Math.floor(((2 * base + iv) * level) / 100) + level + 10;ย
ย ย }
ย ย function calculateStat(base, iv, level) {ย
ย ย ย ย if(isNaN(base) || isNaN(iv) || isNaN(level)) return 10;
ย ย ย ย return Math.floor(((2 * base + iv) * level) / 100) + 5;ย
ย ย }

ย ย // --- CแบฌP NHแบฌT TรNH CHแป Sแป (Cร SHADOW/RAINBOW) ---
function recalcStats(p) {
ย ย let bHp = p.baseHp || 45; let bAtk = p.baseAtk || 49; let bDef = p.baseDef || 49;ย
ย ย let bSpA = p.baseSpA || 65; let bSpD = p.baseSpD || 65; let bSpd = p.baseSpd || 45;
ย ยย
ย ย // Tรญnh chแป sแป cฦก bแบฃn
ย ย p.maxHp = calculateMaxHp(bHp, p.iv, p.level);
ย ย p.atk = calculateStat(bAtk, p.iv, p.level);
ย ย p.def = calculateStat(bDef, p.iv, p.level);
ย ย p.spA = calculateStat(bSpA, p.iv, p.level);
ย ย p.spD = calculateStat(bSpD, p.iv, p.level);
ย ย p.spd = calculateStat(bSpd, p.iv, p.level);

ย ย // --- รP DแปคNG MODIFIER CHO BIแบพN THแป ---
ย ย if (p.isShadow) {
ย ย ย ย // Shadow: Cรดng x1.2, Thแปง/Mรกu x0.8 (Glass Cannon)
ย ย ย ย p.atk = Math.floor(p.atk * 1.3); // Tฤng 30% Attack
ย ย ย ย p.spA = Math.floor(p.spA * 1.3); // Tฤng 30% Sp.Atk
ย ย ย ย p.def = Math.floor(p.def * 0.8); // Giแบฃm 20% Def
ย ย ย ย p.spD = Math.floor(p.spD * 0.8); // Giแบฃm 20% Sp.Def
ย ย ย ย p.maxHp = Math.floor(p.maxHp * 0.9); // Giแบฃm 10% HP
ย ย } else if (p.isRainbow) {
ย ย ย ย // Rainbow: Toรn bแป chแป sแป x1.15 (Siรชu mแบกnh)
ย ย ย ย p.maxHp = Math.floor(p.maxHp * 1.15);
ย ย ย ย p.atk = Math.floor(p.atk * 1.15);
ย ย ย ย p.def = Math.floor(p.def * 1.15);
ย ย ย ย p.spA = Math.floor(p.spA * 1.15);
ย ย ย ย p.spD = Math.floor(p.spD * 1.15);
ย ย ย ย p.spd = Math.floor(p.spd * 1.15);
ย ย }
ย ย // --------------------------------------

ย ย // Reset status
ย ย if(!p.status) p.status = null;
ย ย if(!p.stages) p.stages = { atk:0, def:0, spA:0, spD:0, spd:0, acc:0 };

ย ย if(p.hp > p.maxHp || isNaN(p.hp)) p.hp = p.maxHp;
}
ย ย // Cแบญp nhแบญt hรm phรขn phรกt chiรชu ฤแป Pokemon cรณ chiรชu Status/Stat
ย ย function assignMoves(p) {
ย ย // Nแบฟu Pokemon ฤรฃ cรณ chiรชu rแปi thรฌ thรดi (trรกnh reset chiรชu khi load game)
ย ย if(p.moves && p.moves.length > 0) return;

ย ย let mainType = p.types[0];
ย ย let moves = [];
ย ยย
ย ย // Mแบทc ฤแปnh luรดn cรณ Tackle
ย ย moves.push(getMoveData('Tackle'));

ย ย // Lแบฅy chiรชu Level 1 cแปงa hแป ฤรณ (nแบฟu cรณ)
ย ย let learnset = getLearnsetForType(mainType);
ย ย if(learnset[1]) {
ย ย ย ย let m = getMoveData(learnset[1]);
ย ย ย ย if(m.name !== 'Tackle') moves.push(m);
ย ย }

ย ย p.moves = moves;
}
ย ย // --- HรM Tแปฐ ฤแปNG SแปฌA LแปI & CแบฌP NHแบฌT CHIรU CHO POKEMON Cลจ ---
function ensureDataIntegrity(p) {
ย ย // 1. Fix chแป sแป cลฉ
ย ย if(!p.spA || !p.spD) {ย
ย ย ย ย p.baseSpA = p.baseAtk || 50;ย
ย ย ย ย p.baseSpD = p.baseDef || 50;ย
ย ย ย ย recalcStats(p);ย
ย ย }

ย ย // 2. Khแปi tแบกo mแบฃng moves
ย ย if (!p.moves) p.moves = [];

ย ย // 3. LOGIC MแปI: Nแบฟu thiแบฟu chiรชu -> Gแปi hรm chแบกy ngแบงm ฤแป ฤiแปn chiรชu chuแบฉn
ย ย if (p.moves.length < 4) {
ย ย ย ย // Gแปi hรm async nhฦฐng KHรNG dรนng await ฤแป trรกnh lรm ฤฦก giao diแปn tรบi ฤแป
ย ย ย ย // Nรณ sแบฝ tแปฑ ฤแปng cแบญp nhแบญt ngแบงm vร lฦฐu lแบกi sau vรi giรขy
ย ย ย ย backfillMovesForOldPokemon(p);
ย ย }
}
// --- HรM PHแปค: TรM CHIรU PHร HแปขP ฤแป DแบY ---
function autoLearnMovesForOldPokemon(p) {
ย ย let type = p.types[0]; // Lแบฅy hแป chรญnh
ย ยย
ย ย // Lแบฅy tแบฅt cแบฃ chiรชu cแปงa hแป ฤรณ + hแป Normal
ย ย let pool = ALL_MOVES.filter(m => m.type === type || m.type === 'normal');
ย ยย
ย ย // Sแบฏp xแบฟp chiรชu theo sแปฉc mแบกnh (Mแบกnh nhแบฅt lรชn ฤแบงu)
ย ย // ฤแป ฦฐu tiรชn dแบกy chiรชu xแปn cho Pokemon level cao
ย ย pool.sort((a, b) => (b.pwr || 0) - (a.pwr || 0));

ย ย // Duyแปt qua danh sรกch chiรชu
ย ย for (let move of pool) {
ย ย ย ย // Nแบฟu ฤรฃ ฤแปง 4 chiรชu thรฌ dแปซng
ย ย ย ย if (p.moves.length >= 4) break;

ย ย ย ย // Kiแปm tra ฤiแปu kiแปn Level giแบฃ lแบญp (Chiรชu mแบกnh cแบงn level cao)
ย ย ย ย // Vรญ dแปฅ: Chiรชu Power > 80 cแบงn Lv 30+, Power > 60 cแบงn Lv 15+
ย ย ย ย let reqLv = 1;
ย ย ย ย if (move.pwr >= 100) reqLv = 45;
ย ย ย ย else if (move.pwr >= 80) reqLv = 30;
ย ย ย ย else if (move.pwr >= 60) reqLv = 15;

ย ย ย ย // Nแบฟu Level ngฦฐแปi chฦกi ฤแปง & Chฦฐa hแปc chiรชu nรy -> Dแบกy luรดn
ย ย ย ย if (p.level >= reqLv) {
ย ย ย ย ย ย // Kiแปm tra trรนng
ย ย ย ย ย ย if (!p.moves.some(existing => existing.name === move.name)) {
ย ย ย ย ย ย ย ย p.moves.push(move);
ย ย ย ย ย ย }
ย ย ย ย }
ย ย }
ย ยย
ย ย // Nแบฟu sau khi quรฉt mร vแบซn chฦฐa cรณ chiรชu nรo (Level 1), dแบกy Tackle
ย ย if (p.moves.length === 0) {
ย ย ย ย let tackle = ALL_MOVES.find(m => m.name === 'Tackle');
ย ย ย ย if(tackle) p.moves.push(tackle);
ย ย }
}
ย ย function handleEnter(e) { if(e.key === 'Enter') login(); }
ย ย // --- HรM ฤฤNG Kร (ฤร Cร CHECK TRรNG TรN) ---
async function register() {
ย ย let u = document.getElementById('username-input').value.trim();
ย ย const p = document.getElementById('password-input').value.trim();
ย ยย
ย ย // รp vแป chแปฏ hoa/thฦฐแปng thแปng nhแบฅt ฤแป trรกnh trรนng kiแปu "Admin" vร "admin"
ย ย // (แป ฤรขy mรฌnh รฉp vแป viแบฟt hoa hแบฟt cho ฤแปng bแป)
ย ย u = u;ย

ย ย if (!u || !p) return alert("Thiแบฟu thรดng tin!");
ย ย if (u.length < 3) return alert("Tรชn quรก ngแบฏn!");

ย ย // 1. Kiแปm tra xem tรชn ฤรฃ tแปn tแบกi chฦฐa
ย ย const snapshot = await firebase.database().ref('users/' + u).once('value');
ย ยย
ย ย if (snapshot.exists()) {
ย ย ย ย // NแบพU ฤร Cร -> BรO LแปI NGAY
ย ย ย ย alert("โ Tรชn nรy ฤรฃ cรณ ngฦฐแปi dรนng! Vui lรฒng chแปn tรชn khรกc.");
ย ย } else {
ย ย ย ย // NแบพU CHฦฏA Cร -> TแบO MแปI
ย ย ย ย // Tแบกo account vแปi mแบญt khแบฉu
ย ย ย ย await firebase.database().ref('accounts/' + u).set({
ย ย ย ย ย ย password: p,
ย ย ย ย ย ย createdAt: Date.now()
ย ย ย ย });
ย ย ย ยย
ย ย ย ย // Tแบกo dแปฏ liแปu game khแปi ฤแบงu
ย ย ย ย await firebase.database().ref('users/' + u).set({
ย ย ย ย ย ย coins: 5000,
ย ย ย ย ย ย level: 1,
ย ย ย ย ย ย // ... cรกc chแป sแป khแปi ฤแบงu khรกc
ย ย ย ย });
ย ย ย ยย
ย ย ย ย alert("โ ฤฤng kรฝ thรnh cรดng! Hรฃy ฤฤng nhแบญp.");
ย ย }
}
ย ย // Thay thแบฟ hรm login cลฉ bแบฑng hรm nรy
// --- CแบฌP NHแบฌT HรM LOGIN ฤแป CHแป Dแปฎ LIแปU ---
// --- CแบฌP NHแบฌT HรM LOGIN (SแปฌA LแปI KHรNG ฤฤNG NHแบฌP ฤฦฏแปขC) ---
// --- HรM ฤฤNG NHแบฌP (ฤร SแปฌA LแปI) ---
async function login() {
ย ย // 1. Lแบฅy dแปฏ liแปu ngฦฐแปi dรนng nhแบญp (chแป cแบฏt khoแบฃng trแบฏng thแปซa 2 ฤแบงu)
ย ย let u = document.getElementById('username-input').value.trim();
ย ย const p = document.getElementById('password-input').value.trim();
ย ย const btn = document.querySelector('.btn-login');

ย ย if (!u || !p) return alert("Vui lรฒng nhแบญp tรชn vร mแบญt khแบฉu!");

ย ย // โ ฤร XรA DรNG u = u.toUpperCase();ย
ย ย // Giแป ฤรขy bแบกn nhแบญp "Nguyen" thรฌ code sแบฝ tรฌm "Nguyen", nhแบญp "admin" tรฌm "admin"

ย ย if(btn) btn.innerText = "ฤang kiแปm tra...";

ย ย try {
ย ย ย ย // 2. Tรฌm tรi khoแบฃn trรชn Firebase
ย ย ย ย const snapshot = await firebase.database().ref('accounts/' + u).once('value');
ย ย ย ย const acc = snapshot.val();

ย ย ย ย // 3. Kiแปm tra kแบฟt quแบฃ
ย ย ย ย if (acc) {
ย ย ย ย ย ย if (acc.password === p) {
ย ย ย ย ย ย ย ย // ฤฤng nhแบญp thรnh cรดng -> Gแปi hรm vรo game
ย ย ย ย ย ย ย ย loginSuccess(u);
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย alert("โ Sai mแบญt khแบฉu!");
ย ย ย ย ย ย ย ย if(btn) btn.innerText = "ฤฤNG NHแบฌP";
ย ย ย ย ย ย }
ย ย ย ย } else {
ย ย ย ย ย ย // Khรดng tรฌm thแบฅy tรชn chรญnh xรกc -> Bรกo lแปi
ย ย ย ย ย ย alert(`โ Tรi khoแบฃn "${u}" khรดng tแปn tแบกi!`);ย
ย ย ย ย ย ย if(btn) btn.innerText = "ฤฤNG NHแบฌP";
ย ย ย ย }

ย ย } catch (err) {
ย ย ย ย console.error("Lแปi ฤฤng nhแบญp:", err);
ย ย ย ย alert("Lแปi kแบฟt nแปi: " + err.message);
ย ย ย ย if(btn) btn.innerText = "ฤฤNG NHแบฌP";
ย ย }
}

// Hรm phแปฅ ฤแป vรo game (cho gแปn)
async function loginSuccess(user) {
ย ย currentUser = user;
ย ย document.getElementById('display-username').innerText = user;
ย ย document.querySelector('.btn-login').innerText = "ฤang tแบฃi dแปฏ liแปu...";
ย ยย
ย ย await loadGame(); // Tแบฃi dแปฏ liแปu game
ย ยย
ย ย document.getElementById('login-screen').style.display = 'none';
ย ย document.getElementById('app').style.display = 'flex';
ย ย document.querySelector('.btn-login').innerText = "ฤฤNG NHแบฌP";
ย ยย
ย ย // Kiแปm tra xem cรณ phแบฃi Admin khรดng ฤแป hiแปn nรบt cรดng cแปฅ
ย ย if (typeof checkAdminPrivileges === 'function') checkAdminPrivileges();
}
ย ย function logout() { saveGame(); location.reload(); }

ย ยfunction saveGame() {
ย ย if (!currentUser) return;
ย ย const dataToSave = {
ย ย ย ย coins: coins,
ย ย ย ย myBag: myBag,
ย ย ย ย usedCodes: usedCodes,
ย ย ย ย towerData: towerData,
ย ย ย ย limitedShopHistory: limitedShopHistory,
ย ย ย ย pokedex: Array.from(pokedex),
ย ย ย ย inventory: inventory,
ย ย ย ย lastDailyDate: lastDailyDate,
ย ย ย ย trainerData: trainerData,
ย ย ย ย currentZone: currentZone,
ย ย ย ย dailyQuizStatus: dailyQuizStatus,
ย ย ย ย userStats: userStats,
ย ย ย ย stamina: stamina,
ย ย ย ย lastStaminaTime: lastStaminaTime,
ย ย ย ย bossTeamIndices: bossTeamIndices,
ย ย ย ย completedAchievements: completedAchievements,
ย ย ย ย daycare: daycare,
ย ย ย ย gymProgress: gymProgress,
ย ย ย ย maxBagSize: maxBagSize,
ย ย ย ย pickaxe: pickaxe,
ย ย ย ย dailyRepairs: dailyRepairs,
ย ย ย ย dailyQuests: dailyQuests
ย ย };
ย ย firebase.database().ref('users/' + currentUser).set(dataToSave)
ย ย ย ย .then(() => console.log("Saved to Firebase"))
ย ย ย ย .catch((e) => console.error("Save error:", e));
}
ย ยย
ย ยasync function loadGame() {
ย ย if (!currentUser) return;

ย ย // Hiแปn thแป thรดng bรกo ฤang tแบฃi
ย ย const controlsDiv = document.getElementById('controls');
ย ย if(controlsDiv) controlsDiv.innerHTML = '<div style="color:yellow; padding:10px">โ๏ธ ฤang ฤแปng bแป dแปฏ liแปu mรกy chแปง...</div>';

ย ย try {
ย ย ย ย // 1. Thแปญ lแบฅy dแปฏ liแปu tแปซ Firebase
ย ย ย ย const snapshot = await firebase.database().ref('users/' + currentUser).once('value');
ย ย ย ย let d = snapshot.val();
ย ย ย ย let source = "server"; // ฤรกnh dแบฅu nguแปn dแปฏ liแปu

ย ย ย ย // 2. LOGIC MIGRATION: Nแบฟu trรชn mแบกng chฦฐa cรณ (null), kiแปm tra dแปฏ liแปu cลฉ trong mรกy
ย ย ย ย if (!d) {
ย ย ย ย ย ย console.log("Dแปฏ liแปu trรชn server trแปng. Kiแปm tra LocalStorage...");
ย ย ย ย ย ย const localData = localStorage.getItem(BASE_SAVE_KEY + currentUser);
ย ย ย ย ย ย if (localData) {
ย ย ย ย ย ย ย ย d = JSON.parse(localData);
ย ย ย ย ย ย ย ย source = "local";
ย ย ย ย ย ย ย ย console.log("Tรฌm thแบฅy dแปฏ liแปu cลฉ! ฤang di chuyแปn lรชn server...");
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย // 3. Nแบกp dแปฏ liแปu (Nแบฟu cรณ d)
ย ย ย ย if (d) {
ย ย ย ย ย ย coins = d.coins || 0;
ย ย ย ย ย ย myBag = d.myBag || [];
ย ย ย ย ย ย pokedex = new Set(d.pokedex || []);
ย ย ย ย ย ย inventory = { ...inventory, ...d.inventory };
ย ย ย ย ย ย lastDailyDate = d.lastDailyDate || "";
ย ย ย ย ย ย if (d.limitedShopHistory) limitedShopHistory = d.limitedShopHistory;
ย ย ย ย ย ย if (typeof d.stamina !== 'undefined') stamina = d.stamina;
ย ย ย ย ย ย if (d.trainerData) trainerData = d.trainerData;
ย ย ย ย ย ย if (d.currentZone) currentZone = d.currentZone;
ย ย ย ย ย ย updateTrainerUI();
ย ย ย ย ย ย if (d.towerData) {
ย ย ย ย ย ย towerData = d.towerData;
ย ย // Fix lแปi nแบฟu data cลฉ thiแบฟu field
ย ย ย ย ย ย if(!towerData.floor) towerData.floor = 1;
ย ย ย ย ย ย if(!towerData.tokens) towerData.tokens = 0;
ย ย ย ย ย ย if(!towerData.teamIndices) towerData.teamIndices = [];
ย ย ย ย ย ย }
ย ย ย ย ย ย if (d.lastStaminaTime) lastStaminaTime = d.lastStaminaTime;
ย ย ย ย ย ย if (d.bossTeamIndices) bossTeamIndices = d.bossTeamIndices;

ย ย ย ย ย ย ย ย // Tรญnh toรกn Stamina hแปi phแปฅc trong lรบc offline
ย ย ย ย ย ย calculateOfflineStamina();
ย ย ย ย ย ย if (d.dailyQuizStatus) dailyQuizStatus = d.dailyQuizStatus;
ย ย ย ย ย ย if (d.userStats) userStats = d.userStats;
ย ย ย ย ย ย if (d.usedCodes) usedCodes = d.usedCodes;
ย ย ย ย ย ย// --- SแปฌA LแปI MแบคT THรNH TแปฐU (QUAN TRแปNG) ---
ย ย ย ย ย ย if (d.completedAchievements) {
ย ย ย ย ย ย ย ย // Kiแปm tra: Nแบฟu Firebase trแบฃ vแป dแบกng Object, รฉp nรณ vแป Array
ย ย ย ย ย ย ย ย if (Array.isArray(d.completedAchievements)) {
ย ย ย ย ย ย ย ย ย ย completedAchievements = d.completedAchievements;
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย // Chuyแปn Object {0: "id1", 1: "id2"} thรnh Array ["id1", "id2"]
ย ย ย ย ย ย ย ย ย ย completedAchievements = Object.values(d.completedAchievements);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย completedAchievements = [];
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย // ฤแบฃm bแบฃo userStats khรดng bแป thiแบฟu chแป sแป (gรขy lแปi hiแปn thแป tiแบฟn ฤแป)
ย ย ย ย ย ย if (d.userStats) {
ย ย ย ย ย ย ย ย userStats = d.userStats;
ย ย ย ย ย ย ย ย if(!userStats.catches) userStats.catches = 0;
ย ย ย ย ย ย ย ย if(!userStats.spent) userStats.spent = 0;
ย ย ย ย ย ย ย ย if(!userStats.hardWins) userStats.hardWins = 0;
ย ย ย ย ย ย ย ย if(!userStats.mining) userStats.mining = 0;
ย ย ย ย ย ย ย ย if(!userStats.shinies) userStats.shinies = 0;
ย ย ย ย ย ย }
ย ย ย ย ย ย // ------------------------------------------
ย ย ย ย ย ย if (d.gymProgress) gymProgress = d.gymProgress;
ย ย ย ย ย ยif (d.maxBagSize) {
ย ย ย ย ย ย ย ย // Nแบฟu dแปฏ liแปu cลฉ nhแป hฦกn 500, tแปฑ ฤแปng nรขng lรชn 500
ย ย ย ย ย ย ย ย if (d.maxBagSize < 500) {
ย ย ย ย ย ย ย ย ย ย maxBagSize = 500;
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย maxBagSize = d.maxBagSize;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย maxBagSize = 500; // Mแบทc ฤแปnh cho ngฦฐแปi mแปi
ย ย ย ย ย ย }
ย ย ย ย ย ย if (d.pickaxe) pickaxe = d.pickaxe;
ย ย ย ย ย ย if (d.dailyRepairs) dailyRepairs = d.dailyRepairs;
ย ย ย ย ย ยย
ย ย ย ย ย ย if (d.dailyQuests && Array.isArray(d.dailyQuests)) dailyQuests = d.dailyQuests;ย
ย ย ย ย ย ย else dailyQuests = [];

ย ย ย ย ย ย // --- SแปฌA LแปI DAYCARE (Load slot chuแบฉn xรกc) ---
ย ย ย ย ย ย if (d.daycare) {
ย ย ย ย ย ย ย ย // 1. Lแบฅy sแป slot ฤรฃ mแป (Nแบฟu khรดng cรณ thรฌ mแบทc ฤแปnh lร 1)
ย ย ย ย ย ย ย ย let loadedUnlocked = d.daycare.unlocked || 1;
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // 2. Xแปญ lรฝ danh sรกch Slots (Chแปng lแปi Object/Array)
ย ย ย ย ย ย ย ย let loadedSlots = [];
ย ย ย ย ย ย ย ย if (d.daycare.slots) {
ย ย ย ย ย ย ย ย ย ย if (Array.isArray(d.daycare.slots)) {
ย ย ย ย ย ย ย ย ย ย ย ย loadedSlots = d.daycare.slots;
ย ย ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย ย ย // รp kiแปu Object {0:{...}, 1:{...}} vแป Mแบฃng [{...}, {...}]
ย ย ย ย ย ย ย ย ย ย ย ย loadedSlots = Object.values(d.daycare.slots);
ย ย ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย // Nแบฟu mแบฅt dแปฏ liแปu slots, tแบกo slot trแปng
ย ย ย ย ย ย ย ย ย ย loadedSlots = [{pokemon: null, depositTime: 0}];
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย // 3. ฤแบฃm bแบฃo sแป lฦฐแปฃng slot khแปp vแปi sแป ฤรฃ mแป
ย ย ย ย ย ย ย ย // (Vรญ dแปฅ: Mแป 3 slot mร dแปฏ liแปu chแป cรฒn 1 -> Tแปฑ bรน thรชm 2 slot trแปng)
ย ย ย ย ย ย ย ย while(loadedSlots.length < loadedUnlocked) {
ย ย ย ย ย ย ย ย ย ย loadedSlots.push({pokemon: null, depositTime: 0});
ย ย ย ย ย ย ย ย }

ย ย ย ย ย ย ย ย // 4. Gรกn vรo biแบฟn toรn cแปฅc
ย ย ย ย ย ย ย ย daycare = {
ย ย ย ย ย ย ย ย ย ย unlocked: loadedUnlocked,
ย ย ย ย ย ย ย ย ย ย slots: loadedSlots
ย ย ย ย ย ย ย ย };
ย ย ย ย ย ย }
ย ย ย ย ย ย // ---------------------------------------------

ย ย ย ย ย ย // --- FIX DATA & NรNG CแบคP (Giแปฏ nguyรชn logic cแปงa bแบกn) ---
ย ย ย ย ย ย myBag = myBag.filter(p => p && p.name && p.name !== 'undefined');
ย ย ย ย ย ย let fixCount = 0;
ย ย ย ย ย ย myBag.forEach(p => {
ย ย ย ย ย ย ย ย if (!p.isEgg) {
ย ย ย ย ย ย ย ย ย ย if (isNaN(p.hp)) p.hp = p.maxHp;
ย ย ย ย ย ย ย ย ย ย if (isNaN(p.maxHp)) recalcStats(p);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย if (!p.stages) p.stages = { atk: 0, def: 0, spA: 0, spD: 0, spd: 0, acc: 0 };
ย ย ย ย ย ย ย ย if (!p.status) p.status = null;
ย ย ย ย ย ย ย ย recalcStats(p);ย
ย ย ย ย ย ย ย ย if (p.moves && p.moves.length > 0 && typeof p.moves[0].priority === 'undefined') assignMoves(p);
ย ย ย ย ย ย });
ย ย ย ย ย ย // --------------------------------------------------------

ย ย ย ย ย ย // 4. Nแบฟu dแปฏ liแปu lแบฅy tแปซ Local (Migration), thรฌ LฦฏU NGAY lรชn Server
ย ย ย ย ย ย if (source === "local") {
ย ย ย ย ย ย ย ย saveGame(); // ฤแบฉy lรชn Firebase
ย ย ย ย ย ย ย ย alert("ฤรฃ chuyแปn dแปฏ liแปu cลฉ lรชn Online thรnh cรดng!");
ย ย ย ย ย ย }

ย ย ย ย } else {
ย ย ย ย ย ย console.log("Chรo mแปซng ngฦฐแปi chฦกi mแปi (hoแบทc dแปฏ liแปu ฤรฃ mแบฅt).");
ย ย ย ย }

ย ย ย ย // 5. Hoรn tแบฅt
ย ย ย ย makeDraggable('btn-chat-float');
ย ย ย ย checkDailyQuestGen();
ย ย ย ย updateStats();
ย ย ย ย updateZoneNameUI();
ย ย ย ย initOnlineSystem();
ย ย ย ย initAdminListener();
ย ย ย ย checkAdminPrivileges();
ย ย ย ย playBGM('map');
ย ย ย ย showMenu(); // Hiแปn lแบกi menu
ย ย ย ย showUpdateLog();

ย ย } catch (error) {
ย ย ย ย console.error("Lแปi tแบฃi game:", error);
ย ย ย ย alert("Lแปi kแบฟt nแปi! Vui lรฒng kiแปm tra mแบกng hoแบทc F12 xem console.");
ย ย ย ย // Nแบฟu lแปi mแบกng, cแป gแบฏng load tแบกm tแปซ local ฤแป chฦกi offline (tรนy chแปn)
ย ย ย ย showMenu();
ย ย }
}
ย ยย
ย ย function resetGame() { if(confirm("Xรณa dแปฏ liแปu?")) { localStorage.removeItem(BASE_SAVE_KEY+currentUser); logout(); } }

ย ย const chat = document.getElementById('chat-area'), controls = document.getElementById('controls');
ย ย function log(h) { const d=document.createElement('div'); d.innerHTML=h; chat.appendChild(d); chat.scrollTop=chat.scrollHeight; }
ย ยย
ย ย function updateStats() {ย
ย ย ย ย document.getElementById('coin-display').innerText = coins.toLocaleString();
ย ย ย ย let h=''; if(activeBuffs.berry) h+=`<span style="background:#e91e63;color:white;padding:2px 5px;border-radius:3px">Berry</span> `;
ย ย ย ย if(activeBuffs.egg) h+=`<span style="background:#f1c40f;color:black;padding:2px 5px;border-radius:3px">x2 Coin</span>`;
ย ย ย ย if(inventory['amulet-coin'] > 0) h+= `<span style="background:#7289da;color:white;padding:2px 5px;border-radius:3px;margin-left:5px">Amulet x${inventory['amulet-coin']}</span>`;
ย ย ย ย document.getElementById('buff-bar').innerHTML = h;
ย ย ย ย const badgeBar = document.getElementById('badge-bar');
ย ย ย ย if(gymProgress > 0) {
ย ย ย ย ย ย badgeBar.style.display = 'flex';
ย ย ย ย ย ย let bHtml = '';
ย ย ย ย ย ย for(let i=0; i<gymProgress; i++) { bHtml += `<div class="badge-item" title="${GYM_DB[i].badge}">${GYM_DB[i].icon}</div>`; }
ย ย ย ย ย ย badgeBar.innerHTML = bHtml;
ย ย ย ย }
ย ย }
ย ยย
ย ย // Biแบฟn lฦฐu trแบกng thรกi Menu (ฤแป biแบฟt ฤang ฤรณng hay mแป)
let isMenuOpen = false;

function toggleMenu() {
ย ย isMenuOpen = !isMenuOpen;
ย ย const extraDiv = document.getElementById('extra-controls');
ย ย const menuBtn = document.getElementById('btn-menu-toggle');
ย ยย
ย ย if(isMenuOpen) {
ย ย ย ย extraDiv.style.display = 'flex';
ย ย ย ย menuBtn.innerHTML = 'โ ฤรณng';
ย ย ย ย menuBtn.style.background = '#7f8c8d';
ย ย } else {
ย ย ย ย extraDiv.style.display = 'none';
ย ย ย ย menuBtn.innerHTML = 'โฐ Menu';
ย ย ย ย menuBtn.style.background = '#34495e';
ย ย }
}

// --- MENU CHรNH (ฤรฃ xรณa nรบt Gรณp รฝ bแป thแปซa) ---
// --- MENU CHรNH (ฤร CแบฌP NHแบฌT NรT PC) ---
// --- MENU CHรNH (UPDATE GIAO DIแปN GแปN GรNG) ---
// --- Hแป THแปNG MENU TAB HIแปN ฤแบI ---
let currentMenuTab = 'battle'; // Mแบทc ฤแปnh vรo tab Chiแบฟn ฤแบฅu

function showMenu() {
ย ย // 1. ฤแปnh nghฤฉa dแปฏ liแปu cรกc nรบt cho tแปซng Tab
ย ย const MENU_DATA = {
ย ย ย ย 'battle': [
ย ย ย ย ย ย { name: "SฤN BแบฎT", icon: "๐", color: "#2ecc71", action: "hunt()" },
ย ย ย ย ย ย { name: "THรP", icon: "๐ผ", color: "#a29bfe", action: "openTower()" },
ย ย ย ย ย ย { name: "BOSS", icon: "โ๏ธ", color: "#ed4245", action: "openWorldBoss()" },
ย ย ย ย ย ย { name: "ARENA", icon: "โ๏ธ", color: "#e67e22", action: "openBattleModal(0)" } // (Mแป tแบกm vแปi con ฤแบงu tiรชn)
ย ย ย ย ],
ย ย ย ย 'city': [
ย ย ย ย ย ย { name: "SHOP", icon: "๐", color: "#f1c40f", action: "shop()" },
ย ย ย ย ย ย { name: "CHแปข ฤEN", icon: "โ๏ธ", color: "#9b59b6", action: "openMarket()" },
ย ย ย ย ย ย { name: "CENTER", icon: "๐ฅ", color: "#ff7675", action: "healAll()" },
ย ย ย ย ย ย { name: "JOB", icon: "๐ผ", color: "#74b9ff", action: "openJobs()" },
ย ย ย ย ย ย { name: "DAYCARE", icon: "๐ก", color: "#e91e63", action: "openDaycare()" },
ย ย ย ย ย ย { name: "QUร", icon: "๐", color: "#fd79a8", action: "openDaily()" }
ย ย ย ย ],
ย ย ย ย 'user': [
ย ย ย ย ย ย { name: "PC BOX", icon: "๐ป", color: "#3498db", action: "openBag()" },
ย ย ย ย ย ย { name: "TEAM", icon: "๐ฅ", color: "#00b894", action: "openTowerTeamSelect()" }, // Dรนng chung giao diแปn chแปn team
ย ย ย ย ย ย { name: "POKEDEX", icon: "๐", color: "#0984e3", action: "showPokedex()" },
ย ย ย ย ย ย { name: "CรP", icon: "๐", color: "#ffeaa7", action: "openAchieve()" }
ย ย ย ย ],
ย ย ย ย 'social': [
ย ย ย ย ย ย { name: "BXH", icon: "๐ฅ", color: "#fab1a0", action: "openLeaderboard()" },
ย ย ย ย ย ย { name: "CHAT", icon: "๐ฌ", color: "#81ecec", action: "toggleChat()" },
ย ย ย ย ย ย { name: "CODE", icon: "๐๏ธ", color: "#55efc4", action: "openGiftCodeModal()" },
ย ย ย ย ย ย { name: "THOรT", icon: "๐ช", color: "#636e72", action: "logout()" }
ย ย ย ย ]
ย ย };

ย ย // 2. Tแบกo HTML cho cรกc nรบt bแบฅm (Grid)
ย ย let buttonsHtml = MENU_DATA[currentMenuTab].map(btn => `
ย ย ย ย <button class="menu-btn" onclick="${btn.action}" style="border-bottom: 2px solid ${btn.color}">
ย ย ย ย ย ย <span style="font-size:1.5em">${btn.icon}</span>
ย ย ย ย ย ย <span style="color:${btn.color}; font-weight:bold">${btn.name}</span>
ย ย ย ย </button>
ย ย `).join('');

ย ย // 3. Tแบกo HTML cho thanh Tab (Footer)
ย ย let tabsHtml = `
ย ย ย ย <button class="menu-tab-btn tab-battle ${currentMenuTab==='battle'?'active':''}" onclick="switchMenu('battle')">โ๏ธ Battle</button>
ย ย ย ย <button class="menu-tab-btn tab-city ${currentMenuTab==='city'?'active':''}" onclick="switchMenu('city')">๐๏ธ City</button>
ย ย ย ย <button class="menu-tab-btn tab-user ${currentMenuTab==='user'?'active':''}" onclick="switchMenu('user')">๐ค Me</button>
ย ย ย ย <button class="menu-tab-btn tab-social ${currentMenuTab==='social'?'active':''}" onclick="switchMenu('social')">๐ Social</button>
ย ย `;

ย ย // 4. Render ra mรn hรฌnh controls
ย ย const controls = document.getElementById('controls');
ย ย controls.innerHTML = `
ย ย ย ย <div id="menu-container">
ย ย ย ย ย ย <div id="menu-grid">${buttonsHtml}</div>
ย ย ย ย ย ย <div class="menu-tabs">${tabsHtml}</div>
ย ย ย ย </div>
ย ย `;
}

// Hรm chuyแปn Tab
function switchMenu(tabName) {
ย ย currentMenuTab = tabName;
ย ย showMenu(); // Vแบฝ lแบกi menu
ย ย playSFX('catch'); // (Optional) Thรชm tiแบฟng click cho vui tai
}
ย ย

ย ย function healAll() {
ย ย ย ย if(currentWild) return;
ย ย ย ย let count = 0;
ย ย ย ย myBag.forEach(p => {
ย ย ย ย ย ย if(p.hp < p.maxHp || isNaN(p.hp)) { p.hp = p.maxHp; count++; }
ย ย ย ย });
ย ย ย ย saveGame(); updateStats();
ย ย ย ย if(count > 0) {
ย ย ย ย ย ย log(`<span style="color:#ff7675; font-weight:bold">๐ฅ Nurse Joy: ฤรฃ hแปi phแปฅc cho ${count} Pokemon cแปงa bแบกn!</span>`);
ย ย ย ย ย ย alert("Nurse Joy: Chรo mแปซng tแปi Pokemon Center! Team cแปงa bแบกn ฤรฃ khแปe mแบกnh.");
ย ย ย ย } else {
ย ย ย ย ย ย alert("Nurse Joy: Pokemon cแปงa bแบกn vแบซn rแบฅt khแปe mแบกnh!");
ย ย ย ย }
ย ย }
ย ยย
ย ย function showUpdates() { document.getElementById('update-modal').style.display = 'flex'; }
ย ย function closeUpdates() { document.getElementById('update-modal').style.display = 'none'; }
ย ย function showDonate() { document.getElementById('donate-modal').style.display = 'flex'; }
ย ย function closeDonate() { document.getElementById('donate-modal').style.display = 'none'; }
ย ย function getHpColor(pct) { if(pct > 50) return '#2ecc71'; if(pct > 20) return '#f1c40f'; return '#ed4245'; }
ย ย function openBag() { if(currentWild) return; renderBag(); }
ย ยย
ย ย// --- CแบฌP NHแบฌT HรM HIแปN THแป TรI (VแปI GIร BรN MแปI) ---
// --- Hแป THแปNG PC & CHแปN NHIแปU (ฤร NรNG CแบคP) ---
// --- HรM HIแปN THแป TรI (CแบฌP NHแบฌT SHADOW & RAINBOW) ---
function renderBag() {
ย ย // 1. Header cแปงa PC
ย ย let headerHtml = `
ย ย <div class="embed" style="border-left-color:#3498db">
ย ย ย ย <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; border-bottom:1px solid #444; padding-bottom:5px">
ย ย ย ย ย ย <span class="embed-title">๐ป PC Box 1 (${myBag.length}/${maxBagSize})</span>
ย ย ย ย ย ยย
ย ย ย ย ย ย <button class="btn-small" style="background:${isSelectMode ? '#ed4245' : '#f1c40f'}; color:black; font-weight:bold" onclick="toggleSelectMode()">
ย ย ย ย ย ย ย ย ${isSelectMode ? 'โ Hแปงy chแปn' : 'โ Chแปn nhiแปu'}
ย ย ย ย ย ย </button>
ย ย ย ย </div>
ย ย `;

ย ย if(myBag.length === 0) {ย
ย ย ย ย log(headerHtml + "<div style='padding:10px; color:#777'>PC trแปng trฦกn.</div></div>");ย
ย ย ย ย return;ย
ย ย }

ย ย // 2. Render danh sรกch
ย ย const listHtml = myBag.slice().reverse().map((p, i) => {
ย ย ย ย const realIdx = myBag.length - 1 - i; // Index thแบญt trong mแบฃng gแปc
ย ย ย ยย
ย ย ย ย ensureDataIntegrity(p);
ย ย ย ย if(!p.types) p.types = ['normal'];
ย ย ย ย const r = getRarity(p);
ย ย ย ยย
ย ย ย ย // --- [MแปI] Xแปฌ Lร HIแปU แปจNG VISUAL & GIร BรN ---
ย ย ย ย let specialClass = "";
ย ย ย ย let namePrefix = "";
ย ย ย ย let variantBonus = 0;

ย ย ย ย if (p.isRainbow) {
ย ย ย ย ย ย specialClass = "variant-rainbow"; // Class CSS cแบงu vแปng
ย ย ย ย ย ย namePrefix = "๐ ";
ย ย ย ย ย ย variantBonus = 50000; // Bรกn rแบฅt ฤแบฏt
ย ย ย ย } else if (p.isShadow) {
ย ย ย ย ย ย specialClass = "variant-shadow"; // Class CSS bรณng tแปi
ย ย ย ย ย ย namePrefix = "๐ฟ ";
ย ย ย ย ย ย variantBonus = 2000;
ย ย ย ย } else if (p.isShiny) {
ย ย ย ย ย ย namePrefix = "โจ ";
ย ย ย ย }
ย ย ย ย // ---------------------------------------------

ย ย ย ย // Tรญnh giรก bรกn
ย ย ย ย let basePrice = (p.baseXp * 0.2) + (p.iv * 10) + (p.level * 5);
ย ย ย ย let rarityBonus = 0;
ย ย ย ย if (LEGENDARY_IDS.includes(p.id)) rarityBonus += 5000;ย
ย ย ย ย if (p.isShiny) rarityBonus += 10000;
ย ย ย ย if (r.val >= 3 && !LEGENDARY_IDS.includes(p.id)) rarityBonus += 500;
ย ย ย ยย
ย ย ย ย // Cแปng thรชm giรก trแป cแปงa Variant
ย ย ย ย let pr = Math.floor(basePrice + rarityBonus + variantBonus);
ย ย ย ย if (pr < 50) pr = 50;

ย ย ย ย // Xแปญ lรฝ hiแปn thแป HP
ย ย ย ย let displayHp = (typeof p.hp === 'number' && !isNaN(p.hp)) ? p.hp : 0;
ย ย ย ย let maxHp = (typeof p.maxHp === 'number' && !isNaN(p.maxHp)) ? p.maxHp : 100;
ย ย ย ย let hpPercent = (displayHp / maxHp) * 100;ย
ย ย ย ย let hpColor = getHpColor(hpPercent);

ย ย ย ย // Xแปญ lรฝ แบฃnh: Nแบฟu chแบฟt thรฌ xรกm, nแบฟu sแปng thรฌ hiแปn hiแปu แปฉng ฤแบทc biแปt
ย ย ย ย let imgStyle = "";
ย ย ย ย if (displayHp <= 0) {
ย ย ย ย ย ย imgStyle = "filter: grayscale(1); opacity: 0.6;"; // Chแบฟt thรฌ mแบฅt hiแปu แปฉng mรu
ย ย ย ย ย ย specialClass = ""; // Bแป class hiแปu แปฉng nแบฟu chแบฟt ฤแป trรกnh xung ฤแปt
ย ย ย ย }

ย ย ย ย // --- GIAO DIแปN SELECT MODE ---
ย ย ย ย if (isSelectMode) {
ย ย ย ย ย ย let isSelected = selectedIndices.has(realIdx);
ย ย ย ย ย ย return `
ย ย ย ย ย ย <div class="bag-row ${isSelected ? 'selected' : ''}" onclick="toggleSelection(${realIdx})" style="cursor:pointer">
ย ย ย ย ย ย ย ย <div style="display:flex;align-items:center;gap:10px; flex:1">
ย ย ย ย ย ย ย ย ย ย <input type="checkbox" class="select-checkbox" ${isSelected ? 'checked' : ''} style="pointer-events:none">
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย <img src="${p.img}" width="40" class="${specialClass}" style="${imgStyle}">
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย <div style="width:100%">
ย ย ย ย ย ย ย ย ย ย ย ย <div style="display:flex;justify-content:space-between">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span><span class="rarity-tag ${r.class}">${r.label}</span> <b>${namePrefix}${p.name}</b></span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span style="color:#2ecc71; font-weight:bold; font-size:0.8em">+${pr.toLocaleString()}๐ฐ</span>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <span style="font-size:0.7em; color:#aaa">Lv.${p.level} | IV:${p.iv}</span>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>`;
ย ย ย ย }ย
ย ย ย ย // --- GIAO DIแปN THฦฏแปNG ---
ย ย ย ย else {
ย ย ย ย ย ย let evoBtn = `<button class="btn-small btn-evo" onclick="checkEvolution(${realIdx}, this)">Evo</button>`;
ย ย ย ย ย ย let candyBtn = (inventory['rare-candy'] || 0) > 0 ? `<button class="btn-small btn-candy" onclick="useCandy(${realIdx})">Candy</button>` : '';
ย ย ย ย ย ยย
ย ย ย ย ย ย if(p.isEgg) return `<div class="bag-row">๐ฅ Mystery Egg (${p.steps}/${p.maxSteps}) <button class="btn-small" onclick="hatchEgg(${realIdx})">แบคp</button></div>`;

ย ย ย ย ย ย return `<div class="bag-row">
ย ย ย ย ย ย ย ย <div style="display:flex;align-items:center;gap:10px; flex:1">
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย <img src="${p.img}" width="40" class="${specialClass}" style="${imgStyle}">
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย <div style="width:100%">
ย ย ย ย ย ย ย ย ย ย ย ย <div style="display:flex;justify-content:space-between">
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span><span class="rarity-tag ${r.class}">${r.label}</span> <b>${namePrefix}${p.name}</b></span>
ย ย ย ย ย ย ย ย ย ย ย ย ย ย <span style="font-size:0.8em;font-weight:bold;color:${hpColor}">${displayHp}/${maxHp}</span>
ย ย ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย ย ย ย ย <span style="font-size:0.7em; color:#aaa">Lv.${p.level} | IV:${p.iv}</span>
ย ย ย ย ย ย ย ย ย ย ย ย <div class="hp-container"><div class="hp-fill" style="width:${hpPercent}%; background:${hpColor}"></div></div>
ย ย ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div class="bag-actions">
ย ย ย ย ย ย ย ย ย ย <button class="btn-small" style="background:#9b59b6; color:white" onclick="openMoveManager(${realIdx})">SKILL</button>
ย ย ย ย ย ย ย ย ย ย <button class="btn-small btn-battle" onclick="openBattleModal(${realIdx})">ฤแบคU</button>ย
ย ย ย ย ย ย ย ย ย ย ${candyBtn} ${evoBtn}
ย ย ย ย ย ย ย ย ย ย <button class="btn-small btn-sell" onclick="sell(${realIdx},${pr})">Bรกn</button>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>`;
ย ย ย ย }
ย ย }).join('');

ย ย // 3. Render Footer (Thanh hรnh ฤแปng khi chแปn nhiแปu)
ย ย let footerHtml = '';
ย ย if(isSelectMode) {
ย ย ย ย footerHtml = `
ย ย ย ย <div class="bulk-action-bar">
ย ย ย ย ย ย <span style="color:#bbb">ฤรฃ chแปn: <b style="color:white">${selectedIndices.size}</b></span>
ย ย ย ย ย ย <button class="btn-auth" style="width:auto; background:#ed4245; padding:5px 15px; font-size:0.9em; margin:0" onclick="sellSelectedItems()">
ย ย ย ย ย ย ย ย ๐ฐ BรN NGAY
ย ย ย ย ย ย </button>
ย ย ย ย </div>`;
ย ย }

ย ย // 4. Kแบฟt hแปฃp vร Log ra mรn hรฌnh
ย ย log(headerHtml + `<div class="embed-desc" style="max-height:300px;overflow-y:auto">${listHtml}</div>` + footerHtml + `</div>`);
}

ย ย function sell(idx, price) {
ย ย ย ย if(!myBag[idx]) return;
ย ย ย ย if(confirm(`Bแบกn cรณ chแบฏc muแปn bรกn ${myBag[idx].name} vแปi giรก ${price} coins?`)) {
ย ย ย ย ย ย coins += price;
ย ย ย ย ย ย myBag.splice(idx, 1);
ย ย ย ย ย ย saveGame();
ย ย ย ย ย ย updateStats();
ย ย ย ย ย ย renderBag();
ย ย ย ย ย ย log(`<span style="color:#f1c40f">ฤรฃ bรกn Pokemon nhแบญn ${price}๐ฐ</span>`);
ย ย ย ย }
ย ย }

ย ย // --- Hแป THแปNG SHOP NรNG CแบคP (MUA & BรN) ---
let currentShopTab = 'buy'; // Mแบทc ฤแปnh vรo lร tab Mua

function shop() {
ย ย if(currentWild) return;
ย ย document.getElementById('shop-modal').style.display = 'flex';
ย ย switchShopTab('buy'); // Mแป tab mua trฦฐแปc
}

function closeShop() {
ย ย document.getElementById('shop-modal').style.display = 'none';
}

function switchShopTab(mode) {
ย ย currentShopTab = mode;
ย ย const list = document.getElementById('shop-list');
ย ย const coinDisplay = document.getElementById('shop-coin-display');
ย ยย
ย ย // Cแบญp nhแบญt sแป dฦฐ
ย ย coinDisplay.innerText = coins.toLocaleString();

ย ย // 1. Cแบญp nhแบญt giao diแปn Tab (HTML cแปฉng trong JS ฤแป khแปi sแปญa file HTML)
ย ย const modalBox = document.querySelector('#shop-modal .box-style');
ย ย // Tรฌm hoแบทc tแบกo thanh Tab nแบฟu chฦฐa cรณ
ย ย let tabContainer = document.getElementById('shop-tabs-container');
ย ย if(!tabContainer) {
ย ย ย ย // Chรจn thanh tab vรo dฦฐแปi tiรชu ฤแป
ย ย ย ย const title = modalBox.querySelector('h2');
ย ย ย ย tabContainer = document.createElement('div');
ย ย ย ย tabContainer.id = 'shop-tabs-container';
ย ย ย ย tabContainer.className = 'shop-tabs';
ย ย ย ย title.insertAdjacentElement('afterend', tabContainer);
ย ย }
ย ยย
ย ย // Vแบฝ nรบt Tab
ย ย tabContainer.innerHTML = `
ย ย ย ย <button class="shop-tab-btn ${mode==='buy'?'active':''}" onclick="switchShopTab('buy')">MUA ฤแป</button>
ย ย ย ย <button class="shop-tab-btn ${mode==='sell'?'active':''}" onclick="switchShopTab('sell')">BรN ฤแป</button>
ย ย `;

ย ย // 2. Render danh sรกch hรng hรณa
ย ย list.innerHTML = '';

ย ย if(mode === 'buy') {
ย ย ย ย // --- TAB MUA: Hiแปn ฤแป cรณ giรก (trแปซ loแบกi 'sell' ra) ---
ย ย ย ย SHOP_DB.forEach(item => {
ย ย ย ย ย ย if(item.type === 'sell') return; // Khรดng hiแปn ฤแป rรกc แป tab mua
ย ย ย ย ย ยย
ย ย ย ย ย ย list.innerHTML += `
ย ย ย ย ย ย <div class="shop-card" onclick="openBuy('${item.id}')">
ย ย ย ย ย ย ย ย<img src="${URL_ITEMS}${item.img}" width="50">
ย ย ย ย ย ย ย ย<div style="font-weight:bold; color:#faa61a; text-align:center">${item.name}</div>
ย ย ย ย ย ย ย ย<div style="font-size:0.8em; color:#bbb">${item.price.toLocaleString()}๐ฐ</div>
ย ย ย ย ย ย </div>`;
ย ย ย ย });
ย ย }ย
ย ย else {
ย ย ย ย // --- TAB BรN: Quรฉt tรบi ฤแป xem cรณ gรฌ bรกn ฤฦฐแปฃc khรดng ---
ย ย ย ย let hasItemToSell = false;

ย ย ย ย SHOP_DB.forEach(item => {
ย ย ย ย ย ย // Kiแปm tra xem user cรณ mรณn nรy trong tรบi khรดng
ย ย ย ย ย ย let qty = inventory[item.id] || 0;
ย ย ย ย ย ย if (qty > 0) {
ย ย ย ย ย ย ย ย // Tรญnh giรก bรกn lแบกi (thฦฐแปng lร 50% giรก mua, riรชng Nugget/Stardust thรฌ 100% giรก gแปc)
ย ย ย ย ย ย ย ย let sellPrice = item.type === 'sell' ? item.price : Math.floor(item.price / 2);
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย hasItemToSell = true;
ย ย ย ย ย ย ย ย list.innerHTML += `
ย ย ย ย ย ย ย ย <div class="shop-card" style="border-color:#ed4245" onclick="sellItemDirectly('${item.id}', '${item.name}', ${sellPrice})">
ย ย ย ย ย ย ย ย ย ย<div style="position:absolute; top:5px; right:5px; background:#ed4245; color:white; font-size:0.7em; padding:2px 5px; border-radius:3px">x${qty}</div>
ย ย ย ย ย ย ย ย ย ย<img src="${URL_ITEMS}${item.img}" width="50">
ย ย ย ย ย ย ย ย ย ย<div style="font-weight:bold; color:#fff; text-align:center">${item.name}</div>
ย ย ย ย ย ย ย ย ย ย<div style="font-size:0.8em; color:#2ecc71">Bรกn: ${sellPrice.toLocaleString()}๐ฐ</div>
ย ย ย ย ย ย ย ย </div>`;
ย ย ย ย ย ย }
ย ย ย ย });

ย ย ย ย if(!hasItemToSell) {
ย ย ย ย ย ย list.innerHTML = `<div style="width:200%; text-align:center; color:#777; padding:20px">Tรบi ฤแป sแบกch bรกch!<br>Khรดng cรฒn gรฌ ฤแป bรกn.</div>`;
ย ย ย ย }
ย ย }
}

// Hรm bรกn nhanh trong Shop
function sellItemDirectly(id, name, price) {
ย ย let qty = inventory[id] || 0;
ย ย if(qty <= 0) return;

ย ย // Hแปi muแปn bรกn bao nhiรชu (Mแบทc ฤแปnh bรกn 1, hoแบทc bรกn hแบฟt nแบฟu lร ฤแป rรกc)
ย ย let amount = 1;
ย ย // Nแบฟu lร ฤแป rรกc (Nugget/Stardust) thรฌ bรกn hแบฟt luรดn cho lแบน, hoแบทc prompt hแปi
ย ย if(confirm(`Bรกn 1x ${name} vแปi giรก ${price} coins?`)) {
ย ย ย ย inventory[id]--;
ย ย ย ย coins += price;
ย ย ย ยย
ย ย ย ย saveGame();
ย ย ย ยย
ย ย ย ย // Hiแปu แปฉng update
ย ย ย ย switchShopTab('sell'); // Vแบฝ lแบกi tab bรกn
ย ย ย ย updateStats(); // Cแบญp nhแบญt tiแปn trรชn UI chรญnh
ย ย ย ยย
ย ย ย ย // Log nhแป
ย ย ย ย const coinDisplay = document.getElementById('shop-coin-display');
ย ย ย ย coinDisplay.innerText = coins.toLocaleString();
ย ย ย ย coinDisplay.style.color = '#2ecc71';
ย ย ย ย setTimeout(() => coinDisplay.style.color = '#f1c40f', 500);
ย ย }
}
ย ย // --- Hแป THแปNG MUA HรNG (ฤร SแปฌA LแปI & ฤแปNG Bแป) ---

// 1. Biแบฟn lฦฐu mรณn ฤแป ฤang chแปn (Quan trแปng)
let currentBuyItem = "";ย

// 2. Hรm mแป bแบฃng mua chi tiแบฟt (Gแบฏn vรo แบฃnh mรณn ฤแป)
function openBuy(id) {
ย ย currentBuyItem = id; // Lฦฐu ID lแบกi ฤแป lรกt nแปฏa mua
ย ย selectedItemId = id; // (Giแปฏ tฦฐฦกng thรญch ngฦฐแปฃc)

ย ย const item = SHOP_DB.find(i => i.id === id);
ย ย if(!item) return;

ย ย // ฤiแปn thรดng tin vรo bแบฃng #buy-modal (Bแบฃng to ฤแบนp)
ย ย document.getElementById('buy-name').innerText = item.name;
ย ย document.getElementById('buy-img').src = URL_ITEMS + item.img;
ย ย document.getElementById('buy-price').innerText = item.price.toLocaleString();
ย ยย
ย ย // Reset sแป lฦฐแปฃng vแป 1
ย ย const qtyInput = document.getElementById('buy-qty');
ย ย if(qtyInput) qtyInput.value = 1;
ย ยย
ย ย document.getElementById('buy-total').innerText = item.price.toLocaleString();

ย ย // แบจn Shop, Hiแปn bแบฃng Mua
ย ย document.getElementById('shop-modal').style.display = 'none';
ย ย document.getElementById('buy-modal').style.display = 'flex';
}

// 3. Hรm tรญnh tแปng tiแปn khi nhแบญp sแป lฦฐแปฃng
function calcTotal() {
ย ย const item = SHOP_DB.find(i => i.id === currentBuyItem);
ย ย if(!item) return;

ย ย let qtyInput = document.getElementById('buy-qty');
ย ย let qty = parseInt(qtyInput.value);
ย ยย
ย ย if(qty < 1 || isNaN(qty)) {
ย ย ย ย qty = 1;
ย ย ย ย // Khรดng set lแบกi value ngay ฤแป trรกnh khรณ chแปu khi ฤang gรต xรณa
ย ย }
ย ยย
ย ย document.getElementById('buy-total').innerText = (item.price * qty).toLocaleString();
}

// 4. Hรm ฤรณng bแบฃng mua (Quay vแป Shop)
function closeBuy() {
ย ย document.getElementById('buy-modal').style.display = 'none';
ย ย document.getElementById('shop-modal').style.display = 'flex';
}

// 5. HรM Xแปฌ Lร MUA (FIX LแปI CHรNH TแบI ฤรY)
function submitBuy() {
ย ย // Lแบฅy ID tแปซ biแบฟn ฤรฃ lฦฐu
ย ย const id = currentBuyItem;
ย ยย
ย ย // Lแบฅy sแป lฦฐแปฃng tแปซ bแบฃng #buy-modal (ID lร 'buy-qty')
ย ย const qtyInput = document.getElementById('buy-qty');
ย ยย
ย ย // Kiแปm tra lแปi
ย ย if (!id) return alert("Lแปi: Khรดng xรกc ฤแปnh ฤฦฐแปฃc vแบญt phแบฉm!");
ย ย if (!qtyInput) return alert("Lแปi: Khรดng tรฌm thแบฅy รด nhแบญp sแป lฦฐแปฃng!");

ย ย const qty = parseInt(qtyInput.value);
ย ย if (qty <= 0 || isNaN(qty)) return alert("Sแป lฦฐแปฃng phแบฃi lแปn hฦกn 0!");

ย ย const item = SHOP_DB.find(i => i.id === id);
ย ย if (!item) return alert("Vแบญt phแบฉm khรดng tแปn tแบกi!");

ย ย // --- LOGIC GIแปI HแบN (Cho Old Map) ---
ย ย if (item.uniqueKey) {
ย ย ย ย if (limitedShopHistory && limitedShopHistory[id] === item.uniqueKey) {
ย ย ย ย ย ย closeBuy();
ย ย ย ย ย ย return alert("โ Bแบกn ฤรฃ mua vแบญt phแบฉm nรy rแปi! Hรฃy kiแปm tra lแบกi trong tรบi.");
ย ย ย ย }
ย ย ย ย if (qty > 1) return alert("Vแบญt phแบฉm ฤแบทc biแปt nรy chแป ฤฦฐแปฃc mua 1 cรกi!");
ย ย }

ย ย // Tรญnh tiแปn
ย ย let cost = item.price * qty;
ย ย if (coins < cost) return alert("Khรดng ฤแปง tiแปn!");

ย ย // Trแปซ tiแปn & Cแปng ฤแป
ย ย coins -= cost;
ย ย if (!inventory[id]) inventory[id] = 0;
ย ย inventory[id] += qty;

ย ย // Lฦฐu lแปch sแปญ giแปi hแบกn
ย ย if (item.uniqueKey) {
ย ย ย ย if(!limitedShopHistory) limitedShopHistory = {};
ย ย ย ย limitedShopHistory[id] = item.uniqueKey;
ย ย }

ย ย // Lฦฐu game
ย ย saveGame();
ย ย updateStats();
ย ยย
ย ย // Cแบญp nhแบญt sแป dฦฐ แป Shop
ย ย const coinDisplay = document.getElementById('shop-coin-display');
ย ย if(coinDisplay) coinDisplay.innerText = coins.toLocaleString();

ย ย closeBuy(); // ฤรณng bแบฃng
ย ยย
ย ย // Hiแปu แปฉng & Thรดng bรกo
ย ย if(typeof playSFX === 'function') playSFX('levelup');ย

ย ย if(item.uniqueKey) {
ย ย ย ย log(`<div style="color:#f1c40f; border:1px dashed #f1c40f; padding:10px; background:rgba(241, 196, 15, 0.1)">
ย ย ย ย ย ย ๐บ๏ธ <b>ฤร MUA ${item.name.toUpperCase()}!</b><br>
ย ย ย ย ย ย <i>"${item.desc}"</i>
ย ย ย ย </div>`);
ย ย } else {
ย ย ย ย alert(`ฤรฃ mua ${qty}x ${item.name} thรnh cรดng!`);
ย ย }
}
ย ย function incrementEggSteps() { let hatched = false; myBag.forEach(p => { if(p.isEgg && p.steps < p.maxSteps) { p.steps++; if(p.steps >= p.maxSteps) hatched = true; } }); if(hatched) log(`<span style="color:#f1c40f">๐ฅ Cรณ trแปฉng ฤรฃ sแบตn sรng nแป! Vรo tรบi kiแปm tra ngay.</span>`); saveGame(); }
ย ยย
ย ย async function hatchEgg(idx) {
ย ย ย ย let egg = myBag[idx]; if(!egg.isEgg || egg.steps < egg.maxSteps) return;
ย ย ย ย let id = Math.floor(Math.random()*MAX_ID)+1;
ย ย ย ย const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`); const data = await res.json();
ย ย ย ย const isShiny = Math.random() < 0.1; let img = data.sprites.other['official-artwork'].front_default || data.sprites.front_default; if(isShiny) img = data.sprites.front_shiny || img;
ย ย ย ย let iv = Math.floor(Math.random() * 32);ย
ย ย ย ยย
ย ย ย ย let stats = {};
ย ย ย ย data.stats.forEach(s => { stats[s.stat.name] = s.base_stat; });

ย ย ย ย let p = {ย
ย ย ย ย ย ย id: data.id, name: data.name.toUpperCase(), types: data.types.map(t=>t.type.name), iv: iv, isShiny: isShiny, img: img, baseXp: data.base_experience,ย
ย ย ย ย ย ย baseHp: stats['hp'], baseAtk: stats['attack'], baseDef: stats['defense'], baseSpA: stats['special-attack'], baseSpD: stats['special-defense'], baseSpd: stats['speed'],
ย ย ย ย ย ย level: 5, xp: 0, maxXp: 100ย
ย ย ย ย };
ย ย ย ย recalcStats(p);ย
ย ย ย ย assignMoves(p);ย

ย ย ย ย myBag[idx] = p;
ย ย ย ย playCry(p.id);
ย ย ย ย if(isShiny) userStats.shinies++; saveGame(); renderBag();
ย ย ย ย log(`<div class="embed" style="border-left-color:#f1c40f"><div class="embed-header"><div><span class="embed-title">๐ฃ TRแปจNG Nแป!</span><div class="embed-desc">Chรo mแปซng <b>${isShiny?'โจ ':''}${data.name.toUpperCase()}</b> (IV: ${iv}) - HP: ${p.maxHp}</div></div><img class="poke-sprite" src="${img}"></div></div>`);
ย ย }

ย ย async function hunt() { controls.innerHTML=`<div style="color:#faa61a">ฤang tรฌm...</div>`; streakBonus=0; activeBuffs.berry=false; updateStats(); await spawnPokemon(); }
ย ยย
ย ย // --- Hแป THแปNG SPAWN POKEMON (HARDCORE MODE) ---
let originalEnemyImgSrc = "";ย

// --- HรM SPAWN POKEMON (UPDATE: HIแปN THแป ICON ฤแปC LแบฌP) ---
async function spawnPokemon() {
ย ย // 1. Reset UI
ย ย const controlsDiv = document.getElementById('controls');
ย ย if(controlsDiv) controlsDiv.innerHTML = `<div style="color:#faa61a; padding:10px">ฤang tรฌm kiแบฟm... <span class="loading-spinner">๐</span></div>`;
ย ยย
ย ย activeBuffs = { berry: false, egg: false };
ย ย battleState.active = false;
ย ย streakBonus = 0;
ย ยย
ย ย const battleMenu = document.getElementById('battle-main-menu');
ย ย if(battleMenu) battleMenu.style.display = 'none';

ย ย try {
ย ย ย ย let id = 1;

ย ย ย ย // --- CแบคU HรNH Tแปถ Lแป (GIแปฎ NGUYรN) ---
ย ย ย ย const RATE_LEGENDARY = 1 / 3000;ย
ย ย ย ย const LEGEND_LIST = [144,145,146,150,151,243,244,245,249,250,251,377,378,379,380,381,382,383,384,385,386,480,481,482,483,484,485,486,487,488,489,490,491,492,493,494,638,639,640,641,642,643,644,645,646];

ย ย ย ย // 2. LOGIC TรM ID
ย ย ย ย if (typeof currentZone !== 'undefined' && currentZone !== 'all' && typeof ZONES !== 'undefined') {
ย ย ย ย ย ย let zoneInfo = ZONES.find(z => z.id === currentZone);
ย ย ย ย ย ย if (zoneInfo) {
ย ย ย ย ย ย ย ย let randomType = zoneInfo.types[Math.floor(Math.random() * zoneInfo.types.length)];
ย ย ย ย ย ย ย ย let typeRes = await fetch(`https://pokeapi.co/api/v2/type/${randomType}`);
ย ย ย ย ย ย ย ย let typeData = await typeRes.json();
ย ย ย ย ย ย ย ย let pokeList = typeData.pokemon.filter(p => parseInt(p.pokemon.url.split('/')[6]) <= 649);
ย ย ย ย ย ย ย ย if(pokeList.length > 0) id = pokeList[Math.floor(Math.random() * pokeList.length)].pokemon.url.split('/')[6];
ย ย ย ย ย ย }
ย ย ย ย } else {
ย ย ย ย ย ย let roll = Math.random();ย
ย ย ย ย ย ย if (roll < RATE_LEGENDARY) id = LEGEND_LIST[Math.floor(Math.random() * LEGEND_LIST.length)];
ย ย ย ย ย ย else {
ย ย ย ย ย ย ย ย do { id = Math.floor(Math.random() * 649) + 1; } while (LEGEND_LIST.includes(id));ย
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย // 3. LOGIC BIแบพN THแป
ย ย ย ย let hasCharm = (inventory['shiny-charm'] || 0) > 0;
ย ย ย ย let rand = Math.random();
ย ย ย ย let isShiny = false, isShadow = false, isRainbow = false;

ย ย ย ย // Logic cลฉ: Shadow/Rainbow loแบกi trแปซ nhau.ย
ย ย ย ย // Admin Tool cรณ thแป force cแบฃ 3 lร true, nรชn ta cแปฉ xแปญ lรฝ hiแปn thแป cho trฦฐแปng hแปฃp ฤรณ.
ย ย ย ย if (rand < 1/20000) isRainbow = true;ย
ย ย ย ย else if (rand < 1/5000) isShadow = true;ย
ย ย ย ยย
ย ย ย ย let shinyRate = hasCharm ? (3/4096) : (1/4096);
ย ย ย ย if (Math.random() < shinyRate) isShiny = true;

ย ย ย ย // 4. FETCH API
ย ย ย ย const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);ย
ย ย ย ย const data = await res.json();

ย ย ย ย let img = data.sprites.other['official-artwork'].front_default || data.sprites.front_default;
ย ย ย ย if(isShiny && !isShadow && !isRainbow && data.sprites.front_shiny) img = data.sprites.front_shiny;

ย ย ย ย let stats = {};
ย ย ย ย data.stats.forEach(s => { stats[s.stat.name] = s.base_stat; });
ย ย ย ย let iv = Math.floor(Math.random() * 32);ย

ย ย ย ย // Tรญnh Rate
ย ย ย ย // --- TรNH Tแปถ Lแป BแบฎT (CATCH RATE) ---
ย ย ย ย let baseRate = 255;ย
ย ย ย ย let xp = data.base_experience; // Lแบฅy chแป sแป sแปฉc mแบกnh ฤแป xรฉt ฤแป hiแบฟm

ย ย ย ย // 1. CHแปNH Tแปถ Lแป THEO ฤแป HIแบพM (COMMON - UNCOMMON - RARE)
ย ย ย ย if (xp < 70) {
ย ย ย ย ย ย // COMMON (Rแบฅt phแป biแบฟn - Sรขu, Chuแปt...)
ย ย ย ย ย ย baseRate = 200; // ๐ข Dแป nhแบฅt (100% dรญnh vแปi Poke Ball)
ย ย ย ย }ย
ย ย ย ย else if (xp < 140) {
ย ย ย ย ย ย // UNCOMMON (Trung bรฌnh - Cแบฅp 2)
ย ย ย ย ย ย baseRate = 150; // ๐ก Khรก dแป bแบฏt
ย ย ย ย }ย
ย ย ย ย else if (xp < 200) {
ย ย ย ย ย ย // RARE (Hiแบฟm - Cแบฅp 3 hoแบทc con mแบกnh)
ย ย ย ย ย ย baseRate = 70;ย // ๐ Hฦกi khรณ (Nรชn dรนng Great Ball)
ย ย ย ย }ย
ย ย ย ย else {
ย ย ย ย ย ย // EPIC / MYTHIC (Siรชu mแบกnh)
ย ย ย ย ย ย baseRate = 30;ย // ๐ด Khรณ (Nรชn dรนng Ultra Ball)
ย ย ย ย }

ย ย ย ย // 2. HUYแปN THOแบI (Ghi ฤรจ tแบฅt cแบฃ)
ย ย ย ย if (LEGEND_LIST.includes(parseInt(id))) {
ย ย ย ย ย ย baseRate = 6; // โซ Cแปฑc khรณ (Mแปฉc 3 lร chuแบฉn game gแปc, bแบกn cรณ thแป chแปnh lรชn 10-20 cho dแป hฦกn)
ย ย ย ย }

ย ย ย ย // 3. BIแบพN THแป (Shadow/Rainbow lรm khรณ thรชm)
ย ย ย ย if (isShadow) baseRate = Math.floor(baseRate * 0.6); // Khรณ hฦกn 40%
ย ย ย ย if (isRainbow) baseRate = Math.floor(baseRate * 0.4); // Khรณ hฦกn 60%

ย ย ย ย // Chแปt chแบทn cuแปi cรนng
ย ย ย ย if (baseRate < 1) baseRate = 1;

ย ย ย ย let p = {ย
ย ย ย ย ย ย id: data.id, name: data.name.toUpperCase(), types: data.types.map(t=>t.type.name), iv: iv,ย
ย ย ย ย ย ย isShiny: isShiny, isShadow: isShadow, isRainbow: isRainbow,
ย ย ย ย ย ย img: img, baseXp: data.base_experience,ย
ย ย ย ย ย ย baseHp: stats['hp'], baseAtk: stats['attack'], baseDef: stats['defense'],ย
ย ย ย ย ย ย baseSpA: stats['special-attack'], baseSpD: stats['special-defense'], baseSpd: stats['speed'],
ย ย ย ย ย ย level: 5, xp: 0, maxXp: 100, catchRate: baseRate, maxHp: stats['hp'] // temp
ย ย ย ย };
ย ย ย ย recalcStats(p);ย
ย ย ย ย assignMoves(p);

ย ย ย ย // 5. HIแปN THแป (RENDER) - LOGIC MแปI TแบI ฤรY
ย ย ย ย currentWild = p;
ย ย ย ย playCry(p.id);

ย ย ย ย // A. Xรกc ฤแปnh Tag Rarity Gแปc (Common/Rare/Legendary...)
ย ย ย ย let r = getRarity(p);ย
ย ย ย ย // getRarity trแบฃ vแป: { label: "LEGENDARY", class: "rarity-legendary", color: "#..." }

ย ย ย ย // B. Xรขy dแปฑng chuแปi Icons (Icons string)
ย ย ย ย let variantIcons = "";
ย ย ย ย let visualClass = ""; // Class CSS ฤแป ฤแปi mรu แบฃnh
ย ย ย ย let borderSideColor = r.color; // Mแบทc ฤแปnh viแปn theo ฤแป hiแบฟm

ย ย ย ย // Logic cแปng dแปn icon: Cรณ cรกi nรo hiแปn cรกi ฤรณ
ย ย ย ย if (isShiny) {
ย ย ย ย ย ย variantIcons += `<span title="Shiny">โจ</span> `;
ย ย ย ย }
ย ย ย ย if (isShadow) {
ย ย ย ย ย ย variantIcons += `<span title="Shadow">๐ฟ</span> `;
ย ย ย ย ย ย visualClass = "variant-shadow"; // ฦฏu tiรชn hiแปu แปฉng Shadow
ย ย ย ย ย ย borderSideColor = "#9b59b6";
ย ย ย ย }
ย ย ย ย if (isRainbow) {
ย ย ย ย ย ย variantIcons += `<span title="Rainbow">๐</span> `;
ย ย ย ย ย ย visualClass = "variant-rainbow"; // Rainbow ฤรจ hiแปu แปฉng Shadow nแบฟu cรณ
ย ย ย ย ย ย borderSideColor = "gold";
ย ย ย ย }
ย ย ย ย const oldSprite = document.getElementById('active-wild-sprite');
ย ย ย ย if (oldSprite) oldSprite.removeAttribute('id');
ย ย ย ย // C. Render HTML
ย ย ย ย log(`<div class="embed" style="border-left-color:${borderSideColor}">
ย ย ย ย ย ย <div class="embed-header">
ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <div style="display:flex; align-items:center; margin-bottom:2px">
ย ย ย ย ย ย ย ย ย ย ย ย <span class="rarity-tag ${r.class}" style="margin-right:5px">${r.label}</span>
ย ย ย ย ย ย ย ย ย ย ย ย <span style="font-size:1.2em">${variantIcons}</span>
ย ย ย ย ย ย ย ย ย ย </div>

ย ย ย ย ย ย ย ย ย ย <div class="embed-title" style="line-height:1.2">${currentWild.name}</div>
ย ย ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ย ย <div class="embed-desc">Hแป: ${p.types.join('/')} | CP: ${Math.floor((p.atk+p.spA)*p.level/10)}</div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <img id="active-wild-sprite" class="poke-sprite ${visualClass}" src="${currentWild.img}">
ย ย ย ย ย ย </div>
ย ย ย ย </div>`);
ย ย ย ยย
ย ย ย ย renderBattleControls();
ย ย ย ย updateStats();

ย ย } catch (e) {
ย ย ย ย console.error("Lแปi spawn:", e);
ย ย ย ย setTimeout(() => spawnPokemon(), 1000);
ย ย }
}
ย ย // --- HรM SPAWN CฦฏแปNG CHแบพ (DรNG CHO ADMIN) ---
async function forceSpawnPokemon(id, forceShiny, forceShadow, forceRainbow) {
ย ย // 1. Reset UI
ย ย const controlsDiv = document.getElementById('controls');
ย ย if(controlsDiv) controlsDiv.innerHTML = `<div style="color:red">ADMIN SPAWN...</div>`;
ย ยย
ย ย activeBuffs = { berry: false, egg: false };
ย ย battleState.active = false;
ย ย streakBonus = 0;

ย ย try {
ย ย ย ย // Fetch dแปฏ liแปu theo ID chแป ฤแปnh
ย ย ย ย const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);ย
ย ย ย ย const data = await res.json();

ย ย ย ย // Xแปญ lรฝ แบฃnh & Biแบฟn thแป
ย ย ย ย let isShiny = forceShiny;
ย ย ย ย let isShadow = forceShadow;
ย ย ย ย let isRainbow = forceRainbow;

ย ย ย ย let img = data.sprites.other['official-artwork'].front_default || data.sprites.front_default;
ย ย ย ย if(isShiny && !isShadow && !isRainbow && data.sprites.front_shiny) {
ย ย ย ย ย ย img = data.sprites.front_shiny;
ย ย ย ย }

ย ย ย ย // Stats
ย ย ย ย let stats = {};
ย ย ย ย data.stats.forEach(s => { stats[s.stat.name] = s.base_stat; });

ย ย ย ย // Tแบกo Object
ย ย ย ย let p = {ย
ย ย ย ย ย ย id: data.id, name: data.name.toUpperCase(), types: data.types.map(t=>t.type.name), iv: 31, // Admin spawn auto max IV
ย ย ย ย ย ย isShiny: isShiny, isShadow: isShadow, isRainbow: isRainbow,
ย ย ย ย ย ย img: img, baseXp: data.base_experience,ย
ย ย ย ย ย ย baseHp: stats['hp'], baseAtk: stats['attack'], baseDef: stats['defense'],ย
ย ย ย ย ย ย baseSpA: stats['special-attack'], baseSpD: stats['special-defense'], baseSpd: stats['speed'],
ย ย ย ย ย ย level: 100, // Spawn cแบฅp 100 luรดn cho mรกu
ย ย ย ย ย ย xp: 0, maxXp: 100, catchRate: 255 // Dแป bแบฏt ฤแป test
ย ย ย ย };
ย ย ย ยย
ย ย ย ย recalcStats(p);ย
ย ย ย ย assignMoves(p);

ย ย ย ย // Render
ย ย ย ย currentWild = p;
ย ย ย ย playCry(p.id);

ย ย ย ย let visualClass = "";
ย ย ย ย let namePrefix = "";
ย ย ย ย let titleColor = "#00b0f4";ย
ย ย ย ยย
ย ย ย ย if (isRainbow) { visualClass="variant-rainbow"; namePrefix="๐ "; titleColor="gold"; }
ย ย ย ย else if (isShadow) { visualClass="variant-shadow"; namePrefix="๐ฟ "; titleColor="#9b59b6"; }
ย ย ย ย else if (isShiny) { titleColor="#e74c3c"; namePrefix="โจ "; }

ย ย ย ย log(`<div class="embed" style="border-left-color:${titleColor}">
ย ย ย ย ย ย <div class="embed-header">
ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <span class="rarity-tag" style="background:red">ADMIN SPAWN</span>ย
ย ย ย ย ย ย ย ย ย ย <span class="embed-title">${namePrefix}${currentWild.name}</span>
ย ย ย ย ย ย ย ย ย ย <div class="embed-desc">Hแป: ${p.types.join('/')} | CP: ${Math.floor((p.atk+p.spA)*p.level/10)}</div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <img id="active-wild-sprite" class="poke-sprite ${visualClass}" src="${currentWild.img}">
ย ย ย ย ย ย </div>
ย ย ย ย </div>`);
ย ย ย ยย
ย ย ย ย renderBattleControls();
ย ย ย ย updateStats();

ย ย } catch (e) {
ย ย ย ย console.error(e);
ย ย ย ย alert("Lแปi ID Pokemon khรดng tแปn tแบกi!");
ย ย }
}
// Hรm phแปฅ lแบฅy tรชn Zone (trรกnh lแปi nแบฟu chฦฐa khai bรกo)
function getCurrentZoneName() {
ย ย if(typeof ZONES !== 'undefined' && typeof currentZone !== 'undefined') {
ย ย ย ย let z = ZONES.find(x => x.id === currentZone);
ย ย ย ย return z ? z.name : 'Vรนng hoang dรฃ';
ย ย }
ย ย return 'Vรนng hoang dรฃ';
}
function renderBattleControls() {
ย ย const balls = SHOP_DB.filter(i => i.type === 'ball');
ย ยย
ย ย // 1. Tแบกo HTML cho cรกc nรบt Bรณng
ย ย let ballsHtml = balls.map(b => {
ย ย ย ย const count = inventory[b.id] || 0;
ย ย ย ย const cls = count > 0 ? '' : 'disabled';
ย ย ย ยย
ย ย ย ย // Mรu viแปn tรนy loแบกi bรณng cho ฤแบนp
ย ย ย ย let color = '#ccc';
ย ย ย ย if(b.id === 'poke-ball') color = '#e74c3c'; // ฤแป
ย ย ย ย if(b.id === 'great-ball') color = '#3498db'; // Xanh
ย ย ย ย if(b.id === 'ultra-ball') color = '#f1c40f'; // Vรng
ย ย ย ย if(b.id === 'master-ball') color = '#9b59b6'; // Tรญm

ย ย ย ย return `
ย ย ย ย <div class="ball-btn-horizontal ${cls}" onclick="catchAttempt('${b.id}')" style="border-bottom: 2px solid ${color}">
ย ย ย ย ย ย <img src="${URL_ITEMS}${b.img}">
ย ย ย ย ย ย <span>x${count}</span>
ย ย ย ย </div>`;
ย ย }).join('');

ย ย // 2. Nรบt Berry (Nแบฟu cรณ)
ย ย let berryHtml = '';
ย ย if(!activeBuffs.berry && (inventory['razz-berry'] || 0) > 0) {
ย ย ย ย berryHtml = `
ย ย ย ย <div class="ball-btn-horizontal" onclick="useItem('razz-berry')" style="border-bottom: 2px solid #e91e63">
ย ย ย ย ย ย <img src="${URL_ITEMS}razz-berry.png">
ย ย ย ย ย ย <span style="color:#e91e63">Buff</span>
ย ย ย ย </div>`;
ย ย }

ย ย // 3. Nรบt Chแบกy (Luรดn hiแปn)
ย ย let runHtml = `
ย ย <div class="ball-btn-horizontal" onclick="run()" style="border-bottom: 2px solid #7f8c8d; background: rgba(255,255,255,0.05)">
ย ย ย ย <span style="font-size:1.6em; line-height:1">๐</span>
ย ย ย ย <span style="color:#bbb">Run</span>
ย ย </div>`;

ย ย // 4. Gom tแบฅt cแบฃ vรo thanh ngang (Flex container)
ย ย controls.innerHTML = `
ย ย ย ย <div class="hunt-controls-bar">
ย ย ย ย ย ย ${ballsHtml}
ย ย ย ย ย ย ${berryHtml}
ย ย ย ย ย ย ${runHtml}
ย ย ย ย </div>
ย ย `;
}
ย ย // --- Hแป THแปNG BแบฎT POKEMON ฤฦN GIแบขN (SAFARI STYLE) ---

// --- LOGIC NรM BรNG MแปI (FIX Tแปถ Lแป) ---
// Biแบฟn lฦฐu แบฃnh gแปc cแปงa Pokemon ฤแป nแบฟu bแบฏt hแปฅt thรฌ hiแปn lแบกi
let originalEnemyImg = "";ย

function catchAttempt(ballType) {
ย ย if ((inventory[ballType] || 0) <= 0) return alert("Hแบฟt bรณng loแบกi nรy!");
ย ยย
ย ย inventory[ballType]--;ย
ย ย saveGame();
ย ย renderBattleControls();

ย ย let p = currentWild;
ย ย let rate = p.catchRate || 255;ย

ย ย // A. TรM แบขNH ฤANG HIแปN THแป
ย ย const enemyImg = document.getElementById('active-wild-sprite');
ย ยย
ย ย if (enemyImg) {
ย ย ย ย // Lฦฐu แบฃnh gแปc
ย ย ย ย if(!originalEnemyImgSrc) originalEnemyImgSrc = enemyImg.src;ย
ย ย ย ยย
ย ย ย ย // Tรฌm แบฃnh quแบฃ bรณng tฦฐฦกng แปฉng
ย ย ย ย let ballItem = SHOP_DB.find(i => i.id === ballType);
ย ย ย ย let ballImgSrc = URL_ITEMS + (ballItem ? ballItem.img : 'poke-ball.png');
ย ย ย ยย
ย ย ย ย // ฤแปi แบฃnh
ย ย ย ย enemyImg.src = ballImgSrc;
ย ย ย ย enemyImg.style.width = "60px";ย
ย ย ย ย enemyImg.style.marginTop = "20px";ย
ย ย }

ย ย // B. TรNH Tแปถ Lแป
ย ย let ballMult = 1;
ย ย if (ballType === 'great-ball') ballMult = 1.5;
ย ย if (ballType === 'ultra-ball') ballMult = 2.0;
ย ย if (ballType === 'master-ball') ballMult = 255;

ย ย let buffMult = activeBuffs.berry ? 1.5 : 1.0;
ย ย let chance = (rate * ballMult * buffMult) / 255;
ย ย if(streakBonus) chance += (streakBonus * 0.05);

ย ย log(`<i>Bแบกn nรฉm ${ballType.replace('-', ' ')}...</i>`);

ย ย let isCaught = (chance >= 1 || Math.random() < chance);

ย ย // C. GแปI HIแปU แปจNG LแบฎC
ย ย setTimeout(() => {
ย ย ย ย processVisualShake(isCaught, 1);
ย ย }, 500);
}
function captureSuccess() {
ย ย if (!currentWild) return;
ย ย // 1. Hiแปu แปฉng รขm thanh
ย ย playSFX('catch');
ย ยย
ย ย let xpGain = 10;
ย ย if (currentWild.baseXp > 200) xpGain += 20;
ย ย if (currentWild.isShiny) xpGain += 40;
ย ย if (currentWild.isShadow || currentWild.isRainbow) xpGain += 50;
ย ยย
ย ย addTrainerXp(xpGain);ย
ย ย log(`<span style="color:#0984e3; font-weight:bold">+${xpGain} Trainer XP</span>`);
ย ย // 2. Thรชm vรo Pokedex & Tรบi
ย ย let isNew = !pokedex.has(currentWild.id);
ย ย pokedex.add(currentWild.id);
ย ย myBag.push(currentWild);

ย ย // 3. Tรญnh tiแปn thฦฐแปng
ย ย let m = 100 + (currentWild.iv * 5); // Tiแปn cฦก bแบฃn theo IV
ย ย if (currentWild.isShiny) m *= 5;ย ย // Shiny nhรขn 5 tiแปn

ย ย // Bonus Amulet Coin (nแบฟu cรณ)
ย ย let amulets = inventory['amulet-coin'] || 0;
ย ย if(amulets > 10) amulets = 10;
ย ย let bonus = Math.floor(m * (amulets * 0.05));

ย ย // Reset Berry nแบฟu cรณ dรนng
ย ย if(activeBuffs.berry) { activeBuffs.berry = false; }

ย ย coins += m + bonus;
ย ย userStats.catches++;
ย ย if (currentWild.isShiny) userStats.shinies++;

ย ย // 4. Lฦฐu game & Cแบญp nhแบญt nhiแปm vแปฅ hรng ngรy
ย ย if(typeof updateQuestProgress === "function") updateQuestProgress('catch', 1);
ย ย incrementEggSteps();
ย ย saveGame();
ย ย updateStats();

ย ย // 5. Thรดng bรกo kแบฟt quแบฃ ฤแบนp mแบฏt
ย ย let newBadge = isNew ? `<span style="background:#e67e22; color:white; padding:2px 5px; border-radius:3px; animation:pulse 1s infinite">NEW!</span>` : "";
ย ยย
ย ย log(`<div style="border:2px solid #3ba55c; padding:10px; border-radius:5px; margin-top:5px; background:rgba(59, 165, 92, 0.1)">
ย ย ย ย <h3 style="color:#3ba55c; margin:0">โจ GOTCHA!</h3>
ย ย ย ย <div style="margin:5px 0">ฤรฃ bแบฏt ฤฦฐแปฃc <b>${currentWild.name}</b> ${newBadge}</div>
ย ย ย ย <div style="font-size:0.9em; color:#f1c40f">+${m+bonus} Coins</div>
ย ย </div>`);

ย ยย

ย ย // 6. Dแปn dแบนp vร vแป Menu
ย ย currentWild = null;
ย ย showMenu();
}
// --- HรM Xแปฌ Lร HIแปU แปจNG LแบฎC BรNG (ฤร SแปฌA LแปI ฤฦ) ---
function processVisualShake(success, shakeCount) {
ย ย const ballElement = document.getElementById('active-wild-sprite');
ย ย if(!ballElement) return;
ย ยย
ย ย // 1. Reset Animation (Kแปน thuแบญt Force Reflow ฤแป trรกnh bแป ฤฦก animation)
ย ย ballElement.classList.remove('shaking');
ย ย void ballElement.offsetWidth; // Dรฒng nรy cแปฑc quan trแปng: Buแปc trรฌnh duyแปt vแบฝ lแบกi
ย ย ballElement.classList.add('shaking');ย
ย ยย
ย ย // (Optional) Thรชm tiแบฟng lแบฏc nแบฟu bแบกn cรณ file รขm thanh
ย ย // playSFX('shake');ย

ย ย // 2. Xแปญ lรฝ Logic: Lแบฏc tiแบฟp hay Bung bรณng?
ย ย if (success) {
ย ย ย ย // --- TRฦฏแปNG HแปขP: BแบฎT DรNH ---
ย ย ย ย if (shakeCount < 3) {
ย ย ย ย ย ย // Chฦฐa ฤแปง 3 lแบงn lแบฏc -> Lแบฏc tiแบฟp sau 1 giรขy
ย ย ย ย ย ย log(`<span style="color:#bbb">... Lแบฏc (${shakeCount})...</span>`);
ย ย ย ย ย ย setTimeout(() => { processVisualShake(true, shakeCount + 1); }, 1000);ย
ย ย ย ย } else {
ย ย ย ย ย ย // ฤรฃ lแบฏc ฤแปง 3 lแบงn -> CHรC MแปชNG!
ย ย ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย ย ย ballElement.classList.remove('shaking');
ย ย ย ย ย ย ย ย ballElement.classList.add('caught-anim'); // Hiแปu แปฉng sรกng ฤรจn
ย ย ย ย ย ย ย ย captureSuccess(); // Gแปi hรm nhแบญn thฦฐแปng
ย ย ย ย ย ย ย ย originalEnemyImgSrc = ""; // Reset แบฃnh gแปc
ย ย ย ย ย ย }, 600);
ย ย ย ย }
ย ย } else {
ย ย ย ย // --- TRฦฏแปNG HแปขP: BแบฎT TRฦฏแปขT ---
ย ย ย ย // Logic hแปi hแปp: 50% cฦก hแปi lแบฏc thรชm cรกi nแปฏa ฤแป lแปซa ngฦฐแปi chฦกi
ย ย ย ย // Nแบฟu bแบกn muแปn nรณ luรดn lแบฏc nhiแปu, hรฃy tฤng sแป 0.5 lรชn (vรญ dแปฅ 0.8)
ย ย ย ย let keepShaking = Math.random() < 0.5;ย

ย ย ย ย if (shakeCount < 3 && keepShaking) {
ย ย ย ย ย ย // Lแปซa tรฌnh: Lแบฏc tiแบฟp dรน sแบฝ trฦฐแปฃt
ย ย ย ย ย ย log(`<span style="color:#bbb">... Lแบฏc (${shakeCount})...</span>`);
ย ย ย ย ย ย setTimeout(() => { processVisualShake(false, shakeCount + 1); }, 1000);
ย ย ย ย } else {
ย ย ย ย ย ย // Bung lแปฅa: Bรณng bแบญt ra
ย ย ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย ย ย ballElement.classList.remove('shaking');
ย ย ย ย ย ย ย ย resetEnemySprite(); // Trแบฃ lแบกi hรฌnh Pokemon
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย log(`<span style="color:#ed4245; font-weight:bold">Bรณng bแบญt ra!</span>`);
ย ย ย ย ย ย ย ย activeBuffs.berry = false;
ย ย ย ย ย ย ย ย updateStats();
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // Tแปท lแป bแป chแบกy sau khi bung bรณng (25%)
ย ย ย ย ย ย ย ย if (Math.random() < 0.25) {
ย ย ย ย ย ย ย ย ย ย setTimeout(() => {
ย ย ย ย ย ย ย ย ย ย ย ย log(`๐จ <b>${currentWild.name}</b> ฤรฃ bแป chแบกy!`);
ย ย ย ย ย ย ย ย ย ย ย ย currentWild = null;
ย ย ย ย ย ย ย ย ย ย ย ย streakBonus = 0;
ย ย ย ย ย ย ย ย ย ย ย ย showMenu();
ย ย ย ย ย ย ย ย ย ย }, 1000);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }, 600);
ย ย ย ย }
ย ย }
}

// --- 4. HรM TRแบข LแบI แบขNH GแปC (Khi bแบฏt hแปฅt) ---
function resetEnemySprite() {
ย ย const enemyImg = document.getElementById('active-wild-sprite');
ย ย if(enemyImg && originalEnemyImgSrc) {
ย ย ย ย enemyImg.src = originalEnemyImgSrc;
ย ย ย ย enemyImg.style.width = "";ย
ย ย ย ย enemyImg.style.marginTop = "";ย
ย ย ย ย originalEnemyImgSrc = "";
ย ย }
}

// --- 5. Hแป THแปNG รM THANH (Fix lแปi Console ฤแป) ---
function playSFX(type) {
ย ย if(isMuted) return;
ย ย let src = "";
ย ย if(type === 'levelup') src = "https://raw.githubusercontent.com/PokeAPI/cries/main/cries/pokemon/latest/132.ogg";
ย ย if(type === 'catch') src = "https://raw.githubusercontent.com/PokeAPI/cries/main/cries/pokemon/latest/25.ogg";
ย ยย
ย ย if(src) {
ย ย ย ย let a = new Audio(src);
ย ย ย ย a.volume = 0.1;
ย ย ย ย a.play().catch(e => { console.warn("Lแปi SFX (bแป qua):", e); });
ย ย }
}

function playCry(id) {
ย ย if(isMuted) return;
ย ย let audio = new Audio(`https://raw.githubusercontent.com/PokeAPI/cries/main/cries/pokemon/latest/${id}.ogg`);
ย ย audio.volume = 0.15;
ย ย audio.play().catch(e => { console.warn("Lแปi Cry (bแป qua):", e); });
}
ย ย // --- SแปฌA LแบI HรM DรNG ITEM (Cร HIแปU แปจNG) ---
function useItem(id) {
ย ย // 1. Kiแปm tra sแป lฦฐแปฃng
ย ย if ((inventory[id] || 0) <= 0) return;

ย ย // 2. Trแปซ ฤแป
ย ย inventory[id]--;
ย ย saveGame();

ย ย // 3. Xแปญ lรฝ hiแปu แปฉng Berry
ย ย if (id === 'razz-berry') {
ย ย ย ย activeBuffs.berry = true;
ย ย ย ยย
ย ย ย ย // Log thรดng bรกo mรu hแปng cho dแป thแบฅy
ย ย ย ย log(`<div style="color:#e91e63; background:rgba(233, 30, 99, 0.1); padding:5px; border-radius:5px; border:1px solid #e91e63">
ย ย ย ย ย ย ๐ <b>ฤรฃ cho ฤn Razz Berry!</b><br>
ย ย ย ย ย ย <i>Pokemon thรญch nรณ! Tแป lแป bแบฏt tฤng gแบฅp 1.5 lแบงn.</i>
ย ย ย ย </div>`);

ย ย ย ย // --- VISUAL: LรM POKEMON PHรT SรNG MรU HแปNG ---
ย ย ย ย const pokeSprite = document.getElementById('active-wild-sprite');
ย ย ย ย if(pokeSprite) {
ย ย ย ย ย ย // Thรชm hiแปu แปฉng bรณng ฤแป mรu hแปng (Pink Glow)
ย ย ย ย ย ย pokeSprite.style.filter = "drop-shadow(0 0 15px #e91e63)";
ย ย ย ย ย ยย
ย ย ย ย ย ย // Hiแปu แปฉng nhรบn nhแบฃy 1 cรกi thแป hiแปn sแปฑ vui vแบป
ย ย ย ย ย ย pokeSprite.animate([
ย ย ย ย ย ย ย ย { transform: 'translateY(0)' },
ย ย ย ย ย ย ย ย { transform: 'translateY(-10px)' },
ย ย ย ย ย ย ย ย { transform: 'translateY(0)' }
ย ย ย ย ย ย ], { duration: 300 });
ย ย ย ย }
ย ย }

ย ย // 4. Xแปญ lรฝ hiแปu แปฉng khรกc (Lucky Egg, Incense...)
ย ย if (id === 'lucky-egg') {
ย ย ย ย activeBuffs.egg = true;
ย ย ย ย alert("ฤรฃ dรนng Lucky Egg! x2 Vรng nhแบญn ฤฦฐแปฃc.");
ย ย }
ย ยย
ย ย if (id === 'incense') {
ย ย ย ย log("๐จ ฤแปt hฦฐฦกng trแบงm... Pokemon mแปi ฤang ฤแบฟn!");
ย ย ย ย spawnPokemon();
ย ย ย ย return; // Spawn mแปi nรชn khรดng cแบงn updateStats แป dฦฐแปi ngay
ย ย }

ย ย // 5. Cแบญp nhแบญt giao diแปn
ย ย updateStats();
ย ย renderBattleControls(); // Nรบt Berry sแบฝ แบฉn ฤi sau khi dรนng
}

ย ย function openBattleModal(idx) {
ย ย ย ย selectedBattleIdx = idx; let p = myBag[idx];
ย ย ย ย document.getElementById('battle-my-poke').innerText = `${p.name} (Lv.${p.level})`;
ย ย ย ย document.getElementById('battle-select-screen').style.display = 'block';
ย ย ย ย document.getElementById('battle-combat-screen').style.display = 'none';
ย ย ย ยย
ย ย ย ย let gymData = GYM_DB[gymProgress] || {name: "All Cleared", type: "none"};
ย ย ย ย const gymBtn = document.getElementById('gym-btn');
ย ย ย ย if(gymProgress < GYM_DB.length) { gymBtn.innerHTML = `<span>HARD: ${gymData.name} (${gymData.type.toUpperCase()})</span> <span>Badge: ${gymData.badge}</span>`; gymBtn.disabled = false; } else { gymBtn.innerHTML = `<span>CHAMPION! ฤรฃ thแบฏng hแบฟt Gym.</span>`; gymBtn.disabled = true; }
ย ย ย ย document.getElementById('battle-modal').style.display = 'flex';
ย ย }
ย ย function closeBattle() { document.getElementById('battle-modal').style.display = 'none'; }

ย ย // --- SMART AI SYSTEM ---
ย ย function chooseBestMove(attacker, defender) {
ย ย ย ย let moves = attacker.moves;
ย ย ย ย let bestMoveIdx = 0;
ย ย ย ย let bestScore = -9999;

ย ย ย ย moves.forEach((move, index) => {
ย ย ย ย ย ย if(!move) return;
ย ย ย ย ย ย let score = 0;

ย ย ย ย ย ย // 1. Tรญnh sรกt thฦฐฦกng dแปฑ kiแบฟn
ย ย ย ย ย ย if(move.pwr > 0) {
ย ย ย ย ย ย ย ย let typeMod = getEffectiveness(move.type, defender.types);
ย ย ย ย ย ย ย ย // ฦฏu tiรชn chiรชu siรชu hiแปu quแบฃ
ย ย ย ย ย ย ย ย if(typeMod > 1) score += 50;
ย ย ย ย ย ย ย ย if(typeMod < 1) score -= 30;
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // ฦฏu tiรชn Priority nแบฟu ฤแปch cรฒn รญt mรกu (ฤแป kแบฟt liแปu)
ย ย ย ย ย ย ย ย if(move.priority > 0 && defender.hp < defender.maxHp * 0.2) score += 100;
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย score += move.pwr;ย
ย ย ย ย ย ย }

ย ย ย ย ย ย // 2. Logic Status (Chiแบฟn thuแบญt)
ย ย ย ย ย ย if(move.cat === 'status') {
ย ย ย ย ย ย ย ย // ฤแปซng dรนng status nแบฟu ฤแปch ฤรฃ dรญnh status rแปi
ย ย ย ย ย ย ย ย if(defender.status) {
ย ย ย ย ย ย ย ย ย ย score -= 500;ย
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย score += 40; // Khuyแบฟn khรญch dรนng status ฤแบงu trแบญn
ย ย ย ย ย ย ย ย ย ย if(move.status === 'slp') score += 20; // Ngแปง mแบกnh hฦกn
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }

ย ย ย ย ย ย // 3. Logic Buff/Debuff
ย ย ย ย ย ย if(move.cat === 'stat') {
ย ย ย ย ย ย ย ย if(move.target === 'self') {
ย ย ย ย ย ย ย ย ย ย // ฤแปซng buff nแบฟu mรกu giแบฅy quรก
ย ย ย ย ย ย ย ย ย ย if(attacker.hp < attacker.maxHp * 0.4) score -= 50;
ย ย ย ย ย ย ย ย ย ย else if(attacker.stages[move.stat] < 2) score += 30;ย
ย ย ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย ย ย // Debuff ฤแปch
ย ย ย ย ย ย ย ย ย ย score += 20;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย // Random nhแบน ฤแป AI khรดng quรก cแปฉng nhแบฏc
ย ย ย ย ย ย score += Math.random() * 10;

ย ย ย ย ย ย if(score > bestScore) {
ย ย ย ย ย ย ย ย bestScore = score;
ย ย ย ย ย ย ย ย bestMoveIdx = index;
ย ย ย ย ย ย }
ย ย ย ย });

ย ย ย ย return moves[bestMoveIdx]; // Trแบฃ vแป object move
ย ย }
ย ยย
ย ย async function startBattle(difficulty) {
ย ย ย ย let p = myBag[selectedBattleIdx];
ย ย ย ย ensureDataIntegrity(p);ย
ย ย ย ย if(p.hp <= 0 && !isNaN(p.hp)) return alert("Pokemon nรy ฤรฃ ngแบฅt! Hรฃy hแปi mรกu tแบกi Center.");
ย ย ย ยย
ย ย ย ย document.getElementById('battle-select-screen').style.display = 'none';
ย ย ย ย document.getElementById('battle-combat-screen').style.display = 'flex';
ย ย ย ยย
ย ย ย ย // --- CแบคU HรNH ฤแป KHร ---
ย ย ย ย let enemyName = "Wild Pokemon";ย
ย ย ย ย let enemySprite = "";ย
ย ย ย ย let enemyLevel = 1;ย
ย ย ย ย let enemyTypes = ['normal'];
ย ย ย ย let enemyIv = 5;
ย ย ย ย let isBoss = false;

ย ย ย ย // Xแปฌ Lร LOGIC TแบO ฤแปCH
ย ย ย ย let id = 1;
ย ย ย ย let data = null;
ย ย ย ย let stats = {};

ย ย ย ย if(difficulty === 'easy') {
ย ย ย ย ย ย // EASY: Random, nhฦฐng trรกnh Legendary, Level thแบฅp
ย ย ย ย ย ย let valid = false;
ย ย ย ย ย ย while(!valid) {
ย ย ย ย ย ย ย ย id = Math.floor(Math.random() * 649) + 1;
ย ย ย ย ย ย ย ย // Nแบฟu trรบng Legendary thรฌ random lแบกi
ย ย ย ย ย ย ย ย if(!LEGENDARY_IDS.includes(id)) valid = true;ย
ย ย ย ย ย ย }
ย ย ย ย ย ย let res = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);ย
ย ย ย ย ย ย data = await res.json();
ย ย ย ย ย ยย
ย ย ย ย ย ย enemyName = data.name.toUpperCase();
ย ย ย ย ย ย enemyLevel = Math.max(1, p.level - 2); // Thแบฅp hฦกn ngฦฐแปi chฦกi 2 cแบฅp
ย ย ย ย ย ย enemyIv = Math.floor(Math.random() * 6); // IV tแปซ 0-5 (Yแบฟu)
ย ย ย ย ย ยย
ย ย ย ย } else if(difficulty === 'medium') {
ย ย ย ย ย ย // MEDIUM: Random thoแบฃi mรกi, Level ngang bแบฑng
ย ย ย ย ย ย id = Math.floor(Math.random() * 649) + 1;
ย ย ย ย ย ย let res = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);ย
ย ย ย ย ย ย data = await res.json();
ย ย ย ย ย ยย
ย ย ย ย ย ย enemyName = `Trainer's ${data.name.toUpperCase()}`;
ย ย ย ย ย ย enemyLevel = p.level; // Ngang cแบฅp
ย ย ย ย ย ย enemyIv = 15; // IV Trung bรฌnh
ย ย ย ย ย ย } else if (difficulty === 'tower') {
ย ย ย ย ย ย // --- LOGIC TOWER: ฤแปch mแบกnh dแบงn ---
ย ย ย ย ย ย isBoss = false; // Mแบทc ฤแปnh khรดng phแบฃi boss to (trแปซ tแบงng 10, 20...)
ย ย ย ย ย ยย
ย ย ย ย ย ย // Mแปi 10 tแบงng gแบทp Boss (Legendary hoแบทc Evolved)
ย ย ย ย ย ย let isTowerBossLevel = (towerData.floor % 10 === 0);
ย ย ย ย ย ยย
ย ย ย ย ย ย // Random ID
ย ย ย ย ย ย if (isTowerBossLevel) {
ย ย ย ย ย ย ย ย // Tแบงng boss: Random Legend hoแบทc cแบฅp 3
ย ย ย ย ย ย ย ย id = LEGENDARY_IDS[Math.floor(Math.random() * LEGENDARY_IDS.length)];
ย ย ย ย ย ย ย ย enemyName = `TOWER KEEPER ${towerData.floor}`;
ย ย ย ย ย ย ย ย isBoss = true; // ฤแป dรนng แบฃnh ฤแบนp vร buff chแป sแป
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย id = Math.floor(Math.random() * 649) + 1;
ย ย ย ย ย ย ย ย enemyName = `Tower Guardian`;
ย ย ย ย ย ย }

ย ย ย ย ย ย // Fetch dแปฏ liแปu
ย ย ย ย ย ย let res = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);
ย ย ย ย ย ย data = await res.json();

ย ย ย ย ย ย // Tรญnh Level: 9 + Tแบงng (Tแบงng 1 -> Lv 10, Tแบงng 100 -> Lv 109)
ย ย ย ย ย ย enemyLevel = 9 + towerData.floor;
ย ย ย ย ย ยย
ย ย ย ย ย ย // IV tฤng dแบงn: Tแบงng 1 (IV 5) -> Tแบงng 100 (IV 31)
ย ย ย ย ย ย enemyIv = Math.min(31, Math.floor(towerData.floor / 3));ย
ย ย ย ยย
ย ย ย ย ย ยย
ย ย ย ย } else {
ย ย ย ย ย ย // HARD (GYM): ฤรบng hแป, Level cao, Max IV, Buff chแป sแป
ย ย ย ย ย ย isBoss = true;
ย ย ย ย ย ย let gymData = GYM_DB[gymProgress] || {name: "Champion", type: "dragon"};
ย ย ย ย ย ยย
ย ย ย ย ย ย // Tรฌm Pokemon ฤรบng hแป cแปงa Gym (Thแปญ 5 lแบงn, nแบฟu khรดng ra thรฌ lแบฅy ฤแบกi ฤแป ฤแปก lag)
ย ย ย ย ย ย let foundType = false;
ย ย ย ย ย ย let attempts = 0;
ย ย ย ย ย ย while(!foundType && attempts < 8) {
ย ย ย ย ย ย ย ย id = Math.floor(Math.random() * 649) + 1;
ย ย ย ย ย ย ย ย let res = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);
ย ย ย ย ย ย ย ย data = await res.json();
ย ย ย ย ย ย ย ย let types = data.types.map(t=>t.type.name);
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // Nแบฟu Pokemon cรณ hแป trรนng vแปi Gym HOแบถC lร vรฒng cuแปi
ย ย ย ย ย ย ย ย if(types.includes(gymData.type) || gymProgress >= 8) {
ย ย ย ย ย ย ย ย ย ย foundType = true;
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย ย ย attempts++;
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย enemyName = `${gymData.name}'s ${data.name.toUpperCase()}`;
ย ย ย ย ย ย enemyLevel = p.level + 5; // Cao hฦกn 5 cแบฅp
ย ย ย ย ย ย enemyIv = 31; // Max IV
ย ย ย ย }

ย ย ย ย // Lแบฅy Sprite vร Stats tแปซ data ฤรฃ fetch
ย ย ย ย enemySprite = data.sprites.front_default;
ย ย ย ย if(isBoss) enemySprite = data.sprites.other['official-artwork'].front_default || data.sprites.front_default; // Boss dรนng แบฃnh ฤแบนp
ย ย ย ยย
ย ย ย ย enemyTypes = data.types.map(t=>t.type.name);
ย ย ย ย data.stats.forEach(s => stats[s.stat.name] = s.base_stat);

ย ย ย ย // Tแบกo Object Enemy
ย ย ย ย let enemy = {
ย ย ย ย ย ย id: data.id, // Lฦฐu ID ฤแป dรนng cho tiแบฟng kรชu (Audio)
ย ย ย ย ย ย name: enemyName, level: enemyLevel, types: enemyTypes, img: enemySprite, iv: enemyIv,
ย ย ย ย ย ย baseHp: stats['hp'], baseAtk: stats['attack'], baseDef: stats['defense'],
ย ย ย ย ย ย baseSpA: stats['special-attack'], baseSpD: stats['special-defense'], baseSpd: stats['speed']
ย ย ย ย };

ย ย ย ย // Tรญnh toรกn chแป sแป
ย ย ย ย recalcStats(enemy);ย

ย ย ย ย assignMoves(enemy);
ย ย ย ย // LOGIC BOSS: Tฤng thรชm 20% chแป sแป sau khi tรญnh toรกn ฤแป lรm Trรนm
ย ย ย ย if(isBoss) {
ย ย ย ย ย ย enemy.maxHp = Math.floor(enemy.maxHp * 1.2);
ย ย ย ย ย ย enemy.atk = Math.floor(enemy.atk * 1.2);
ย ย ย ย ย ย enemy.def = Math.floor(enemy.def * 1.2);
ย ย ย ย ย ย enemy.spA = Math.floor(enemy.spA * 1.2);
ย ย ย ย ย ย enemy.spD = Math.floor(enemy.spD * 1.2);
ย ย ย ย }
ย ย ย ยย
ย ย ย ย enemy.hp = enemy.maxHp; // Hแปi ฤแบงy mรกu

ย ย ย ย // Cแบญp nhแบญt State Battle
ย ย ย ย battleState = {
ย ย ย ย ย ย active: true, finished: false,
ย ย ย ย ย ย player: p,
ย ย ย ย ย ย enemy: enemy,
ย ย ย ย ย ย turn: 0, difficulty: difficulty,
ย ย ย ย ย ย rewards: {ย
ย ย ย ย ย ย ย ย xp: difficulty==='easy'? 80 : (difficulty==='medium'? 250 : 800),ย
ย ย ย ย ย ย ย ย coin: difficulty==='easy'? 30 : (difficulty==='medium'? 150 : 1000)ย
ย ย ย ย ย ย }
ย ย ย ย };

ย ย ย ย // Cแบญp nhแบญt giao diแปn
ย ย ย ย document.getElementById('enemy-name').innerText = battleState.enemy.name;
ย ย ย ย document.getElementById('enemy-lv').innerText = `Lv.${battleState.enemy.level}`;
ย ย ย ย document.getElementById('enemy-sprite').src = battleState.enemy.img;
ย ย ย ย document.getElementById('player-name').innerText = battleState.player.name;
ย ย ย ย document.getElementById('player-sprite').src = battleState.player.img || `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/back/${battleState.player.id}.png`;
ย ย ย ยย
ย ย ย ย updateBattleUI();
ย ย ย ยย
ย ย ย ย // Log & Audio
ย ย ย ย logBattle(`<b>${enemyName}</b> xuแบฅt hiแปn! (HP: ${enemy.maxHp})`);
ย ย ย ยย
ย ย ย ย // --- AUDIO TRIGGER (Nแบฟu ฤรฃ thรชm code Audio แป bฦฐแปc trฦฐแปc) ---
ย ย ย ย if(typeof playCry === "function") playCry(enemy.id);ย
ย ย ย ย playBGM('battle');
ย ย ย ย // -----------------------------------------------------------
ย ย ย ยย
ย ย ย ย document.getElementById('battle-main-menu').style.display = 'grid';
ย ย ย ย document.getElementById('battle-move-menu').style.display = 'none';
ย ย ย ย document.getElementById('battle-end-btn').style.display = 'none';
ย ย ย ย document.getElementById('potion-count').innerText = (inventory['potion'] || 0);
ย ย }

ย ย function showMoveMenu() {
ย ย ย ย if(!battleState.active) return;
ย ย ย ย document.getElementById('battle-main-menu').style.display = 'none';
ย ย ย ย document.getElementById('battle-move-menu').style.display = 'grid';
ย ย ย ยย
ย ย ย ย let moves = battleState.player.moves;
ย ย ย ย for(let i=0; i<4; i++) {
ย ย ย ย ย ย let btn = document.getElementById(`move-btn-${i}`);
ย ย ย ย ย ย if(moves[i]) {
ย ย ย ย ย ย ย ย let typeColor = TYPE_COLORS[moves[i].type] || '#fff';
ย ย ย ย ย ย ย ย let pwrText = moves[i].pwr ? moves[i].pwr : '-';
ย ย ย ย ย ย ย ย let catText = moves[i].cat === 'spe' ? '๐ฅ' : '๐';
ย ย ย ย ย ย ย ย btn.innerHTML = `<span class="move-name">${moves[i].name}</span><span class="move-type" style="font-size:0.8em">${catText} ${moves[i].type} | ${pwrText}</span>`;
ย ย ย ย ย ย ย ย btn.style.borderColor = typeColor;
ย ย ย ย ย ย ย ย btn.style.color = typeColor;
ย ย ย ย ย ย ย ย btn.style.visibility = 'visible';
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย btn.style.visibility = 'hidden';
ย ย ย ย ย ย }
ย ย ย ย }
ย ย }

ย ย function hideMoveMenu() {
ย ย ย ย document.getElementById('battle-move-menu').style.display = 'none';
ย ย ย ย document.getElementById('battle-main-menu').style.display = 'grid';
ย ย }

ย ย function useMove(moveIdx) {
ย ย ย ย if(!battleState.active) return;
ย ย ย ยย
ย ย ย ย // 1. แบจn menu ngay lแบญp tแปฉc ฤแป trรกnh bแบฅm ฤรบp
ย ย ย ย hideMoveMenu();
ย ย ย ยย
ย ย ย ย // 2. Gแปi engine mแปi vแปi tham sแป lร INDEX (sแป thแปฉ tแปฑ 0,1,2,3)
ย ย ย ย // Lฦฐu รฝ: Hรm executeTurn giแป lร async, nhฦฐng แป ฤรขy ta gแปi khรดng cแบงn await
ย ย ย ย executeTurn('attack', moveIdx).catch(err => {
ย ย ย ย ย ย console.error("Lแปi Battle:", err);
ย ย ย ย ย ย alert("ฤรฃ xแบฃy ra lแปi trong trแบญn ฤแบฅu! Xem console (F12) ฤแป biแบฟt chi tiแบฟt.");
ย ย ย ย ย ย // Hiแปn lแบกi menu nแบฟu lแปi ฤแป khรดng bแป kแบนt
ย ย ย ย ย ย document.getElementById('battle-main-menu').style.display = 'grid';
ย ย ย ย ย ย document.getElementById('battle-main-menu').style.opacity = '1';
ย ย ย ย ย ย document.getElementById('battle-main-menu').style.pointerEvents = 'auto';
ย ย ย ย });
ย ย }

ย ย function updateBattleUI() {
ย ย ย ย let p = battleState.player;ย
ย ย ย ย let e = battleState.enemy;

ย ย ย ย // 1. Cแบญp nhแบญt Thanh Mรกu (HP Bar)
ย ย ย ย let pHpPct = Math.max(0, (p.hp / p.maxHp) * 100);
ย ย ย ย let eHpPct = Math.max(0, (e.hp / e.maxHp) * 100);
ย ย ย ยย
ย ย ย ย document.getElementById('player-hp-bar').style.width = pHpPct + '%';
ย ย ย ย document.getElementById('player-hp-bar').style.background = getHpColor(pHpPct);
ย ย ย ย let displayHP = isNaN(p.hp) ? 0 : Math.max(0, p.hp);
ย ย ย ย document.getElementById('player-hp-text').innerText = `${displayHP}/${p.maxHp}`;
ย ย ย ยย
ย ย ย ย document.getElementById('enemy-hp-bar').style.width = eHpPct + '%';
ย ย ย ย document.getElementById('enemy-hp-bar').style.background = getHpColor(eHpPct);

ย ย ย ย // 2. CแบฌP NHแบฌT TRแบNG THรI (Status Icons) - MแปI
ย ย ย ย // Gแปi hรm phแปฅ ฤแป vแบฝ lแบกi tรชn kรจm icon
ย ย ย ย renderStatusIcon(p, 'player-name');
ย ย ย ย renderStatusIcon(e, 'enemy-name');
ย ย }

ย ย // Hรm phแปฅ trแปฃ giรบp vแบฝ icon ฤแบนp hฦกn
ย ย function renderStatusIcon(pokemon, elementId) {
ย ย let el = document.getElementById(elementId);
ย ย if (!el) return;

ย ย let statusHtml = "";
ย ยย
ย ย // Chแป render nแบฟu status tแปn tแบกi (khรกc null/undefined)
ย ย if (pokemon.status) {
ย ย ย ย let color = 'gray';
ย ย ย ย let text = pokemon.status.toUpperCase();

ย ย ย ย if (pokemon.status === 'brn') { text = 'BRN'; color = '#e74c3c'; }
ย ย ย ย if (pokemon.status === 'par') { text = 'PAR'; color = '#f1c40f'; }
ย ย ย ย if (pokemon.status === 'slp') { text = 'SLP'; color = '#34495e'; }
ย ย ย ย if (pokemon.status === 'psn') { text = 'PSN'; color = '#9b59b6'; }

ย ย ย ย statusHtml = `<span style="background:${color}; color:white; font-size:0.7em; padding:1px 4px; border-radius:3px; margin-left:5px">${text}</span>`;
ย ย }
ย ยย
ย ย el.innerHTML = `${pokemon.name} ${statusHtml}`;
}

ย ย function logBattle(msg) {
ย ย ย ย let box = document.getElementById('battle-log');
ย ย ย ย box.innerHTML += `<div>${msg}</div>`;
ย ย ย ย box.scrollTop = box.scrollHeight;
ย ย }

ย ย function playerHeal() {
ย ย if(!battleState.active) return;
ย ยย
ย ย // Lแบฅy sแป lฦฐแปฃng thแปฑc tแบฟ tแปซ kho
ย ย let qty = inventory['potion'] || 0;

ย ย if(qty <= 0) {
ย ย ย ย return logBattle("โ Bแบกn ฤรฃ hแบฟt Potion! Hรฃy vรo Shop mua thรชm.");
ย ย }
ย ยย
ย ย // Gแปi lแปnh hแปi mรกu
ย ย executeTurn('heal', null);
}

ย ย function playerSkip() {ย
ย ย ย ย if(!battleState.active) return;
ย ย ย ย executeTurn('skip', null);ย
ย ย }
ย ย function playerRun() {
ย ย ย ย if(battleState.difficulty === 'hard') return logBattle("Khรดng thแป bแป chแบกy khแปi Gym!");
ย ย ย ย logBattle("ฤรฃ bแป chแบกy thรnh cรดng!");
ย ย ย ย endBattle(false);
ย ย }

ย ย // --- ADVANCED BATTLE ENGINE v3.0 ---
ย ย function getStageMulti(stage) {
ย ย ย ย if(stage >= 0) return (2 + stage) / 2;
ย ย ย ย return 2 / (2 + Math.abs(stage));
ย ย }

ย ย async function executeTurn(action, playerMoveIdx) {
ย ย ย ย document.getElementById('battle-main-menu').style.pointerEvents = 'none';ย
ย ย ย ย document.getElementById('battle-main-menu').style.opacity = '0.5';
ย ย ย ยย
ย ย ย ย let p = battleState.player;ย
ย ย ย ย let e = battleState.enemy;

ย ย ย ย // 1. Xรกc ฤแปnh chiรชu thแปฉc 2 bรชn dรนng
ย ย ย ย let pMove = null;
ย ย ย ย if(action === 'attack') pMove = p.moves[playerMoveIdx];
ย ย ย ย else if(action === 'heal') pMove = {name: 'Potion', priority: 6, isItem: true}; // Item ฦฐu tiรชn cao nhแบฅt
ย ย ย ย else if(action === 'skip') pMove = {name: 'Skipping', priority: 0, isSkip: true};

ย ย ย ย // AI chแปn chiรชu
ย ย ย ย let eMove = chooseBestMove(e, p);
ย ย ย ย if(!eMove.priority) eMove.priority = 0;
ย ย ย ย if(!pMove.priority) pMove.priority = 0;

ย ย ย ย // 2. Tรญnh Speed thแปฑc tแบฟ (Paralysis giแบฃm 50% Speed)
ย ย ย ย let pSpd = p.spd * getStageMulti(p.stages.spd) * (p.status === 'par' ? 0.5 : 1);
ย ย ย ย let eSpd = e.spd * getStageMulti(e.stages.spd) * (e.status === 'par' ? 0.5 : 1);

ย ย ย ย // 3. Xรกc ฤแปnh thแปฉ tแปฑ ฤรกnh (Priority > Speed)
ย ย ย ย let playerGoesFirst = false;
ย ย ย ย if (pMove.priority > eMove.priority) playerGoesFirst = true;
ย ย ย ย else if (pMove.priority < eMove.priority) playerGoesFirst = false;
ย ย ย ย else {
ย ย ย ย ย ย // Cรนng priority thรฌ so Speed
ย ย ย ย ย ย if (pSpd > eSpd) playerGoesFirst = true;
ย ย ย ย ย ย else if (pSpd < eSpd) playerGoesFirst = false;
ย ย ย ย ย ย else playerGoesFirst = Math.random() < 0.5; // Speed tie
ย ย ย ย }

ย ย ย ย // 4. Thแปฑc thi Turn
ย ย ย ย if(playerGoesFirst) {
ย ย ย ย ย ย await runMove(p, e, pMove, true); // Player ฤรกnh
ย ย ย ย ย ย if(e.hp > 0 && !battleState.finished) await runMove(e, p, eMove, false); // Enemy ฤรกnh
ย ย ย ย } else {
ย ย ย ย ย ย await runMove(e, p, eMove, false); // Enemy ฤรกnh
ย ย ย ย ย ย if(p.hp > 0 && !battleState.finished) await runMove(p, e, pMove, true); // Player ฤรกnh
ย ย ย ย }

ย ย ย ย // 5. Cuแปi lฦฐแปฃt: Sรกt thฦฐฦกng Burn/Poison
ย ย ย ย if(!battleState.finished) {
ย ย ย ย ย ย await applyStatusDamage(p);
ย ย ย ย ย ย if(e.hp > 0) await applyStatusDamage(e);
ย ย ย ย }

ย ย ย ย document.getElementById('battle-main-menu').style.pointerEvents = 'auto';
ย ย ย ย document.getElementById('battle-main-menu').style.opacity = '1';
ย ย ย ย checkWinCondition();
ย ย }

ย ย // --- HรM Xแปฌ Lร RA CHIรU (ฤร SแปฌA LแปI TARGET) ---
async function runMove(attacker, defender, move) {
ย ย // 1. Thรดng bรกo ra chiรชu
ย ย logBattle(`<b>${attacker.name}</b> dรนng <b>${move.name}</b>!`);

ย ย // 2. Kiแปm tra ฤแป chรญnh xรกc (Accuracy)
ย ย // Nแบฟu move.acc = 0 hoแบทc null thรฌ lร chiรชu tแบฅt trรบng (nhฦฐ Aerial Ace)
ย ย if (move.acc && move.acc < 100) {
ย ย ย ย if (Math.random() * 100 > move.acc) {
ย ย ย ย ย ย logBattle("โ Nhฦฐng chiรชu thแปฉc bแป trฦฐแปฃt!");
ย ย ย ย ย ย return;
ย ย ย ย }
ย ย }

ย ย // ====================================================
ย ย // TRฦฏแปNG HแปขP 1: CHIรU GรY SรT THฦฏฦNG (Vแบญt lรฝ / Phรฉp)
ย ย // ====================================================
ย ย if (move.cat === 'phy' || move.cat === 'spe') {
ย ย ย ยย
ย ย ย ย // A. Xรกc ฤแปnh chแป sแป Tแบฅn cรดng vs Phรฒng thแปง
ย ย ย ย let atkStat = (move.cat === 'phy') ? attacker.atk : attacker.spA;
ย ย ย ย let defStat = (move.cat === 'phy') ? defender.def : defender.spD;

ย ย ย ย // B. Tรญnh Damage cฦก bแบฃn (Cรดng thแปฉc Pokemon giแบฃn lฦฐแปฃc)
ย ย ย ย // Damage = (((2 * Level / 5 + 2) * Power * A / D) / 50 + 2)
ย ย ย ย let damage = Math.floor(((2 * attacker.level / 5 + 2) * move.pwr * (atkStat / defStat)) / 50 + 2);

ย ย ย ย // C. Tรญnh khแบฏc hแป (Type Effectiveness)
ย ย ย ย // Giแบฃ sแปญ bแบกn cรณ hรm getTypeEffectiveness, nแบฟu khรดng thรฌ mแบทc ฤแปnh lร 1
ย ย ย ย let multiplier = 1;
ย ย ย ย if (typeof getMultiplier === 'function') {
ย ย ย ย ย ย multiplier = getMultiplier(move.type, defender.types[0]);
ย ย ย ย ย ย if (defender.types[1]) {
ย ย ย ย ย ย ย ย multiplier *= getMultiplier(move.type, defender.types[1]);
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย // D. Tรญnh Critical Hit (Chรญ mแบกng - Tแป lแป 1/16)
ย ย ย ย let isCrit = Math.random() < 0.0625;
ย ย ย ย if (isCrit) {
ย ย ย ย ย ย damage *= 1.5;
ย ย ย ย ย ย multiplier *= 1; // Crit thฦฐแปng bแป qua giแบฃm thแปง, แป ฤรขy lรm ฤฦกn giแบฃn
ย ย ย ย }

ย ย ย ย // E. รp dแปฅng Multiplier vรo Damage
ย ย ย ย damage = Math.floor(damage * multiplier);
ย ย ย ย if (damage < 1) damage = 1; // Sรกt thฦฐฦกng tแปi thiแปu lร 1

ย ย ย ย // F. Trแปซ mรกu
ย ย ย ย defender.hp -= damage;
ย ย ย ย if (defender.hp < 0) defender.hp = 0;

ย ย ย ย // G. Hiแปn thแป thรดng bรกo
ย ย ย ย if (isCrit) logBattle("๐ฏ CHร MแบNG! (Critical Hit)");
ย ย ย ย if (multiplier > 1) logBattle("๐ฅ Siรชu hiแปu quแบฃ! (Super Effective)");
ย ย ย ย if (multiplier < 1 && multiplier > 0) logBattle("๐ก๏ธ Khรดng hiแปu quแบฃ lแบฏm...");
ย ย ย ย if (multiplier === 0) logBattle("๐ซ Khรดng cรณ tรกc dแปฅng!");

ย ย ย ย logBattle(`Mแบฅt <b style="color:red">${damage} HP</b>!`);
ย ย ย ยย
ย ย ย ย // Rung mรn hรฌnh nแบฟu damage to
ย ย ย ย if(damage > defender.maxHp / 4) {
ย ย ย ย ย ย let spriteId = defender === battleState.player ? 'player-sprite' : 'enemy-sprite';
ย ย ย ย ย ย let el = document.getElementById(spriteId);
ย ย ย ย ย ย if(el) {
ย ย ย ย ย ย ย ย el.classList.add('shake');
ย ย ย ย ย ย ย ย setTimeout(()=>el.classList.remove('shake'), 500);
ย ย ย ย ย ย }
ย ย ย ย }
ย ย }ย

ย ย // ====================================================
ย ย // TRฦฏแปNG HแปขP 2: CHIรU TRแบNG THรI (STATUS / HEAL)
ย ย // ====================================================
ย ย else if (move.cat === 'status') {
ย ย ย ยย
ย ย ย ย // A. NHรM HแปI MรU (Target = Attacker)
ย ย ย ย // Danh sรกch cรกc chiรชu hแปi mรกu phแป biแบฟn
ย ย ย ย const healingMoves = ['Recover', 'Roost', 'Soft-Boiled', 'Synthesis', 'Moonlight', 'Morning Sun', 'Slack Off'];
ย ย ย ยย
ย ย ย ย if (healingMoves.includes(move.name)) {
ย ย ย ย ย ย // Target lร CHรNH MรNH (Attacker) chแปฉ khรดng phแบฃi Defender
ย ย ย ย ย ย let healAmount = Math.floor(attacker.maxHp / 2);
ย ย ย ย ย ย attacker.hp += healAmount;
ย ย ย ย ย ย if (attacker.hp > attacker.maxHp) attacker.hp = attacker.maxHp;
ย ย ย ย ย ยย
ย ย ย ย ย ย logBattle(`๐ <b>${attacker.name}</b> tแปฑ hแปi phแปฅc sแปฉc khแปe! (+${healAmount} HP)`);
ย ย ย ย }ย
ย ย ย ยย
ย ย ย ย // B. NHรM GรY HIแปU แปจNG XแบคU (Target = Defender)
ย ย ย ย else if (move.status) {
ย ย ย ย ย ย if (defender.status) {
ย ย ย ย ย ย ย ย logBattle("Nhฦฐng ฤแปi thแปง ฤang bแป hiแปu แปฉng rแปi!");
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย // Gแปi hรm applyStatus (ฤแบฃm bแบฃo hรm nรy ฤรฃ fix nhฦฐ hฦฐแปng dแบซn trฦฐแปc)
ย ย ย ย ย ย ย ย if (typeof applyStatus === 'function') {
ย ย ย ย ย ย ย ย ย ย applyStatus(defender, move.status);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }ย
ย ย ย ยย
ย ย ย ย // C. CรC CHIรU STATUS KHรC (Splash, Teleport...)
ย ย ย ย else {
ย ย ย ย ย ย logBattle("Nhฦฐng khรดng cรณ gรฌ xแบฃy ra!");
ย ย ย ย }
ย ย }

ย ย // ====================================================
ย ย // TRฦฏแปNG HแปขP 3: CHIรU TฤNG/GIแบขM CHแป Sแป (STAT)
ย ย // ====================================================
ย ย else if (move.cat === 'stat' || move.stat) { // Hแป trแปฃ cแบฃ 2 kiแปu dแปฏ liแปu
ย ย ย ย // Xรกc ฤแปnh mแปฅc tiรชu:ย
ย ย ย ย // Nแบฟu API trแบฃ vแป target lร 'user' hoแบทc 'selected-pokemon-me' -> Buff cho bแบฃn thรขn
ย ย ย ย // Nแบฟu khรดng thรฌ mแบทc ฤแปnh lร Debuff ฤแปi thแปง
ย ย ย ยย
ย ย ย ย let target = defender; // Mแบทc ฤแปnh nhแบฏm vรo ฤแปch (nhฦฐ Growl, Tail Whip)
ย ย ย ย let isSelf = false;

ย ย ย ย // Kiแปm tra danh sรกch cรกc chiรชu Buff bแบฃn thรขn phแป biแบฟn
ย ย ย ย const selfBuffMoves = ['Swords Dance', 'Dragon Dance', 'Calm Mind', 'Bulk Up', 'Agility', 'Nasty Plot', 'Growth', 'Harden', 'Defense Curl'];
ย ย ย ยย
ย ย ย ย if (move.target === 'user' || selfBuffMoves.includes(move.name)) {
ย ย ย ย ย ย target = attacker;
ย ย ย ย ย ย isSelf = true;
ย ย ย ย }

ย ย ย ย let statName = move.stat; // atk, def, spA...
ย ย ย ย let stageChange = move.stage || 1;

ย ย ย ย // Logic tฤng/giแบฃm stage (Tแปi ฤa +6, Tแปi thiแปu -6)
ย ย ย ย if (!target.stages) target.stages = { atk:0, def:0, spA:0, spD:0, spe:0 }; // Khแปi tแบกo nแบฟu chฦฐa cรณ
ย ย ย ยย
ย ย ย ย if (!target.stages[statName]) target.stages[statName] = 0;

ย ย ย ย let currentStage = target.stages[statName];

ย ย ย ย if (currentStage >= 6 && stageChange > 0) {
ย ย ย ย ย ย logBattle(`${statName.toUpperCase()} cแปงa ${target.name} khรดng thแป tฤng thรชm!`);
ย ย ย ย } else if (currentStage <= -6 && stageChange < 0) {
ย ย ย ย ย ย logBattle(`${statName.toUpperCase()} cแปงa ${target.name} khรดng thแป giแบฃm thรชm!`);
ย ย ย ย } else {
ย ย ย ย ย ย target.stages[statName] += stageChange;
ย ย ย ย ย ยย
ย ย ย ย ย ย let text = "";
ย ย ย ย ย ย if (stageChange >= 2) text = "tฤng rแบฅt mแบกnh!";
ย ย ย ย ย ย else if (stageChange === 1) text = "tฤng lรชn!";
ย ย ย ย ย ย else if (stageChange === -1) text = "giแบฃm xuแปng!";
ย ย ย ย ย ย else if (stageChange <= -2) text = "giแบฃm rแบฅt mแบกnh!";
ย ย ย ย ย ยย
ย ย ย ย ย ย logBattle(`${statName.toUpperCase()} cแปงa <b>${target.name}</b> ฤรฃ ${text}`);
ย ย ย ย }
ย ย }

ย ย // 3. Cแบญp nhแบญt giao diแปn thanh mรกu ngay lแบญp tแปฉc
ย ย updateBattleUI();
}
function applyStatus(target, status) {
ย ย // ๐ KIแปM TRA QUAN TRแปNG: Nแบฟu khรดng cรณ status thรฌ dแปซng ngay
ย ย if (!status) return;ย

ย ย target.status = status;
ย ย let icon = "";
ย ยย
ย ย // Kiแปm tra tแปซng loแบกi
ย ย if(status === 'brn') icon = "๐ฅ Bแป BแปNG";
ย ย else if(status === 'par') icon = "โก Tร LIแปT";
ย ย else if(status === 'slp') icon = "๐ค ฤANG NGแปฆ";
ย ย else if(status === 'psn') icon = "โ๏ธ TRรNG ฤแปC";
ย ย else if(status === 'frz') icon = "โ๏ธ ฤรNG BฤNG";
ย ย else icon = status.toUpperCase(); // Fallback

ย ย logBattle(`<b>${target.name}</b> ฤรฃ bแป ${icon}!`);
ย ยย
ย ย // Cแบญp nhแบญt giao diแปn
ย ย let idName = target === battleState.player ? 'player-name' : 'enemy-name';
ย ย let el = document.getElementById(idName);
ย ยย
ย ย if (el) {
ย ย ย ย // Chแป viแบฟt hoa khi status chแบฏc chแบฏn tแปn tแบกi
ย ย ย ย el.innerHTML = `${target.name} <span style='background:red;color:white;font-size:0.7em;padding:1px 3px'>${status.toUpperCase()}</span>`;
ย ย }
}

ย ย async function applyStatusDamage(p) {
ย ย ย ย if(p.hp <= 0) return;
ย ย ย ย if(p.status === 'brn') {
ย ย ย ย ย ย let dmg = Math.floor(p.maxHp / 8); // Bแปng trแปซ 1/8 mรกu
ย ย ย ย ย ย p.hp -= dmg;
ย ย ย ย ย ย logBattle(`${p.name} bแป tแปn thฦฐฦกng do bแปng! -${dmg}`);
ย ย ย ย ย ย updateBattleUI();
ย ย ย ย }
ย ย }

ย ย // --- NEW DAMAGE CALCULATION ENGINE (GEN 5) ---
ย ย function calculateDamage(attacker, defender, move, typeMod) {
ย ย ย ย // 1. Determine Stats based on Move Category (Physical vs Special)
ย ย ย ย // Default to Physical if unknown
ย ย ย ย let isSpecial = move.cat === 'spe';
ย ย ย ย let atk = isSpecial ? attacker.spA : attacker.atk;
ย ย ย ย let def = isSpecial ? defender.spD : defender.def;
ย ย ย ยย
ย ย ย ย // 2. Level Factor
ย ย ย ย let levelFactor = ((2 * attacker.level) / 5) + 2;
ย ย ย ยย
ย ย ย ย // 3. Base Damage Formula
ย ย ย ย // Damage = ((((2 * Level / 5 + 2) * AttackStat * AttackPower / DefenseStat) / 50) + 2)
ย ย ย ย let baseDamage = ((levelFactor * move.pwr * (atk / def)) / 50) + 2;
ย ย ย ยย
ย ย ย ย // 4. Modifiers
ย ย ย ย // Critical Hit (1/16 chance = 6.25%) -> 1.5x damage
ย ย ย ย let isCrit = Math.random() < 0.0625;
ย ย ย ย let critMult = isCrit ? 1.5 : 1.0;
ย ย ย ยย
ย ย ย ย // Random Variance (0.85 to 1.00)
ย ย ย ย let randomMult = (Math.floor(Math.random() * 16) + 85) / 100;
ย ย ย ยย
ย ย ย ย // STAB (Same Type Attack Bonus) -> 1.5x if move type matches user type
ย ย ย ย let stab = 1.0;
ย ย ย ย if(attacker.types.includes(move.type)) stab = 1.5;
ย ย ย ยย
ย ย ย ย let finalDamage = Math.floor(baseDamage * typeMod * stab * critMult * randomMult);
ย ย ย ยย
ย ย ย ย // Return object to allow logging details
ย ย ย ย return { damage: Math.max(1, finalDamage), isCrit: isCrit, typeMod: typeMod, stab: stab };
ย ย }

ย ย async function doPlayerAction(action, move) {
ย ย ย ย if(battleState.player.hp <= 0) return;
ย ย ย ย let p = battleState.player; let e = battleState.enemy;
ย ย ย ยย
ย ย ย ย if(action === 'attack') {
ย ย ย ย ย ย let usedMove = move;
ย ย ย ย ย ย if(!move.pwr) { usedMove = {name: 'Struggle', type: 'normal', pwr: 50, cat: 'phy'}; }
ย ย ย ย ย ยย
ย ย ย ย ย ย logBattle(`<b>${p.name}</b> dรนng ${usedMove.name}!`);
ย ย ย ย ย ย let typeMod = getEffectiveness(usedMove.type, e.types);
ย ย ย ย ย ยย
ย ย ย ย ย ย let result = calculateDamage(p, e, usedMove, typeMod);
ย ย ย ย ย ยย
ย ย ย ย ย ย document.getElementById('player-sprite').style.transform = "translateX(20px)";
ย ย ย ย ย ย setTimeout(()=>document.getElementById('player-sprite').style.transform="translateX(0)", 200);
ย ย ย ย ย ยย
ย ย ย ย ย ย await sleep(500);
ย ย ย ย ย ย if(result.isCrit) logBattle(`<span style="color:#e74c3c;font-weight:bold">Chรญ mแบกng! (Crit)</span>`);
ย ย ย ย ย ย if(result.typeMod > 1) logBattle(`<span style="color:#f1c40f">Siรชu hiแปu quแบฃ!</span>`);
ย ย ย ย ย ย if(result.typeMod < 1) logBattle(`<span style="color:#aaa">Khรดng hiแปu quแบฃ...</span>`);
ย ย ย ย ย ยย
ย ย ย ย ย ย applyDamage(e, result.damage, 'enemy');
ย ย ย ย } else if (action === 'heal') {
ย ย ย ย ย ย inventory['potion']--;
ย ย ย ย ย ย let heal = 50;
ย ย ย ย ย ย if(isNaN(p.hp)) p.hp = 0;ย
ย ย ย ย ย ย p.hp = Math.min(p.maxHp, p.hp + heal);
ย ย ย ย ย ย logBattle(`<span style="color:#2ecc71">${p.name} hแปi ${heal} HP.</span>`);
ย ย ย ย ย ย updateBattleUI();
ย ย ย ย ย ย document.getElementById('potion-count').innerText = inventory['potion'];
ย ย ย ย ย ย await sleep(500);
ย ย ย ย } else {
ย ย ย ย ย ย logBattle(`${p.name} ฤang nghแป ngฦกi...`);
ย ย ย ย ย ย await sleep(500);
ย ย ย ย }
ย ย }

ย ย async function doEnemyAction() {
ย ย ย ย if(battleState.enemy.hp <= 0) return;
ย ย ย ย let p = battleState.player; let e = battleState.enemy;
ย ย ย ยย
ย ย ย ย let pool = MOVES_DB[e.types[0]] || MOVES_DB['normal'];
ย ย ย ย let move = pool[Math.floor(Math.random() * pool.length)];
ย ย ย ย // Fallback for enemy move
ย ย ย ย if(!move.cat) move.cat = 'phy';

ย ย ย ย logBattle(`ฤแปch dรนng ${move.name}!`);
ย ย ย ย let typeMod = getEffectiveness(move.type, p.types);
ย ย ย ย let result = calculateDamage(e, p, move, typeMod);
ย ย ย ยย
ย ย ย ย document.getElementById('enemy-sprite').style.transform = "translateX(-20px)";
ย ย ย ย setTimeout(()=>document.getElementById('enemy-sprite').style.transform="translateX(0)", 200);
ย ย ย ยย
ย ย ย ย await sleep(500);
ย ย ย ย if(result.isCrit) logBattle(`<span style="color:#e74c3c;font-weight:bold">ฤแปch ฤรกnh chรญ mแบกng!</span>`);
ย ย ย ย applyDamage(p, result.damage, 'player');
ย ย }

ย ย function getEffectiveness(atkType, defTypes) {
ย ย ย ย let mod = 1;
ย ย ย ย defTypes.forEach(dT => {
ย ย ย ย ย ย if(TYPE_ADVANTAGE[atkType] && TYPE_ADVANTAGE[atkType].includes(dT)) mod *= 2;
ย ย ย ย ย ย if(TYPE_ADVANTAGE[dT] && TYPE_ADVANTAGE[dT].includes(atkType)) mod *= 0.5;
ย ย ย ย });
ย ย ย ย return mod;
ย ย }

ย ย function applyDamage(target, dmg, who) {
ย ย ย ย if(isNaN(target.hp)) target.hp = target.maxHp;ย
ย ย ย ย target.hp -= dmg;
ย ย ย ย if(target.hp < 0) target.hp = 0;
ย ย ย ย updateBattleUI();
ย ย ย ยย
ย ย ย ย let spriteId = who === 'enemy' ? 'enemy-sprite' : 'player-sprite';
ย ย ย ย let el = document.getElementById(spriteId);
ย ย ย ย el.classList.add('shake');
ย ย ย ย setTimeout(()=>el.classList.remove('shake'), 500);
ย ย ย ยย
ย ย ย ย logBattle(`<span style="color:#e74c3c">Mแบฅt ${dmg} HP!</span>`);
ย ย }

ย ย // --- LOGIC KIแปM TRA THแบฎNG THUA (ฤร CแบฌP NHแบฌT ฤแปI NGฦฏแปI) ---
function checkWinCondition() {
ย ย // 1. Nแบฟu ฤแปch chแบฟt -> Thแบฏng
ย ย if(battleState.enemy.hp <= 0) {
ย ย ย ย battleState.active = false;
ย ย ย ย logBattle(`<b style="color:#f1c40f">CHIแบพN THแบฎNG!</b>`);
ย ย ย ย document.getElementById('battle-main-menu').style.display = 'none';
ย ย ย ย document.getElementById('battle-end-btn').style.display = 'block';
ย ย ย ย battleState.finished = true;
ย ย ย ยย
ย ย ย ย // Gแปi hรm xแปญ lรฝ thแบฏng
ย ย ย ย processWin();ย
ย ย }ย
ย ย // 2. Nแบฟu Ta chแบฟt
ย ย else if(battleState.player.hp <= 0) {
ย ย ย ยย
ย ย ย ย // --- LOGIC MแปI: NแบพU LEO THรP THร CHO ฤแปI NGฦฏแปI ---
ย ย ย ย if (battleState.difficulty === 'tower') {
ย ย ย ย ย ย handleTowerPlayerFaint(); // <--- Gแปi hรm xแปญ lรฝ ฤแปi ngฦฐแปi
ย ย ย ย ย ย return; // Dแปซng lแบกi, chฦฐa xแปญ thua vแปi
ย ย ย ย }
ย ย ย ย // --------------------------------------------------

ย ย ย ย // Nแบฟu khรดng phแบฃi leo thรกp (ฤรกnh thฦฐแปng) thรฌ thua luรดn
ย ย ย ย battleState.active = false;
ย ย ย ย logBattle(`<b style="color:#ed4245">THแบคT BแบI...</b>`);
ย ย ย ย document.getElementById('battle-main-menu').style.display = 'none';
ย ย ย ย document.getElementById('battle-end-btn').style.display = 'block';
ย ย ย ย battleState.finished = true;
ย ย }
}

ย ย // --- SแปฌA LแปI LOGIC CHIแบพN THแบฎNG (FIX LแปI THรP) ---
async function processWin() {
ย ย let r = battleState.rewards;
ย ย let p = battleState.player;
ย ยย
ย ย // 1. Cแปng thฦฐแปng cฦก bแบฃn
ย ย p.xp += r.xp;ย
ย ย coins += r.coin;
ย ยย
ย ย // 2. Logic riรชng cho tแปซng chแบฟ ฤแป
ย ย if(battleState.difficulty === 'hard') {
ย ย ย ย userStats.hardWins++;
ย ย ย ย gymProgress++;
ย ย ย ย logBattle(`Nhแบญn Badge! +${r.coin} xu.`);
ย ย }ย
ย ย else if (battleState.difficulty === 'tower') {
ย ย ย ย // --- QUAN TRแปNG: GแปI HรM LรN TแบฆNG ---
ย ย ย ย handleTowerWin();ย
ย ย ย ย return; // Dแปซng hรm tแบกi ฤรขy, khรดng chแบกy logic bรชn dฦฐแปi ฤแป trรกnh lแปi giao diแปn
ย ย }
ย ย else {
ย ย ย ย logBattle(`+${r.xp} XP | +${r.coin} xu.`);
ย ย }
ย ยย
ย ย // 3. Xแปญ lรฝ lรชn cแบฅp (Chแป chแบกy cho chแบฟ ฤแป thฦฐแปng/gym)
ย ย if(p.xp >= p.maxXp) {
ย ย ย ย playSFX('levelup');
ย ย ย ย p.level++; p.xp -= p.maxXp; p.maxXp = Math.floor(p.maxXp * 1.2);
ย ย ย ย recalcStats(p);
ย ย ย ย logBattle(`๐ Lรชn cแบฅp ${p.level}! Stats tฤng!`);
ย ย ย ย await checkLevelUpMoves(p);
ย ย }
ย ยย
ย ย updateQuestProgress('win', 1);
ย ย saveGame();
}

// Hรm bแป trแปฃ: Xแปญ lรฝ thแบฏng Thรกp (Bแบกn kiแปm tra xem ฤรฃ cรณ hรm nรy trong code chฦฐa, nแบฟu chฦฐa thรฌ dรกn vรo)
function handleTowerWin() {
ย ย // 1. Cแปng Level แบฃo cho Pokemon (ฤแป nรณ mแบกnh lรชn theo thรกp mร khรดng cแบงn XP)
ย ย // Hoแบทc giแปฏ nguyรชn logic cลฉ lร hแปi mรกu
ย ยย
ย ย towerData.floor++;
ย ย if(towerData.floor > towerData.bestRecord) towerData.bestRecord = towerData.floor;

ย ย // 2. Hแปi mรกu 20% cho cแบฃ team
ย ย let healMsg = "Hแปi 20% HP team.";
ย ย if (towerData.teamIndices) {
ย ย ย ย towerData.teamIndices.forEach(idx => {
ย ย ย ย ย ย let p = myBag[idx];
ย ย ย ย ย ย if(p && p.hp > 0) {
ย ย ย ย ย ย ย ย let heal = Math.floor(p.maxHp * 0.2);
ย ย ย ย ย ย ย ย p.hp = Math.min(p.maxHp, p.hp + heal);
ย ย ย ย ย ย }
ย ย ย ย });
ย ย }

ย ย // 3. Thฦฐแปng Token
ย ย let rewardMsg = "";
ย ย if((towerData.floor - 1) % 10 === 0) {
ย ย ย ย towerData.tokens += 1;
ย ย ย ย rewardMsg = " +1 Token!";
ย ย ย ย playSFX('levelup');
ย ย }

ย ย saveGame();

ย ย // 4. CHUYแปN CแบขNH (Fix lแปi bแป kแบนt)
ย ย // ฤแปฃi 1 giรขy ฤแป ngฦฐแปi chฦกi nhรฌn thแบฅy chแปฏ Chiแบฟn Thแบฏng rแปi mแปi chuyแปn
ย ย setTimeout(() => {
ย ย ย ย document.getElementById('battle-modal').style.display = 'none'; // Tแบฏt bแบฃng ฤรกnh nhau
ย ย ย ย document.getElementById('tower-modal').style.display = 'flex';ย // Mแป lแบกi bแบฃng thรกp
ย ย ย ย updateTowerUI(); // Cแบญp nhแบญt sแป tแบงng mแปi
ย ย ย ย alert(`๐ CHIแบพN THแบฎNG TแบฆNG ${towerData.floor - 1}!\n${healMsg}${rewardMsg}`);
ย ย }, 1000);
}

ย ย function endBattle() {
ย ย ย ย playBGM('map');
ย ย ย ย document.getElementById('battle-modal').style.display = 'none';
ย ย ย ย updateStats();
ย ย ย ย openBag();ย
ย ย }

ย ย function sleep(ms) { return new Promise(resolve => setTimeout(resolve, ms)); }
ย ยย
ย ย // --- DAILY SYSTEM & OTHER FUNCTIONS (SAME AS V2.2) ---
ย ย function openDaily() { if(currentWild) return; checkDailyQuestGen(); checkDailyQuestUI(); document.getElementById('daily-modal').style.display = 'flex'; }
ย ย function closeDaily() { document.getElementById('daily-modal').style.display = 'none'; }
ย ย function checkDailyQuestGen() {
ย ย ย ย const today = new Date().toDateString();
ย ย ย ย if(lastDailyDate !== today) { document.getElementById('btn-claim-daily').disabled = false; document.getElementById('btn-claim-daily').innerText = "Nhแบญn 5000๐ฐ"; }ย
ย ย ย ย else { document.getElementById('btn-claim-daily').disabled = true; document.getElementById('btn-claim-daily').innerText = "ฤรฃ nhแบญn"; }
ย ย ย ย if(dailyQuests.length === 0 || dailyQuests[0].date !== today) {
ย ย ย ย ย ย dailyQuests = [];
ย ย ย ย ย ย let rE = Math.random(); if(rE < 0.33) dailyQuests.push({date: today, type: 'mine', target: 50 + Math.floor(Math.random()*21), progress: 0, reward: {type:'item', id:'poke-ball', qty:20}, difficulty: 0, text: "ฤรo mแป", claimed: false}); else if(rE < 0.66) dailyQuests.push({date: today, type: 'catch', target: 15 + Math.floor(Math.random()*6), progress: 0, reward: {type:'item', id:'great-ball', qty:8}, difficulty: 0, text: "Bแบฏt Pokemon", claimed: false}); else dailyQuests.push({date: today, type: 'spend', target: 5000 + Math.floor(Math.random()*2000), progress: 0, reward: {type:'item', id:'potion', qty:5}, difficulty: 0, text: "Tiรชu Coins", claimed: false});
ย ย ย ย ย ย let rM = Math.random(); if(rM < 0.33) dailyQuests.push({date: today, type: 'mine', target: 150 + Math.floor(Math.random()*51), progress: 0, reward: {type:'item', id:'stardust', qty:10}, difficulty: 1, text: "ฤรo mแป", claimed: false}); else if(rM < 0.66) dailyQuests.push({date: today, type: 'catch', target: 30 + Math.floor(Math.random()*11), progress: 0, reward: {type:'item', id:'ultra-ball', qty:5}, difficulty: 1, text: "Bแบฏt Pokemon", claimed: false}); else dailyQuests.push({date: today, type: 'win', target: 8 + Math.floor(Math.random()*4), progress: 0, reward: {type:'item', id:'rare-candy', qty:2}, difficulty: 1, text: "Thแบฏng Arena", claimed: false});
ย ย ย ย ย ย let rH = Math.random();ย
if(rH < 0.33) dailyQuests.push({date: today, type: 'win', target: 20 + Math.floor(Math.random()*6), progress: 0, reward: {type:'item', id:'master-ball', qty:1}, difficulty: 2, text: "Thแบฏng Arena", claimed: false});ย
else if(rH < 0.66) dailyQuests.push({date: today, type: 'spend', target: 100000 + Math.floor(Math.random()*20001), progress: 0, reward: {type:'item', id:'nugget', qty:3}, difficulty: 2, text: "Tiรชu Coins", claimed: false});ย
else dailyQuests.push({
ย ย date: today,ย
ย ย type: 'catch',ย
ย ย target: 50 + Math.floor(Math.random()*21),ย
ย ย progress: 0,ย
ย ย reward: {type:'item', id:'rare-candy', qty:3}, // <-- ฤร ฤแปI Tแปช BAG UPGRADE SANG RARE CANDY
ย ย difficulty: 2,ย
ย ย text: "Bแบฏt Pokemon",ย
ย ย claimed: false
});
ย ย ย ย ย ย dailyQuests.forEach(q => { if(q.type === 'mine') q.text = `ฤรo mแป ${q.target} lแบงn`; if(q.type === 'catch') q.text = `Bแบฏt ${q.target} Pokemon`; if(q.type === 'spend') q.text = `Tiรชu ${q.target.toLocaleString()} Coins`; if(q.type === 'win') q.text = `Thแบฏng ${q.target} trแบญn ฤแบฅu`; });
ย ย ย ย ย ย saveGame();
ย ย ย ย }
ย ย }
ย ย function checkDailyQuestUI() { const container = document.getElementById('daily-quests-container'); container.innerHTML = dailyQuests.map((q, i) => { let pct = Math.min(100, Math.floor((q.progress / q.target) * 100)); let diffClass = q.difficulty === 0 ? 'diff-0' : (q.difficulty === 1 ? 'diff-1' : 'diff-2'); let diffName = q.difficulty === 0 ? 'EASY' : (q.difficulty === 1 ? 'MEDIUM' : 'HARD'); let btn = ''; if(q.claimed) btn = `<button class="btn-auth" style="background:#555; font-size:0.7em; padding:5px" disabled>ฤรฃ nhแบญn</button>`; else if(q.progress >= q.target) btn = `<button class="btn-auth" style="background:#3ba55c; font-size:0.7em; padding:5px" onclick="claimQuest(${i})">NHแบฌN</button>`; else btn = `<button class="btn-auth" style="background:#555; font-size:0.7em; padding:5px" disabled>${q.progress}/${q.target}</button>`; return `<div class="quest-item"><div class="quest-header"><span class="difficulty-tag ${diffClass}">${diffName}</span><span style="font-size:0.9em; font-weight:bold">${q.text}</span></div><div class="quest-progress-bar"><div class="quest-progress-fill" style="width:${pct}%"></div></div><div style="display:flex; justify-content:flex-end; margin-top:5px">${btn}</div></div>`; }).join(''); }
ย ย function claimDailyReward() { const today = new Date().toDateString(); if(lastDailyDate===today) return; coins+=5000; lastDailyDate=today; saveGame(); updateStats(); openDaily(); alert("ฤรฃ nhแบญn 5000 Coins ฤiแปm danh!"); }
ย ย function claimQuest(index) { let q = dailyQuests[index]; if(q.claimed || q.progress < q.target) return; q.claimed = true; let r = q.reward; if(r.type === 'item') { if(!inventory[r.id]) inventory[r.id]=0; inventory[r.id]+=r.qty; alert(`Hoรn thรnh nhiแปm vแปฅ! Nhแบญn ${r.qty}x ${r.id.toUpperCase()}`); } saveGame(); updateStats(); openDaily(); }
ย ย function updateQuestProgress(type, amount) { let changed = false; dailyQuests.forEach(q => { if(!q.claimed && q.type === type) { q.progress += amount; changed = true; } }); if(changed) saveGame(); }
ย ย function openDaycare() { if(currentWild) return; updateDaycareUI(); document.getElementById('daycare-modal').style.display = 'flex'; }
ย ย function closeDaycare() { document.getElementById('daycare-modal').style.display = 'none'; }
ย ย function updateDaycareUI() { const listDiv = document.getElementById('daycare-list'); listDiv.innerHTML = ''; daycare.slots.forEach((slot, index) => { let content = ''; if(slot.pokemon) { let now = Date.now(); let diffMins = Math.floor((now - slot.depositTime) / 60000); let pendingXP = diffMins * 50; content = `<div style="flex:1"><div style="font-weight:bold">${slot.pokemon.name} <span style="font-size:0.8em;color:#aaa">Lv.${slot.pokemon.level}</span></div><div style="font-size:0.8em; color:#3ba55c">+${pendingXP} XP (${diffMins}m)</div></div><button class="btn-auth" style="width:auto; padding:5px 10px; font-size:0.8em; background:#ed4245" onclick="withdrawPokemon(${index})">Rรบt</button>`; } else { let validMons = myBag.map((p, i) => ({...p, originalIdx: i})).filter(p => !p.isEgg); if(validMons.length > 0) { let opts = validMons.map(p => `<option value="${p.originalIdx}">${p.name} (Lv.${p.level})</option>`).join(''); content = `<div style="flex:1"><select id="daycare-select-${index}" class="login-input" style="margin:0; padding:5px; width:100%; font-size:0.9em">${opts}</select></div><button class="btn-auth" style="width:auto; padding:5px 10px; font-size:0.8em; background:#3ba55c; margin-left:5px" onclick="depositPokemon(${index})">Gแปญi</button>`; } else { content = `<div style="color:#aaa; font-size:0.9em">Khรดng cรณ Pokemon ฤแป gแปญi</div>`; } } listDiv.innerHTML += `<div class="daycare-row"><div style="width:20px; font-weight:bold; color:#7289da">#${index+1}</div>${content}</div>`; }); const btnBuy = document.getElementById('btn-buy-slot'); if(daycare.unlocked < 5) { let price = DAYCARE_PRICES[daycare.unlocked]; btnBuy.style.display = 'block'; btnBuy.innerText = `Mแป Slot ${daycare.unlocked + 1} (${price.toLocaleString()}๐ฐ)`; } else { btnBuy.style.display = 'none'; } }
ย ย function depositPokemon(slotIndex) { let select = document.getElementById(`daycare-select-${slotIndex}`); if(!select) return; let bagIdx = select.value; daycare.slots[slotIndex].pokemon = myBag[bagIdx]; daycare.slots[slotIndex].depositTime = Date.now(); myBag.splice(bagIdx, 1); saveGame(); updateDaycareUI(); }
ย ย function withdrawPokemon(slotIndex) { let slot = daycare.slots[slotIndex]; if(!slot.pokemon) return; let p = slot.pokemon; let now = Date.now(); let diffMins = Math.floor((now - slot.depositTime) / 60000); let earnedXP = diffMins * 50; if(earnedXP > 0) { p.xp += earnedXP; while(p.xp >= p.maxXp) { p.level++; p.xp -= p.maxXp; p.maxXp = Math.floor(p.maxXp * 1.2); recalcStats(p); } alert(`Rรบt ${p.name} vแป! Nhแบญn ฤฦฐแปฃc ${earnedXP} XP!`); } else { alert(`Chฦฐa ฤแปง 1 phรบt, chฦฐa cรณ XP.`); } myBag.push(p); slot.pokemon = null; slot.depositTime = 0; saveGame(); updateDaycareUI(); }
ย ย function buyDaycareSlot() { if(daycare.unlocked >= 5) return; let price = DAYCARE_PRICES[daycare.unlocked]; if(coins >= price) { coins -= price; daycare.unlocked++; daycare.slots.push({pokemon: null, depositTime: 0}); saveGame(); updateStats(); updateDaycareUI(); alert("ฤรฃ mแป rแปng Daycare thรnh cรดng!"); } else { alert("Khรดng ฤแปง tiแปn!"); } }
ย ย function openJobs() { if(currentWild) return; updateMiningUI(); let totalBalls = (inventory['poke-ball']||0); let povertyLine = coins < 200 && totalBalls < 5; const aidBtn = document.getElementById('emergency-aid'); if(povertyLine) { aidBtn.style.display = 'block'; } else { aidBtn.style.display = 'none'; } document.getElementById('job-modal').style.display = 'flex'; document.getElementById('job-menu').style.display = 'block'; document.getElementById('quiz-ui').style.display = 'none'; }
ย ย function closeJobs() { document.getElementById('job-modal').style.display = 'none'; }
ย ย // --- Hแป THแปNG THรNH TแปฐU (ฤร SแปฌA LแปI HแปI LแบI) ---

function openAchieve() {
ย ย if(currentWild) return;
ย ยย
ย ย const list = document.getElementById('achieve-list');
ย ย list.innerHTML = '';
ย ย let html = '';

ย ย ACHIEVEMENT_DB.forEach(a => {
ย ย ย ย // 1. Kiแปm tra xem thรnh tแปฑu nรy ID ฤรฃ nแบฑm trong danh sรกch ฤรฃ hoรn thรnh chฦฐa
ย ย ย ย // (completedAchievements lร mแบฃng lฦฐu cรกc ID ฤรฃ nhแบญn, vรญ dแปฅ: ['novice', 'catch_10'])
ย ย ย ย let isDone = completedAchievements.includes(a.id);

ย ย ย ย // 2. Kiแปm tra ฤiแปu kiแปn (Nแบฟu chฦฐa xong thรฌ mแปi check chแป sแป)
ย ย ย ย let canClaim = !isDone && a.req(userStats);

ย ย ย ย let btn = '';

ย ย ย ย if (isDone) {
ย ย ย ย ย ย // Nแบฟu ฤรฃ nhแบญn -> Hiแปn nรบt xรกm "ฤรฃ nhแบญn"
ย ย ย ย ย ย btn = `<button class="achieve-btn achieve-done" style="background:#444; color:#bbb; border:1px solid #666; cursor:default" disabled>ฤรฃ nhแบญn</button>`;
ย ย ย ย } else if (canClaim) {
ย ย ย ย ย ย // Nแบฟu ฤแปง ฤiแปu kiแปn -> Hiแปn nรบt "NHแบฌN" sรกng mรu
ย ย ย ย ย ย btn = `<button class="achieve-btn achieve-claim" style="background:#2ecc71; animation:pulse 1s infinite" onclick="claimAchieve('${a.id}')">NHแบฌN THฦฏแปNG</button>`;
ย ย ย ย } else {
ย ย ย ย ย ย // Chฦฐa ฤแปง -> Hiแปn nรบt mแป
ย ย ย ย ย ย btn = `<button class="achieve-btn" style="opacity:0.5; background:#333; cursor:not-allowed">Chฦฐa ฤแบกt</button>`;
ย ย ย ย }

ย ย ย ย // Render giao diแปn
ย ย ย ย html += `
ย ย ย ย <div class="achieve-row" onclick="previewAchieve('${a.id}')" style="display:flex; justify-content:space-between; align-items:center; background:rgba(0,0,0,0.3); padding:10px; margin-bottom:5px; border-radius:5px; border:1px solid ${isDone ? '#2ecc71' : '#444'}">
ย ย ย ย ย ย <div class="achieve-info" style="text-align:left">
ย ย ย ย ย ย ย ย <b style="color:${isDone ? '#2ecc71' : 'white'}">${a.name}</b>
ย ย ย ย ย ย ย ย <div style="font-size:0.8em;color:#bbb">${a.desc}</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย ${btn}
ย ย ย ย </div>`;
ย ย });

ย ย list.innerHTML = html;
ย ย document.getElementById('achieve-modal').style.display = 'flex';
}

function closeAchieve() {ย
ย ย document.getElementById('achieve-modal').style.display = 'none';ย
}

function previewAchieve(id) {ย
ย ย const a = ACHIEVEMENT_DB.find(x => x.id === id);ย
ย ย if(a) {
ย ย ย ย let rewardText = "";
ย ย ย ย if(a.reward.type === 'item') rewardText = `${a.reward.qty}x ${a.reward.id.toUpperCase()}`;
ย ย ย ย // Nแบฟu bแบกn cรณ thรชm loแบกi reward khรกc (vรญ dแปฅ coin) thรฌ thรชm vรo ฤรขy
ย ย ย ยย
ย ย ย ย alert(`๐ Phแบงn thฦฐแปng: ${rewardText}`);ย
ย ย }
}

function claimAchieve(id) {ย
ย ย // 1. Kiแปm tra kแปน: Nแบฟu ฤรฃ cรณ trong danh sรกch hoรn thรnh thรฌ dแปซng ngay
ย ย if(completedAchievements.includes(id)) return;ย

ย ย const a = ACHIEVEMENT_DB.find(x => x.id === id);ย
ย ย if(a) {ย
ย ย ย ย // 2. Thรชm ID vรo mแบฃng ฤรฃ hoรn thรnh
ย ย ย ย completedAchievements.push(id);ย

ย ย ย ย // 3. Cแปng quร vรo tรบi
ย ย ย ย if(a.reward.type === 'item') {ย
ย ย ย ย ย ย if(!inventory[a.reward.id]) inventory[a.reward.id]=0;ย
ย ย ย ย ย ย inventory[a.reward.id]+=a.reward.qty;ย
ย ย ย ย ย ย alert(`๐ Chรบc mแปซng! Bแบกn nhแบญn ฤฦฐแปฃc ${a.reward.qty}x ${a.reward.id.toUpperCase()}`);
ย ย ย ย }ย

ย ย ย ย // 4. LฦฏU GAME NGAY LแบฌP TแปจC (Quan trแปng ฤแป khรดng bแป mแบฅt khi F5)
ย ย ย ย saveGame();ย
ย ย ย ย updateStats(); // Cแบญp nhแบญt hiแปn thแป tiแปn/item
ย ย ย ยย
ย ย ย ย // 5. Vแบฝ lแบกi bแบฃng thรnh tแปฑu ฤแป nรบt ฤแปi thรnh "ฤรฃ nhแบญn"
ย ย ย ย openAchieve();ย
ย ย }ย
}
ย ย function openRepairModal() { document.getElementById('job-modal').style.display = 'none'; const today = new Date().toDateString(); if(dailyRepairs.date !== today) { dailyRepairs = {date: today, count: 0}; saveGame(); } if(dailyRepairs.count >= 10) { alert("Hรดm nay bแบกn ฤรฃ sแปญa 10 lแบงn! Hรฃy quay lแบกi vรo ngรy mai."); openJobs(); return; } document.getElementById('repair-limit-text').innerText = `Lฦฐแปฃt sแปญa hรดm nay: ${dailyRepairs.count}/10`; let a = Math.floor(Math.random() * 10) + 1; let b = Math.floor(Math.random() * 10) + 1; repairAnswer = a + b; document.getElementById('repair-question').innerText = `${a} + ${b} = ?`; let opts = [repairAnswer]; while(opts.length < 4) { let fake = Math.floor(Math.random() * 20) + 1; if(!opts.includes(fake)) opts.push(fake); } opts.sort(() => Math.random() - 0.5); document.getElementById('repair-options').innerHTML = opts.map(n => `<button class="btn-auth" onclick="submitRepair(${n})">${n}</button>`).join(''); document.getElementById('repair-modal').style.display = 'flex'; }
ย ย function submitRepair(ans) { document.getElementById('repair-modal').style.display = 'none'; if(ans === repairAnswer) { pickaxe.durability = pickaxe.max; dailyRepairs.count++; alert("Sแปญa thรnh cรดng!"); saveGame(); openJobs(); } else { alert("Sai rแปi! Cรบp vแบซn gรฃy. Thแปญ lแบกi sau."); setTimeout(() => openJobs(), 2000); } }
ย ย // --- Hแป THแปNG QUIZ NรNG CแบคP (STREAK REWARDS) ---

function startQuiz() {
ย ย document.getElementById('job-menu').style.display = 'none';
ย ย document.getElementById('quiz-ui').style.display = 'block';
ย ยย
ย ย // Hiแปn thแป Combo hiแปn tแบกi
ย ย const comboEl = document.getElementById('quiz-combo-display');
ย ย if(quizStreak > 0) {
ย ย ย ย comboEl.style.display = 'block';
ย ย ย ย comboEl.innerText = `๐ฅ Streak: ${quizStreak}`;
ย ย } else {
ย ย ย ย comboEl.style.display = 'none';
ย ย }

ย ย document.getElementById('quiz-options').innerHTML = '<div style="grid-column:span 2; color:yellow">ฤang tแบฃi dแปฏ liแปu...</div>';

ย ย (async () => {
ย ย ย ย try {
ย ย ย ย ย ย // Random Pokemon (Gen 1-3 cho dแป ฤoรกn, hoแบทc full 649 tรนy bแบกn)
ย ย ย ย ย ย let id = Math.floor(Math.random() * 649) + 1;ย
ย ย ย ย ย ย let res = await fetch(`https://pokeapi.co/api/v2/pokemon/${id}`);
ย ย ย ย ย ย let data = await res.json();
ย ย ย ย ย ยย
ย ย ย ย ย ย quizAnswer = data.name;
ย ย ย ย ย ย document.getElementById('quiz-image').src = data.sprites.front_default;
ย ย ย ย ย ย document.getElementById('quiz-image').classList.remove('revealed'); // ฤen thui

ย ย ย ย ย ย // Tแบกo ฤรกp รกn giแบฃ
ย ย ย ย ย ย let opts = [quizAnswer];
ย ย ย ย ย ย while(opts.length < 4) {
ย ย ย ย ย ย ย ย let rId = Math.floor(Math.random() * 649) + 1;
ย ย ย ย ย ย ย ย let r = await fetch(`https://pokeapi.co/api/v2/pokemon/${rId}`);
ย ย ย ย ย ย ย ย let d = await r.json();
ย ย ย ย ย ย ย ย if(!opts.includes(d.name)) opts.push(d.name);
ย ย ย ย ย ย }
ย ย ย ย ย ยย
ย ย ย ย ย ย // Xรกo trแปn ฤรกp รกn
ย ย ย ย ย ย opts.sort(() => Math.random() - 0.5);
ย ย ย ย ย ยย
ย ย ย ย ย ย document.getElementById('quiz-options').innerHTML = opts.map(n =>ย
ย ย ย ย ย ย ย ย `<button class="quiz-opt" style="padding:12px; border:1px solid #555; background:#2f3136; color:white; border-radius:5px; cursor:pointer; font-weight:bold" onclick="submitQuiz('${n}', this)">${n.toUpperCase()}</button>`
ย ย ย ย ย ย ).join('');
ย ย ย ย ย ยย
ย ย ย ย } catch(e) {
ย ย ย ย ย ย console.error(e);
ย ย ย ย ย ย alert("Lแปi tแบฃi Quiz, thแปญ lแบกi sau!");
ย ย ย ย ย ย openJobs();
ย ย ย ย }
ย ย })();
}

function submitQuiz(ans, btnElement) {
ย ย // 1. Khรณa nรบt
ย ย const allBtns = document.querySelectorAll('.quiz-opt');
ย ย allBtns.forEach(b => b.onclick = null);
ย ย document.getElementById('quiz-image').classList.add('revealed');

ย ย // 2. Kiแปm tra ngรy mแปi ฤแป reset quร
ย ย const today = new Date().toDateString();
ย ย if (dailyQuizStatus.date !== today) {
ย ย ย ย dailyQuizStatus = { date: today, milestones: [] };
ย ย }

ย ย if(ans === quizAnswer) {
ย ย ย ย // --- ฤรNG ---
ย ย ย ย btnElement.style.background = '#2ecc71';
ย ย ย ย btnElement.style.color = 'black';
ย ย ย ยย
ย ย ย ย quizStreak++; // Tฤng chuแปi

ย ย ย ย // Tรญnh tiแปn (Vแบซn nhแบญn tiแปn bรฌnh thฦฐแปng)
ย ย ย ย let baseCoin = 150;
ย ย ย ย let streakBonus = (quizStreak * 20);
ย ย ย ย if(streakBonus > 500) streakBonus = 500;
ย ย ย ย let totalWin = baseCoin + streakBonus;
ย ย ย ย coins += totalWin;

ย ย ย ย // --- LOGIC KIแปM TRA QUร MแปC (ITEM) ---
ย ย ย ย let itemReward = "";
ย ย ย ย let rewardType = null;
ย ย ย ย let rewardQty = 1;
ย ย ย ย let milestoneId = quizStreak; // Lฦฐu mแปc hiแปn tแบกi (vรญ dแปฅ: 3, 5, 10...)

ย ย ย ย // Xรกc ฤแปnh quร cแปงa mแปc nรy (nแบฟu cรณ)
ย ย ย ย if(quizStreak % 10 === 0) {
ย ย ย ย ย ย rewardType = 'nugget';ย
ย ย ย ย ย ย rewardMsg = '1x Nugget';
ย ย ย ย }ย
ย ย ย ย else if(quizStreak % 5 === 0) {
ย ย ย ย ย ย rewardType = 'rare-candy';
ย ย ย ย ย ย rewardMsg = '1x Rare Candy';
ย ย ย ย }
ย ย ย ย else if(quizStreak % 3 === 0) {
ย ย ย ย ย ย rewardType = 'great-ball';
ย ย ย ย ย ย rewardMsg = '1x Great Ball';
ย ย ย ย }

ย ย ย ย // Nแบฟu mแปc nรy cรณ quร Vร chฦฐa nhแบญn hรดm nay
ย ย ย ย if (rewardType) {
ย ย ย ย ย ย if (!dailyQuizStatus.milestones.includes(milestoneId)) {
ย ย ย ย ย ย ย ย // CHฦฏA NHแบฌN -> TRAO QUร
ย ย ย ย ย ย ย ย if(!inventory[rewardType]) inventory[rewardType] = 0;
ย ย ย ย ย ย ย ย inventory[rewardType] += rewardQty;
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย // ฤรกnh dแบฅu ฤรฃ nhแบญn mแปc nรy
ย ย ย ย ย ย ย ย dailyQuizStatus.milestones.push(milestoneId);
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย itemReward = `<div class="quiz-reward-item">๐ Thฦฐแปng chuแปi ${quizStreak}: <b>${rewardMsg}</b></div>`;
ย ย ย ย ย ย ย ย playSFX('levelup');ย
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย // ฤร NHแบฌN -> THรNG BรO
ย ย ย ย ย ย ย ย itemReward = `<div class="quiz-reward-item" style="filter:grayscale(1); opacity:0.7">๐ Chuแปi ${quizStreak}: ฤรฃ nhแบญn hรดm nay</div>`;
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย // Log ra mรn hรฌnh
ย ย ย ย log(`<div style="border-left:3px solid #2ecc71; padding-left:5px; margin-bottom:5px">
ย ย ย ย ย ย <div style="color:#2ecc71"><b>Chรญnh xรกc!</b> (Streak: ${quizStreak})</div>
ย ย ย ย ย ย <div>+${totalWin} Coins ${streakBonus > 0 ? `(+${streakBonus} bonus)` : ''}</div>
ย ย ย ย ย ย ${itemReward}
ย ย ย ย </div>`);

ย ย } else {
ย ย ย ย // --- SAI ---
ย ย ย ย btnElement.style.background = '#ed4245';
ย ย ย ยย
ย ย ย ย allBtns.forEach(b => {
ย ย ย ย ย ย if(b.innerText === quizAnswer.toUpperCase()) {
ย ย ย ย ย ย ย ย b.style.background = '#2ecc71';
ย ย ย ย ย ย ย ย b.style.color = 'black';
ย ย ย ย ย ย }
ย ย ย ย });

ย ย ย ย if(quizStreak >= 3) {
ย ย ย ย ย ย log(`<span style="color:#ed4245">Sai rแปi! Mแบฅt chuแปi ${quizStreak} ๐ฅ.</span>`);
ย ย ย ย } else {
ย ย ย ย ย ย log(`<span style="color:#ed4245">Sai! ฤรกp รกn: ${quizAnswer.toUpperCase()}.</span>`);
ย ย ย ย }
ย ย ย ย quizStreak = 0; // Reset chuแปi vแป 0
ย ย }

ย ย incrementEggSteps();
ย ย saveGame();
ย ย updateStats();

ย ย setTimeout(() => { startQuiz(); }, 2000);
}
ย ย function updateMiningUI() { if(pickaxe.durability <= 0) { document.getElementById('btn-mining').style.display = 'none'; document.getElementById('btn-repair').style.display = 'flex'; } else { document.getElementById('btn-mining').style.display = 'flex'; document.getElementById('btn-repair').style.display = 'none'; let percent = (pickaxe.durability / pickaxe.max) * 100; document.getElementById('durability-bar-fill').style.width = percent + '%'; document.getElementById('durability-text').innerText = `${pickaxe.durability}/${pickaxe.max}`; } }
ย ย // --- HรM ฤรO Mแป (ฤร CรN BแบฐNG KINH Tแบพ) ---
function startMining() {
ย ย // 1. Kiแปm tra ฤแป bแปn cรบp
ย ย if(pickaxe.durability <= 0) return updateMiningUI();

ย ย // 2. Trแปซ ฤแป bแปn vร tฤng thแปng kรช
ย ย pickaxe.durability--;
ย ย userStats.mining++;

ย ย // 3. TรNH TIแปN THฦฏแปNG MแปI
ย ย // Random tแปซ 50 ฤแบฟn 150 xu (ฤแปง ฤแป ngฦฐแปi chฦกi mแปi sแปng sรณt)
ย ย let earned = Math.floor(Math.random() * 101) + 50;ย

ย ย // 4. Xแปฌ Lร RแปT ฤแป HIแบพM (LUCKY DROPS)
ย ย let r = Math.random();
ย ย let bonusText = "";

ย ย // 0.5% cฦก hแปi nhแบญn Nugget (Bรกn giรก cao)
ย ย if (r < 0.005) {ย
ย ย ย ย if(!inventory['nugget']) inventory['nugget'] = 0;
ย ย ย ย inventory['nugget']++;ย
ย ย ย ย bonusText = " + 1 Nugget! ๐";
ย ย ย ย log(`<span style="color:#f1c40f; font-weight:bold">โ๏ธ WOW! ฤรo trรบng vแปa vรng! Nhแบญn 1 Nugget.</span>`);
ย ย }ย
ย ย // 3% cฦก hแปi nhแบญn Stardust
ย ย else if (r < 0.035) {ย
ย ย ย ย if(!inventory['stardust']) inventory['stardust'] = 0;
ย ย ย ย inventory['stardust']++;ย
ย ย ย ย bonusText = " + Stardust โจ";
ย ย ย ย log(`<span style="color:#a29bfe">โ๏ธ Tรฌm thแบฅy bแปฅi sao! Nhแบญn 1 Stardust.</span>`);
ย ย }

ย ย // 5. CแบฌP NHแบฌT Dแปฎ LIแปU
ย ย coins += earned;
ย ย incrementEggSteps(); // แบคp trแปฉng
ย ย updateQuestProgress('mine', 1); // Nhiแปm vแปฅ hรng ngรy
ย ยย
ย ย saveGame();
ย ย updateStats();
ย ย updateMiningUI();

ย ย // 6. HIแปU แปจNG NรT BแบคM (VISUAL)
ย ย const btn = document.getElementById('btn-mining');
ย ย const oldHtml = btn.innerHTML; // Lฦฐu giao diแปn cลฉ
ย ยย
ย ย // Hiแปn sแป tiแปn vแปซa kiแบฟm ฤฦฐแปฃc ฤรจ lรชn nรบt
ย ย btn.innerHTML = `<div style="color:#2ecc71; font-size:1.1em; text-align:center; font-weight:bold; display:flex; flex-direction:column; justify-content:center; height:100%">
ย ย ย ย <span>+${earned}๐ฐ</span>
ย ย ย ย <span style="font-size:0.8em; color:#f1c40f">${bonusText}</span>
ย ย </div>`;
ย ยย
ย ย btn.disabled = true; // Khรณa nรบt tแบกm thแปi ฤแป trรกnh spam quรก nhanh

ย ย // Sau 0.8 giรขy thรฌ trแบฃ lแบกi nรบt bรฌnh thฦฐแปng
ย ย setTimeout(() => {ย
ย ย ย ย btn.innerHTML = oldHtml;ย
ย ย ย ย btn.disabled = false;ย
ย ย ย ย updateMiningUI(); // Cแบญp nhแบญt lแบกi thanh ฤแป bแปn lแบงn nแปฏa cho chแบฏc
ย ย }, 800);
}
ย ย function claimEmergency() { if(confirm("Nhแบญn trแปฃ cแบฅp?")) { coins += 200; inventory['poke-ball'] += 5; saveGame(); updateStats(); openJobs(); alert("ฤรฃ nhแบญn 200 Coins & 5 Poke Balls."); } }
ย ย function closePokedex() { document.getElementById('dex-modal').style.display = 'none'; }
ย ย // --- CแบขI TIแบพN: VISUAL POKEDEX ---


// --- 1. Dแปฎ LIแปU VรNG ---
const REGIONS = [
ย ย { name: 'Kanto', start: 1, end: 151 },
ย ย { name: 'Johto', start: 152, end: 251 },
ย ย { name: 'Hoenn', start: 252, end: 386 },
ย ย { name: 'Sinnoh', start: 387, end: 493 },
ย ย { name: 'Unova', start: 494, end: 649 }
];

let currentDexGen = 0;ย

// --- 2. HรM HIแปN THแป KHUNG MODAL ---
function showPokedex() {
ย ย const modal = document.getElementById('dex-modal');
ย ย const innerBox = modal.querySelector('.inner-box');
ย ยย
ย ย // Reset lแบกi nแปi dung HTML
ย ย innerBox.innerHTML = `
ย ย ย ย <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px">
ย ย ย ย ย ย <h2 style="color: #3498db; margin:0;">๐ Pokedex</h2>
ย ย ย ย ย ย <span style="font-size:0.9em; color:#ddd">ฤรฃ bแบฏt: <b style="color:#f1c40f">${pokedex.size}</b>/649</span>
ย ย ย ย </div>

ย ย ย ย <div class="region-bar">
ย ย ย ย ย ย ${REGIONS.map((r, idx) => `
ย ย ย ย ย ย ย ย <button id="dex-btn-${idx}" class="btn-region" onclick="switchDexRegion(${idx})">
ย ย ย ย ย ย ย ย ย ย ${r.name}
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย `).join('')}
ย ย ย ย </div>

ย ย ย ย <div id="dex-grid-container" class="dex-grid" style="flex:1; min-height:0">
ย ย ย ย ย ย </div>

ย ย ย ย <button class="btn-close" onclick="closePokedex()" style="margin-top:10px">ฤรณng</button>
ย ย `;

ย ย modal.style.display = 'flex';
ย ยย
ย ย // Vแบฝ dแปฏ liแปu lแบงn ฤแบงu
ย ย renderDexRegion(currentDexGen);
}

// --- 3. HรM CHUYแปN ฤแปI VรNG ---
function switchDexRegion(genIdx) {
ย ย currentDexGen = genIdx;
ย ย renderDexRegion(genIdx);
}

// --- 4. HรM Vแบผ LฦฏแปI Vร CแบฌP NHแบฌT NรT ---
function renderDexRegion(genIdx) {
ย ย // A. Cแบญp nhแบญt mรu nรบt (Active)
ย ย REGIONS.forEach((r, idx) => {
ย ย ย ย const btn = document.getElementById(`dex-btn-${idx}`);
ย ย ย ย if(btn) {
ย ย ย ย ย ย if(idx === genIdx) btn.classList.add('active');
ย ย ย ย ย ย else btn.classList.remove('active');
ย ย ย ย }
ย ย });

ย ย // B. Vแบฝ lฦฐแปi แบฃnh
ย ย const container = document.getElementById('dex-grid-container');
ย ย const region = REGIONS[genIdx];
ย ย let html = '';

ย ย for (let i = region.start; i <= region.end; i++) {
ย ย ย ย const isCaught = pokedex.has(i);
ย ย ย ย // Dรนng แบฃnh nhแป (icon) ฤแป tแบฃi nhanh
ย ย ย ย const imgSrc = `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${i}.png`;
ย ย ย ยย
ย ย ย ย html += `
ย ย ย ย ย ย <div class="dex-card ${isCaught ? 'owned' : ''}" onclick="speakDex(${i}, ${isCaught})">
ย ย ย ย ย ย ย ย <span class="dex-id">#${i}</span>
ย ย ย ย ย ย ย ย <img class="dex-img" src="${imgSrc}" loading="lazy">
ย ย ย ย ย ย ย ย <div style="font-size:0.7em; font-weight:bold; margin-top:5px; color:${isCaught?'white':'#555'}">
ย ย ย ย ย ย ย ย ย ย ${isCaught ? 'โ' : '?'}
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย `;
ย ย }
ย ย container.innerHTML = html;
ย ย container.scrollTop = 0; // Cuแปn lรชn ฤแบงu
}

// Hรm nghe tiแบฟng kรชu (giแปฏ nguyรชn)
function speakDex(id, isCaught) {
ย ย if(isCaught && typeof playCry === "function") {
ย ย ย ย playCry(id);
ย ย }
}
ย ย function run() { currentWild=null; showMenu(); log("Bแป chแบกy."); }
ย ย function checkEvolution(idx, btn) { btn.innerHTML = "โณ"; btn.classList.add('loading'); (async () => { let p = myBag[idx]; try { let res = await fetch(`https://pokeapi.co/api/v2/pokemon-species/${p.id}`); let data = await res.json(); let chain = await (await fetch(data.evolution_chain.url)).json(); let node = findNodeInChain(chain.chain, data.name); if(!node || node.evolves_to.length === 0) { btn.innerHTML="Max"; btn.classList.remove('loading'); return; } let nextEvo = node.evolves_to[0]; let details = nextEvo.evolution_details[0]; let reqType = details ? details.trigger.name : 'level-up'; let canEvolve = false; if (reqType === "level-up") { let minLv = (details && details.min_level) ? details.min_level : 25; if (p.level >= minLv) canEvolve = true; } else if (reqType === "use-item") { if (inventory['evo-stone'] > 0) canEvolve = true; } else { if (p.level >= 25) canEvolve = true; } if(canEvolve) { if(reqType === "use-item") inventory['evo-stone']--; let newId = nextEvo.species.name; let d2 = await (await fetch(`https://pokeapi.co/api/v2/pokemon/${newId}`)).json(); p.id = d2.id; p.name = d2.name.toUpperCase(); p.img = d2.sprites.other['official-artwork'].front_default; p.types = d2.types.map(t=>t.type.name);ย
ย ย p.baseHp = d2.stats.find(s=>s.stat.name==='hp').base_stat;ย
ย ย p.baseAtk = d2.stats.find(s=>s.stat.name==='attack').base_stat;ย
ย ย p.baseDef = d2.stats.find(s=>s.stat.name==='defense').base_stat;ย
ย ย p.baseSpA = d2.stats.find(s=>s.stat.name==='special-attack').base_stat;ย
ย ย p.baseSpD = d2.stats.find(s=>s.stat.name==='special-defense').base_stat;ย
ย ย p.baseSpd = d2.stats.find(s=>s.stat.name==='speed').base_stat;ย
ย ย recalcStats(p);ย
ย ย assignMoves(p);ย
ย ย saveGame(); openBag(); log(`<div class="embed" style="border-left-color:#9b59b6"><div class="embed-header"><div><span class="embed-title">TIแบพN HรA!</span><div class="embed-desc"><b>${p.name}</b><br>HP: ${p.maxHp} | ATK: ${p.atk}</div></div><img class="poke-sprite" src="${p.img}"></div></div>`); } else { btn.innerHTML = "Evo"; btn.classList.remove('loading'); let reqText = reqType === 'use-item' ? 'Cแบงn Evo Stone' : `Cแบงn Level ${(details && details.min_level) || 25}`; alert(`Chฦฐa ฤแปง ฤiแปu kiแปn!\n${reqText}`); } } catch(e) { console.log(e); btn.innerHTML="Err"; btn.classList.remove('loading'); } })(); }
ย ย function findNodeInChain(node, name) { if (node.species.name === name) return node; for (let child of node.evolves_to) { let f = findNodeInChain(child, name); if (f) return f; } return null; }
ย ย // --- Hแป THแปNG LEADERBOARD ---
// --- SแปฌA LOGIC BXH: แบจN ADMIN ---
function openLeaderboard() {
ย ย if(!currentUser) return;
ย ย document.getElementById('leaderboard-modal').style.display = 'flex';
ย ย document.getElementById('leaderboard-list').innerHTML = '<div style="color:yellow">ฤang tแบฃi dแปฏ liแปu...</div>';

ย ย firebase.database().ref('users').orderByChild('coins').limitToLast(20).once('value') // Lแบฅy 20 ngฦฐแปi ฤแป trแปซ hao Admin
ย ย .then((snapshot) => {
ย ย ย ย let list = [];
ย ย ย ย snapshot.forEach((childSnapshot) => {
ย ย ย ย ย ย let name = childSnapshot.key;
ย ย ย ย ย ย let data = childSnapshot.val();
ย ย ย ย ย ยย
ย ย ย ย ย ย // ๐ LOGIC MแปI: Nแบฟu tรชn lร ADMIN thรฌ bแป qua, khรดng thรชm vรo list
ย ย ย ย ย ย if (name === 'ADMIN') return;ย

ย ย ย ย ย ย list.push({ name: name, coins: data.coins || 0 });
ย ย ย ย });

ย ย ย ย list.reverse(); // ฤแบฃo ngฦฐแปฃc ฤแป cao nhแบฅt lรชn ฤแบงu
ย ย ย ย list = list.slice(0, 10); // Chแป lแบฅy Top 10 sau khi ฤรฃ lแปc Admin

ย ย ย ย renderLeaderboard(list);
ย ย });
}

function renderLeaderboard(list) {
ย ย const container = document.getElementById('leaderboard-list');
ย ยย
ย ย if(list.length === 0) {
ย ย ย ย container.innerHTML = '<div style="color:#bbb">Chฦฐa cรณ ai ฤua top...</div>';
ย ย ย ย return;
ย ย }

ย ย let html = list.map((user, index) => {
ย ย ย ย let rank = index + 1;
ย ย ย ย let specialClass = '';
ย ย ย ย let icon = `#${rank}`;

ย ย ย ย if(rank === 1) { specialClass = 'top-1'; icon = '๐'; }
ย ย ย ย if(rank === 2) { specialClass = 'top-2'; icon = '๐ฅ'; }
ย ย ย ย if(rank === 3) { specialClass = 'top-3'; icon = '๐ฅ'; }

ย ย ย ย // ฤรกnh dแบฅu bแบฃn thรขn
ย ย ย ย let isMe = (user.name === currentUser) ? ' (Bแบกn)' : '';
ย ย ย ย let nameColor = (user.name === currentUser) ? '#2ecc71' : 'white';

ย ย ย ย return `
ย ย ย ย <div class="rank-row ${specialClass}">
ย ย ย ย ย ย <div class="rank-num">${icon}</div>
ย ย ย ย ย ย <div class="rank-name" style="color:${nameColor}">
ย ย ย ย ย ย ย ย ${user.name.toUpperCase()}${isMe}
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div class="rank-coin">
ย ย ย ย ย ย ย ย ${user.coins.toLocaleString()}๐ฐ
ย ย ย ย ย ย </div>
ย ย ย ย </div>`;
ย ย }).join('');

ย ย container.innerHTML = html;
}

function closeLeaderboard() {
ย ย document.getElementById('leaderboard-modal').style.display = 'none';
}
ย ย // --- Hแป THแปNG GรP ร (FEEDBACK) ---
function openFeedback() {
ย ย if(!currentUser) return alert("Bแบกn cแบงn ฤฤng nhแบญp ฤแป gรณp รฝ!");
ย ย document.getElementById('feedback-modal').style.display = 'flex';
ย ย document.getElementById('feedback-text').value = ""; // Xรณa nแปi dung cลฉ
}

function closeFeedback() {
ย ย document.getElementById('feedback-modal').style.display = 'none';
}

function submitFeedback() {
ย ย const content = document.getElementById('feedback-text').value.trim();
ย ย if(content.length < 5) return alert("Nแปi dung quรก ngแบฏn! Hรฃy viแบฟt chi tiแบฟt hฦกn.");

ย ย // Gแปญi lรชn Firebase vรo mแปฅc 'feedback'
ย ย firebase.database().ref('feedback').push({
ย ย ย ย user: currentUser,
ย ย ย ย content: content,
ย ย ย ย time: new Date().toLocaleString()
ย ย })
ย ย .then(() => {
ย ย ย ย alert("โ ฤรฃ gแปญi thรnh cรดng! Cแบฃm ฦกn รฝ kiแบฟn cแปงa bแบกn.");
ย ย ย ย closeFeedback();
ย ย })
ย ย .catch((err) => {
ย ย ย ย console.error(err);
ย ย ย ย alert("Lแปi gแปญi tin! Vui lรฒng thแปญ lแบกi.");
ย ย });
}
ย ย // --- LOGIC SแปฌA CรP ---
let currentRepairQ = null;

function openRepairModal() {
ย ย if(coins < 500) return alert("Cแบงn 500 Coins ฤแป mua dแปฅng cแปฅ sแปญa!");
ย ยย
ย ย // Chแปn cรขu hแปi ngแบซu nhiรชn
ย ย currentRepairQ = REPAIR_QUESTIONS[Math.floor(Math.random() * REPAIR_QUESTIONS.length)];
ย ยย
ย ย document.getElementById('repair-modal').style.display = 'flex';
ย ย document.getElementById('repair-question').innerText = currentRepairQ.q;
ย ยย
ย ย // Tแบกo 4 nรบt trแบฃ lแปi
ย ย const optsDiv = document.getElementById('repair-options');
ย ย optsDiv.innerHTML = '';
ย ยย
ย ย currentRepairQ.a.forEach((ans, index) => {
ย ย ย ย let btn = document.createElement('button');
ย ย ย ย btn.className = 'btn-auth';
ย ย ย ย btn.style.background = '#34495e';
ย ย ย ย btn.innerText = ans;
ย ย ย ย btn.onclick = () => checkRepairAnswer(index);
ย ย ย ย optsDiv.appendChild(btn);
ย ย });
ย ยย
ย ย document.getElementById('repair-limit-text').innerText = "Phรญ sแปญa: 500 Coins (Trแบฃ lแปi sai mแบฅt tiแปn!)";
}
ย ย function checkRepairAnswer(index) {
ย ย if(index === currentRepairQ.correct) {
ย ย ย ย // ฤรบng
ย ย ย ย if(coins >= 500) {
ย ย ย ย ย ย coins -= 500;
ย ย ย ย ย ย pickaxe.durability = 30; // Hแปi phแปฅc ฤแป bแปn
ย ย ย ย ย ย alert("โ Chรญnh xรกc! Cรบp ฤรฃ ฤฦฐแปฃc sแปญa ฤแบงy.");
ย ย ย ย ย ยย
ย ย ย ย ย ย saveGame();
ย ย ย ย ย ย updateMiningUI();
ย ย ย ย ย ยย
ย ย ย ย ย ย // ฤรณng modal sแปญa vร mแป lแบกi modal Job
ย ย ย ย ย ย document.getElementById('repair-modal').style.display = 'none';
ย ย ย ย ย ย openJobs();ย
ย ย ย ย } else {
ย ย ย ย ย ย alert("Khรดng ฤแปง tiแปn (Cแบงn 500 coin)!");
ย ย ย ย }
ย ย } else {
ย ย ย ย // Sai
ย ย ย ย alert("โ Sai rแปi! Bแบกn bแป ฤiแปn giแบญt tรช ngฦฐแปi. Thแปญ lแบกi nhรฉ!");
ย ย }
}
// --- BIแบพN TOรN CแปคC LฦฏU TRแบNG THรI HแปC CHIรU ---
// Biแบฟn tแบกm ฤแป lฦฐu trแบกng thรกi hแปc chiรชu
let pendingLearning = {
ย ย pokemon: null,
ย ย newMoveData: null,
ย ย moveIndex: -1 // Dรนng khi hแปc nhiแปu chiรชu 1 lรบc
};

// --- HรM KIแปM TRA LEVEL UP CHUแบจN GAME GแปC ---
async function checkLevelUpMoves(pokemon) {
ย ย // Hiแปn thแป thรดng bรกo nhแป ฤแป ngฦฐแปi chฦกi biแบฟt ฤang tแบฃi
ย ย logBattle(`Checking moves for ${pokemon.name}...`);

ย ย try {
ย ย ย ย // 1. Lแบฅy dแปฏ liแปu Pokemon tแปซ API
ย ย ย ย const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${pokemon.id}`);
ย ย ย ย const data = await res.json();

ย ย ย ย // 2. Lแปc ra cรกc chiรชu hแปc ฤฦฐแปฃc แป Level hiแปn tแบกi (move_learn_method = level-up)
ย ย ย ย // Lฦฐu รฝ: Phiรชn bแบฃn 'yellow' hoแบทc 'red-blue' cho Gen 1 chuแบฉn nhแบฅt, nhฦฐng mแบทc ฤแปnh lแบฅy bแบฃn mแปi nhแบฅt cลฉng ok
ย ย ย ย const potentialMoves = data.moves.filter(m => {
ย ย ย ย ย ย const details = m.version_group_details[m.version_group_details.length - 1]; // Lแบฅy bแบฃn mแปi nhแบฅt
ย ย ย ย ย ย return details.move_learn_method.name === 'level-up' && details.level_learned_at === pokemon.level;
ย ย ย ย });

ย ย ย ย if (potentialMoves.length === 0) return; // Khรดng cรณ chiรชu nรo แป level nรy

ย ย ย ย // 3. Duyแปt qua tแปซng chiรชu tรฌm ฤฦฐแปฃc
ย ย ย ย for (let m of potentialMoves) {
ย ย ย ย ย ย let moveName = m.move.name;
ย ย ย ย ย ยย
ย ย ย ย ย ย // Kiแปm tra xem ฤรฃ hแปc chฦฐa
ย ย ย ย ย ย if (pokemon.moves.some(known => known.id === moveName || known.name.toLowerCase() === moveName.replace(/-/g,' '))) continue;

ย ย ย ย ย ย // Lแบฅy chi tiแบฟt sแปฉc mแบกnh chiรชu
ย ย ย ย ย ย let moveDetails = await fetchMoveDetails(moveName);
ย ย ย ย ย ย if (moveDetails) {
ย ย ย ย ย ย ย ย await processLearningMove(pokemon, moveDetails);
ย ย ย ย ย ย }
ย ย ย ย }

ย ย } catch (e) {
ย ย ย ย console.error("Lแปi check move:", e);
ย ย }
}

// --- HรM Xแปฌ Lร QUY TRรNH HแปC ---
async function processLearningMove(pokemon, newMove) {
ย ย return new Promise(resolve => {
ย ย ย ย // Trฦฐแปng hแปฃp 1: Cรฒn slot trแปng -> Hแปc luรดn
ย ย ย ย if (pokemon.moves.length < 4) {
ย ย ย ย ย ย pokemon.moves.push(newMove);
ย ย ย ย ย ย alert(`๐ก ${pokemon.name} ฤรฃ hแปc ฤฦฐแปฃc ${newMove.name}!`);
ย ย ย ย ย ย logBattle(`<span style="color:#2ecc71">${pokemon.name} hแปc ฤฦฐแปฃc <b>${newMove.name}</b>!</span>`);
ย ย ย ย ย ย saveGame();
ย ย ย ย ย ย resolve();
ย ย ย ย }ย
ย ย ย ย // Trฦฐแปng hแปฃp 2: Full 4 chiรชu -> Mแป bแบฃng chแปn
ย ย ย ย else {
ย ย ย ย ย ย // Mแป UI vร chแป ngฦฐแปi chฦกi chแปn (Async UI)
ย ย ย ย ย ย openMoveRelearner(pokemon, newMove, resolve);
ย ย ย ย }
ย ย });
}

// --- 2. HรM Xแปฌ Lร HแปC (AUTO HOแบถC HแปI) ---
function attemptLearnMove(pokemon, newMove) {
ย ย // TRฦฏแปNG HแปขP 1: Chฦฐa ฤแปง 4 chiรชu -> Hแปc luรดn
ย ย if (pokemon.moves.length < 4) {
ย ย ย ย pokemon.moves.push(newMove);
ย ย ย ย alert(`๐ก ${pokemon.name} ฤรฃ hแปc ฤฦฐแปฃc ${newMove.name}!`);
ย ย ย ย logBattle(`<span style="color:#2ecc71">${pokemon.name} hแปc ฤฦฐแปฃc <b>${newMove.name}</b>!</span>`);
ย ย ย ย saveGame();
ย ย }ย
ย ย // TRฦฏแปNG HแปขP 2: ฤรฃ ฤแปง 4 chiรชu -> Hiแปn Modal chแปn
ย ย else {
ย ย ย ย showLearnMoveUI(pokemon, newMove);
ย ย }
}

// --- 3. HIแปN THแป UI ---
function showLearnMoveUI(pokemon, newMove) {
ย ย pendingLearnState = { pokemon: pokemon, newMove: newMove }; // Lฦฐu lแบกi ฤแป xแปญ lรฝ sau

ย ย // ฤiแปn thรดng tin vรo Modal
ย ย document.getElementById('learn-poke-name').innerText = pokemon.name;
ย ย document.getElementById('learn-move-name').innerText = newMove.name;
ย ย document.getElementById('learn-move-img').src = pokemon.img;
ย ยย
ย ย document.getElementById('new-move-stats').innerHTML =ย
ย ย ย ย `Hแป: <b style="color:${TYPE_COLORS[newMove.type]}">${newMove.type.toUpperCase()}</b> | ` +
ย ย ย ย `Pwr: <b>${newMove.pwr || '-'}</b> | Acc: ${newMove.acc || '-'}`;

ย ย // Render danh sรกch 4 chiรชu cลฉ
ย ย const listDiv = document.getElementById('move-forget-list');
ย ย listDiv.innerHTML = pokemon.moves.map((m, idx) => `
ย ย ย ย <button class="move-select-btn" onclick="confirmForgetMove(${idx})">
ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย <div class="m-name">${m.name}</div>
ย ย ย ย ย ย ย ย <div class="m-info">Type: ${m.type} | Pwr: ${m.pwr||'-'}</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div style="color:#ed4245; font-weight:bold; font-size:0.8em">QUรN ๐๏ธ</div>
ย ย ย ย </button>
ย ย `).join('');

ย ย // Hiแปn Modal
ย ย document.getElementById('learn-move-modal').style.display = 'flex';
}

// --- 4. XรC NHแบฌN QUรN CHIรU Cลจ ---
function confirmForgetMove(index) {
ย ย if (!pendingLearnState) return;

ย ย let p = pendingLearnState.pokemon;
ย ย let newM = pendingLearnState.newMove;
ย ย let oldM = p.moves[index];

ย ย // Ghi ฤรจ chiรชu mแปi vรo vแป trรญ cลฉ
ย ย p.moves[index] = newM;

ย ย // Thรดng bรกo & Lฦฐu
ย ย alert(`1.. 2.. 3.. Poof! ๐จ\n${p.name} ฤรฃ quรชn ${oldM.name} vร hแปc ฤฦฐแปฃc ${newM.name}!`);
ย ย logBattle(`${p.name} quรชn <b>${oldM.name}</b> ฤแป hแปc <b>${newM.name}</b>.`);
ย ยย
ย ย saveGame();
ย ย closeLearnModal();
}

// --- 5. HแปฆY Bแป (KHรNG HแปC) ---
function cancelLearnMove() {
ย ย if (!pendingLearnState) return;
ย ย let p = pendingLearnState.pokemon;
ย ย let m = pendingLearnState.newMove;

ย ย if (confirm(`${p.name} sแบฝ tแปซ bแป viแปc hแปc chiรชu ${m.name}. Bแบกn chแบฏc chแปฉ?`)) {
ย ย ย ย logBattle(`${p.name} ฤรฃ khรดng hแปc ${m.name}.`);
ย ย ย ย closeLearnModal();
ย ย }
}

function closeLearnModal() {
ย ย document.getElementById('learn-move-modal').style.display = 'none';
ย ย pendingLearnState = null;
}
ย ย // --- LOGIC Xแปฌ Lร CHแปN NHIแปU & BรN SLL ---

// 1. Bแบญt/Tแบฏt chแบฟ ฤแป
function toggleSelectMode() {
ย ย isSelectMode = !isSelectMode;
ย ย selectedIndices.clear(); // Xรณa lแปฑa chแปn cลฉ khi chuyแปn chแบฟ ฤแป
ย ย renderBag(); // Vแบฝ lแบกi giao diแปn
}

// 2. Chแปn/Bแป chแปn mแปt Pokemon
function toggleSelection(index) {
ย ย if(!isSelectMode) return;
ย ยย
ย ย if(selectedIndices.has(index)) {
ย ย ย ย selectedIndices.delete(index);
ย ย } else {
ย ย ย ย selectedIndices.add(index);
ย ย }
ย ย renderBag(); // Vแบฝ lแบกi ฤแป cแบญp nhแบญt mรu nแปn/checkbox
}

// 3. Thแปฑc hiแปn bรกn cรกc Pokemon ฤรฃ chแปn
function sellSelectedItems() {
ย ย if(selectedIndices.size === 0) return alert("Chฦฐa chแปn Pokemon nรo!");

ย ย // Tรญnh tแปng tiแปn
ย ย let totalPrice = 0;
ย ย let count = 0;
ย ยย
ย ย // Duyแปt qua danh sรกch chแปn ฤแป tรญnh tiแปn
ย ย selectedIndices.forEach(idx => {
ย ย ย ย let p = myBag[idx];
ย ย ย ย if(p && !p.isEgg) {
ย ย ย ย ย ย ยlet basePrice = (p.baseXp * 0.2) + (p.iv * 10) + (p.level * 5);
ย ย ย ย ย ย ยlet rarityBonus = 0;
ย ย ย ย ย ย ยif (LEGENDARY_IDS.includes(p.id)) rarityBonus += 5000;ย
ย ย ย ย ย ย ยif (p.isShiny) rarityBonus += 10000;
ย ย ย ย ย ย ยif (getRarity(p).val >= 3 && !LEGENDARY_IDS.includes(p.id)) rarityBonus += 500;
ย ย ย ย ย ย ยlet pr = Math.floor(basePrice + rarityBonus);
ย ย ย ย ย ย ยif (pr < 50) pr = 50;
ย ย ย ย ย ย ย
ย ย ย ย ย ย ยtotalPrice += pr;
ย ย ย ย ย ย ยcount++;
ย ย ย ย }
ย ย });

ย ย // Xรกc nhแบญn bรกn
ย ย if(confirm(`Bรกn ${count} Pokemon ฤแป nhแบญn ${totalPrice.toLocaleString()} Coins?`)) {
ย ย ย ย // QUAN TRแปNG: Xรณa tแปซ mแบฃng (Phแบฃi xรณa tแปซ index lแปn vแป nhแป ฤแป khรดng bแป lแปch index)
ย ย ย ย // Chuyแปn Set thรnh Array -> Sแบฏp xแบฟp giแบฃm dแบงn
ย ย ย ย let sortedIndices = Array.from(selectedIndices).sort((a, b) => b - a);
ย ย ย ยย
ย ย ย ย sortedIndices.forEach(idx => {
ย ย ย ย ย ย myBag.splice(idx, 1);
ย ย ย ย });

ย ย ย ย coins += totalPrice;
ย ย ย ย updateQuestProgress('spend', 0); // (Optional) Nแบฟu cรณ quest bรกn
ย ย ย ยย
ย ย ย ย // Reset trแบกng thรกi
ย ย ย ย isSelectMode = false;
ย ย ย ย selectedIndices.clear();
ย ย ย ยย
ย ย ย ย saveGame();
ย ย ย ย updateStats();
ย ย ย ย renderBag();
ย ย ย ยย
ย ย ย ย log(`<span style="color:#f1c40f; font-weight:bold">๐ฐ ฤรฃ bรกn ${count} Pokemon thu ฤฦฐแปฃc ${totalPrice.toLocaleString()} Coins!</span>`);
ย ย }
}
ย ย // --- Hแป THแปNG WORLD BOSS (REALTIME FIREBASE) ---

let currentBossData = null;
let myBossDamage = 0;
let lastBossAttackTime = 0;

// 1. Mแป giao diแปn vร tแบฃi dแปฏ liแปu Boss
function openWorldBoss() {
ย ย if(!currentUser) return alert("Cแบงn ฤฤng nhแบญp!");
ย ย document.getElementById('boss-modal').style.display = 'flex';
ย ย updateStaminaUI();
ย ย loadBossData();
}

function closeWorldBoss() {
ย ย document.getElementById('boss-modal').style.display = 'none';
ย ย // Hแปงy lแบฏng nghe realtime ฤแป ฤแปก lag mรกy khi ฤรณng
ย ย firebase.database().ref('world_boss').off();
}

// 2. Tแบฃi dแปฏ liแปu tแปซ Firebase (Realtime)
function loadBossData() {
ย ย const bossRef = firebase.database().ref('world_boss');
ย ยย
ย ย bossRef.on('value', (snapshot) => {
ย ย ย ย const data = snapshot.val();
ย ย ย ยย
ย ย ย ย // Nแบฟu chฦฐa cรณ Boss hoแบทc Boss tuแบงn cลฉ -> Tแบกo Boss mแปi
ย ย ย ย const currentWeek = getWeekNumber(new Date());
ย ย ย ย if (!data || data.weekId !== currentWeek) {
ย ย ย ย ย ย createNewBoss(currentWeek);
ย ย ย ย } else {
ย ย ย ย ย ย currentBossData = data;
ย ย ย ย ย ย renderBossUI(data);
ย ย ย ย }
ย ย });
}

// 3. Tแบกo Boss mแปi (Admin hoแบทc ngฦฐแปi ฤแบงu tiรชn mแป vรo ฤแบงu tuแบงn sแบฝ kรญch hoแบกt)
async function createNewBoss(weekId) {
ย ย // Random 1 con Huyแปn thoแบกi
ย ย const legendId = LEGENDARY_IDS[Math.floor(Math.random() * LEGENDARY_IDS.length)];
ย ย const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${legendId}`);
ย ย const pokeData = await res.json();
ย ยย
ย ย const newBoss = {
ย ย ย ย weekId: weekId,
ย ย ย ย name: pokeData.name.toUpperCase(),
ย ย ย ย img: pokeData.sprites.other['official-artwork'].front_default,
ย ย ย ย hp: 200000, // 1 Triแปu Mรกu (Chแปnh sแป nรy tรนy lฦฐแปฃng ngฦฐแปi chฦกi)
ย ย ย ย maxHp: 200000,
ย ย ย ย contributors: {}, // Danh sรกch ngฦฐแปi ฤรกnh
ย ย ย ย isDead: false
ย ย };

ย ย firebase.database().ref('world_boss').set(newBoss);
}

// 4. Hiแปn thแป UI Boss
// --- GIAO DIแปN BOSS MแปI (2 CแปT) ---
function renderBossUI(data) {
ย ย const area = document.getElementById('boss-display-area');
ย ย const hpPercent = Math.max(0, (data.hp / data.maxHp) * 100);
ย ยย
ย ย let statusText = "";
ย ย if(data.hp <= 0) statusText = "<div style='color:#f1c40f; font-weight:bold; font-size:1.2em; margin-top:5px'>BOSS ฤร CHแบพT!</div>";
ย ยย
ย ย // Xแปญ lรฝ danh sรกch DPS
ย ย let contributors = [];
ย ย if(data.contributors) {
ย ย ย ย Object.keys(data.contributors).forEach(key => {
ย ย ย ย ย ย contributors.push({name: key, dmg: data.contributors[key].damage});
ย ย ย ย });
ย ย }
ย ย contributors.sort((a,b) => b.dmg - a.dmg); // Xแบฟp hแบกng cao xuแปng thแบฅp

ย ย let rankHtml = contributors.map((c, i) => {
ย ย ย ย let icon = i===0 ? '๐' : (i===1 ? '๐ฅ' : (i===2 ? '๐ฅ' : `#${i+1}`));
ย ย ย ย let color = c.name === currentUser ? '#2ecc71' : '#ddd';
ย ย ย ย let percent = ((c.dmg / data.maxHp) * 100).toFixed(2);
ย ย ย ย return `<div style="display:flex; justify-content:space-between; font-size:0.85em; padding:3px 0; border-bottom:1px dashed #444; color:${color}">
ย ย ย ย ย ย <span>${icon} ${c.name}</span>
ย ย ย ย ย ย <span>${parseInt(c.dmg).toLocaleString()}</span>
ย ย ย ย </div>`;
ย ย }).join('');

ย ย // --- HTML MแปI: CHIA CแปT BแบฐNG FLEX ---
ย ย area.innerHTML = `
ย ย ย ย <div style="display:flex; gap:10px; height:300px;">
ย ย ย ย ย ยย
ย ย ย ย ย ย <div style="width:35%; background:rgba(0,0,0,0.3); border:1px solid #555; border-radius:5px; padding:5px; display:flex; flex-direction:column;">
ย ย ย ย ย ย ย ย <div style="text-align:center; color:#f1c40f; font-weight:bold; border-bottom:1px solid #555; margin-bottom:5px">๐ TOP DPS</div>
ย ย ย ย ย ย ย ย <div style="overflow-y:auto; flex:1;">
ย ย ย ย ย ย ย ย ย ย ${rankHtml || '<div style="text-align:center; color:#777; margin-top:20px">Chฦฐa cรณ ai ฤรกnh</div>'}
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div class="boss-container" style="width:65%; margin:0; display:flex; flex-direction:column; justify-content:center; align-items:center;">
ย ย ย ย ย ย ย ย <h3 style="color:white; margin:0">${data.name}</h3>
ย ย ย ย ย ย ย ย <div style="font-size:0.8em; color:#ed4245">WORLD BOSS</div>
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <img class="boss-sprite ${data.hp<=0 ? 'grayscale' : ''}" src="${data.img}" style="width:120px; height:120px;">
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ${statusText}
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <div class="boss-hp-bar" style="width:100%; margin-top:10px">
ย ย ย ย ย ย ย ย ย ย <div class="boss-hp-fill" style="width:${hpPercent}%"></div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div style="font-weight:bold; color:white; font-size:0.9em; margin-top:2px">
ย ย ย ย ย ย ย ย ย ย ${Math.floor(data.hp).toLocaleString()} HP
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย `;

ย ย // แบจn bแบฃng xแบฟp hแบกng cลฉ ฤi (nแบฟu cรฒn code cลฉ tแบกo ra nรณ แป bรชn ngoรi)
ย ย const oldList = document.getElementById('boss-dps-list');
ย ย if(oldList) oldList.style.display = 'none';

ย ย // Cแบญp nhแบญt nรบt tแบฅn cรดng
ย ย document.getElementById('btn-attack-boss').disabled = (data.hp <= 0);
ย ย if(data.hp <= 0 && !data.isDead) handleBossDeath(contributors);
}

// 5. Tแบฅn cรดng Boss
function attackWorldBoss() {
ย ย if(!currentBossData || currentBossData.hp <= 0) return;
ย ยย
ย ย // Cooldown 10 giรขy ฤแป chแปng spam click quรก ฤร
ย ย const now = Date.now();
ย ย if(now - lastBossAttackTime < 10000) {
ย ย ย ย let wait = Math.ceil((10000 - (now - lastBossAttackTime))/1000);
ย ย ย ย return alert(`Chแป ${wait}s ฤแป hแปi sแปฉc!`);
ย ย }
ย ย lastBossAttackTime = now;

ย ย // Tรญnh Damage: Dแปฑa trรชn Pokemon mแบกnh nhแบฅt trong tรบi cแปงa bแบกn
ย ย // Cรดng thแปฉc: Tแปng Attack cแปงa 6 con ฤแบงu tiรชn / 2
ย ย let totalAtk = 0;
ย ย let count = 0;
ย ยย
ย ย if(myBag.length === 0) return alert("Bแบกn cแบงn cรณ Pokemon ฤแป ฤรกnh Boss!");
ย ยย
ย ย // Lแบฅy 6 con ฤแบงu
ย ย for(let i=0; i<Math.min(6, myBag.length); i++) {
ย ย ย ย let p = myBag[i];
ย ย ย ย // ฤแบฃm bแบฃo chแป sแป tแปn tแบกi
ย ย ย ย if(!p.atk) recalcStats(p);ย
ย ย ย ย totalAtk += (p.atk + p.spA);
ย ย ย ย count++;
ย ย }
ย ยย
ย ย // Damage dao ฤแปng random
ย ย let damage = Math.floor(totalAtk * (0.9 + Math.random() * 0.2));
ย ยย
ย ย // Crit
ย ย let isCrit = false;
ย ย if(Math.random() < 0.15) {
ย ย ย ย isCrit = true;
ย ย }
ย ย showDamageText(damage, isCrit);

ย ย // Gแปญi damage lรชn Firebase (Dรนng transaction ฤแป cแปng dแปn an toรn)
ย ย const bossRef = firebase.database().ref('world_boss');
ย ยย
ย ย // 1. Trแปซ mรกu Boss
ย ย bossRef.child('hp').transaction((currentHp) => {
ย ย ย ย return (currentHp || 0) - damage;
ย ย });

ย ย // 2. Cแปng damage cho bแบฃn thรขn
ย ย firebase.database().ref(`world_boss/contributors/${currentUser}`).transaction((userData) => {
ย ย ย ย if(!userData) return { damage: damage };
ย ย ย ย return { damage: userData.damage + damage };
ย ย });
ย ยย
ย ย // Hiแปu แปฉng Visual
ย ย playSFX('catch'); // Tแบกm dรนng tiแบฟng nรy
ย ย document.getElementById('boss-modal').classList.add('shake');
ย ย setTimeout(()=>document.getElementById('boss-modal').classList.remove('shake'), 500);
}

// 6. Xแปญ lรฝ khi Boss chแบฟt (Phรกt quร)
function handleBossDeath(contributors) {
ย ย // ฤรกnh dแบฅu boss chแบฟt ฤแป khรดng phรกt quร 2 lแบงn
ย ย firebase.database().ref('world_boss/isDead').set(true);

ย ย // Kiแปm tra xem MรNH cรณ trong danh sรกch khรดng ฤแป nhแบญn quร
ย ย let myEntry = contributors.find(c => c.name === currentUser);
ย ยย
ย ย if(myEntry) {
ย ย ย ย let rank = contributors.indexOf(myEntry) + 1;
ย ย ย ย let rewardMsg = "";
ย ย ย ยย
ย ย ย ย // --- Cฦ CแบคU GIแบขI THฦฏแปNG ---
ย ย ย ย if(rank === 1) {
ย ย ย ย ย ย coins += 50000;
ย ย ย ย ย ย inventory['master-ball'] = (inventory['master-ball'] || 0) + 1;
ย ย ย ย ย ย rewardMsg = "TOP 1 MVP: 50,000 Xu + 1 Master Ball!";
ย ย ย ย } else if (rank <= 3) {
ย ย ย ย ย ย coins += 20000;
ย ย ย ย ย ย inventory['ultra-ball'] = (inventory['ultra-ball'] || 0) + 5;
ย ย ย ย ย ย rewardMsg = "TOP 3: 20,000 Xu + 5 Ultra Ball!";
ย ย ย ย } else if (rank <= 10) {
ย ย ย ย ย ย coins += 10000;
ย ย ย ย ย ย inventory['rare-candy'] = (inventory['rare-candy'] || 0) + 3;
ย ย ย ย ย ย rewardMsg = "TOP 10: 10,000 Xu + 3 Rare Candy!";
ย ย ย ย } else {
ย ย ย ย ย ย coins += 5000;
ย ย ย ย ย ย rewardMsg = "Tham gia: 5,000 Xu";
ย ย ย ย }
ย ย ย ยย
ย ย ย ย saveGame();
ย ย ย ย updateStats();
ย ย ย ย alert(`๐ BOSS ฤร Bแป Hแบ GแปคC!\nThรnh tรญch cแปงa bแบกn: Hแบกng ${rank}\nQuร: ${rewardMsg}`);
ย ย }
}

// Helper: Lแบฅy sแป thแปฉ tแปฑ tuแบงn trong nฤm (ฤแป reset boss)
function getWeekNumber(d) {
ย ย d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
ย ย d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
ย ย var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
ย ย var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
ย ย return weekNo;
}
ย ย // --- Hแป THแปNG STAMINA ---
function calculateOfflineStamina() {
ย ย const now = Date.now();
ย ย const diffMs = now - lastStaminaTime;
ย ย const diffMins = Math.floor(diffMs / 60000); // 1 phรบt = 60000ms

ย ย if (diffMins > 0 && stamina < MAX_STAMINA) {
ย ย ย ย stamina = Math.min(MAX_STAMINA, stamina + diffMins);
ย ย ย ย lastStaminaTime = now; // Reset mแปc thแปi gian
ย ย ย ย saveGame();
ย ย }
}

function updateStaminaUI() {
ย ย // Gแปi hรm tรญnh toรกn trฦฐแปc khi hiแปn
ย ย calculateOfflineStamina();
ย ยย
ย ย const bar = document.getElementById('stamina-bar-fill');
ย ย const text = document.getElementById('stamina-text');
ย ย const teamText = document.getElementById('team-count-display');
ย ยย
ย ย if(bar) {
ย ย ย ย let pct = (stamina / MAX_STAMINA) * 100;
ย ย ย ย bar.style.width = pct + '%';
ย ย ย ย text.innerText = `${stamina}/${MAX_STAMINA}`;
ย ย }
ย ย if(teamText) {
ย ย ย ย // Lแปc lแบกi phรฒng trฦฐแปng hแปฃp bรกn mแบฅt Pokemon
ย ย ย ย bossTeamIndices = bossTeamIndices.filter(idx => myBag[idx]);ย
ย ย ย ย teamText.innerText = bossTeamIndices.length;
ย ย }
}

// --- Hแป THแปNG CHแปN TEAM ---
let tempTeamIndices = []; // Biแบฟn tแบกm khi ฤang chแปn

// --- SแปฌA LแปI: RESET NรT LฦฏU Vแป ฤรNG CHแปจC NฤNG ---
function openBossTeamSelect() {
ย ย document.getElementById('boss-team-modal').style.display = 'flex';
ย ยย
ย ย // 1. ฤแบทt lแบกi tiรชu ฤแป cho ฤรบng
ย ย document.querySelector('#boss-team-modal h3').innerText = "Chแปn ฤแปi Hรฌnh Boss (Tแปi ฤa 6)";

ย ย // 2. ๐ QUAN TRแปNG: TRแบข LแบI NรT LฦฏU CHO BOSS ๐
ย ย // (Vรฌ hรm openTowerTeamSelect ฤรฃ cฦฐแปp nรบt nรy, giแป phแบฃi ฤรฒi lแบกi)
ย ย const saveBtn = document.querySelector('#boss-team-modal .btn-auth');
ย ย saveBtn.innerText = "LฦฏU ฤแปI HรNH BOSS"; // ฤแปi tรชn cho dแป nhแบญn biแบฟt
ย ย saveBtn.onclick = saveBossTeam;ย ย ย ย ย // Gรกn lแบกi hรm lฦฐu Boss
ย ยย
ย ย // 3. Lแปc bแป cรกc Pokemon khรดng cรฒn tแปn tแบกi (do ฤรฃ bรกn) ฤแป trรกnh lแปi
ย ย // (Copy mแบฃng cลฉ sang biแบฟn tแบกm ฤแป thao tรกc)
ย ย tempTeamIndices = bossTeamIndices.filter(idx => myBag[idx]);ย
ย ยย
ย ย renderTeamGrid();
}

function renderTeamGrid() {
ย ย const grid = document.getElementById('boss-team-grid');
ย ย grid.innerHTML = myBag.map((p, idx) => {
ย ย ย ย let isSelected = tempTeamIndices.includes(idx);
ย ย ย ย let slotNum = tempTeamIndices.indexOf(idx) + 1;
ย ย ย ยย
ย ย ย ย // Tรญnh tแปng sแปฉc mแบกnh hiแปn thแป cho dแป chแปn
ย ย ย ย let power = (p.atk || 0) + (p.spA || 0);
ย ย ย ยย
ย ย ย ย return `
ย ย ย ย <div class="team-card ${isSelected ? 'selected' : ''}" onclick="toggleTeamMember(${idx})">
ย ย ย ย ย ย <div class="team-slot-indicator">${slotNum}</div>
ย ย ย ย ย ย <img src="${p.img}">
ย ย ย ย ย ย <div style="font-size:0.7em; font-weight:bold">${p.name}</div>
ย ย ย ย ย ย <div style="font-size:0.65em; color:#ed4245">DMG: ${power}</div>
ย ย ย ย </div>`;
ย ย }).join('');
}

function toggleTeamMember(idx) {
ย ย if(tempTeamIndices.includes(idx)) {
ย ย ย ย // Bแป chแปn
ย ย ย ย tempTeamIndices = tempTeamIndices.filter(i => i !== idx);
ย ย } else {
ย ย ย ย // Chแปn mแปi (Kiแปm tra max 6)
ย ย ย ย if(tempTeamIndices.length >= 6) return alert("Chแป ฤฦฐแปฃc chแปn tแปi ฤa 6 Pokemon!");
ย ย ย ย tempTeamIndices.push(idx);
ย ย }
ย ย renderTeamGrid();
}

function saveBossTeam() {
ย ย bossTeamIndices = [...tempTeamIndices];
ย ย saveGame();
ย ย updateStaminaUI(); // Cแบญp nhแบญt sแป lฦฐแปฃng hiแปn thแป
ย ย document.getElementById('boss-team-modal').style.display = 'none';
}

// --- CแบฌP NHแบฌT HรM ฤรNH BOSS (Sแปญ dแปฅng Stamina & Team thแบญt) ---
function attackWorldBoss() {
ย ย if(!currentBossData || currentBossData.hp <= 0) return alert("Boss chฦฐa xuแบฅt hiแปn hoแบทc ฤรฃ chแบฟt!");
ย ยย
ย ย // 1. Kiแปm tra Stamina
ย ย calculateOfflineStamina(); // Cแบญp nhแบญt mแปi nhแบฅt
ย ย if(stamina < 10) return alert(`Khรดng ฤแปง nฤng lฦฐแปฃng! Cแบงn 10, bแบกn cรณ ${stamina}. (Hแปi 1 ฤiแปm/phรบt)`);

ย ย // 2. Kiแปm tra ฤแปi hรฌnh
ย ย // Lแปc bแป cรกc index khรดng cรฒn tแปn tแบกi (do bรกn Pokemon)
ย ย bossTeamIndices = bossTeamIndices.filter(idx => myBag[idx]);
ย ยย
ย ย if(bossTeamIndices.length === 0) {
ย ย ย ย return alert("Bแบกn chฦฐa chแปn ฤแปi hรฌnh! Hรฃy bแบฅm vรo nรบt 'Chแปnh Team'.");
ย ย }

ย ย // 3. Trแปซ Stamina
ย ย stamina -= 10;
ย ย // Cแบญp nhแบญt lแบกi thแปi gian ฤแป khรดng bแป tรญnh double hแปi phแปฅc
ย ย lastStaminaTime = Date.now();ย
ย ย updateStaminaUI();
ย ย saveGame();

ย ย // 4. Tรญnh Damage dแปฑa trรชn Team ฤรฃ chแปn
ย ย let totalAtk = 0;
ย ยย
ย ย bossTeamIndices.forEach(idx => {
ย ย ย ย let p = myBag[idx];
ย ย ย ย if(p) {
ย ย ย ย ย ย // ฤแบฃm bแบฃo cรณ chแป sแป
ย ย ย ย ย ย if(!p.atk) recalcStats(p);ย
ย ย ย ย ย ย // Cรดng thแปฉc: (Atk + SpA) * (Level / 10) -> Level cรng cao cรng mแบกnh
ย ย ย ย ย ย let pokeDmg = (p.atk + p.spA) * (1 + (p.level / 20));
ย ย ย ย ย ย totalAtk += pokeDmg;
ย ย ย ย }
ย ย });
ย ยย
ย ย // Random dao ฤแปng 90% - 110%
ย ย let damage = Math.floor(totalAtk * (0.9 + Math.random() * 0.2));
ย ยย
ย ย // Crit 15%
ย ย if(Math.random() < 0.15) {
ย ย ย ย damage = Math.floor(damage * 1.5);
ย ย ย ย log(`<span style="color:#ed4245">Chรญ mแบกng vรo Boss!</span>`);
ย ย }

ย ย // Gแปญi lรชn Firebase
ย ย const bossRef = firebase.database().ref('world_boss');
ย ย bossRef.child('hp').transaction((currentHp) => {
ย ย ย ย return (currentHp || 0) - damage;
ย ย });

ย ย firebase.database().ref(`world_boss/contributors/${currentUser}`).transaction((userData) => {
ย ย ย ย if(!userData) return { damage: damage };
ย ย ย ย return { damage: userData.damage + damage };
ย ย });
ย ยย
ย ย playSFX('catch');
ย ย // Hiแปu แปฉng rung mรn hรฌnh
ย ย document.getElementById('boss-modal').classList.add('shake');
ย ย setTimeout(()=>document.getElementById('boss-modal').classList.remove('shake'), 500);
}
ย ย // --- HรM HIแปN THแป Sแป SรT THฦฏฦNG ---
function showDamageText(amount, isCrit) {
ย ย const bossContainer = document.querySelector('.boss-container');
ย ย if (!bossContainer) return;

ย ย // Tแบกo thแบป hiแปn thแป sแป
ย ย const dmgEl = document.createElement('div');
ย ย dmgEl.className = 'damage-popup';
ย ย if (isCrit) dmgEl.classList.add('crit');
ย ยย
ย ย // Thรชm nแปi dung: Nแบฟu crit thรฌ thรชm icon cho ngแบงu
ย ย dmgEl.innerHTML = (isCrit ? '๐ฅ ' : '') + amount.toLocaleString();

ย ย // Random vแป trรญ lแปch mแปt chรบt ฤแป khรดng bแป chแปng chรฉo nแบฟu click nhanh
ย ย const randomX = (Math.random() - 0.5) * 40; // Lแปch trรกi phแบฃi 20px
ย ย const randomY = (Math.random() - 0.5) * 20;
ย ย dmgEl.style.marginLeft = randomX + 'px';
ย ย dmgEl.style.marginTop = randomY + 'px';

ย ย // Gแบฏn vรo boss container
ย ย bossContainer.appendChild(dmgEl);

ย ย // Tแปฑ ฤแปng xรณa sau 1 giรขy (khi animation chแบกy xong) ฤแป nhแบน mรกy
ย ย setTimeout(() => {
ย ย ย ย dmgEl.remove();
ย ย }, 1000);
}
ย ย // --- UPDATE LOG (v2.4.2) ---
// Hรm hiแปn thแป Update Log (Chแบกy khi vรo game)
// --- CแบคU HรNH PHIรN BแบขN (DรN CรI NรY LรN ฤแบฆU FILE JS) ---
const GAME_VERSION = "v2.5.0"; // <-- ฤรขy lร cรกi biแบฟn bแป thiแบฟu
const VERSION_NAME = "Reawakened Power";

const UPDATE_LOG_CONTENT = `
<div style="text-align:left; font-size:0.9em; color:#ddd; line-height:1.5;">
ย ย <p style="color:#f1c40f; font-weight:bold; font-size:1.1em; text-align:center; margin-bottom:10px">
ย ย ย ย ๐ CHรO MแปชNG ฤแบพN VแปI V2.5.0 ๐<br>
ย ย ย ย "SแปจC MแบNH THแปจC TแปNH"
ย ย </p>
ย ย <ul style="padding-left:20px;">
ย ย ย ย <li><b>โจ Move Relearner:</b> ฤรฃ thรชm tรญnh nฤng Hแปi Tฦฐแปng Chiรชu Thแปฉc trong Tรบi ฤแป.</li>
ย ย ย ย <li><b>๐ค Auto-Fill:</b> Tแปฑ ฤแปng cแบญp nhแบญt chiรชu chuแบฉn cho Pokemon cลฉ.</li>
ย ย ย ย <li><b>๐ฅ Battle Fix:</b> Sแปญa lแปi Recover hแปi mรกu cho ฤแปch vร cรกc lแปi Status.</li>
ย ย ย ย <li><b>๐ Quร:</b> Tฤng vรng khแปi ฤแบงu lรชn 5,000.</li>
ย ย ย ย <li><b>๐ CodeCode:</b> UPDATE250.</li>
ย ย </ul>
ย ย <div style="text-align:center; margin-top:10px; color:#777;">~ Dev Team ~</div>
</div>
`;

// --- HรM HIแปN THแป LOG ---
function showUpdateLog() {
ย ย // Bรขy giแป nรณ ฤรฃ tรฌm thแบฅy GAME_VERSION แป ngay bรชn trรชn rแปi!
ย ย const lastReadVersion = localStorage.getItem('last_read_version');
ย ยย
ย ย if (lastReadVersion !== GAME_VERSION) {
ย ย ย ย let modal = document.createElement('div');
ย ย ย ย modal.style.cssText = "position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); z-index:10000; display:flex; justify-content:center; align-items:center;";
ย ย ย ยย
ย ย ย ย modal.innerHTML = `
ย ย ย ย ย ย <div class="box-style" style="width:90%; max-width:500px; background:#222; border-color:#f1c40f; max-height:80vh; overflow-y:auto; padding:20px;">
ย ย ย ย ย ย ย ย ${UPDATE_LOG_CONTENT}
ย ย ย ย ย ย ย ย <button class="btn-auth" style="margin-top:20px; width:100%" onclick="this.parentElement.parentElement.remove(); localStorage.setItem('last_read_version', '${GAME_VERSION}')">
ย ย ย ย ย ย ย ย ย ย ฤร HIแปU, VรO GAME!
ย ย ย ย ย ย ย ย </button>
ย ย ย ย ย ย </div>
ย ย ย ย `;
ย ย ย ย document.body.appendChild(modal);
ย ย }
}
ย ย // --- Hแป THแปNG GIFTCODE ---

// 1. Cแบฅu hรฌnh danh sรกch Code vร Quร
const GIFT_CODES = {
ย ย "UPDATE250": {ย
ย ย ย ย coins: 10000,ย
ย ย ย ย items: { 'ultra-ball': 20, 'rare-candy': 5 },
ย ย ย ย msg: "Mแปซng bแบฃn cแบญp nhแบญt 2.5.0! Tแบทng bแบกn 20 Ultra balls & 5 Kแบนo."
ย ย },
ย ย "POKESTAY": {
ย ย ย ย coins: 5000,
ย ย ย ย items: { 'great-ball': 10 },
ย ย ย ย msg: "Code tรขn thแปง: 5000 Xu + 10 Great Ball."
ย ย },
ย ย // Thรชm code mแปi vรo ฤรขy (Viแบฟt HOA hแบฟt cho dแป quแบฃn lรฝ)
};
function openGiftCodeModal() {
ย ย document.getElementById('gift-modal').style.display = 'flex';
ย ย document.getElementById('input-giftcode').value = ''; // Reset รด nhแบญp
ย ย document.getElementById('input-giftcode').focus();
}

function submitGiftCodeUI() {
ย ย let val = document.getElementById('input-giftcode').value;
ย ย if(!val) return alert("Vui lรฒng nhแบญp mรฃ!");
ย ยย
ย ย document.getElementById('gift-modal').style.display = 'none';
ย ย redeemCode(val.trim());
}

// 3. Hรm xแปญ lรฝ nhแบญn quร
function redeemCode(code) {
ย ย code = code.toUpperCase(); // Chuyแปn vแป chแปฏ hoa hแบฟt

ย ย // Kiแปm tra code cรณ tแปn tแบกi khรดng
ย ย if (!GIFT_CODES[code]) {
ย ย ย ย return alert("โ Mรฃ code khรดng tแปn tแบกi hoแบทc ฤรฃ hแบฟt hแบกn!");
ย ย }

ย ย // Kiแปm tra ฤรฃ dรนng chฦฐa
ย ย if (usedCodes.includes(code)) {
ย ย ย ย return alert("โ๏ธ Bแบกn ฤรฃ sแปญ dแปฅng mรฃ code nรy rแปi!");
ย ย }

ย ย // --- PHรT QUร ---
ย ย const gift = GIFT_CODES[code];
ย ย let rewardText = [];

ย ย // 1. Cแปng tiแปn
ย ย if (gift.coins) {
ย ย ย ย coins += gift.coins;
ย ย ย ย rewardText.push(`+${gift.coins.toLocaleString()} Coins`);
ย ย }

ย ย // 2. Cแปng vแบญt phแบฉm
ย ย if (gift.items) {
ย ย ย ย for (let itemId in gift.items) {
ย ย ย ย ย ย let qty = gift.items[itemId];
ย ย ย ย ย ย if (!inventory[itemId]) inventory[itemId] = 0;
ย ย ย ย ย ย inventory[itemId] += qty;
ย ย ย ย ย ยย
ย ย ย ย ย ย // Lแบฅy tรชn vแบญt phแบฉm cho ฤแบนp
ย ย ย ย ย ย let itemName = itemId;
ย ย ย ย ย ย let itemData = SHOP_DB.find(i => i.id === itemId);
ย ย ย ย ย ย if(itemData) itemName = itemData.name;
ย ย ย ย ย ยย
ย ย ย ย ย ย rewardText.push(`+${qty} ${itemName}`);
ย ย ย ย }
ย ย }

ย ย // 3. Lฦฐu lแบกi lร ฤรฃ dรนng
ย ย usedCodes.push(code);
ย ย saveGame();
ย ย updateStats();

ย ย // 4. Thรดng bรกo & Hiแปu แปฉng
ย ย playSFX('levelup'); // Dรนng tiแบฟng lรชn cแบฅp nghe cho sฦฐแปng
ย ยย
ย ย // Log ra mรn hรฌnh chat cho ฤแบนp
ย ย log(`<div class="embed" style="border-left-color:#e91e63">
ย ย ย ย <h3 style="color:#e91e63; margin:0">๐ NHแบฌP CODE THรNH CรNG!</h3>
ย ย ย ย <div style="margin:5px 0">Code: <b>${code}</b></div>
ย ย ย ย <div style="color:#f1c40f">${rewardText.join(', ')}</div>
ย ย ย ย <div style="font-size:0.8em; color:#bbb">"${gift.msg}"</div>
ย ย </div>`);

ย ย alert(`๐ Chรบc mแปซng! Bแบกn nhแบญn ฤฦฐแปฃc:\n${rewardText.join('\n')}`);
}
ย ย // ======================================================
// Hแป THแปNG GLOBAL CHAT (REALTIME)
// ======================================================
let isChatOpen = false;
let chatListenerAdded = false;

function toggleChat() {
ย ย isChatOpen = !isChatOpen;
ย ย const modal = document.getElementById('chat-modal');
ย ย modal.style.display = isChatOpen ? 'flex' : 'none';
ย ยย
ย ย if(isChatOpen) {
ย ย ย ย initChat();
ย ย ย ย document.getElementById('btn-chat-float').style.display = 'none';
ย ย } else {
ย ย ย ย document.getElementById('btn-chat-float').style.display = 'block';
ย ย }
}
// --- HรM LแบฎNG NGHE LแปNH Tแปช ADMIN (DรNH CHO NGฦฏแปI CHฦI) ---
function initAdminListener() {
ย ย if (!currentUser) return;

ย ย // Lแบฏng nghe thฦฐ mแปฅc 'admin_event' trong data cแปงa mรฌnh
ย ย firebase.database().ref('users/' + currentUser + '/admin_event').on('value', (snapshot) => {
ย ย ย ย const data = snapshot.val();
ย ย ย ยย
ย ย ย ย // Nแบฟu cรณ lแปnh mแปi
ย ย ย ย if (data && data.type === 'spawn') {
ย ย ย ย ย ย // 1. Thแปฑc hiแปn Spawn ngay lแบญp tแปฉc
ย ย ย ย ย ย log(`<div style="color:red; font-weight:bold">โ๏ธ ADMIN ฤร TRIแปU HแปI QUรI VแบฌT!</div>`);
ย ย ย ย ย ย forceSpawnPokemon(data.id, data.shiny, data.shadow, data.rainbow);

ย ย ย ย ย ย // 2. Xรณa lแปnh ngay sau khi nhแบญn (ฤแป trรกnh lแบทp lแบกi khi F5)
ย ย ย ย ย ย snapshot.ref.remove();
ย ย ย ย }
ย ย });
}
function initChat() {
ย ย if(chatListenerAdded) return;
ย ย chatListenerAdded = true;
ย ยย
ย ย const chatBox = document.getElementById('global-chat-content');
ย ย chatBox.innerHTML = ''; // Clear loading text

ย ย // Lแบฏng nghe 50 tin nhแบฏn cuแปi cรนng
ย ย firebase.database().ref('global_chat').limitToLast(50).on('child_added', (snapshot) => {
ย ย ย ย const msg = snapshot.val();
ย ย ย ย const div = document.createElement('div');
ย ย ย ย div.className = 'chat-msg';
ย ย ย ยย
ย ย ย ย let userDisplay = msg.user;
ย ย ย ย let msgColor = "#dcddde"; // Mรu chแปฏ mแบทc ฤแปnh
ย ย ย ย let nameStyle = "color:#3ba55c"; // Mรu tรชn mแบทc ฤแปnh (User)

ย ย ย ย // ๐ KIแปM TRA ADMIN
ย ย ย ย if (msg.user === 'ADMIN') {
ย ย ย ย ย ย userDisplay = `๐ก๏ธ [AD] ${msg.user}`; // Thรชm tiแปn tแป
ย ย ย ย ย ย nameStyle = "color:#ed4245; font-weight:bold; text-shadow: 0 0 5px red"; // Tรชn mรu ฤแป phรกt sรกng
ย ย ย ย ย ย msgColor = "#ff7675"; // Chแปฏ mรu hแปng nhแบกt cho nแปi
ย ย ย ย }

ย ย ย ย div.innerHTML = `<span class="chat-name" style="${nameStyle}" onclick="alert('User: ${msg.user}')">${userDisplay}:</span> <span style="color:${msgColor}">${msg.text}</span>`;
ย ย ย ย chatBox.appendChild(div);
ย ย ย ย chatBox.scrollTop = chatBox.scrollHeight;
ย ย });
ย ย firebase.database().ref('global_chat').on('value', (snapshot) => {
ย ย ย ย // Nแบฟu snapshot.val() lร null nghฤฉa lร dแปฏ liแปu ฤรฃ bแป xรณa trรชn server
ย ย ย ย if (!snapshot.exists()) {
ย ย ย ย ย ย chatBox.innerHTML = ''; // Xรณa sแบกch giao diแปn ngay lแบญp tแปฉc
ย ย ย ย ย ยย
ย ย ย ย ย ย // (Tรนy chแปn) Hiแปn thรดng bรกo nhแป
ย ย ย ย ย ย const sysDiv = document.createElement('div');
ย ย ย ย ย ย sysDiv.style.cssText = "text-align:center; color:#72767d; font-size:0.8em; margin-top:10px; font-style:italic";
ย ย ย ย ย ย sysDiv.innerText = "--- Lแปch sแปญ trรฒ chuyแปn ฤรฃ ฤฦฐแปฃc dแปn dแบนp ---";
ย ย ย ย ย ย chatBox.appendChild(sysDiv);
ย ย ย ย }
ย ย });
}

function handleChatEnter(e) {
ย ย if(e.key === 'Enter') sendChat();
}

function sendChat() {
ย ย if(!currentUser) return alert("Cแบงn ฤฤng nhแบญp ฤแป chat!");
ย ย const input = document.getElementById('chat-input');
ย ย const text = input.value.trim();
ย ย if(!text) return;
ย ย if(text.length > 100) return alert("Tin nhแบฏn quรก dรi!");

ย ย // Chแปng spam (Cooldown 2s)
ย ย const now = Date.now();
ย ย if(window.lastChatTime && now - window.lastChatTime < 2000) return log("โณ Chat chแบญm thรดi!");
ย ย window.lastChatTime = now;

ย ย firebase.database().ref('global_chat').push({
ย ย ย ย user: currentUser,
ย ย ย ย text: text,
ย ย ย ย time: firebase.database.ServerValue.TIMESTAMP
ย ย });
ย ยย
ย ย input.value = '';
}

// ======================================================
// Hแป THแปNG CHแปข ฤEN (MARKET)
// ======================================================
let pendingMoney = 0;

function openMarket() {
ย ย if(!currentUser) return alert("Cแบงn ฤฤng nhแบญp!");
ย ย document.getElementById('market-modal').style.display = 'flex';
ย ย document.getElementById('market-coin').innerText = coins.toLocaleString();
ย ย switchMarketTab('buy'); // Mแบทc ฤแปnh vรo tab mua
ย ย checkInbox(); // Kiแปm tra tiแปn bรกn ฤฦฐแปฃc
}

function closeMarket() {
ย ย document.getElementById('market-modal').style.display = 'none';
}

function switchMarketTab(tab) {
ย ย document.getElementById('market-buy-tab').style.display = 'none';
ย ย document.getElementById('market-sell-tab').style.display = 'none';
ย ย document.getElementById('market-inbox-tab').style.display = 'none';
ย ยย
ย ย if(tab === 'buy') {
ย ย ย ย document.getElementById('market-buy-tab').style.display = 'grid';
ย ย ย ย loadMarketListings();
ย ย } else if(tab === 'sell') {
ย ย ย ย document.getElementById('market-sell-tab').style.display = 'block';
ย ย ย ย renderSellList();
ย ย } else {
ย ย ย ย document.getElementById('market-inbox-tab').style.display = 'block';
ย ย }
}

// --- LOGIC MUA: Tแบฃi danh sรกch ---
// --- CแบฌP NHแบฌT: HIแปN THแป HรNG CแปฆA MรNH & NGฦฏแปI KHรC ---
// --- HรM LOAD CHแปข ฤEN (ฤร SแปฌA LแปI HIแปN THแป MรU SHADOW/RAINBOW) ---
function loadMarketListings() {
ย ย const container = document.getElementById('market-buy-tab');
ย ย container.innerHTML = '<div style="grid-column:span 2; text-align:center; color:yellow">ฤang tแบฃi dแปฏ liแปu...</div>';

ย ย firebase.database().ref('market').once('value').then(snap => {
ย ย ย ย const data = snap.val();
ย ย ย ยย
ย ย ย ย // Reset nแปi dung
ย ย ย ย container.innerHTML = '';

ย ย ย ย if(!data) {
ย ย ย ย ย ย container.innerHTML = '<div style="grid-column:span 2; text-align:center; color:#777">Chแปฃ vแบฏng tanh...</div>';
ย ย ย ย ย ย return;
ย ย ย ย }

ย ย ย ย // Tรกch danh sรกch thรnh 2 mแบฃng: Cแปงa mรฌnh vร Cแปงa ngฦฐแปi khรกc
ย ย ย ย let myItemsHtml = '';
ย ย ย ย let otherItemsHtml = '';
ย ย ย ย let hasMine = false;
ย ย ย ย let hasOthers = false;

ย ย ย ย Object.keys(data).forEach(key => {
ย ย ย ย ย ย const item = data[key];
ย ย ย ย ย ย const isMine = item.seller === currentUser;
ย ย ย ย ย ยย
ย ย ย ย ย ย // --- [SแปฌA LแปI TแบI ฤรY] Xแปฌ Lร VISUAL SHADOW/RAINBOW ---
ย ย ย ย ย ย let variantClass = "";ย // Class CSS cho แบฃnh
ย ย ย ย ย ย let variantPrefix = ""; // Icon trฦฐแปc tรชn
ย ย ย ย ย ยย
ย ย ย ย ย ย if (item.data.isRainbow) {
ย ย ย ย ย ย ย ย variantClass = "variant-rainbow";
ย ย ย ย ย ย ย ย variantPrefix = "๐ ";
ย ย ย ย ย ย } else if (item.data.isShadow) {
ย ย ย ย ย ย ย ย variantClass = "variant-shadow";
ย ย ย ย ย ย ย ย variantPrefix = "๐ฟ ";
ย ย ย ย ย ย } else if (item.data.isShiny) {
ย ย ย ย ย ย ย ย variantPrefix = "โจ ";
ย ย ย ย ย ย }
ย ย ย ย ย ย // ----------------------------------------------------

ย ย ย ย ย ย let rarityInfo = getRarity(item.data);ย
ย ย ย ย ย ยย
ย ย ย ย ย ย // Tแบกo HTML cho thแบป Pokemon
ย ย ย ย ย ย // Chรบ รฝ dรฒng <img class="${variantClass}"> ฤฦฐแปฃc thรชm vรo bรชn dฦฐแปi
ย ย ย ย ย ย let cardHtml = `
ย ย ย ย ย ย <div class="market-item" style="${isMine ? 'border:1px solid #3ba55c; background:rgba(59, 165, 92, 0.1)' : ''}">
ย ย ย ย ย ย ย ย <span class="seller-name" style="${isMine ? 'color:#3ba55c' : ''}">${isMine ? 'Cแปงa bแบกn' : item.seller}</span>
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <img src="${item.data.img}" width="60" class="${variantClass}" style="image-rendering:pixelated">
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <div style="font-weight:bold; font-size:0.9em; margin-top:5px">
ย ย ย ย ย ย ย ย ย ย <span class="${rarityInfo.class}">${variantPrefix}${item.data.name}</span>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <div style="font-size:0.7em; color:#aaa">Lv.${item.data.level} | IV:${item.data.iv}</div>
ย ย ย ย ย ย ย ย <div class="market-price">${parseInt(item.price).toLocaleString()}๐ฐ</div>
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย ${isMineย
ย ย ย ย ย ย ย ย ย ย ? `<button class="btn-small" style="width:100%; margin-top:5px; background:#ed4245" onclick="cancelMarketListing('${key}')">RรT Vแป</button>`
ย ย ย ย ย ย ย ย ย ย : `<button class="btn-small" style="width:100%; margin-top:5px; background:#2ecc71" onclick="buyMarketItem('${key}')">MUA</button>`
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย </div>
ย ย ย ย ย ย `;

ย ย ย ย ย ย if(isMine) {
ย ย ย ย ย ย ย ย myItemsHtml += cardHtml;
ย ย ย ย ย ย ย ย hasMine = true;
ย ย ย ย ย ย } else {
ย ย ย ย ย ย ย ย otherItemsHtml += cardHtml;
ย ย ย ย ย ย ย ย hasOthers = true;
ย ย ย ย ย ย }
ย ย ย ย });

ย ย ย ย // Render ra mรn hรฌnh (Cแปงa mรฌnh nแบฑm trรชn cรนng)
ย ย ย ย if(hasMine) {
ย ย ย ย ย ย container.innerHTML += `<div style="grid-column:span 2; font-weight:bold; color:#3ba55c; border-bottom:1px solid #444; margin:10px 0 5px 0">๐ฆ ฤang treo bรกn:</div>`;
ย ย ย ย ย ย container.innerHTML += myItemsHtml;
ย ย ย ย }

ย ย ย ย if(hasOthers) {
ย ย ย ย ย ย container.innerHTML += `<div style="grid-column:span 2; font-weight:bold; color:#faa61a; border-bottom:1px solid #444; margin:10px 0 5px 0">๐ Chแปฃ toรn cแบงu:</div>`;
ย ย ย ย ย ย container.innerHTML += otherItemsHtml;
ย ย ย ย } else {
ย ย ย ย ย ย container.innerHTML += `<div style="grid-column:span 2; text-align:center; color:#777; margin-top:20px">Khรดng cรณ ai khรกc bรกn hรng.</div>`;
ย ย ย ย }
ย ย });
}
ย ย // --- HรM RรT LแบI HรNG (CANCEL LISTING) ---
function cancelMarketListing(key) {
ย ย // 1. Kiแปm tra tรบi cรณ ฤแบงy khรดng
ย ย if(myBag.length >= maxBagSize) {
ย ย ย ย return alert("Tรบi Pokemon ฤรฃ ฤแบงy! Khรดng thแป rรบt vแป. Hรฃy dแปn tรบi trฦฐแปc.");
ย ย }

ย ย // 2. Lแบฅy thรดng tin item ฤแป chแบฏc chแบฏn lร cแปงa mรฌnh
ย ย firebase.database().ref('market/' + key).once('value').then(snap => {
ย ย ย ย const item = snap.val();
ย ย ย ย if(!item) return alert("Vแบญt phแบฉm khรดng tแปn tแบกi (Cรณ thแป ฤรฃ bแป ai ฤรณ mua rแปi)!");

ย ย ย ย // Bแบฃo mแบญt: Chแป chแปง sแป hแปฏu mแปi ฤฦฐแปฃc rรบt
ย ย ย ย if(item.seller !== currentUser) {
ย ย ย ย ย ย return alert("Khรดng thแป rรบt vแบญt phแบฉm khรดng phแบฃi cแปงa bแบกn!");
ย ย ย ย }

ย ย ย ย if(confirm(`Bแบกn muแปn gแปก bรกn ${item.data.name} vร ฤฦฐa vแป tรบi?`)) {
ย ย ย ย ย ย // A. ฤฦฐa vแป tรบi
ย ย ย ย ย ย myBag.push(item.data);
ย ย ย ย ย ยย
ย ย ย ย ย ย // B. Xรณa trรชn chแปฃ
ย ย ย ย ย ย firebase.database().ref('market/' + key).remove()
ย ย ย ย ย ย .then(() => {
ย ย ย ย ย ย ย ย saveGame();
ย ย ย ย ย ย ย ย updateStats(); // Cแบญp nhแบญt lแบกi sแป lฦฐแปฃng trong tรบi
ย ย ย ย ย ย ย ย alert(`ฤรฃ rรบt ${item.data.name} vแป tรบi thรnh cรดng!`);
ย ย ย ย ย ย ย ย loadMarketListings(); // Tแบฃi lแบกi giao diแปn chแปฃ
ย ย ย ย ย ย })
ย ย ย ย ย ย .catch(err => alert("Lแปi khi rรบt: " + err));
ย ย ย ย }
ย ย });
}

// --- LOGIC BรN: Chแปn Pokemon ฤแป treo ---
// --- HรM HIแปN THแป DANH SรCH TREO BรN (ฤร CแบฌP NHแบฌT VISUAL) ---
function renderSellList() {
ย ย const container = document.getElementById('market-sell-list');
ย ยย
ย ย // Kiแปm tra tรบi rแปng
ย ย if(myBag.length === 0) {
ย ย ย ย container.innerHTML = '<div style="text-align:center; color:#777; padding:20px">Tรบi rแปng! Hรฃy ฤi bแบฏt Pokemon trฦฐแปc.</div>';
ย ย ย ย return;
ย ย }

ย ย container.innerHTML = myBag.map((p, idx) => {
ย ย ย ย // --- [SแปฌA LแปI TแบI ฤรY] Xแปฌ Lร VISUAL SHADOW/RAINBOW ---
ย ย ย ย let variantClass = "";ย // Class CSS hiแปu แปฉng แบฃnh
ย ย ย ย let variantPrefix = ""; // Icon trฦฐแปc tรชn
ย ย ย ยย
ย ย ย ย if (p.isRainbow) {
ย ย ย ย ย ย variantClass = "variant-rainbow";
ย ย ย ย ย ย variantPrefix = "๐ ";
ย ย ย ย } else if (p.isShadow) {
ย ย ย ย ย ย variantClass = "variant-shadow";
ย ย ย ย ย ย variantPrefix = "๐ฟ ";
ย ย ย ย } else if (p.isShiny) {
ย ย ย ย ย ย variantPrefix = "โจ ";
ย ย ย ย }
ย ย ย ย // ----------------------------------------------------

ย ย ย ย // Tรญnh chแป sแป sแปฉc mแบกnh (CP) hiแปn thแป cho ngแบงu
ย ย ย ย let cp = Math.floor((p.atk + p.spA + p.def + p.spD + p.maxHp + p.spd) * p.level / 10);

ย ย ย ย return `
ย ย ย ย <div class="market-item" style="border-color:#555">
ย ย ย ย ย ย <img src="${p.img}" width="50" class="${variantClass}" style="image-rendering:pixelated">
ย ย ย ย ย ยย
ย ย ย ย ย ย <div style="font-weight:bold; font-size:0.8em; margin-top:5px">
ย ย ย ย ย ย ย ย ${variantPrefix}${p.name}
ย ย ย ย ย ย </div>
ย ย ย ย ย ยย
ย ย ย ย ย ย <div style="font-size:0.7em; color:#aaa">CP: ${cp} | Lv.${p.level}</div>
ย ย ย ย ย ยย
ย ย ย ย ย ย <button class="btn-small" style="width:100%; margin-top:5px; background:#e67e22" onclick="promptSell(${idx})">BรN</button>
ย ย ย ย </div>
ย ย ย ย `;
ย ย }).join('');
}

function promptSell(idx) {
ย ย let p = myBag[idx];
ย ย let price = prompt(`Nhแบญp giรก bรกn cho ${p.name} (Tแปi thiแปu 100):`);
ย ย if(!price) return;
ย ย price = parseInt(price);
ย ยย
ย ย if(isNaN(price) || price < 100) return alert("Giรก khรดng hแปฃp lแป (Min 100)!");
ย ย if(price > 1000000000) return alert("Giรก quรก cao!");

ย ย if(confirm(`Bแบกn muแปn treo bรกn ${p.name} vแปi giรก ${price.toLocaleString()} coins?`)) {
ย ย ย ย // 1. ฤแบฉy lรชn chแปฃ
ย ย ย ย const newItemRef = firebase.database().ref('market').push();
ย ย ย ย newItemRef.set({
ย ย ย ย ย ย seller: currentUser,
ย ย ย ย ย ย price: price,
ย ย ย ย ย ย data: p, // Lฦฐu toรn bแป thรดng tin Pokemon
ย ย ย ย ย ย timestamp: firebase.database.ServerValue.TIMESTAMP
ย ย ย ย });

ย ย ย ย // 2. Xรณa khแปi tรบi
ย ย ย ย myBag.splice(idx, 1);
ย ย ย ย saveGame();
ย ย ย ยย
ย ย ย ย alert("ฤรฃ treo bรกn thรnh cรดng! Vรo tab 'Hรฒm Thฦฐ' ฤแป nhแบญn tiแปn khi cรณ ngฦฐแปi mua.");
ย ย ย ย switchMarketTab('buy'); // Quay vแป chแปฃ
ย ย }
}

// --- LOGIC GIAO DแปCH (Transaction) ---
function buyMarketItem(key) {
ย ย // 1. Lแบฅy thรดng tin mแปi nhแบฅt (ฤแป trรกnh mua ฤแป ฤรฃ bแป ngฦฐแปi khรกc mua)
ย ย firebase.database().ref('market/' + key).once('value').then(snap => {
ย ย ย ย const item = snap.val();
ย ย ย ย if(!item) return alert("Vแบญt phแบฉm nรy khรดng cรฒn tแปn tแบกi (ฤรฃ bแป mua hoแบทc gแปก)!");
ย ย ย ยย
ย ย ย ย // 2. Kiแปm tra tiแปn
ย ย ย ย if(coins < item.price) return alert("Bแบกn khรดng ฤแปง tiแปn!");

ย ย ย ย if(myBag.length >= maxBagSize) return alert("Tรบi Pokemon ฤรฃ ฤแบงy!");

ย ย ย ย // 3. Thแปฑc hiแปn giao dแปch
ย ย ย ย // A. Trแปซ tiแปn ngฦฐแปi mua
ย ย ย ย coins -= item.price;
ย ย ย ย // B. Thรชm Pokemon cho ngฦฐแปi mua
ย ย ย ย myBag.push(item.data);
ย ย ย ย saveGame();
ย ย ย ย updateStats();

ย ย ย ย // C. Gแปญi tiแปn cho ngฦฐแปi bรกn (vรo inbox)
ย ย ย ย firebase.database().ref('users/' + item.seller + '/inbox').push({
ย ย ย ย ย ย type: 'sold',
ย ย ย ย ย ย msg: `ฤรฃ bรกn ${item.data.name} (+${item.price} coins)`,
ย ย ย ย ย ย amount: item.price,
ย ย ย ย ย ย time: Date.now()
ย ย ย ย });

ย ย ย ย // D. Xรณa khแปi chแปฃ
ย ย ย ย firebase.database().ref('market/' + key).remove()
ย ย ย ย .then(() => {
ย ย ย ย ย ย alert(`Mua thรnh cรดng ${item.data.name}!`);
ย ย ย ย ย ย loadMarketListings(); // Tแบฃi lแบกi chแปฃ
ย ย ย ย ย ย document.getElementById('market-coin').innerText = coins.toLocaleString();
ย ย ย ย })
ย ย ย ย .catch(err => alert("Lแปi giao dแปch: " + err));
ย ย });
}

// --- HรM THฦฏ & NHแบฌN TIแปN ---
function checkInbox() {
ย ย if(!currentUser) return;
ย ย firebase.database().ref('users/' + currentUser + '/inbox').once('value').then(snap => {
ย ย ย ย const data = snap.val();
ย ย ย ย const logsDiv = document.getElementById('inbox-logs');
ย ย ย ย const btnClaim = document.getElementById('btn-claim-money');
ย ย ย ย const countBadge = document.getElementById('inbox-count');
ย ย ย ยย
ย ย ย ย pendingMoney = 0;
ย ย ย ย logsDiv.innerHTML = '';

ย ย ย ย if(data) {
ย ย ย ย ย ย let count = 0;
ย ย ย ย ย ย Object.keys(data).forEach(k => {
ย ย ย ย ย ย ย ย let mail = data[k];
ย ย ย ย ย ย ย ย if(mail.amount) pendingMoney += mail.amount;
ย ย ย ย ย ย ย ย logsDiv.innerHTML += `<div style="border-bottom:1px dashed #444; padding:5px">๐ ${new Date(mail.time).toLocaleDateString()}: ${mail.msg}</div>`;
ย ย ย ย ย ย ย ย count++;
ย ย ย ย ย ย });
ย ย ย ย ย ย countBadge.innerText = count;
ย ย ย ย } else {
ย ย ย ย ย ย countBadge.innerText = '0';
ย ย ย ย ย ย logsDiv.innerHTML = 'Hรฒm thฦฐ trแปng.';
ย ย ย ย }

ย ย ย ย if(pendingMoney > 0) {
ย ย ย ย ย ย btnClaim.style.display = 'block';
ย ย ย ย ย ย btnClaim.innerText = `๐ฐ RรT TIแปN: ${pendingMoney.toLocaleString()}`;
ย ย ย ย } else {
ย ย ย ย ย ย btnClaim.style.display = 'none';
ย ย ย ย }
ย ย });
}

function claimMarketMoney() {
ย ย if(pendingMoney <= 0) return;
ย ยย
ย ย // Cแปng tiแปn
ย ย coins += pendingMoney;
ย ย pendingMoney = 0;
ย ยย
ย ย // Xรณa hรฒm thฦฐ
ย ย firebase.database().ref('users/' + currentUser + '/inbox').remove();
ย ยย
ย ย saveGame();
ย ย updateStats();
ย ยย
ย ย alert("ฤรฃ rรบt toรn bแป tiแปn bรกn hรng vแป tรบi!");
ย ย checkInbox();
ย ย document.getElementById('market-coin').innerText = coins.toLocaleString();
}
ย ย // --- HรM LรM NรT CHAT KรO ฤฦฏแปขC (DRAGGABLE) ---
function makeDraggable(elementId) {
ย ย const el = document.getElementById(elementId);
ย ย if (!el) return;

ย ย let isDragging = false;
ย ย let startX, startY, initialLeft, initialTop;
ย ย let hasMoved = false; // Biแบฟn kiแปm tra xem lร Click hay Drag

ย ย // 1. Bแบฏt ฤแบงu kรฉo (Chuแปt hoแบทc Ngรณn tay)
ย ย const startDrag = (e) => {
ย ย ย ย isDragging = true;
ย ย ย ย hasMoved = false; // Reset trแบกng thรกi

ย ย ย ย // Lแบฅy vแป trรญ con trแป (Touch hoแบทc Mouse)
ย ย ย ย const clientX = e.touches ? e.touches[0].clientX : e.clientX;
ย ย ย ย const clientY = e.touches ? e.touches[0].clientY : e.clientY;

ย ย ย ย startX = clientX;
ย ย ย ย startY = clientY;

ย ย ย ย // Lแบฅy vแป trรญ hiแปn tแบกi cแปงa nรบt
ย ย ย ย const rect = el.getBoundingClientRect();
ย ย ย ย initialLeft = rect.left;
ย ย ย ย initialTop = rect.top;

ย ย ย ย // Xรณa thuแปc tรญnh bottom/right ฤแป chuyแปn sang dรนng top/left hoรn toรn
ย ย ย ย el.style.bottom = 'auto';
ย ย ย ย el.style.right = 'auto';
ย ย ย ย el.style.left = initialLeft + 'px';
ย ย ย ย el.style.top = initialTop + 'px';
ย ย ย ยย
ย ย ย ย // Hiแปu แปฉng mแป nhแบน khi ฤang kรฉo
ย ย ย ย el.style.opacity = '0.7';
ย ย };

ย ย // 2. Di chuyแปn
ย ย const onDrag = (e) => {
ย ย ย ย if (!isDragging) return;
ย ย ย ยย
ย ย ย ย // Ngฤn mรn hรฌnh bแป cuแปn khi kรฉo trรชn ฤiแปn thoแบกi
ย ย ย ย if(e.cancelable) e.preventDefault();

ย ย ย ย const clientX = e.touches ? e.touches[0].clientX : e.clientX;
ย ย ย ย const clientY = e.touches ? e.touches[0].clientY : e.clientY;

ย ย ย ย const dx = clientX - startX;
ย ย ย ย const dy = clientY - startY;

ย ย ย ย // Nแบฟu di chuyแปn quรก 5px thรฌ tรญnh lร ฤang Kรฉo (khรดng phแบฃi Click nhแบงm)
ย ย ย ย if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
ย ย ย ย ย ย hasMoved = true;
ย ย ย ย }

ย ย ย ย el.style.left = (initialLeft + dx) + 'px';
ย ย ย ย el.style.top = (initialTop + dy) + 'px';
ย ย };

ย ย // 3. Thแบฃ ra
ย ย const endDrag = () => {
ย ย ย ย if (!isDragging) return;
ย ย ย ย isDragging = false;
ย ย ย ย el.style.opacity = '1';

ย ย ย ย // Nแบฟu KHรNG di chuyแปn (tแปฉc lร chแป Click) -> Mแป Chat
ย ย ย ย if (!hasMoved) {
ย ย ย ย ย ย toggleChat();
ย ย ย ย }
ย ย };

ย ย // --- Gแบฏn sแปฑ kiแปn cho PC ---
ย ย el.addEventListener('mousedown', startDrag);
ย ย window.addEventListener('mousemove', onDrag);
ย ย window.addEventListener('mouseup', endDrag);

ย ย // --- Gแบฏn sแปฑ kiแปn cho Mobile ---
ย ย el.addEventListener('touchstart', startDrag, {passive: false});
ย ย window.addEventListener('touchmove', onDrag, {passive: false});
ย ย window.addEventListener('touchend', endDrag);
}
ย ย // --- Hแป THแปNG CHแปN TEAM THรP ---
function openTowerTeamSelect() {
ย ย // Tรกi sแปญ dแปฅng modal chแปn team cแปงa Boss nhฦฐng ฤแปi hรnh ฤแปng nรบt Lฦฐu
ย ย document.getElementById('boss-team-modal').style.display = 'flex';
ย ยย
ย ย // ฤแปi tiรชu ฤแป cho ngฦฐแปi chฦกi biแบฟt ฤang chแปn team Thรกp
ย ย document.querySelector('#boss-team-modal h3').innerText = "Chแปn Team Leo Thรกp (Tแปi ฤa 6)";
ย ยย
ย ย // Load team hiแปn tแบกi cแปงa thรกp
ย ย // Lแปc bแป index khรดng cรฒn tแปn tแบกi
ย ย tempTeamIndices = (towerData.teamIndices || []).filter(idx => myBag[idx]);
ย ยย
ย ย // Thay ฤแปi nรบt Lฦฐu ฤแป gแปi hรm lฦฐu team Thรกp
ย ย const saveBtn = document.querySelector('#boss-team-modal .btn-auth');
ย ย saveBtn.innerText = "LฦฏU TEAM THรP";
ย ย saveBtn.onclick = saveTowerTeam;
ย ยย
ย ย renderTeamGrid();
}

function saveTowerTeam() {
ย ย if(tempTeamIndices.length === 0) return alert("Phแบฃi chแปn รญt nhแบฅt 1 Pokemon!");
ย ยย
ย ย towerData.teamIndices = [...tempTeamIndices];
ย ย saveGame();
ย ยย
ย ย document.getElementById('boss-team-modal').style.display = 'none';
ย ย alert("ฤรฃ lฦฐu ฤแปi hรฌnh leo thรกp!");
ย ย updateTowerUI();
}
ย ย // ======================================================
// Hแป THแปNG BATTLE TOWER ENGINE
// ======================================================

function openTower() {
ย ย document.getElementById('tower-modal').style.display = 'flex';
ย ย updateTowerUI();
}

function closeTower() {
ย ย document.getElementById('tower-modal').style.display = 'none';
}

function updateTowerUI() {
ย ย document.getElementById('tower-floor-display').innerText = towerData.floor;
ย ย document.getElementById('tower-token-display').innerText = towerData.tokens;
ย ยย
ย ย // Tรญnh Level ฤแปch: Floor 1 = Lv 10, mแปi tแบงng tฤng 1 Level
ย ย // Floor 100 = Lv 109
ย ย let enemyLv = 9 + towerData.floor;
ย ย document.getElementById('tower-enemy-preview').innerText = `Lv.${enemyLv}`;
}

// 1. BแบฎT ฤแบฆU TRแบฌN ฤแบคU
// --- HรM BแบฎT ฤแบฆU LEO THรP (ฤร SแปฌA LแปI HIแปN THแป) ---
async function startTowerBattle() {
ย ย // 1. Lแปc lแปi ฤแปi hรฌnh (phรฒng trฦฐแปng hแปฃp ฤรฃ bรกn Pokemon)
ย ย if (!towerData.teamIndices) towerData.teamIndices = [];
ย ย towerData.teamIndices = towerData.teamIndices.filter(idx => myBag[idx]);

ย ย if(towerData.teamIndices.length === 0) return alert("Chฦฐa chแปn ฤแปi hรฌnh leo thรกp!");

ย ย // 2. Tรฌm Pokemon ฤแบงu tiรชn cรฒn sแปng trong ฤแปi hรฌnh
ย ย let alivePokemonIdx = towerData.teamIndices.find(idx => myBag[idx].hp > 0);
ย ยย
ย ย if (typeof alivePokemonIdx === 'undefined') {
ย ย ย ย // Nแบฟu chแบฟt hแบฟt cแบฃ team -> Hแปi Reset
ย ย ย ย if(confirm("Toรn bแป ฤแปi hรฌnh ฤรฃ gแปฅc ngรฃ! Bแบกn cรณ muแปn Reset vแป Tแบงng 1 ฤแป chฦกi lแบกi khรดng?")) {
ย ย ย ย ย ย resetTowerRun();
ย ย ย ย }
ย ย ย ย return;
ย ย }

ย ย // 3. Chแปn Pokemon ฤรณ ฤแป ฤรกnh
ย ย selectedBattleIdx = alivePokemonIdx;ย
ย ยย
ย ย // 4. Xแปญ lรฝ giao diแปn (QUAN TRแปNG: Phแบฃi mแป battle-modal lรชn)
ย ย document.getElementById('tower-modal').style.display = 'none'; // ฤรณng bแบฃng thรกp
ย ย document.getElementById('battle-modal').style.display = 'flex'; // Mแป bแบฃng chiแบฟn ฤแบฅu
ย ยย
ย ย // 5. Bแบฏt ฤแบงu trแบญn ฤแบฅu vแปi chแบฟ ฤแป 'tower'
ย ย // (Lฦฐu รฝ: Bแบกn phแบฃi chแบฏc chแบฏn ฤรฃ thรชm logic 'tower' vรo hรm startBattle แป bฦฐแปc trฦฐแปc)
ย ย await startBattle('tower');
}

// Hรm xแปญ lรฝ khi thแบฏng tแบงng thรกp
function handleTowerWin() {
ย ย // 1. Tฤng tแบงng
ย ย towerData.floor++;
ย ยย
ย ย // 2. Cแบญp nhแบญt kแปท lแปฅc
ย ย if(towerData.floor > towerData.bestRecord) towerData.bestRecord = towerData.floor;

ย ย // 3. Cฦก chแบฟ Hแปi phแปฅc 20% cho cแบฃ team
ย ย let healMsg = "";
ย ย towerData.teamIndices.forEach(idx => {
ย ย ย ย let p = myBag[idx];
ย ย ย ย if(p && p.hp > 0) { // Chแป hแปi cho con cรฒn sแปng
ย ย ย ย ย ย let healAmount = Math.floor(p.maxHp * 0.2);
ย ย ย ย ย ย p.hp = Math.min(p.maxHp, p.hp + healAmount);
ย ย ย ย }
ย ย });
ย ย healMsg = "Team ฤฦฐแปฃc hแปi 20% HP.";

ย ย // 4. Phแบงn thฦฐแปng mแปi 10 tแบงng
ย ย let rewardMsg = "";
ย ย if((towerData.floor - 1) % 10 === 0) {
ย ย ย ย towerData.tokens += 1;
ย ย ย ย rewardMsg = "\n๐ Nhแบญn ฤฦฐแปฃc 1 Tower Token!";
ย ย ย ย playSFX('levelup');
ย ย }

ย ย saveGame();
ย ยย
ย ย // 5. Thรดng bรกo vร mแป lแบกi bแบฃng Thรกp
ย ย setTimeout(() => {
ย ย ย ย alert(`๐ CHIแบพN THแบฎNG TแบฆNG ${towerData.floor - 1}!\n${healMsg}${rewardMsg}`);
ย ย ย ย openTower(); // Mแป lแบกi bแบฃng thรกp ฤแป ฤi tiแบฟp
ย ย }, 500);
}

// Hรm Reset khi thua
function resetTowerRun() {
ย ย towerData.floor = 1;
ย ย // Hแปi ฤแบงy mรกu cho team ฤแป chฦกi lแบกi tแปซ ฤแบงu
ย ย towerData.teamIndices.forEach(idx => {
ย ย ย ย if(myBag[idx]) myBag[idx].hp = myBag[idx].maxHp;
ย ย });
ย ย saveGame();
ย ย updateTowerUI();
ย ย alert("ฤรฃ Reset vแป Tแบงng 1. Chรบc may mแบฏn lแบงn nรy!");
}

// ======================================================
// Hแป THแปNG SHOP TOKEN
// ======================================================
const TOWER_SHOP = [
ย ย // Giรก ฤแบฏt hฦกn ฤแป ngฦฐแปi chฦกi phแบฃi cรy cuแปc
ย ย { id: 'master-ball', name: 'Master Ball', price: 20, img: 'master-ball.png' }, // Tฤng tแปซ 1 -> 20
ย ย { id: 'shiny-charm', name: 'Shiny Charm', price: 50, img: 'shiny-charm.png' }, // Tฤng tแปซ 5 -> 50 (Vแบญt phแบฉm cแปฑc mแบกnh)
ย ย { id: 'mystery-egg', name: 'Mystery Egg', price: 10, img: 'lucky-egg.png' },ย ย// Tฤng tแปซ 2 -> 10
ย ย { id: 'rare-candy', name: '5x Rare Candy', price: 5, rewardId: 'rare-candy', qty: 5, img: 'rare-candy.png' }, // Tฤng tแปซ 1 -> 5
ย ย { id: 'ultra-ball', name: '10x Ultra Ball', price: 2, rewardId: 'ultra-ball', qty: 10, img: 'ultra-ball.png' } // Thรชm bรณng thฦฐแปng
];

function openTowerShop() {
ย ย document.getElementById('tower-shop-modal').style.display = 'flex';
ย ย const list = document.getElementById('tower-shop-list');
ย ยย
ย ย list.innerHTML = TOWER_SHOP.map(item => `
ย ย ย ย <div class="shop-card" style="border-color:#f1c40f">
ย ย ย ย ย ย <img src="${URL_ITEMS}${item.img}" width="50">
ย ย ย ย ย ย <div style="font-weight:bold; color:white">${item.name}</div>
ย ย ย ย ย ย <div style="color:#f1c40f; margin:5px 0">${item.price} ๐</div>
ย ย ย ย ย ย <button class="btn-small" style="width:100%; background:#6c5ce7" onclick="buyTowerItem('${item.id}')">ฤแปI</button>
ย ย ย ย </div>
ย ย `).join('');
}

function buyTowerItem(itemId) {
ย ย const item = TOWER_SHOP.find(i => i.id === itemId);
ย ย if(towerData.tokens < item.price) return alert("Khรดng ฤแปง Tower Token!");
ย ยย
ย ย if(confirm(`ฤแปi ${item.price} Token lแบฅy ${item.name}?`)) {
ย ย ย ย towerData.tokens -= item.price;
ย ย ย ยย
ย ย ย ย let realId = item.rewardId || item.id;
ย ย ย ย let qty = item.qty || 1;
ย ย ย ยย
ย ย ย ย if(!inventory[realId]) inventory[realId] = 0;
ย ย ย ย inventory[realId] += qty;
ย ย ย ยย
ย ย ย ย saveGame();
ย ย ย ย openTowerShop(); // Reload UI
ย ย ย ย document.getElementById('tower-token-display').innerText = towerData.tokens;
ย ย ย ย alert("ฤแปi quร thรnh cรดng!");
ย ย }
}
ย ย // --- Hแป THแปNG ฤแปI POKEMON KHI CHแบพT (BATTLE TOWER) ---

// 1. Xแปญ lรฝ khi Pokemon hiแปn tแบกi bแป hแบก
function handleTowerPlayerFaint() {
ย ย // Tรฌm nhแปฏng con cรฒn sแปng trong team thรกp (trแปซ con vแปซa chแบฟt ra)
ย ย let survivors = towerData.teamIndices.filter(idx => {
ย ย ย ย let p = myBag[idx];
ย ย ย ย return p && p.hp > 0;
ย ย });

ย ย if (survivors.length > 0) {
ย ย ย ย // Vแบซn cรฒn ngฦฐแปi -> Mแป bแบฃng chแปn
ย ย ย ย logBattle(`<b>${battleState.player.name}</b> khรดng thแป thi ฤแบฅu tiแบฟp!`);
ย ย ย ย openSwitchModal(survivors);
ย ย } else {
ย ย ย ย // Chแบฟt hแบฟt cแบฃ 6 con -> THUA THแบฌT
ย ย ย ย battleState.active = false;
ย ย ย ย logBattle(`<b style="color:#ed4245">ฤแปI HรNH ฤร Bแป QUรT SแบCH!</b>`);
ย ย ย ย document.getElementById('battle-main-menu').style.display = 'none';
ย ย ย ยย
ย ย ย ย // Hiแปn nรบt Reset thรกp
ย ย ย ย let endBtn = document.getElementById('battle-end-btn');
ย ย ย ย endBtn.style.display = 'block';
ย ย ย ย endBtn.innerText = "Vแป Tแบงng 1 (Thแบฅt bแบกi)";
ย ย ย ย endBtn.onclick = () => {
ย ย ย ย ย ย endBattle();
ย ย ย ย ย ย resetTowerRun(); // Reset vแป tแบงng 1
ย ย ย ย };
ย ย ย ยย
ย ย ย ย battleState.finished = true;
ย ย }
}

// 2. Mแป bแบฃng chแปn
function openSwitchModal(survivorIndices) {
ย ย const modal = document.getElementById('switch-modal');
ย ย const list = document.getElementById('switch-list');
ย ยย
ย ย list.innerHTML = survivorIndices.map(idx => {
ย ย ย ย let p = myBag[idx];
ย ย ย ย return `
ย ย ย ย <div class="shop-item" style="display:flex; align-items:center; gap:10px; text-align:left; cursor:pointer; background:#2f3136" onclick="confirmSwitch(${idx})">
ย ย ย ย ย ย <img src="${p.img}" width="40">
ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย <div style="font-weight:bold; color:white">${p.name}</div>
ย ย ย ย ย ย ย ย <div style="font-size:0.8em; color:#2ecc71">HP: ${p.hp}/${p.maxHp}</div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>`;
ย ย }).join('');

ย ย modal.style.display = 'flex';
}

// 3. Xรกc nhแบญn ฤแปi
function confirmSwitch(newIdx) {
ย ย let newPoke = myBag[newIdx];
ย ยย
ย ย // Cแบญp nhแบญt State trแบญn ฤแบฅu
ย ย battleState.player = newPoke;
ย ย selectedBattleIdx = newIdx; // Cแบญp nhแบญt index ฤแป hแป thแปng biแบฟt ฤang dรนng con nรo

ย ย // ฤรณng modal
ย ย document.getElementById('switch-modal').style.display = 'none';

ย ย // Cแบญp nhแบญt giao diแปn chiแบฟn ฤแบฅu
ย ย document.getElementById('player-name').innerText = newPoke.name;
ย ย document.getElementById('player-sprite').src = newPoke.img || `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/back/${newPoke.id}.png`;
ย ยย
ย ย // Reset hiแปu แปฉng status cลฉ trรชn UI
ย ย renderStatusIcon(newPoke, 'player-name');
ย ย updateBattleUI();

ย ย // Log thรดng bรกo
ย ย logBattle(`๐ <b>${newPoke.name}</b> bฦฐแปc vรo trแบญn chiแบฟn!`);

ย ย // Reset lแบกi menu chiรชu thแปฉc cho Pokemon mแปi
ย ย hideMoveMenu(); // แบจn menu chiรชu cลฉ ฤi ฤแป user bแบฅm lแบกi nรบt "Chiแบฟn ฤแบฅu" cho nรณ load chiรชu mแปi
ย ยย
ย ย // Quan trแปng: Vรฌ ฤรขy lร thay ngฦฐแปi sau khi chแบฟt, lฦฐแปฃt cแปงa ฤแปch coi nhฦฐ ฤรฃ xong แป turn trฦฐแปc.
ย ย // Ngฦฐแปi chฦกi ฤฦฐแปฃc quyแปn hรnh ฤแปng ngay.
}

// 4. ฤแบงu hรng (Nแบฟu lฦฐแปi ฤรกnh tiแบฟp)
function surrenderTower() {
ย ย if(confirm("Bแบกn chแบฏc chแบฏn muแปn ฤแบงu hรng vร reset vแป tแบงng 1?")) {
ย ย ย ย document.getElementById('switch-modal').style.display = 'none';
ย ย ย ย endBattle();
ย ย ย ย resetTowerRun();
ย ย }
}
ย ย // --- CONFIG BแบขN ฤแป & LEVEL ---
let trainerData = {
ย ย level: 1,
ย ย xp: 0,
ย ย maxXp: 100
};
let currentZone = 'all'; // Mแบทc ฤแปnh lร vรนng tแปฑ do (Random hแบฟt)

// Danh sรกch cรกc khu vแปฑc
const ZONES = [
ย ย { id: 'all', name: 'Thแบฃo Nguyรชn', icon: '๐ฟ', desc: 'Pokemon ngแบซu nhiรชn', types: [], req: 1 },
ย ย { id: 'forest', name: 'Rแปซng Rแบญm', icon: '๐ฒ', desc: 'Hแป Cแป, Bแป, ฤแปc', types: ['grass', 'bug', 'poison'], req: 3 },
ย ย { id: 'volcano', name: 'Nรบi Lแปญa', icon: '๐', desc: 'Hแป Lแปญa, ฤรก, ฤแบฅt', types: ['fire', 'rock', 'ground'], req: 10 },
ย ย { id: 'sea', name: 'Biแปn Cแบฃ', icon: '๐', desc: 'Hแป Nฦฐแปc, Bฤng', types: ['water', 'ice'], req: 15 },
ย ย { id: 'power', name: 'Nhร Mรกy ฤiแปn', icon: 'โก', desc: 'Hแป ฤiแปn, Thรฉp', types: ['electric', 'steel'], req: 20 },
ย ย { id: 'haunted', name: 'Nghฤฉa ฤแปa', icon: '๐ป', desc: 'Hแป Ma, Bรณng Tแปi, Siรชu Linh', types: ['ghost', 'dark', 'psychic'], req: 25 },
ย ย { id: 'dragon', name: 'Hang Rแปng', icon: '๐', desc: 'Hแป Rแปng, Tiรชn (Hiแบฟm)', types: ['dragon', 'fairy'], req: 40 }
];

// Cรกc danh hiแปu theo cแบฅp ฤแป
function getRankTitle(lv) {
ย ย if(lv >= 50) return "MASTER";
ย ย if(lv >= 40) return "Champion";
ย ย if(lv >= 30) return "Elite";
ย ย if(lv >= 20) return "Veteran";
ย ย if(lv >= 10) return "Pro";
ย ย if(lv >= 5) return "Rookie";
ย ย return "Newbie";
}
ย ย // --- Hแป THแปNG LEVEL TRAINER ---
function addTrainerXp(amount) {
ย ย trainerData.xp += amount;
ย ยย
ย ย // Check lรชn cแบฅp
ย ย if(trainerData.xp >= trainerData.maxXp) {
ย ย ย ย trainerData.level++;
ย ย ย ย trainerData.xp -= trainerData.maxXp;
ย ย ย ย trainerData.maxXp = Math.floor(trainerData.maxXp * 1.2); // Cแบฅp sau khรณ hฦกn cแบฅp trฦฐแปc 20%
ย ย ย ยย
ย ย ย ย // Quร lรชn cแบฅp
ย ย ย ย playSFX('levelup');
ย ย ย ย coins += trainerData.level * 500;
ย ย ย ย inventory['poke-ball'] = (inventory['poke-ball']||0) + 5;
ย ย ย ยย
ย ย ย ย alert(`๐ CHรC MแปชNG! Bแบกn ฤรฃ lรชn Level ${trainerData.level}!\nNhแบญn: ${trainerData.level * 500} Xu & 5 Poke Ball.`);
ย ย ย ยย
ย ย ย ย // Cแบญp nhแบญt lแบกi UI Map (ฤแป mแป khรณa map mแปi)
ย ย ย ย renderMapList();ย
ย ย }
ย ยย
ย ย updateTrainerUI();
ย ย saveGame();
}

function updateTrainerUI() {
ย ย document.getElementById('trainer-level').innerText = trainerData.level;
ย ย document.getElementById('rank-title').innerText = getRankTitle(trainerData.level);
ย ยย
ย ย let pct = (trainerData.xp / trainerData.maxXp) * 100;
ย ย document.getElementById('trainer-xp-bar').style.width = pct + '%';
}

// --- Hแป THแปNG MAP ---
function openMap() {
ย ย if(currentWild) return alert("ฤang cรณ Pokemon, khรดng thแป xem bแบฃn ฤแป!");
ย ย document.getElementById('map-modal').style.display = 'flex';
ย ย renderMapList();
}

function renderMapList() {
ย ย const list = document.getElementById('map-list');
ย ย list.innerHTML = ZONES.map(z => {
ย ย ย ย let isLocked = trainerData.level < z.req;
ย ย ย ย let isActive = currentZone === z.id;
ย ย ย ย let lockText = isLocked ? `<div class="map-req">๐ Cแบงn Lv.${z.req}</div>` : '';
ย ย ย ย let activeClass = isActive ? 'active' : '';
ย ย ย ย let lockedClass = isLocked ? 'locked' : '';
ย ย ย ยย
ย ย ย ย // Nแบฟu locked thรฌ khรดng bแบฅm ฤฦฐแปฃc
ย ย ย ย let clickAction = isLocked ? '' : `selectZone('${z.id}')`;
ย ย ย ยย
ย ย ย ย return `
ย ย ย ย <div class="map-card ${activeClass} ${lockedClass}" onclick="${clickAction}">
ย ย ย ย ย ย <span class="map-icon">${z.icon}</span>
ย ย ย ย ย ย <div style="font-weight:bold; color:#0984e3">${z.name}</div>
ย ย ย ย ย ย <div style="font-size:0.8em; color:#bbb">${z.desc}</div>
ย ย ย ย ย ย ${lockText}
ย ย ย ย ย ย ${isActive ? '<div style="color:#2ecc71; font-weight:bold; font-size:0.8em">โ ฤang แป ฤรขy</div>' : ''}
ย ย ย ย </div>
ย ย ย ย `;
ย ย }).join('');
}

function selectZone(zoneId) {
ย ย currentZone = zoneId;
ย ย updateZoneNameUI();
ย ย saveGame();
ย ย document.getElementById('map-modal').style.display = 'none';
ย ยย
ย ย // Tรฌm tรชn map ฤแป thรดng bรกo
ย ย let z = ZONES.find(x => x.id === zoneId);
ย ย log(`<div style="color:#0984e3">๐บ๏ธ ฤรฃ di chuyแปn ฤแบฟn: <b>${z.name}</b></div>`);
ย ยย
ย ย // ฤแปi background game cho sinh ฤแปng (Tรนy chแปn, nแบฟu bแบกn cรณ แบฃnh)
ย ย // document.body.style.backgroundImage = `url('bg_${zoneId}.jpg')`;ย
}
ย ย // --- HรM CแบฌP NHแบฌT UI TรN VรNG ฤแบคT ---
function updateZoneNameUI() {
ย ย const el = document.getElementById('zone-display-name');
ย ย if(!el) return;

ย ย // Tรฌm thรดng tin zone hiแปn tแบกi
ย ย let z = ZONES.find(x => x.id === currentZone);
ย ย let name = z ? z.name : "Vรนng Vรด Danh";
ย ยย
ย ย el.innerText = name;
ย ยย
ย ย // ฤแปi mรu chแปฏ theo map cho ฤแบนp (Tรนy chแปn)
ย ย if(currentZone === 'volcano') el.style.color = '#e74c3c'; // ฤแป
ย ย else if(currentZone === 'sea') el.style.color = '#3498db'; // Xanh biแปn
ย ย else if(currentZone === 'forest') el.style.color = '#2ecc71'; // Xanh lรก
ย ย else el.style.color = '#0984e3'; // Mแบทc ฤแปnh
}
ย ย // --- Hแป THแปNG ฤแบพM NGฦฏแปI ONLINE (REALTIME) ---
function initOnlineSystem() {
ย ย if (!currentUser) return;

ย ย // 1. Tham chiแบฟu ฤแบฟn vแป trรญ lฦฐu trแบกng thรกi cแปงa mรฌnh
ย ย const myStatusRef = firebase.database().ref('status/' + currentUser);
ย ยย
ย ย // 2. Tham chiแบฟu ฤแบฟn biแบฟn hแป thแปng ฤแบทc biแปt cแปงa Firebase (.info/connected)
ย ย // Biแบฟn nรy tแปฑ ฤแปng = true khi cรณ mแบกng, false khi mแบฅt mแบกng
ย ย const connectedRef = firebase.database().ref('.info/connected');

ย ย connectedRef.on('value', (snap) => {
ย ย ย ย if (snap.val() === true) {
ย ย ย ย ย ย // A. Khi kแบฟt nแปi thรnh cรดng:
ย ย ย ย ย ยย
ย ย ย ย ย ย // ฤฤng kรฝ lแปnh: "Nแบฟu tรดi bแป ngแบฏt kแบฟt nแปi, hรฃy XรA tรดi khแปi database"
ย ย ย ย ย ย myStatusRef.onDisconnect().remove();

ย ย ย ย ย ย // Ghi tรชn mรฌnh vรo danh sรกch Online
ย ย ย ย ย ย myStatusRef.set({
ย ย ย ย ย ย ย ย state: 'online',
ย ย ย ย ย ย ย ย last_changed: firebase.database.ServerValue.TIMESTAMP
ย ย ย ย ย ย });
ย ย ย ย }
ย ย });

ย ย // 3. Lแบฏng nghe tแปng sแป ngฦฐแปi ฤang Online ฤแป hiแปn thแป
ย ย firebase.database().ref('status').on('value', (snap) => {
ย ย ย ย // ฤแบฟm sแป lฦฐแปฃng con trong thฦฐ mแปฅc status
ย ย ย ย const count = snap.numChildren();
ย ย ย ยย
ย ย ย ย // Cแบญp nhแบญt lรชn mรn hรฌnh
ย ย ย ย const countEl = document.getElementById('online-count');
ย ย ย ย if(countEl) {
ย ย ย ย ย ย countEl.innerText = count;
ย ย ย ย ย ยย
ย ย ย ย ย ย // Hiแปu แปฉng nhแบฅp nhรกy nhแบน cho vui mแบฏt
ย ย ย ย ย ย countEl.style.textShadow = "0 0 5px #00b0f4";
ย ย ย ย ย ย setTimeout(() => countEl.style.textShadow = "none", 500);
ย ย ย ย }
ย ย });
}
ย ย // --- Hแป THแปNG ADMIN TOOLS (CHแป HIแปN CHO ADMIN) ---
// --- Hแป THแปNG ADMIN PANEL CAO CแบคP (DRAGGABLE) ---
// =========================================================================
//ย ย ย ย ย ย ย Hแป THแปNG ADMIN PANEL TOรN DIแปN (FINAL VERSION)
// =========================================================================

// --- SแปฌA LแปI KHรNG NHแบฌP ฤฦฏแปขC TEXT (FIXED DRAG LOGIC) ---
function checkAdminPrivileges() {
ย ย if (currentUser !== 'ADMIN') return;

ย ย // 1. Dแปn dแบนp cรกi cลฉ
ย ย const oldPanel = document.getElementById('admin-panel');
ย ย if (oldPanel) oldPanel.remove();
ย ย const oldBtn = document.getElementById('admin-toggle-btn');
ย ย if (oldBtn) oldBtn.remove();

ย ย // 2. HTML MแปI (CHร ร DรNG id="admin-panel-header")
ย ย const panelHTML = `
ย ย <div id="admin-toggle-btn" onclick="toggleAdminPanel()">โก</div>
ย ยย
ย ย <div id="admin-panel">
ย ย ย ย <div id="admin-panel-header">
ย ย ย ย ย ย <span>๐ก๏ธ ADMIN CONTROL</span>
ย ย ย ย ย ย <span style="cursor:pointer" onclick="toggleAdminPanel()">โ</span>
ย ย ย ย </div>

ย ย ย ย <div class="admin-body">
ย ย ย ย ย ย <div class="admin-group">
ย ย ย ย ย ย ย ย <span class="admin-label">--- BแบขN THรN ---</span>
ย ย ย ย ย ย ย ย <button class="admin-btn" onclick="adminAddCoins()">๐ฐ +1 Tแปท Vรng</button>
ย ย ย ย ย ย ย ย <button class="admin-btn" onclick="adminAddBalls()">๐ด +100 Master Ball</button>
ย ย ย ย ย ย ย ย <button class="admin-btn" onclick="adminFullStamina()">โก Hแปi Full Stamina</button>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div class="admin-group">
ย ย ย ย ย ย ย ย <span class="admin-label">--- TRIแปU HแปI (SPAWN) ---</span>
ย ย ย ย ย ย ย ย <input type="text" id="adm-spawn-target" class="admin-input" placeholder="Tรชn ngฦฐแปi nhแบญn (Trแปng = Tแปฑ sฦฐแปng)">
ย ย ย ย ย ย ย ย <input type="number" id="adm-poke-id" class="admin-input" placeholder="Nhแบญp ID Pokemon (1-649)">
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <div style="display:flex; gap:5px; margin-top:5px; justify-content: space-between;">
ย ย ย ย ย ย ย ย ย ย <label><input type="checkbox" id="adm-shiny"> โจShiny</label>
ย ย ย ย ย ย ย ย ย ย <label><input type="checkbox" id="adm-shadow"> ๐ฟShadow</label>
ย ย ย ย ย ย ย ย ย ย <label><input type="checkbox" id="adm-rainbow"> ๐Rainbow</label>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ยย
ย ย ย ย ย ย ย ย <button class="admin-btn" onclick="adminForceSpawn()">๐ฆ TRIแปU HแปI NGAY</button>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div class="admin-group">
ย ย ย ย ย ย ย ย <span class="admin-label">--- TแบถNG QUร (GIFT) ---</span>
ย ย ย ย ย ย ย ย <input type="text" id="adm-target-user" class="admin-input" placeholder="Tรชn ngฦฐแปi nhแบญn">
ย ย ย ย ย ย ย ย <div style="display:flex; gap:5px">
ย ย ย ย ย ย ย ย ย ย <select id="adm-gift-type" class="admin-input" style="width:60%">
ย ย ย ย ย ย ย ย ย ย ย ย <option value="coins">Vรng (Coins)</option>
ย ย ย ย ย ย ย ย ย ย ย ย <option value="master-ball">Master Ball</option>
ย ย ย ย ย ย ย ย ย ย </select>
ย ย ย ย ย ย ย ย ย ย <input type="number" id="adm-gift-amount" class="admin-input" style="width:40%" placeholder="Sแป lฦฐแปฃng">
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <button class="admin-btn" onclick="adminSendGift()">๐ Gแปญi Quร</button>
ย ย ย ย ย ย </div>

ย ย ย ย ย ย <div class="admin-group" style="border-bottom:none">
ย ย ย ย ย ย ย ย <span class="admin-label">--- QUแบขN Lร SERVER ---</span>
ย ย ย ย ย ย ย ย <input type="text" id="adm-broadcast-msg" class="admin-input" placeholder="Thรดng bรกo toรn server...">
ย ย ย ย ย ย ย ย <button class="admin-btn" onclick="adminBroadcast()">๐ข Phรกt Loa</button>
ย ย ย ย ย ย ย ย <div style="display:flex; gap:5px; margin-top:5px">
ย ย ย ย ย ย ย ย ย ย <button class="admin-btn" style="background:#800" onclick="adminClearChat()">๐๏ธ Xรณa Chat</button>
ย ย ย ย ย ย ย ย ย ย <button class="admin-btn" style="background:#800" onclick="adminResetBoss()">โ๏ธ Reset Boss</button>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย </div>
ย ย ย ย </div>
ย ย </div>`;

ย ย document.body.insertAdjacentHTML('beforeend', panelHTML);

ย ย // 3. KรCH HOแบT KรO THแบข (Giแป nรณ sแบฝ tแปฑ tรฌm thแบฅy admin-panel-header)
ย ย dragElement(document.getElementById("admin-panel"));
}
// ---------------------------------------------------------
//ย ย ย ย CรC HรM Hแป TRแปข (HELPER FUNCTIONS)
// ---------------------------------------------------------

// 1. ฤรณng/Mแป Panel
function toggleAdminPanel() {
ย ย const p = document.getElementById('admin-panel');
ย ย if (p.style.display === 'none' || p.style.display === '') {
ย ย ย ย p.style.display = 'block';
ย ย } else {
ย ย ย ย p.style.display = 'none';
ย ย }
}

// 2. Logic Kรฉo Thแบฃ (Draggable)
function dragElement(elmnt) {
ย ย var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
ย ย const header = document.getElementById(elmnt.id + "-header");
ย ย if (header) {
ย ย ย ย header.onmousedown = dragMouseDown;
ย ย } else {
ย ย ย ย elmnt.onmousedown = dragMouseDown;
ย ย }

ย ย function dragMouseDown(e) {
ย ย ย ย e = e || window.event;
ย ย ย ย e.preventDefault();
ย ย ย ย pos3 = e.clientX;
ย ย ย ย pos4 = e.clientY;
ย ย ย ย document.onmouseup = closeDragElement;
ย ย ย ย document.onmousemove = elementDrag;
ย ย }

ย ย function elementDrag(e) {
ย ย ย ย e = e || window.event;
ย ย ย ย e.preventDefault();
ย ย ย ย pos1 = pos3 - e.clientX;
ย ย ย ย pos2 = pos4 - e.clientY;
ย ย ย ย pos3 = e.clientX;
ย ย ย ย pos4 = e.clientY;
ย ย ย ย elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
ย ย ย ย elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
ย ย }

ย ย function closeDragElement() {
ย ย ย ย document.onmouseup = null;
ย ย ย ย document.onmousemove = null;
ย ย }
}

// ---------------------------------------------------------
//ย ย ย ย CรC HรM CHแปจC NฤNG (LOGIC Xแปฌ Lร)
// ---------------------------------------------------------

// [SELF] Hack ฤแป Cho Mรฌnh
function adminAddCoins() {
ย ย coins += 1000000000;
ย ย saveGame(); updateStats();
ย ย alert("โ ฤรฃ hack 1 Tแปท Vรng!");
}
function adminAddBalls() {
ย ย inventory['master-ball'] = (inventory['master-ball'] || 0) + 100;
ย ย saveGame();
ย ย alert("โ ฤรฃ lแบฅy 100 Master Ball!");
}
function adminFullStamina() {
ย ย stamina = 100;
ย ย updateStaminaUI();
ย ย alert("โ Full Stamina!");
}

// [SPAWN] Triแปu Hแปi Pokemon (Hแป trแปฃ tแปซ xa)
async function adminForceSpawn() {
ย ย let id = document.getElementById('adm-poke-id').value;
ย ย let targetUser = document.getElementById('adm-spawn-target').value.trim().toUpperCase(); // Lแบฅy tรชn ngฦฐแปi nhแบญn

ย ย if(!id || id < 1 || id > 649) return alert("โ ID khรดng hแปฃp lแป (1-649)");
ย ยย
ย ย let isShiny = document.getElementById('adm-shiny').checked;
ย ย let isShadow = document.getElementById('adm-shadow').checked;
ย ย let isRainbow = document.getElementById('adm-rainbow').checked;

ย ย // CASE 1: Spawn cho ngฦฐแปi khรกc
ย ย if (targetUser && targetUser !== "") {
ย ย ย ย if (!confirm(`Bแบกn muแปn triแปu hแปi Pokemon ID ${id} cho ngฦฐแปi chฦกi [${targetUser}]?`)) return;

ย ย ย ย // Gแปญi lแปnh vรo Firebase cแปงa ngฦฐแปi ฤรณ
ย ย ย ย firebase.database().ref('users/' + targetUser + '/admin_event').set({
ย ย ย ย ย ย type: 'spawn',
ย ย ย ย ย ย id: id,
ย ย ย ย ย ย shiny: isShiny,
ย ย ย ย ย ย shadow: isShadow,
ย ย ย ย ย ย rainbow: isRainbow,
ย ย ย ย ย ย timestamp: Date.now()
ย ย ย ย }, (error) => {
ย ย ย ย ย ย if (error) alert("โ Lแปi: Ngฦฐแปi chฦกi khรดng tแปn tแบกi hoแบทc lแปi mแบกng.");
ย ย ย ย ย ย else alert(`โ ฤรฃ gแปญi Pokemon tแปi mรn hรฌnh cแปงa ${targetUser}!`);
ย ย ย ย });
ย ย }ย
ย ย // CASE 2: Spawn cho chรญnh mรฌnh (Test)
ย ย else {
ย ย ย ย // alert(`ฤang triแปu hแปi Pokemon ID: ${id} tแบกi ฤรขy...`);
ย ย ย ย await forceSpawnPokemon(id, isShiny, isShadow, isRainbow);
ย ย ย ย // Khรดng ฤรณng panel nแปฏa ฤแป tiแปn spawn liรชn tแปฅc
ย ย }
}

// [GIFT] Tแบทng Quร
function adminSendGift() {
ย ย let target = document.getElementById('adm-target-user').value.toUpperCase().trim();
ย ย let type = document.getElementById('adm-gift-type').value;
ย ย let amount = parseInt(document.getElementById('adm-gift-amount').value);

ย ย if(!target || !amount) return alert("โ Nhแบญp thiแบฟu thรดng tin!");

ย ย firebase.database().ref('users/' + target).once('value', snapshot => {
ย ย ย ย if(!snapshot.exists()) return alert("โ Khรดng tรฌm thแบฅy ngฦฐแปi chฦกi nรy!");
ย ย ย ยย
ย ย ย ย let data = snapshot.val();
ย ย ย ยย
ย ย ย ย if(type === 'coins') {
ย ย ย ย ย ย let current = data.coins || 0;
ย ย ย ย ย ย firebase.database().ref('users/' + target + '/coins').set(current + amount);
ย ย ย ย } else {
ย ย ย ย ย ย let currentInv = data.inventory || {};
ย ย ย ย ย ย let currentItemQty = currentInv[type] || 0;
ย ย ย ย ย ย firebase.database().ref('users/' + target + '/inventory/' + type).set(currentItemQty + amount);
ย ย ย ย }
ย ย ย ย alert(`โ ฤรฃ gแปญi ${amount} ${type} cho ${target}`);
ย ย });
}

// [SERVER] Cรดng cแปฅ quแบฃn lรฝ
function adminClearChat() {
ย ย if(confirm("Xรณa sแบกch toรn bแป lแปch sแปญ Chat Server?")) {
ย ย ย ย firebase.database().ref('global_chat').remove();
ย ย ย ย alert("โ Chat ฤรฃ ฤฦฐแปฃc dแปn sแบกch!");
ย ย }
}
function adminResetBoss() {
ย ย if(confirm("Bแบกn cรณ chแบฏc muแปn Reset Boss tuแบงn khรดng?")) {
ย ย ย ย firebase.database().ref('world_boss/weekId').set(0);
ย ย ย ย alert("โ Boss ฤรฃ ฤฦฐแปฃc Reset.");
ย ย }
}
function adminBroadcast() {
ย ย let msg = document.getElementById('adm-broadcast-msg').value;
ย ย if(!msg) return alert("Chฦฐa nhแบญp nแปi dung!");
ย ยย
ย ย firebase.database().ref('global_chat').push({
ย ย ย ย user: "ADMIN",
ย ย ย ย text: "๐ข THรNG BรO: " + msg,
ย ย ย ย timestamp: firebase.database.ServerValue.TIMESTAMP
ย ย });
ย ย alert("โ ฤรฃ phรกt thรดng bรกo toรn server!");
ย ย document.getElementById('adm-broadcast-msg').value = ""; // Xรณa รด nhแบญp sau khi gแปญi
}
ย ย // --- HรM XรC ฤแปNH ฤแป HIแบพM (COMMON/RARE/LEGENDARY) ---
function getRarity(pokemon) {
ย ย // 1. Check Huyแปn Thoแบกi trฦฐแปc
ย ย const LEGEND_LIST = [144,145,146,150,151,243,244,245,249,250,251,377,378,379,380,381,382,383,384,385,386,480,481,482,483,484,485,486,487,488,489,490,491,492,493,494,638,639,640,641,642,643,644,645,646];
ย ย if (LEGEND_LIST.includes(pokemon.id)) {
ย ย ย ย return { label: "LEGENDARY", class: "rarity-legendary", color: "#f1c40f" }; // Vรng
ย ย }

ย ย // 2. Check theo Base XP (Sแปฉc mแบกnh)
ย ย let xp = pokemon.baseXp;
ย ย if (xp < 70) return { label: "COMMON", class: "rarity-common", color: "#95a5a6" }; // Xรกm
ย ย if (xp < 140) return { label: "UNCOMMON", class: "rarity-uncommon", color: "#2ecc71" }; // Xanh lรก
ย ย if (xp < 200) return { label: "RARE", class: "rarity-rare", color: "#3498db" }; // Xanh dฦฐฦกng
ย ยย
ย ย // 3. Cรฒn lแบกi lร Epic/Mythic
ย ย return { label: "EPIC", class: "rarity-epic", color: "#9b59b6" }; // Tรญm
}
ย ย // --- HรM LแบคY CHI TIแบพT CHIรU Tแปช API ---
async function fetchMoveDetails(moveNameOrId) {
ย ย try {
ย ย ย ย // 1. Gแปi API lแบฅy thรดng tin chiรชu
ย ย ย ย const res = await fetch(`https://pokeapi.co/api/v2/move/${moveNameOrId}`);
ย ย ย ย const data = await res.json();

ย ย ย ย // 2. Lแบฅy mรด tแบฃ tiแบฟng Anh
ย ย ย ย const descEntry = data.effect_entries.find(e => e.language.name === 'en');
ย ย ย ย const desc = descEntry ? descEntry.short_effect : "No description.";

ย ย ย ย // 3. Chuแบฉn hรณa vแป format game cแปงa bแบกn
ย ย ย ย return {
ย ย ย ย ย ย name: data.name.split('-').map(w => w.charAt(0).toUpperCase()+w.slice(1)).join(' '), // Format tรชn ฤแบนp
ย ย ย ย ย ย id: data.name, // ID gแปc ฤแป lฦฐu
ย ย ย ย ย ย type: data.type.name,
ย ย ย ย ย ย pwr: data.power || 0, // Nแบฟu null (chiรชu status) thรฌ cho bแบฑng 0
ย ย ย ย ย ย acc: data.accuracy || 100,
ย ย ย ย ย ย cat: data.damage_class.name === 'special' ? 'spe' : (data.damage_class.name === 'physical' ? 'phy' : 'status'),
ย ย ย ย ย ย desc: desc,
ย ย ย ย ย ย priority: data.priority || 0
ย ย ย ย };
ย ย } catch (e) {
ย ย ย ย console.error("Lแปi lแบฅy move:", e);
ย ย ย ย return null;
ย ย }
}
ย ย let learnResolve = null; // Biแบฟn ฤแป bรกo hiแปu khi nรo hแปc xong

function openMoveRelearner(pokemon, newMove, resolveCallback) {
ย ย pendingLearning.pokemon = pokemon;
ย ย pendingLearning.newMoveData = newMove;
ย ย learnResolve = resolveCallback; // Lฦฐu callback ฤแป gแปi sau khi chแปn xong

ย ย // 1. ฤiแปn thรดng tin chiรชu MแปI
ย ย document.getElementById('learner-name').innerText = pokemon.name;
ย ย document.getElementById('new-move-name').innerText = newMove.name;
ย ย document.getElementById('new-move-type').innerText = newMove.type.toUpperCase();
ย ย document.getElementById('new-move-type').style.color = TYPE_COLORS[newMove.type] || 'white';
ย ย document.getElementById('new-move-pwr').innerText = newMove.pwr > 0 ? newMove.pwr : '-';
ย ย document.getElementById('new-move-acc').innerText = newMove.acc || '-';
ย ย document.getElementById('new-move-desc').innerText = newMove.desc;

ย ย // 2. ฤiแปn danh sรกch 4 chiรชu Cลจ
ย ย const list = document.getElementById('old-moves-list');
ย ย list.innerHTML = pokemon.moves.map((m, idx) => `
ย ย ย ย <div onclick="forgetAndLearn(${idx})" style="background:#333; padding:10px; border:1px solid #555; border-radius:5px; cursor:pointer; display:flex; justify-content:space-between; align-items:center; transition:0.2s">
ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย <div style="font-weight:bold; color:${TYPE_COLORS[m.type] || 'white'}">${m.name}</div>
ย ย ย ย ย ย ย ย <div style="font-size:0.8em; color:#aaa">PP: 10/10 | Pwr: ${m.pwr||'-'}</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <div style="background:#ed4245; color:white; font-size:0.7em; padding:2px 5px; border-radius:3px">QUรN</div>
ย ย ย ย </div>
ย ย `).join('');

ย ย // 3. Hiแปn Modal
ย ย document.getElementById('learn-move-modal').style.display = 'flex';
}

// --- NGฦฏแปI CHฦI CHแปN QUรN CHIรU Cลจ ---
function forgetAndLearn(slotIdx) {
ย ย let p = pendingLearning.pokemon;
ย ย let oldMove = p.moves[slotIdx];
ย ย let newMove = pendingLearning.newMoveData;

ย ย // Thay thแบฟ
ย ย p.moves[slotIdx] = newMove;

ย ย alert(`1, 2, 3... Poof! ๐จ\n${p.name} ฤรฃ quรชn [${oldMove.name}] vร hแปc ฤฦฐแปฃc [${newMove.name}]!`);
ย ย logBattle(`${p.name} hแปc <b>${newMove.name}</b> (thay ${oldMove.name}).`);
ย ยย
ย ย saveGame();
ย ย closeRelearner();
}

// --- NGฦฏแปI CHฦI Bแป QUA ---
function giveUpMove() {
ย ย let p = pendingLearning.pokemon;
ย ย let m = pendingLearning.newMoveData;
ย ยย
ย ย if(confirm(`${p.name} sแบฝ khรดng hแปc ${m.name}. Bแบกn chแบฏc chแปฉ?`)) {
ย ย ย ย logBattle(`${p.name} ฤรฃ tแปซ bแป viแปc hแปc ${m.name}.`);
ย ย ย ย closeRelearner();
ย ย }
}

function closeRelearner() {
ย ย document.getElementById('learn-move-modal').style.display = 'none';
ย ย if(learnResolve) {
ย ย ย ย learnResolve(); // Bรกo hiแปu ฤรฃ xong ฤแป code chแบกy tiแบฟp (nแบฟu cรณ chiรชu thแปฉ 2)
ย ย ย ย learnResolve = null;
ย ย }
}
ย ย // --- HรM Tแปฐ ฤแปNG CแบฌP NHแบฌT CHIรU CHO POKEMON Cลจ (DรNG API) ---
async function backfillMovesForOldPokemon(pokemon) {
ย ย // Chแป chแบกy nแบฟu Pokemon cรณ รญt hฦกn 4 chiรชu
ย ย if (pokemon.moves.length >= 4) return;

ย ย console.log(`ฤang cแบญp nhแบญt chiรชu cho ${pokemon.name}...`);

ย ย try {
ย ย ย ย // 1. Lแบฅy dแปฏ liแปu chuแบฉn tแปซ API
ย ย ย ย const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${pokemon.id}`);
ย ย ย ย const data = await res.json();

ย ย ย ย // 2. Lแบฅy tแบฅt cแบฃ cรกc chiรชu cรณ thแป hแปc bแบฑng cรกch Lรชn Cแบฅp (Level-up)
ย ย ย ย // ฤiแปu kiแปn: Level hแปc ฤฦฐแปฃc phแบฃi nhแป hฦกn hoแบทc bแบฑng Level hiแปn tแบกi cแปงa Pokemon
ย ย ย ย let possibleMoves = data.moves.filter(m => {
ย ย ย ย ย ย const details = m.version_group_details[m.version_group_details.length - 1];
ย ย ย ย ย ย return details.move_learn_method.name === 'level-up' &&ย
ย ย ย ย ย ย ย ย ย ยdetails.level_learned_at <= pokemon.level;
ย ย ย ย });

ย ย ย ย // 3. Sแบฏp xแบฟp chiรชu: ฦฏu tiรชn chiรชu hแปc แป Level cao nhแบฅt (Chiรชu mแบกnh/mแปi nhแบฅt)
ย ย ย ย possibleMoves.sort((a, b) => {
ย ย ย ย ย ย const getLv = (m) => m.version_group_details[m.version_group_details.length - 1].level_learned_at;
ย ย ย ย ย ย return getLv(b) - getLv(a); // Giแบฃm dแบงn
ย ย ย ย });

ย ย ย ย // 4. ฤiแปn vรo cรกc รด trแปng
ย ย ย ย for (let m of possibleMoves) {
ย ย ย ย ย ย // Nแบฟu ฤรฃ ฤแบงy 4 chiรชu thรฌ dแปซng
ย ย ย ย ย ย if (pokemon.moves.length >= 4) break;

ย ย ย ย ย ย let moveName = m.move.name;

ย ย ย ย ย ย // Kiแปm tra trรนng: Khรดng hแปc lแบกi chiรชu ฤรฃ biแบฟt
ย ย ย ย ย ย // (So sรกnh cแบฃ ID vร Tรชn ฤแป chแบฏc chแบฏn)
ย ย ย ย ย ย let isKnown = pokemon.moves.some(known =>ย
ย ย ย ย ย ย ย ย known.id === moveName ||ย
ย ย ย ย ย ย ย ย known.name.toUpperCase() === moveName.replace(/-/g, ' ').toUpperCase()
ย ย ย ย ย ย );

ย ย ย ย ย ย if (!isKnown) {
ย ย ย ย ย ย ย ย // Lแบฅy chi tiแบฟt vร thรชm vรo
ย ย ย ย ย ย ย ย let moveDetails = await fetchMoveDetails(moveName);
ย ย ย ย ย ย ย ย if (moveDetails) {
ย ย ย ย ย ย ย ย ย ย pokemon.moves.push(moveDetails);
ย ย ย ย ย ย ย ย ย ย console.log(`-> ฤรฃ dแบกy ${moveName} cho ${pokemon.name}`);
ย ย ย ย ย ย ย ย }
ย ย ย ย ย ย }
ย ย ย ย }

ย ย ย ย // 5. Lฦฐu lแบกi game sau khi cแบญp nhแบญt xong con nรy
ย ย ย ย saveGame();

ย ย } catch (e) {
ย ย ย ย console.error(`Lแปi cแบญp nhแบญt move cho ${pokemon.name}:`, e);
ย ย }
}
ย ย // --- BIแบพN TOรN CแปคC QUแบขN Lร MOVE ---
let currentMmPokemonIdx = -1; // Index cแปงa Pokemon ฤang chแปnh
let selectedMoveToLearn = null; // Chiรชu ฤang chแปn ฤแป hแปc

// 1. Mแป GIAO DIแปN
function openMoveManager(bagIndex) {
ย ย currentMmPokemonIdx = bagIndex;
ย ย selectedMoveToLearn = null;
ย ย let p = myBag[bagIndex];

ย ย if(!p) return;

ย ย // Hiแปn thแป Modal
ย ย document.getElementById('move-manager-modal').style.display = 'flex';
ย ย document.getElementById('mm-poke-img').src = p.img;
ย ย document.getElementById('mm-poke-name').innerText = p.name;

ย ย // Render danh sรกch hiแปn tแบกi
ย ย renderCurrentMoves();

ย ย // Tแบฃi danh sรกch cรณ thแป hแปc (Async)
ย ย loadRelearnableMoves(p);
}

function closeMoveManager() {
ย ย document.getElementById('move-manager-modal').style.display = 'none';
}

// 2. HIแปN THแป CHIรU HIแปN TแบI (Cแปt Trรกi)
function renderCurrentMoves() {
ย ย let p = myBag[currentMmPokemonIdx];
ย ย const list = document.getElementById('mm-current-list');
ย ย list.innerHTML = '';

ย ย p.moves.forEach((m, idx) => {
ย ย ย ย let typeColor = TYPE_COLORS[m.type] || '#ccc';
ย ย ย ยย
ย ย ย ย list.innerHTML += `
ย ย ย ย <div class="move-item" onclick="onReplaceMove(${idx})">
ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย <div style="font-weight:bold; color:${typeColor}">${m.name}</div>
ย ย ย ย ย ย ย ย <div style="font-size:0.7em; color:#aaa">Pwr: ${m.pwr||'-'} | Acc: ${m.acc||'-'}</div>
ย ย ย ย ย ย </div>
ย ย ย ย ย ย <span class="type-tag" style="background:${typeColor}">${m.type.substring(0,3)}</span>
ย ย ย ย </div>`;
ย ย });

ย ย // Nแบฟu chฦฐa ฤแปง 4 chiรชu, hiแปn รด trแปng
ย ย for(let i = p.moves.length; i < 4; i++) {
ย ย ย ย list.innerHTML += `
ย ย ย ย <div class="move-item" onclick="onReplaceMove(${i})" style="border:1px dashed #555; justify-content:center; color:#555">
ย ย ย ย ย ย (Trแปng)
ย ย ย ย </div>`;
ย ย }
}

// 3. TแบขI CHIรU Cร THแป HแปC (Cแปt Phแบฃi) - Dรนng API
async function loadRelearnableMoves(pokemon) {
ย ย const list = document.getElementById('mm-pool-list');
ย ย list.innerHTML = '<div style="text-align:center; color:yellow; padding:20px">โณ ฤang ฤแปc kรฝ แปฉc...</div>';

ย ย try {
ย ย ย ย // Gแปi API lแบฅy toรn bแป chiรชu
ย ย ย ย const res = await fetch(`https://pokeapi.co/api/v2/pokemon/${pokemon.id}`);
ย ย ย ย const data = await res.json();

ย ย ย ย // Lแปc chiรชu:
ย ย ย ย // 1. Phแบฃi lร learn method 'level-up'
ย ย ย ย // 2. Level hแปc phแบฃi <= Level hiแปn tแบกi cแปงa Pokemon
ย ย ย ย // 3. Khรดng nแบฑm trong danh sรกch chiรชu hiแปn tแบกi
ย ย ย ย let pool = data.moves.filter(m => {
ย ย ย ย ย ย const details = m.version_group_details[m.version_group_details.length - 1]; // Lแบฅy bแบฃn mแปi nhแบฅt
ย ย ย ย ย ย const isLevelUp = details.move_learn_method.name === 'level-up';
ย ย ย ย ย ย const isLevelOk = details.level_learned_at <= pokemon.level;
ย ย ย ย ย ยย
ย ย ย ย ย ย // Check trรนng
ย ย ย ย ย ย const isKnown = pokemon.moves.some(known => known.id === m.move.name);

ย ย ย ย ย ย return isLevelUp && isLevelOk && !isKnown;
ย ย ย ย });

ย ย ย ย // Sแบฏp xแบฟp: Level cao lรชn ฤแบงu (Chiรชu mแบกnh thฦฐแปng แป lv cao)
ย ย ย ย pool.sort((a, b) => {
ย ย ย ย ย ย const lvA = a.version_group_details[a.version_group_details.length - 1].level_learned_at;
ย ย ย ย ย ย const lvB = b.version_group_details[b.version_group_details.length - 1].level_learned_at;
ย ย ย ย ย ย return lvB - lvA;
ย ย ย ย });

ย ย ย ย // Render ra list
ย ย ย ย list.innerHTML = '';
ย ย ย ย if(pool.length === 0) {
ย ย ย ย ย ย list.innerHTML = '<div style="text-align:center; color:#777">Khรดng cรณ chiรชu nรo ฤแป hแปc lแบกi.</div>';
ย ย ย ย ย ย return;
ย ย ย ย }

ย ย ย ย // Tแบกo nรบt cho tแปซng chiรชu (Chฦฐa fetch chi tiแบฟt, chแป hiแปn tรชn ฤแป nhแบน)
ย ย ย ย // Khi bแบฅm vรo mแปi fetch chi tiแบฟt ฤแป hแปc
ย ย ย ย pool.forEach(m => {
ย ย ย ย ย ย let moveNameRaw = m.move.name;
ย ย ย ย ย ย let moveNameNice = moveNameRaw.split('-').map(w => w.charAt(0).toUpperCase()+w.slice(1)).join(' ');
ย ย ย ย ย ย let lv = m.version_group_details[m.version_group_details.length - 1].level_learned_at;

ย ย ย ย ย ย list.innerHTML += `
ย ย ย ย ย ย <div id="pool-btn-${moveNameRaw}" class="move-item" onclick="onSelectMoveToLearn('${moveNameRaw}')">
ย ย ย ย ย ย ย ย <div>
ย ย ย ย ย ย ย ย ย ย <div style="font-weight:bold; color:white">${moveNameNice}</div>
ย ย ย ย ย ย ย ย ย ย <div style="font-size:0.7em; color:#aaa">Hแปc tแบกi Lv.${lv}</div>
ย ย ย ย ย ย ย ย </div>
ย ย ย ย ย ย ย ย <button class="btn-small" style="background:#9b59b6">HแปC</button>
ย ย ย ย ย ย </div>`;
ย ย ย ย });

ย ย } catch (e) {
ย ย ย ย console.error(e);
ย ย ย ย list.innerHTML = '<div style="color:red">Lแปi kแบฟt nแปi Move Relearner.</div>';
ย ย }
}

// 4. Xแปฌ Lร CHแปN CHIรU ฤแป HแปC
async function onSelectMoveToLearn(moveId) {
ย ย // Highlight nรบt ฤang chแปn
ย ย const allBtns = document.querySelectorAll('#mm-pool-list .move-item');
ย ย allBtns.forEach(b => b.classList.remove('selected-learn'));
ย ยย
ย ย const btn = document.getElementById(`pool-btn-${moveId}`);
ย ย if(btn) btn.classList.add('selected-learn');

ย ย // Fetch chi tiแบฟt chiรชu nรy (Power, Type...) ฤแป chuแบฉn bแป gรกn
ย ย btn.innerHTML = `<div>ฤang tแบฃi dแปฏ liแปu...</div>`; // Hiแปu แปฉng loading nhแบน
ย ยย
ย ย const moveDetails = await fetchMoveDetails(moveId);
ย ยย
ย ย if(!moveDetails) {
ย ย ย ย alert("Lแปi tแบฃi chiรชu nรy!");
ย ย ย ย return;
ย ย }

ย ย selectedMoveToLearn = moveDetails;
ย ยย
ย ย // Khรดi phแปฅc lแบกi giao diแปn nรบt
ย ย let moveNameNice = moveDetails.name;
ย ย btn.innerHTML = `
ย ย ย ย <div>
ย ย ย ย ย ย <div style="font-weight:bold; color:${TYPE_COLORS[moveDetails.type]}">${moveNameNice}</div>
ย ย ย ย ย ย <div style="font-size:0.7em; color:#aaa">Pwr: ${moveDetails.pwr} | Acc: ${moveDetails.acc}</div>
ย ย ย ย </div>
ย ย ย ย <div style="font-size:0.7em; color:#2ecc71; font-weight:bold">ฤANG CHแปN</div>
ย ย `;

ย ย alert(`ฤรฃ chแปn [${moveNameNice}].\nBรขy giแป hรฃy bแบฅm vรo 1 chiรชu แป cแปt TRรI ฤแป thay thแบฟ!`);
}

// 5. Xแปฌ Lร THAY THแบพ (Bแบฅm vรo cแปt trรกi)
function onReplaceMove(slotIndex) {
ย ย if(!selectedMoveToLearn) {
ย ย ย ย return alert("Hรฃy chแปn mแปt chiรชu bรชn PHแบขI ฤแป hแปc trฦฐแปc!");
ย ย }

ย ย let p = myBag[currentMmPokemonIdx];
ย ย let oldMoveName = p.moves[slotIndex] ? p.moves[slotIndex].name : "(ร Trแปng)";

ย ย if(confirm(`Bแบกn muแปn ${p.name} quรชn [${oldMoveName}] ฤแป hแปc [${selectedMoveToLearn.name}]?`)) {
ย ย ย ย // Thแปฑc hiแปn ฤแปi
ย ย ย ย p.moves[slotIndex] = selectedMoveToLearn;
ย ย ย ยย
ย ย ย ย saveGame();
ย ย ย ยย
ย ย ย ย // Reset vร vแบฝ lแบกi
ย ย ย ย selectedMoveToLearn = null;
ย ย ย ย alert("Hแปc chiรชu thรnh cรดng!");
ย ย ย ยย
ย ย ย ย // Vแบฝ lแบกi 2 cแปt
ย ย ย ย renderCurrentMoves();
ย ย ย ย loadRelearnableMoves(p); // Load lแบกi ฤแป trแปซ chiรชu vแปซa hแปc ra
ย ย }
}
</script>
</body>
</html>
